<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Fluxo Semanal - Sistema de Escala</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD1fkxq6USO5RX22TlsPQFEaVSZoTj_t2A",
            authDomain: "escalas-6e0f9.firebaseapp.com",
            projectId: "escalas-6e0f9",
            storageBucket: "escalas-6e0f9.firebasestorage.app",
            messagingSenderId: "19118998563",
            appId: "1:19118998563:web:5412be658ae34bd45add96"
        };

        // Initialize Firebase only if it's not already initialized
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            min-height: 100vh;
            background-color: #f5f6fa;
        }

        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            height: 100vh;
            position: fixed;
        }

        .logo {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #34495e;
        }

        .nav-list {
            list-style: none;
            padding: 20px 0;
        }

        .nav-item {
            padding: 10px 20px;
        }

        .nav-item a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .nav-item i {
            margin-right: 10px;
            width: 20px;
        }

        .nav-item:hover {
            background-color: #34495e;
        }

        .content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            color: #2c3e50;
            background-color: white;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 0;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52,152,219,0.3);
        }

        .btn-submit {
            background-color: #2ecc71;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .designacoes-section {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .designacoes-section.active {
            display: block;
        }

        .designacao-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 8px 16px;
            background-color: #f8f9fa;
            border-radius: 8px;
            min-height: 32px;
            position: relative;
            flex-direction: column;
            align-items: flex-start;
        }

        .designacao-item label {
            margin-bottom: 0;
            flex-grow: 1;
            font-size: 16px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .designacao-item label > span {
            flex-grow: 1;
            margin-left: 8px;
        }


        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Styles for order buttons */
        .order-button {
            background-color: #ddd;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            color: #555;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .order-button.ordered {
            background-color: #2ecc71;
            color: white;
        }

        .order-button.ordered-level-2 {
            background-color: #3498db;
        }

        .order-button.ordered-level-3 {
            background-color: #f39c12;
        }

        .order-display {
            font-size: 14px;
            color: #777;
            margin-left: 4px;
        }

        /* Styles for quantity submenu */
        .quantity-submenu {
            position: relative;
            left: 0;
            top: auto;
            bottom: auto;
            transform: none;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            display: none;
            z-index: 10;
            margin-top: 5px;
        }


        .quantity-submenu.active {
            display: flex;
            gap: 5px;
        }

        .quantity-button {
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background-color 0.3s ease;
        }

        .quantity-button.selected {
            background-color: #2ecc71;
            color: white;
        }

        .quantity-button:hover {
            background-color: #e0e0e0;
        }

        /* Styles for turbo button */
        .turbo-button-container {
        display: flex;
        justify-content: flex-end; /* Align to the right */
        margin-top: 10px;
        margin-bottom: 10px;
    }

    .turbo-button {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        transition: color 0.3s ease;
        margin-left: 10px; /* Add spacing between buttons */
    }

    .turbo-button:hover {
        color: #2980b9; /* Keep the hover effect */
    }

    .turbo-button[title*="Filtrar"] {
        transform-origin: center;
        transition: transform 0.3s ease, color 0.3s ease;
    }

    .turbo-button[title*="Filtrar"]:hover {
        color: #e67e22;
        transform: rotate(15deg) scale(1.1);
    }

    .turbo-button[title*="Preencher Participantes Automaticamente"] {
        transform-origin: center;
        transition: transform 0.3s ease, color 0.3s ease;
    }

    .turbo-button[title*="Preencher Participantes Automaticamente"]:hover {
        color: #27ae60;
        transform: translateY(-5px) scale(1.1);
        animation: rocket-shake 0.5s ease infinite;
    }

    @keyframes rocket-shake {
        0%, 100% { transform: translateY(-5px) rotate(0deg); }
        25% { transform: translateY(-5px) rotate(-2deg); }
        75% { transform: translateY(-5px) rotate(2deg); }
    }

    @keyframes rocket-loading {
        0% { transform: translateY(0) rotate(0deg); }
        15% { transform: translateY(0) rotate(-90deg); }
        30% { transform: translateY(0) rotate(-90deg); }
        50% { transform: translateY(-200px) rotate(-90deg); }
        70% { transform: translateY(-350px) rotate(-90deg); }
        90% { transform: translateY(-450px) rotate(-90deg); opacity: 0.3; }
        100% { transform: translateY(-500px) rotate(-90deg); opacity: 0; }
    }

    @keyframes rocket-return {
        0% { transform: translateY(-500px) rotate(180deg); opacity: 0; }
        20% { transform: translateY(-400px) rotate(180deg); opacity: 0.2; }
        40% { transform: translateY(-300px) rotate(180deg); opacity: 0.4; }
        60% { transform: translateY(-200px) rotate(180deg); opacity: 0.6; }
        80% { transform: translateY(-100px) rotate(180deg); opacity: 0.8; }
        90% { transform: translateY(-50px) rotate(180deg); opacity: 0.9; }
        100% { transform: translateY(0) rotate(180deg); opacity: 1; }
    }

    .turbo-button[title*="Preencher Participantes Automaticamente"].loading {
        animation: rocket-loading 1s forwards;
    }

    .turbo-button[title*="Preencher Participantes Automaticamente"].returning {
        animation: rocket-return 1s forwards;
    }

    /* Initially hide Leitura da Bíblia section */
    #leituraBibliaSection {
        display: none; /* Initially hidden */
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
    }

    /* Initially hide Iniciar Fluxo button */
    #fluxoSemanalForm button[type="submit"].btn-submit {
        display: none; /* Initially hidden */
    }

    /* Styles for the popup */
    .popup-overlay {
        display: none; /* Hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
        z-index: 1000; /* Ensure it's on top */
        justify-content: center;
        align-items: center;
    }

    .popup-content {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        width: 80%;
        max-width: 700px;
        position: relative; /* For close button positioning */
    }

    .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .popup-title {
        color: #2c3e50;
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .popup-title .status-icon {
        display: none;
        font-size: 20px;
    }

    .popup-title .status-icon.thinking {
        display: none;
        color: #3498db;
        animation: spin 2s linear infinite;
    }

    .popup-title .status-icon.success {
        display: none;
        color: #2ecc71;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .popup-close-button {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #777;
        position: absolute;
        top: 10px;
        right: 10px;
    }

    .popup-designation-list {
        margin-bottom: 20px;
    }

    .popup-designation-item {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
    }

    .popup-designation-name {
        font-weight: bold;
        margin-bottom: 5px;
        color: #34495e;
    }

    .popup-participant-list {
        list-style: none;
        padding-left: 20px;
    }

    .popup-participant-item {
        margin-bottom: 3px;
        color: #555;
    }

    .popup-actions {
        text-align: right;
    }

    /* Styles for Preferences Popup */
    #preferencesPopup .popup-content {
        max-width: 500px; /* Slightly narrower max-width */
        padding: 20px; /* Further reduced padding */
        max-height: 75vh; /* Slightly reduced max-height if needed */
        overflow-y: auto;
    }

    #preferencesPopup .popup-designation-preference {
        margin-bottom: 15px; /* Further reduced margin */
        padding: 10px; /* Further reduced padding */
        border: 1px solid #ddd;
        border-radius: 6px; /* Slightly smaller border-radius */
        background-color: #f9f9f9;
    }

    #preferencesPopup .popup-designation-preference:last-child {
        margin-bottom: 0;
    }

    #preferencesPopup .popup-designation-preference label {
        display: block;
        margin-bottom: 5px; /* Further reduced margin */
        font-weight: bold;
        color: #34495e;
        font-size: 0.8em; /*  REDUCED LABEL FONT SIZE TO 0.8em (H5 equivalent) */
    }

    #preferencesPopup .popup-designation-preference select {
        width: 100%;
        padding: 6px; /* Further reduced padding */
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 12px; /* Further reduced select font size */
        color: #2c3e50;
        background-color: white;
    }

    #preferencesPopup .popup-title h2 {
        font-size: 20px; /* Further reduced popup title font size */
        margin-bottom: 10px; /* Further reduced margin */
    }

    #preferencesPopup .popup-designation-preference {
        margin-bottom: 20px; /* Increase margin between designations */
        padding: 15px; /* Add padding inside each designation box */
        border: 1px solid #ddd; /* Add a border to visually separate designations */
        border-radius: 8px; /* Keep border-radius consistent */
        background-color: #f9f9f9; /* Keep background color, or adjust if needed */
    }

    #preferencesPopup .popup-designation-preference:last-child {
        margin-bottom: 0; /* Remove margin from the last designation */
    }

    #preferencesPopup .popup-designation-preference label {
        display: block;
        margin-bottom: 8px; /* Slightly more space below labels */
        font-weight: bold;
        color: #34495e;
        font-size: 1.1em; /* Slightly larger label font */
    }

    #preferencesPopup .popup-designation-preference select {
        width: 100%;
        padding: 10px; /* Slightly larger padding in dropdowns */
        border: 1px solid #ccc; /* Slightly darker border for dropdowns */
        border-radius: 4px;
        font-size: 14px;
        color: #2c3e50;
        background-color: white;
    }

    #preferencesPopup .popup-title h2 {
        font-size: 26px; /* Slightly larger popup title */
        margin-bottom: 15px; /* More space below title */
    }


    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <h2>Sistema de Escala</h2>
        </div>
        <nav>
            <ul class="nav-list">
                </ul>
        </nav>
    </div>

    <main class="content">
        <style>
            .week-info {
                margin-bottom: 20px;
                padding: 15px;
                background-color: #f8f9fa;
                border-radius: 4px;
                border: 1px solid #e9ecef;
            }
            .week-info p {
                margin: 0;
                color: #2c3e50;
                font-size: 16px;
                text-align: center;
                line-height: 1.5em;
            }
        </style>

        <div class="card">
            <h1>Iniciar Fluxo Semanal</h1>
            <div class="week-info">
                <p id="weekDisplay">Carregando informações da semana...</p>
            </div>
            <form id="fluxoSemanalForm">
                <input type="hidden" id="semanaNumero" name="semanaNumero">
                <div class="form-group">
                    <label for="mes">Mês:</label>
                    <select id="mes" name="mes" required>
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tipo">Tipo de Reunião:</label>
                    <select id="tipo" name="tipo" required>
                        <option value="normal">Normal</option>
                        <option value="memorial">Memorial</option>
                        <option value="assembleia">Assembleia</option>
                        <option value="congresso">Congresso</option>
                        <option value="visita-servo">Visita do Servo</option>
                        <option value="evento-especial">Evento Especial</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Com Grupo?</label>
                    <div class="checkbox-group" id="nacionalidades">
                        <!-- Nacionalidades will be loaded here -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="sala">Sala:</label>
                    <select id="sala" name="sala" required>
                        <option value="salao-principal" selected>Salão Principal</option>
                        <option value="segunda-sala">Segunda Sala</option>
                        <option value="terceira-sala">Terceira Sala</option>
                    </select>
                </div>
                <button type="button" class="btn-submit" id="btnSeguinte">Seguinte</button>

                <div id="designacoesSection" class="designacoes-section">
                    <h4>Designações</h4>
                    <div id="designacoesList">
                        <!-- Designações will be loaded here -->
                    </div>
                    <div id="turboButtonContainer" class="turbo-button-container">
                        <button id="turboButton" class="turbo-button" type="button" title="Preencher Participantes Automaticamente" style="color: #2ecc71;">
                            <i class="fas fa-rocket"></i>
                        </button>
                        <button id="estatisticasButton" class="turbo-button" title="Estatísticas (Futuro)" style="color: #3498db;">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        <button id="pesquisarButton" class="turbo-button" title="Pesquisar (Futuro)" style="color: #f39c12;">
                            <i class="fas fa-search"></i>
                        </button>
                        <button id="perfilButton" class="turbo-button" title="Perfil do Participante (Futuro)" style="color: #9b59b6;">
                            <i class="fas fa-user"></i>
                        </button>
                        <button id="filterButton" class="turbo-button" type="button" title="Filtrar por Preferências" style="color: #e67e22;">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                </div>

                <div id="leituraBibliaSection" class="designacoes-section">
                    <h4>Leitura da Bíblia - Participantes</h4>
                    <div id="leituraBibliaDesignationContainer">
                        <!-- Participant selections for Leitura da Bíblia will load here -->
                    </div>
                </div>

                <div id="activeDesignationsContainer">
                    <!-- Active designation participant selections will be loaded here -->
                </div>

                <button type="submit" class="btn-submit" style="margin-top: 20px;">Iniciar Fluxo</button>
            </form>
        </div>

        <!-- Confirmation Popup Overlay -->
        <div id="confirmationPopup" class="popup-overlay">
            <div class="popup-content">
                <div class="popup-header">
                    <div class="popup-title">
                        <h2>Criar Fluxo Semanal</h2>
                        <i class="fas fa-cog status-icon thinking"></i>
                        <i class="fas fa-check-circle status-icon success"></i>
                    </div>
                    <button class="popup-close-button" id="closePopup">×</button>
                </div>
                <div class="popup-body">
                    <div id="popupDesignationSummary" class="popup-designation-list">
                        <!-- Designation summary will be loaded here -->
                    </div>
                </div>
                <div class="popup-actions">
                    <button class="btn-submit" id="createFluxoSemanal">Criar Fluxo Semanal</button>
                </div>
            </div>
        </div>

        <!-- Preferences Popup Overlay -->
        <div id="preferencesPopup" class="popup-overlay">
            <div class="popup-content">
                <div class="popup-header">
                    <div class="popup-title">
                        <h2>Preferências de Filtro</h2>
                    </div>
                    <button class="popup-close-button" id="closePreferencesPopup">×</button>
                </div>
                <div class="popup-body">
                    <div id="popupPreferencesList" class="popup-designation-list">
                        <!-- Designation preferences dropdowns will be loaded here -->
                    </div>
                </div>
                <div class="popup-actions">
                    <button class="btn-submit" id="applyPreferencesFilters">Aplicar Filtros</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyD1fkxq6USO5RX22TlsPQFEaVSZoTj_t2A",
                authDomain: "escalas-6e0f9.firebaseapp.com",
                projectId: "escalas-6e0f9",
                storageBucket: "escalas-6e0f9.firebasestorage.app",
                messagingSenderId: "19118998563",
                appId: "1:19118998563:web:5412be658ae34bd45add96"
            };
    
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();
    
            // Set current month as default
            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('mes').value = currentMonth;
    
    
            // Load nacionalidades from Firebase
            const loadNacionalidades = async () => {
                const nacionalidadesRef = db.collection('nacionalidades');
                const snapshot = await nacionalidadesRef.get();
                const nacionalidadesDiv = document.getElementById('nacionalidades');
    
                nacionalidadesDiv.innerHTML = ''; // Clear existing checkboxes
                snapshot.forEach(doc => {
                    const nacionalidade = doc.data();
                    const label = document.createElement('label');
                    label.className = 'checkbox-item';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = 'nacionalidades';
                    input.value = nacionalidade.nome;
                    if (nacionalidade.nome === 'Portugal') {
                        input.checked = true;
                    }
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(nacionalidade.nome));
                    nacionalidadesDiv.appendChild(label);
                });
            };
    
            // Call loadNacionalidades when page loads
            loadNacionalidades();
    
    
            const reIndexOrderNumbers = () => {
                const designacaoItems = document.querySelectorAll('#designacoesList .designacao-item');
                let currentOrder = 1;
                let orderedDesignations = [];
    
                // Collect ordered designations
                designacaoItems.forEach(item => {
                    const orderButton = item.querySelector('.order-button');
                    const order = parseInt(orderButton.dataset.order) || 0;
                    if (order > 0) {
                        orderedDesignations.push({ item: item, order: order });
                    }
                });
    
                // Sort ordered designations by their current order
                orderedDesignations.sort((a, b) => a.order - b.order);
    
                // Re-index and update display
                orderedDesignations.forEach(orderedDesignation => {
                    const orderButton = orderedDesignation.item.querySelector('.order-button');
                    orderButton.dataset.order = currentOrder;
                    orderButton.textContent = currentOrder;
    
                    orderButton.classList.remove('ordered', 'ordered-level-2', 'ordered-level-3');
                    orderButton.classList.add('ordered');
                    if (currentOrder >= 2) orderButton.classList.add('ordered-level-2');
                    if (currentOrder >= 3) orderButton.classList.add('ordered-level-3');
    
                    currentOrder++;
                });
            };
    
    
            const removeActiveDesignationDisplay = (designacaoId) => {
                const displayToRemove = document.getElementById(`active-designation-${designacaoId}`);
                if (displayToRemove) {
                    displayToRemove.remove();
                }
            };
    
    
            const loadPeopleOptionsIntoSelects = async (designacao, container, preferences = {}, diasSemana, diaSemanaReuniaoString) => {
    console.log("[loadPeopleOptionsIntoSelects] START - Designation:", designacao.nome, ", Preferences:", preferences); // **LOG START**
    try {
        const pessoasRef = db.collection('pessoas');
        const preferenceForDesignation = preferences[designacao.id]; 
        let query = pessoasRef
            .where('fazDesignacoesReuniao', '==', true)
            .where('designacoesReuniao', 'array-contains', designacao.nome);

        if (preferenceForDesignation === 'Masculino') {
            query = query.where('genero', '==', 'Masculino');
        } else if (preferenceForDesignation === 'Feminino') {
            query = query.where('genero', '==', 'Feminino');
        }

        if (designacao.feitoPor === 'Masculino' || designacao.feitoPor === 'Feminino') {
            query = query.where('genero', '==', designacao.feitoPor);
        }

        const selectedLanguages = Array.from(document.querySelectorAll('#nacionalidades input[name="nacionalidades"]:checked'))
            .map(checkbox => checkbox.value);

        query.get().then(snapshot => { 
            container.querySelectorAll('.designacao-instance-container').forEach((instanceContainer, instanceIndex) => {
                instanceContainer.querySelectorAll('.form-select').forEach((participantSelect, participantIndex) => { 
                    participantSelect.innerHTML = '<option value="">Selecione uma pessoa</option>';
                    if (designacao.numeroParticipantes > 1 && participantIndex === 0) { 
                        query = query.where('personalidade', '==', '+ à vontade');
                    }

                    snapshot.forEach(async doc => { 
                        const pessoa = doc.data();
                        let isAbsent = false;
                        const designationDateFormatted = getMeetingDayOfMonth(diasSemana, diaSemanaReuniaoString); 
                        if (designationDateFormatted) { 
                            if (pessoa.ausencias && Array.isArray(pessoa.ausencias)) {
                                isAbsent = pessoa.ausencias.includes(designationDateFormatted);
                            }
                        }

                        const temPrivilegiosNecessarios = designacao.quemFaz.some(privilegio => pessoa.privilegios && pessoa.privilegios.includes(privilegio));

                        let languageMatches = true;
                        if (selectedLanguages.length > 0) {
                            languageMatches = selectedLanguages.includes(pessoa.idioma);
                        }

                        if (languageMatches && temPrivilegiosNecessarios && !isAbsent) { 
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = pessoa.nomePessoa;
                            participantSelect.appendChild(option);
                        }
                    });
                }); 
            });
            console.log("[loadPeopleOptionsIntoSelects] END - Designation:", designacao.nome); // **LOG END**
        });

    } catch (error) {
        console.error('Erro ao carregar pessoas elegíveis:', error);
        console.log("[loadPeopleOptionsIntoSelects] ERROR - Designation:", designacao.nome, ", Error:", error); // **LOG ERROR**
    }
};
    
    
            const getAnoPainelFirebase = async () => {
                const painelAnoRef = db.collection('painel').doc('ano');
                const doc = await painelAnoRef.get();
                if (doc.exists) {
                    return doc.data().ano;
                } else {
                    return new Date().getFullYear();
                }
            };
    
            const countHistoricoSemanas = async (ano, mes) => {
                const historicoRef = db.collection('historico');
                const querySnapshot = await historicoRef
                    .where("ano", "==", ano)
                    .where("mes", "==", parseInt(mes))
                    .get();
                return querySnapshot.size;
            };
    
            const getDiasSemana = (ano, mes, semanaNumero) => {
                const primeiroDiaMes = new Date(ano, mes - 1, 1);
                let diaSemanaPrimeiroDia = primeiroDiaMes.getDay();
                if (diaSemanaPrimeiroDia === 0) diaSemanaPrimeiroDia = 7;
    
                let diasToAddForFirstMonday = 0;
                if (diaSemanaPrimeiroDia !== 1) {
                    diasToAddForFirstMonday = (8 - diaSemanaPrimeiroDia) % 7;
                }
    
                const primeiroSegundaMes = new Date(ano, mes - 1, 1 + diasToAddForFirstMonday);
                const inicioSemanaDate = new Date(ano, mes - 1, primeiroSegundaMes.getDate() + (semanaNumero - 1) * 7);
                const fimSemanaDate = new Date(ano, mes - 1, primeiroSegundaMes.getDate() + (semanaNumero - 1) * 7 + 6);
    
                const formatarData = (date) => {
                    return date.getDate();
                };
    
                const formatarMes = (date) => {
                    const monthNames = ["Jan", "Fev", "Mar", "Abr", "Maio", "Jun", "Jul", "Ago, Set, Out, Nov, Dez"];
                    return monthNames[date.getMonth()];
                };
    
                const inicio_dia = formatarData(inicioSemanaDate);
                const fim_dia = formatarData(fimSemanaDate);
                const inicio_mes = formatarMes(inicioSemanaDate);
                const fim_mes = formatarMes(fimSemanaDate);
    
                let diasSemanaString;
                if (inicioSemanaDate.getMonth() !== fimSemanaDate.getMonth()) {
                    diasSemanaString = `${inicio_dia} ${inicio_mes} - ${fim_dia} ${fim_mes}`;
                } else {
                    diasSemanaString = `${inicio_dia} - ${fim_dia} ${inicio_mes}`;
                }
                return diasSemanaString;
            };
    
    
            const getTotalSemanasNoMes = async (ano, mes) => {
                let countWeeks = 0;
                let currentDay = new Date(ano, mes - 1, 1);
                const lastDayOfMonth = new Date(ano, mes, 0);
    
                while (currentDay <= lastDayOfMonth) {
                    if (currentDay.getDay() === 1) {
                        countWeeks++;
                    }
                    currentDay.setDate(currentDay.getDate() + 1);
                }
                return countWeeks;
            };
    
    
            const updateWeekDisplay = async () => {
                const mesSelecionado = document.getElementById('mes').value;
                const anoFirebase = await getAnoPainelFirebase();
                const semanaNumero = await countHistoricoSemanas(anoFirebase, mesSelecionado) + 1;
                const totalSemanas = await getTotalSemanasNoMes(anoFirebase, mesSelecionado);
                const diasSemana = getDiasSemana(anoFirebase, mesSelecionado, semanaNumero);
    
                // Update the hidden input field
                document.getElementById('semanaNumero').value = semanaNumero;
    
                const weekDisplayText = `${semanaNumero}ª semana de ${totalSemanas} semanas <br>(${diasSemana})`;
                document.getElementById('weekDisplay').innerHTML = weekDisplayText;
            };
    
    
            // Call updateWeekDisplay initially and when month changes
            updateWeekDisplay();
            document.getElementById('mes').addEventListener('change', updateWeekDisplay);
    
    
            // Handle "Seguinte" button click
            document.getElementById('btnSeguinte').addEventListener('click', async function() {
                const designacoesSection = document.getElementById('designacoesSection');
                const leituraBibliaSection = document.getElementById('leituraBibliaSection'); // Get Leitura Bíblia section
                const iniciarFluxoButton = document.querySelector('#fluxoSemanalForm button[type="submit"].btn-submit'); // Get Iniciar Fluxo button
    
    
                designacoesSection.classList.add('active');
                leituraBibliaSection.style.display = 'block'; // Show Leitura Bíblia section
                iniciarFluxoButton.style.display = 'block'; // Show Iniciar Fluxo button
                await loadDesignacoes();
                designacoesSection.scrollIntoView({ behavior: 'smooth' });
            });
    
    
            const activeDesignationsDisplay = {};
    
    
            // --- Nova Função: getEligiblePeopleForDropdown (já existente - manter) ---
            const getEligiblePeopleForDropdown = (dropdown) => {
                const peopleIds = [];
                const options = dropdown.querySelectorAll('option');
                options.forEach(option => {
                    if (option.value && option.value !== "") {
                        peopleIds.push(option.value);
                    }
                });
                return peopleIds;
            };
    
    
            // --- Função rankPeopleByDesignationCount - IMPLEMENTAÇÃO COMPLETA (já existente - manter) ---
            const rankPeopleByDesignationCount = async (eligiblePeopleIds, designationName, ano) => {
                const historicoRef = db.collection('historico');
                const historicoQuery = historicoRef
                    .where("ano", "==", ano)
                    .where("quando", "==", "Semana"); // Assumindo "Escola" = "Semana" - VERIFICAR SE É SEMPRE ASSIM
    
                const historicoSnapshot = await historicoQuery.get();
                const designationCounts = {}; // Contador geral e específico por pessoa
    
                // Inicializar contadores para todas as pessoas elegíveis
                eligiblePeopleIds.forEach(personId => {
                    designationCounts[personId] = { total: 0, specific: 0 };
                });
    
                historicoSnapshot.forEach(doc => {
                    const historicoData = doc.data();
                    historicoData.designacoes.forEach(designacaoHistorico => {
                        designacaoHistorico.participantes.forEach(participanteId => {
                            if (eligiblePeopleIds.includes(participanteId)) {
                                designationCounts[participanteId].total++;
                                if (designacaoHistorico.designacaoId === getDesignationIdByName(designationName)) { // Comparar designacaoId
                                    designationCounts[participanteId].specific++;
                                }
                            }
                        });
                    });
                });
    
    
                // Função para obter o ID da designação pelo nome (necessário para comparação) (já existente - manter)
                function getDesignationIdByName(designationName) {
                    const designacoesListElements = document.querySelectorAll('#designacoesList .designacao-item');
                    for (const item of designacoesListElements) {
                        const labelSpan = item.querySelector('label > span');
                        if (labelSpan && labelSpan.textContent === designationName) {
                            return item.dataset.designacaoId;
                        }
                    }
                    return null; // Retorna null se não encontrar
                }
    
    
                // Converter o objeto designationCounts para array para poder ordenar (já existente - manter)
                const rankedPeopleArray = eligiblePeopleIds.map(personId => ({
                    personId: personId,
                    totalDesignations: designationCounts[personId].total,
                    specificDesignations: designationCounts[personId].specific
                }));
    
                // Ordenar primeiro por designações totais (ascendente) e depois por designações específicas (ascendente) (já existente - manter)
                rankedPeopleArray.sort((a, b) => {
                    if (a.totalDesignations !== b.totalDesignations) {
                        return a.totalDesignations - b.totalDesignations; // Menos designações totais primeiro
                    } else {
                        return a.specificDesignations - b.specificDesignations; // Menos designações específicas em caso de empate
                    }
                });
    
                const rankedPeopleIds = rankedPeopleArray.map(item => item.personId);
                return rankedPeopleIds;
            };
    
    
    
            // --- Função autoFillDesignations - MODIFICADA para regra de unicidade (já existente - MODIFICADA) ---
            const autoFillDesignations = async () => {
                const activeDesignationContainers = document.querySelectorAll('#activeDesignationsContainer .active-designation-container, #leituraBibliaDesignationContainer .active-designation-container');
                const ano = await getAnoPainelFirebase(); // Obter o ano para filtrar o histórico
    
                for (const designationContainer of activeDesignationContainers) {
                    const designacaoId = designationContainer.dataset.designacaoId;
                    const designacaoDoc = await db.collection('designacoes').doc(designacaoId).get();
                    const designacaoData = designacaoDoc.data();
                    const designationName = designacaoData.nome;
    
                    const instances = designationContainer.querySelectorAll('.designacao-instance-container');
    
                    for (let instanceIndex = 0; instanceIndex < instances.length; instanceIndex++) {
                        const instanceContainer = instances[instanceIndex];
                        const participantSelects = instanceContainer.querySelectorAll('.form-select');
                        const assignedPeopleInInstance = new Set(); // Manter pessoas já assignadas nesta instância
    
                        for (const select of participantSelects) {
                            let eligiblePeopleIds = getEligiblePeopleForDropdown(select);
                            // Filtrar pessoas já assignadas nesta instância
                            eligiblePeopleIds = eligiblePeopleIds.filter(personId => !assignedPeopleInInstance.has(personId));
    
                            if (eligiblePeopleIds.length > 0) {
                                const rankedPeopleIds = await rankPeopleByDesignationCount(eligiblePeopleIds, designationName, ano); // Passa o ano agora
                                let bestPersonId = null;
    
                                // Escolher a melhor pessoa que ainda não foi assignada nesta instância
                                for (const personId of rankedPeopleIds) {
                                    if (!assignedPeopleInInstance.has(personId)) {
                                        bestPersonId = personId;
                                        break; // Pega a primeira pessoa disponível e sai do loop
                                    }
                                }
    
                                if (bestPersonId) {
                                    select.value = bestPersonId;
                                    assignedPeopleInInstance.add(bestPersonId); // Adiciona à lista de assignados
                                } else {
                                    console.warn(`autoFillDesignations - Nenhuma pessoa ranqueada e única disponível para designação: ${designationName}, dropdown.`);
                                }
                            } else {
                                console.warn(`autoFillDesignations - Nenhuma pessoa elegível no dropdown para designação: ${designationName}, dropdown.`);
                            }
                        }
                    }
                };
            };
    
    
            // --- Modificar Evento do Botão Turbo (já existente - manter) - REMOVENDO POPUP ---
            document.getElementById('turboButton').addEventListener('click', async function() {
                const rocketButton = this;
                rocketButton.classList.add('loading');
                
                try {
                    await autoFillDesignations();
                } finally {
                    rocketButton.classList.remove('loading');
                    rocketButton.classList.add('returning');
                    
                    // Remove the 'returning' class after animation completes
                    setTimeout(() => {
                        rocketButton.classList.remove('returning');
                    }, 1000);
                }
            });
    
    
            // **MODIFIED: Evento de clique dos botões de ordenar (já existente - manter)**
            document.querySelectorAll('#designacoesList').forEach(designacoesList => {
                designacoesList.addEventListener('click', async function(event) {
                    if (event.target.classList.contains('order-button')) {
                        const orderButton = event.target;
                        const designacaoItem = orderButton.closest('.designacao-item');
                        const designacaoId = designacaoItem.dataset.designacaoId;
                        const quantitySubmenu = designacaoItem.querySelector('.quantity-submenu');
                        let nextOrderNumber = getNextOrderNumber();
                        const leituraBibliaSection = document.getElementById('leituraBibliaSection'); // Get Leitura Bíblia section
    
                        let currentOrderValue = parseInt(orderButton.dataset.order) || 0;
                        let currentQuantity = parseInt(orderButton.dataset.quantity) || 0;
    
                        if (currentOrderValue === 0) {
                            currentOrderValue = nextOrderNumber;
                            if (currentQuantity === 0) {
                                currentQuantity = 1;
                                orderButton.dataset.quantity = currentQuantity;
                                updateQuantitySubmenuSelection(quantitySubmenu, currentQuantity);
                            }
                        } else {
                            currentOrderValue = 0;
                            currentQuantity = 0;
                            orderButton.dataset.quantity = currentQuantity;
                            updateQuantitySubmenuSelection(quantitySubmenu, currentQuantity);
                            removeActiveDesignationDisplay(designacaoId);
                            removeLeituraBibliaDisplay(designacaoId); // Ensure removal from Leitura Bíblia section
                            if (designacaoItem.querySelector('label > span').textContent === 'Leitura da Bíblia') {
                                leituraBibliaSection.style.display = 'none'; // Hide Leitura Bíblia Section if un-ordering Leitura Bíblia
                            }
                        }
    
                        orderButton.dataset.order = currentOrderValue;
                        orderButton.textContent = currentOrderValue > 0 ? currentOrderValue : '';
    
                        updateOrderButtonClasses(orderButton, currentOrderValue);
                        reIndexOrderNumbers();
                        quantitySubmenu.classList.toggle('active', currentOrderValue > 0);
    
                        // ** UPDATED:  Immediately update participant display after order change (já existente - manter)**
                        try {
                            const designacaoDoc = await db.collection('designacoes').doc(designacaoId).get();
                            if (designacaoDoc.exists) {
                                const designacaoData = designacaoDoc.data();
                                const designacaoInfo = {
                                    id: designacaoId,
                                    ordem: currentOrderValue,
                                    quantidade: currentQuantity,
                                    numeroParticipantes: designacaoData.numeroParticipantes,
                                    quemFaz: designacaoData.quemFaz,
                                    feitoPor: designacaoData.feitoPor,
                                    nome: designacaoData.nome
                                };
                                const diasSemanaDisplay = document.getElementById('weekDisplay').innerHTML; // Get diasSemana again
                                const diasSemanaMatch = diasSemanaDisplay.match(/\((.*?)\)/);
                                const diasSemana = diasSemanaMatch ? diasSemanaMatch[1] : null;
    
                                const horariosData = await getHorariosFromFirebase(await getAnoPainelFirebase()); // Fetch horariosData
                                const diaSemanaReuniaoString = horariosData['dia-semana']; // Get diaSemanaReuniaoString
    
                                updateActiveDesignationDisplay(designacaoInfo, currentOrderValue, currentQuantity, {}, diasSemana, diaSemanaReuniaoString, temporaryPreferences); // Call update display and pass diasSemana and diaSemanaReuniaoString
                                 if (designacaoInfo.nome === 'Leitura da Bíblia' && currentOrderValue > 0) {
                                    leituraBibliaSection.style.display = 'block'; // Ensure section is visible when ordering Leitura Bíblia
                                }
                            }
                        } catch (error) {
                            console.error('Erro ao buscar detalhes da designação:', error);
                        }
                    }
                });
            });
    
    
            // Funções auxiliares para o evento de clique dos botões de ordenar (para manter o código mais organizado) (já existente - manter)
            const getNextOrderNumber = () => {
                const designacaoItems = document.querySelectorAll('#designacoesList .designacao-item');
                let maxOrder = 0;
                designacaoItems.forEach(item => {
                    const orderButton = item.querySelector('.order-button');
                    const order = parseInt(orderButton.dataset.order) || 0;
                    maxOrder = Math.max(maxOrder, order);
                });
                return maxOrder + 1;
            };
    
            const updateQuantitySubmenuSelection = (quantitySubmenu, quantity) => {
                quantitySubmenu.querySelectorAll('.quantity-button').forEach(btn => {
                    if (parseInt(btn.dataset.quantityValue) === quantity) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            };
    
            const updateOrderButtonClasses = (orderButton, orderValue) => {
                orderButton.classList.remove('ordered', 'ordered-level-2', 'ordered-level-3');
                if (orderValue > 0) {
                    orderButton.classList.add('ordered');
                    if (orderValue >= 2) orderButton.classList.add('ordered-level-2');
                    if (orderValue >= 3) orderButton.classList.add('ordered-level-3');
                }
            };
    
    
            // **MODIFIED: Evento de submit do formulário "Iniciar Fluxo" - REMOVED POPUP on submit, keeping for summary (já existente - manter)**
            document.getElementById('fluxoSemanalForm').addEventListener('submit', async function(e) {
                e.preventDefault();
    
                // Prepare summary content
                const summaryHTML = await generatePopupSummary();
                document.getElementById('popupDesignationSummary').innerHTML = summaryHTML;
    
                // Show the popup
                document.getElementById('confirmationPopup').style.display = 'flex';
            });
    
            // Function to generate the summary HTML for the popup (já existente - manter)
            const generatePopupSummary = async () => {
                let summaryHTML = '';
                const activeDesignationContainers = document.querySelectorAll('#activeDesignationsContainer .active-designation-container, #leituraBibliaDesignationContainer .active-designation-container');
    
                for (const designationContainer of activeDesignationContainers) {
                    const designacaoId = designationContainer.dataset.designacaoId;
                    const designacaoDoc = await db.collection('designacoes').doc(designacaoId).get();
                    const designacaoData = designacaoDoc.data();
                    const instances = designationContainer.querySelectorAll('.designacao-instance-container');
    
                    summaryHTML += `<div class="popup-designation-item">`;
                    summaryHTML += `<h4 class="popup-designacao-name">${designacaoData.nome}</h4>`;
    
                    for (let instanceIndex = 0; instanceIndex < instances.length; instanceIndex++) {
                        const instanceContainer = instances[instanceIndex];
                        const participantSelects = instanceContainer.querySelectorAll('.form-select');
                        let instanceSummary = `<ul class="popup-participant-list">`;
    
                        for (const select of participantSelects) { // Changed forEach to for...of for await
                            const selectedPersonId = select.value;
                            if (selectedPersonId) {
                                try {
                                    const personDoc = await db.collection('pessoas').doc(selectedPersonId).get(); // Added await
                                    if (personDoc.exists) {
                                        const personData = personDoc.data();
                                        instanceSummary += `<li class="popup-participant-item">${personData.nomePessoa}</li>`;
                                    } else {
                                        instanceSummary += `<li class="popup-participant-item">Pessoa não encontrada</li>`;
                                    }
                                } catch (error) {
                                    instanceSummary += `<li class=\"popup-participant-item\">Erro ao carregar participante</li>`;
                                }
                            } else {
                                instanceSummary += `<li class=\"popup-participant-item\">Não selecionado</li>`;
                            }
                        }
                        instanceSummary += `</ul>`;
                        if (instances.length > 1) {
                            summaryHTML += `<h5>Designação ${instanceIndex + 1}</h5>`;
                        }
                        summaryHTML += instanceSummary;
                    }
                    summaryHTML += `</div>`;
                }
                return summaryHTML;
            };
    
    
            // Close popup event (já existente - manter)
            document.getElementById('closePopup').addEventListener('click', function() {
                document.getElementById('confirmationPopup').style.display = 'none';
            });
    
            // "Criar Fluxo Semanal" button event (já existente - manter)
            document.getElementById('createFluxoSemanal').addEventListener('click', async function() {
                const titleElement = document.querySelector('.popup-title');
                const thinkingIcon = titleElement.querySelector('.thinking');
                const successIcon = titleElement.querySelector('.success');
    
                // Show thinking icon
                thinkingIcon.style.display = 'inline-block';
                successIcon.style.display = 'none';
    
                try {
                    // Get current year and month (já existente - manter)
                    const ano = await getAnoPainelFirebase();
                    const mes = parseInt(document.getElementById('mes').value); // **LINHA CORRIGIDA - PARÊNTESE ADICIONADO**
                    const semanaNumero = parseInt(document.getElementById('semanaNumero').value);
    
                    // Get form values for Tipo, Idioma and Sala (já existente - manter)
                    const tipoReuniao = document.getElementById('tipo').value;
                    const idiomasSelecionados = Array.from(document.querySelectorAll('#nacionalidades input[name="nacionalidades"]:checked'))
                        .map(checkbox => checkbox.value);
                    const salaSelecionada = document.getElementById('sala').value;
    
                    // --- Get diasSemanaString in correct format from updateWeekDisplay (já existente - manter) ---
                    const diasSemana = getDiasSemana(ano, mes, semanaNumero); // Re-calculate diasSemana to ensure correct format
    
    
                    // --- Fetch horarios from Firebase (já existente - manter) ---
                    const horariosData = await getHorariosFromFirebase(ano);
                    const diaSemanaReuniaoString = horariosData['dia-semana']; // Get dia-semana from Firebase
                    const horaSemana = horariosData['hora-semana']; // Get hora-semana from Firebase
    
    
                    // Calculate meeting day of month (já existente - manter)
                    const meetingDayOfMonth = getMeetingDayOfMonth(diasSemana, diaSemanaReuniaoString);
    
    
                    // Prepare historico data (já existente - manter)
                    const historicoData = {
                        ano: ano,
                        mes: mes,
                        semanaNumero: semanaNumero,
                        designacoes: [],
                        tipo: tipoReuniao,
                        idioma: idiomasSelecionados,
                        sala: salaSelecionada,
                        dia: meetingDayOfMonth,
                        hora: horaSemana,
                        quando: "Semana", // ADICIONADO CAMPO "quando" com valor "Semana"
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() // ADICIONADO CAMPO TIMESTAMP
                    };
    
    
                    // Collect all designations (já existente - manter)
                    const activeDesignationContainers = document.querySelectorAll('#activeDesignationsContainer .active-designation-container, #leituraBibliaDesignationContainer .active-designation-container');
    
                    for (const designationContainer of activeDesignationContainers) {
                        const designacaoId = designationContainer.dataset.designacaoId;
                        const instances = designationContainer.querySelectorAll('.designacao-instance-container');
    
                        for (let instanceIndex = 0; instanceIndex < instances.length; instanceIndex++) {
                            const instanceContainer = instances[instanceIndex];
                            const participantSelects = instanceContainer.querySelectorAll('.form-select');
    
                            const participantes = [];
                            for (const select of participantSelects) {
                                if (select.value) {
                                    participantes.push(select.value);
                                }
                            }
    
                            if (participantes.length > 0) {
                                historicoData.designacoes.push({
                                    designacaoId: designacaoId,
                                    instanceIndex: instanceIndex,
                                    participantes: participantes
                                });
                            }
                        }
                    }
    
                    const docRef = await db.collection("historico").add(historicoData);
    
                    // Show success icon (já existente - manter)
                    thinkingIcon.style.display = 'none';
                    successIcon.style.display = 'inline-block';
    
                    // Wait 2 segundos then refresh (já existente - manter)
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
    
                } catch (error) {
                    console.error("Erro ao adicionar documento: ", error);
                    // Hide both icons in case of error (já existente - manter)
                    thinkingIcon.style.display = 'none';
                    successIcon.style.display = 'none';
                    alert('Erro ao criar fluxo semanal: ' + error.message);
                }
            });
    
    
            // --- Helper function to get day of week number (Sunday: 0, Monday: 1, ..., Saturday: 6) (já existente - manter) ---
            function getDayOfWeekNumber(dayOfWeekString) {
                const daysOfWeek = {
                    'domingo': 0, 'segunda': 1, 'terça': 2, 'quarta': 3, 'quinta': 4, 'sexta': 5, 'sábado': 6,
                    'domingo-feira': 0, 'segunda-feira': 1, 'terça-feira': 2, 'quarta-feira': 3, 'quinta-feira': 4, 'sexta-feira': 5, 'sábado-feira': 6
                };
                const normalizedDayOfWeekString = dayOfWeekString.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); // Normalize and remove accents
                return daysOfWeek[normalizedDayOfWeekString] !== undefined ? daysOfWeek[normalizedDayOfWeekString] : null;
            }
    
    
            // --- Helper function to get meeting day of month (NOW RETURNS YYYY-MM-DD DATE) (já existente - manter) ---
            function getMeetingDayOfMonth(diasSemanaString, diaSemanaReuniao) { // REMOVE diaSemanaReuniaoString parameter
    
    
                if (!diasSemanaString || !diaSemanaReuniao) {
                    return null;
                }
    
                const parts = diasSemanaString.split(" - ");
                if (parts.length !== 2) {
                    return null;
                }
                const startDay = parseInt(parts[0]);
                const endPart = parts[1].split(" ");
                if (endPart.length !== 2) {
                    return null;
                }
                const endDay = parseInt(endPart[0]);
                let startMonthStr = parts[0].split(" ")[1] || ""; // Extract start month string ("Mar")
                const endMonthStr = endPart[1]; // End month string ("Abr")
    
                const monthNames = ["Jan", "Fev", "Mar", "Abr", "Maio", "Jun", "Jul", "Ago", "Set, Out, Nov, Dez"];
                let startMonthIndex = monthNames.indexOf(startMonthStr); // Month index for start month
                const endMonthIndex = monthNames.indexOf(endMonthStr);     // Month index for end month
    
                // **CORRECTION: Use endMonthIndex as fallback for startMonthIndex if startMonthStr is empty** (já existente - manter)
                if (startMonthIndex === -1) {
                    startMonthIndex = endMonthIndex; // Use end month if start month is missing
                }
                if (startMonthIndex === -1) { // Double check if even endMonthIndex is invalid (já existente - manter)
                    return null;
                }
                if (endMonthIndex === -1) {
                    return null;
                }
    
    
                const dayOfWeekMeetingNumber = getDayOfWeekNumber(diaSemanaReuniao);
                if (dayOfWeekMeetingNumber === null) {
                    return null;
                }
    
                const currentYear = new Date().getFullYear(); // Get current year once (já existente - manter)
                const startOfWeekDate = new Date(currentYear, startMonthIndex, startDay);
                const endOfWeekDate = new Date(currentYear, endMonthIndex, endDay);
    
    
                let designationDateYYYYMMDD = null; // Variable to store formatted date (já existente - manter)
                let middleDayOfMonth = null;
                let currentDay = new Date(startOfWeekDate);
                let loopCounter = 0;
    
                for (let i = 0; currentDay <= endOfWeekDate; i++) {
                    loopCounter++;
    
    
                    if (currentDay.getDay() === dayOfWeekMeetingNumber) {
                        middleDayOfMonth = currentDay.getDate();
    
    
                        // **FORMAT DATE AS YYYY-MM-DD - START** (já existente - manter)
                        const month = String(currentDay.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
                        const day = String(middleDayOfMonth).padStart(2, '0');
                        designationDateYYYYMMDD = `${currentYear}-${month}-${day}`;
                        // **FORMAT DATE AS YYYY-MM-DD - END** (já existente - manter)
    
    
                        break;
                    }
                    currentDay.setDate(currentDay.getDate() + 1);
                }
    
                return designationDateYYYYMMDD; // Return the formatted date string or null (já existente - manter)
            }
    
    
    
            const loadDesignacoes = async () => { // (já existente - manter)
                const designacoesRef = db.collection('designacoes');
                const query = designacoesRef
                    .where('tipo', '==', 'reuniao')
                    .where('quando', '==', 'Semana');
                const snapshot = await query.get();
                const designacoesList = document.getElementById('designacoesList');
                designacoesList.innerHTML = '';
                let nextOrderNumber = 1;
                let leituraBibliaDesignacao = null; // To store Leitura da Bíblia data
    
                const horariosData = await getHorariosFromFirebase(await getAnoPainelFirebase()); // Fetch horariosData here
                const diaSemanaReuniaoString = horariosData['dia-semana']; // Get diaSemanaReuniaoString
    
                const diasSemanaDisplay = document.getElementById('weekDisplay').innerHTML; // Get diasSemana
                const diasSemanaMatch = diasSemanaDisplay.match(/\((.*?)\)/);
                const diasSemana = diasSemanaMatch ? diasSemanaMatch[1] : null;
    
    
                for (const doc of snapshot.docs) { // Use for...of loop for synchronous processing
                    const designacao = doc.data();
                    const div = document.createElement('div');
                    div.className = 'designacao-item';
                    div.dataset.designacaoId = doc.id;
    
                    // Create order button
                    const orderButton = document.createElement('button');
                    orderButton.type = 'button'; // Explicitly set type="button" - IMPORTANT
                    orderButton.className = 'order-button';
                    let designationOrder = 0;
                    let designationQuantity = 0;
                    if (designacao.nome === 'Leitura da Bíblia') {
                        designationOrder = nextOrderNumber++;
                        designationQuantity = 1;
                        leituraBibliaDesignacao = { ...designacao, id: doc.id, ordem: designationOrder, quantidade: designationQuantity }; // Store Leitura da Bíblia data and default order/quantity
                    }
                    orderButton.dataset.order = designationOrder;
                    orderButton.dataset.quantity = designationQuantity;
                    orderButton.textContent = designationOrder > 0 ? designationOrder : '';
    
                    if (designationOrder > 0) {
                        orderButton.classList.add('ordered');
                        if (designationOrder >= 2) orderButton.classList.add('ordered-level-2');
                        if (designationOrder >= 3) orderButton.classList.add('ordered-level-3');
                    }
    
                    // Create label
                    const label = document.createElement('label');
                    label.setAttribute('for', doc.id);
                    label.style.marginBottom = '0';
                    label.style.flexGrow = '1';
                    label.style.display = 'flex';
    
                    label.appendChild(orderButton);
                    const textSpan = document.createElement('span');
                    textSpan.textContent = designacao.nome;
                    label.appendChild(textSpan);
    
                    div.appendChild(label);
    
                    // Create quantity submenu
                    const quantitySubmenu = createQuantitySubmenu(doc.id, designationQuantity, orderButton); // Helper function to create submenu
                    div.appendChild(quantitySubmenu);
    
                    designacoesList.appendChild(div);
                }
    
                // After loading all designations, if Leitura da Bíblia was found and ordered, display it
                if (leituraBibliaDesignacao) { // Check if leituraBibliaDesignacao is not null
                    updateLeituraBibliaDisplay(leituraBibliaDesignacao, leituraBibliaDesignacao.ordem, leituraBibliaDesignacao.quantidade, {}, diasSemana, diaSemanaReuniaoString); // pass diaSemanaReuniaoString here
                }
            };
    
    
            const createQuantitySubmenu = (designacaoId, designationQuantity, orderButton) => { // (já existente - manter)
                const quantitySubmenu = document.createElement('div');
                quantitySubmenu.className = 'quantity-submenu';
                quantitySubmenu.dataset.designacaoId = designacaoId;
                for (let i = 1; i <= 7; i++) {
                    const quantityButton = document.createElement('button');
                    quantityButton.className = 'quantity-button';
                    quantityButton.textContent = i;
                    quantityButton.dataset.quantityValue = i;
                    if (i === designationQuantity) {
                        quantityButton.classList.add('selected');
                    }
                    quantityButton.addEventListener('click', async (e) => { // ADDED ASYNC
                        e.preventDefault(); // ADDED preventDefault - IMPORTANT
                        e.stopPropagation(); // Ensure event propagation is stopped - CHECK THIS LINE
    
    
                        const selectedQuantity = parseInt(quantityButton.dataset.quantityValue);
                        orderButton.dataset.quantity = selectedQuantity;
    
                        quantitySubmenu.querySelectorAll('.quantity-button').forEach(btn => btn.classList.remove('selected'));
                        quantityButton.classList.add('selected');
                        quantitySubmenu.classList.remove('active');
    
                        // **--- FIX: Call updateActiveDesignationDisplay here ---**
                        const designacaoIdForUpdate = quantitySubmenu.dataset.designacaoId;
                        try {
                            const designacaoDoc = await db.collection('designacoes').doc(designacaoIdForUpdate).get();
                            if (designacaoDoc.exists) {
                                const designacaoData = designacaoDoc.data();
                                // Initialize temporaryPreferences for each instance
                                for (let i = 1; i <= selectedQuantity; i++) {
                                    const instanceKey = `participantes-${designacaoIdForUpdate}-${i}`;
                                    if (!temporaryPreferences[instanceKey]) {
                                        temporaryPreferences[instanceKey] = designacaoData.numeroParticipantes || 1;
                                    }
                                }
                                const designacaoInfo = {
                                    id: designacaoIdForUpdate,
                                    ordem: parseInt(orderButton.dataset.order) || 0, // Get current order
                                    quantidade: selectedQuantity,
                                    numeroParticipantes: designacaoData.numeroParticipantes,
                                    quemFaz: designacaoData.quemFaz,
                                    feitoPor: designacaoData.feitoPor,
                                    nome: designacaoData.nome
                                };
                                const diasSemanaDisplay = document.getElementById('weekDisplay').innerHTML; // Get diasSemana again
                                const diasSemanaMatch = diasSemanaDisplay.match(/\((.*?)\)/);
                                const diasSemana = diasSemanaMatch ? diasSemanaMatch[1] : null;
                                const horariosData = await getHorariosFromFirebase(await getAnoPainelFirebase()); // Fetch horariosData
                                const diaSemanaReuniaoString = horariosData['dia-semana']; // Get diaSemanaReuniaoString
                                updateActiveDesignationDisplay(designacaoInfo, designacaoInfo.ordem, selectedQuantity, {}, diasSemana, diaSemanaReuniaoString, temporaryPreferences); // **Pass temporaryPreferences here**
                            }
                        } catch (error) {
                            console.error('Erro ao buscar detalhes da designação para atualizar display:', error);
                        }
                    });
                    quantitySubmenu.appendChild(quantityButton);
                }
                return quantitySubmenu;
            };
    
    
            const updateActiveDesignationDisplay = async (designacao, order, quantity, instancePreferences = {}, diasSemana, diaSemanaReuniaoString, temporaryPreferences = {}) => {
    const designacaoId = designacao.id;
    const isLeituraBiblia = designacao.nome === 'Leitura da Bíblia';
    const containerToUse = isLeituraBiblia ? document.getElementById('leituraBibliaDesignationContainer') : document.getElementById('activeDesignationsContainer');
    const existingDisplay = containerToUse.querySelector(`#active-designation-${designacaoId}`);

    if (quantity <= 0) {
        if (existingDisplay) {
            existingDisplay.remove();
        }
        return;
    }

    let designationDisplayContainer;
    if (existingDisplay) {
        designationDisplayContainer = existingDisplay;
        designationDisplayContainer.innerHTML = '';
    } else {
        designationDisplayContainer = document.createElement('div');
        designationDisplayContainer.id = `active-designation-${designacaoId}`;
        designationDisplayContainer.className = 'active-designation-container';
        designationDisplayContainer.style.marginTop = '20px';
        designationDisplayContainer.style.padding = '15px';
        designationDisplayContainer.style.backgroundColor = '#f8f9fa';
        designationDisplayContainer.style.borderRadius = '8px';
        designationDisplayContainer.dataset.designacaoId = designacao.id;
    }

    for (let designacaoInstance = 1; designacaoInstance <= quantity; designacaoInstance++) {
        const designacaoInstanceContainer = document.createElement('div');
        designacaoInstanceContainer.className = 'designacao-instance-container';
        designacaoInstanceContainer.style.marginBottom = '20px';

        const title = document.createElement('h5');
        let designacaoNome = designacao.nome || designacaoId;
        let tituloText = `Participantes para designação ${designacaoNome}`;
        if (quantity > 1) {
            tituloText = `Participantes para designação ${designacaoNome} (${designacaoInstance})`;
        }
        title.textContent = tituloText;
        title.style.marginBottom = '10px';
        designacaoInstanceContainer.appendChild(title);

        let numeroParticipantesDynamic = 1; // Default to 1
        const instanceKey = `participantes-${designacaoId}-${designacaoInstance}`;
        if (temporaryPreferences[instanceKey]) {
            numeroParticipantesDynamic = parseInt(temporaryPreferences[instanceKey]);
        } else if (instancePreferences && instancePreferences.numeroParticipantes && designacaoInstance === 1) {
            numeroParticipantesDynamic = parseInt(instancePreferences.numeroParticipantes);
        } else if (designacao.numeroParticipantes && designacaoInstance === 1) {
            numeroParticipantesDynamic = parseInt(designacao.numeroParticipantes);
        }

        const participantRoles = [];
        if (numeroParticipantesDynamic === 1) {
            participantRoles.push("Dirigente");
        } else if (numeroParticipantesDynamic === 2) {
            participantRoles.push("Dirigente", "Morador");
        } else if (numeroParticipantesDynamic === 3) {
            participantRoles.push("Dirigente", "Morador", "Ajudante");
        }


        for (let i = 0; i < numeroParticipantesDynamic; i++) {
            const roleLabel = document.createElement('span');
            roleLabel.textContent = (numeroParticipantesDynamic > 1) ? participantRoles[i] : `Participante`;
            roleLabel.style.fontSize = '0.9em';
            roleLabel.style.color = '#777';
            roleLabel.style.display = 'block';
            roleLabel.style.marginBottom = '3px';
            designacaoInstanceContainer.appendChild(roleLabel);

            const participantSelect = document.createElement('select');
            participantSelect.id = `participant-${designacaoId}-${designacaoInstance}-${i}`;
            participantSelect.className = 'form-select';
            participantSelect.style.marginBottom = '10px';
            participantSelect.style.width = '100%';
            participantSelect.style.padding = '8px';
            participantSelect.innerHTML = '<option value="">Selecione uma pessoa</option>';
            designacaoInstanceContainer.appendChild(participantSelect);
        }
        designationDisplayContainer.appendChild(designacaoInstanceContainer);
    }

    // **MODIFIED: AWAIT loadPeopleOptionsIntoSelects - RETURN the promise from loadPeopleOptionsIntoSelects**
    await loadPeopleOptionsIntoSelects(designacao, designationDisplayContainer, { [designacaoId]: instancePreferences.preferenciaGenero }, diasSemana, diaSemanaReuniaoString); 
    containerToUse.appendChild(designationDisplayContainer);
};
    
    
            const updateLeituraBibliaDisplay = async (designacao, order, quantity, preferences = {}, diasSemana, diaSemanaReuniaoString) => { // ADD diaSemanaReuniaoString parameter
                updateActiveDesignationDisplay(designacao, order, quantity, preferences, diasSemana, diaSemanaReuniaoString, temporaryPreferences); // Reuse updateActiveDesignationDisplay for Leitura Bíblia, pass diaSemanaReuniaoString and temporaryPreferences
            };
    
            const removeLeituraBibliaDisplay = (designacaoId) => { // (já existente - manter)
                const displayToRemove = document.getElementById('leituraBibliaDesignationContainer').querySelector(`#active-designation-${designacaoId}`);
                if (displayToRemove) {
                    displayToRemove.remove();
                }
            };
    
    
            // Evento para fechar submenu de quantidade (keep as is) (já existente - manter)
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.designacao-item')) {
                    document.querySelectorAll('.quantity-submenu.active').forEach(submenu => {
                        submenu.classList.remove('active');
                    });
                }
            });
    
            // --- Fetch horarios from Firebase (já existente - manter) ---
            async function getHorariosFromFirebase(ano) {
                try {
                    const horariosRef = db.collection('horarios');
                    const querySnapshot = await horariosRef
                        .where('ano', '==', ano)
                        .limit(1) // Assuming only one document per year
                        .get();
    
                    if (!querySnapshot.empty) {
                        const doc = querySnapshot.docs[0];
                        const data = doc.data();
                        return data;
                    } else {
                        return { 'dia-semana': null, 'hora-semana': null }; // Return default or null values if not found
                    }
                } catch (error) {
                    return { 'dia-semana': null, 'hora-semana': null }; // Return default or null values in case of error
                }
            }
    
            let temporaryPreferences = {}; // Objeto para guardar as preferências temporárias
    
    
         // Function to open the preferences popup and populate it with dropdowns
            const openPreferencesPopup = async () => {
                const preferencesPopup = document.getElementById('preferencesPopup');
                const preferencesPopupList = document.getElementById('popupPreferencesList');
    
                // Clear any existing content in the popup list before adding new preferences
                preferencesPopupList.innerHTML = '';
    
                // Get all ordered designation items
                const orderedDesignationItems = document.querySelectorAll('#designacoesList .designacao-item');
    
                for (const item of orderedDesignationItems) {
                    const designacaoId = item.dataset.designacaoId;
                    const orderButton = item.querySelector('.order-button');
                    const quantity = parseInt(orderButton.dataset.quantity) || 0; // Get quantity instead of order
                    const designationName = item.querySelector('label > span').textContent; // Get designation name
    
                    if (quantity > 0) { // Check quantity instead of order
                        
                        // **FETCH DESIGNACAO DOCUMENT FROM FIREBASE**
                        const designacaoDoc = await db.collection('designacoes').doc(designacaoId).get();
                        const designacaoData = designacaoDoc.data();
                        let firebasePreference = designacaoData.preferencia; // Get preferencia from Firebase
                        let firebaseNumeroParticipantes = designacaoData.numeroParticipantes; // Get numeroParticipantes from Firebase
    
    
                        // Loop through instances based on quantity
                        for (let instanceIndex = 1; instanceIndex <= quantity; instanceIndex++) { // Loop for quantity
                            const preferenceDiv = document.createElement('div');
                            preferenceDiv.className = 'popup-designation-preference';
                            preferenceDiv.dataset.designacaoId = designacaoId;
                            preferenceDiv.dataset.instanceIndex = instanceIndex; // Store instance index
    
                            // **PREFERENCE DROPDOWN - GENDER**
                            const labelPreferencia = document.createElement('label');
                            labelPreferencia.setAttribute('for', `preferencia-${designacaoId}-${instanceIndex}`); // Unique ID for each instance
                            let labelTextPreferencia = `Preferência para ${designationName}`; // Base label text
                            if (quantity > 1) {
                                labelTextPreferencia += ` (${instanceIndex})`; // Add instance number if quantity > 1
                            }
                            labelPreferencia.textContent = labelTextPreferencia + ":"; // Set label text
                            preferenceDiv.appendChild(labelPreferencia);
    
                            const selectPreferencia = document.createElement('select');
                            selectPreferencia.id = `preferencia-${designacaoId}-${instanceIndex}`; // Unique ID for each instance
                            selectPreferencia.name = `preferencia-${designacaoId}-${instanceIndex}`; // Unique name for each instance
    
                            // **REDUCED GENDER OPTIONS LIST**
                            const optionsPreferencia = [
                                { value: 'Masculino Feminino', text: 'Masculino Feminino' },
                                { value: 'Masculino', text: 'Masculino' },
                                { value: 'Feminino', text: 'Feminino' }
                            ];
                            optionsPreferencia.forEach(option => {
                                const optionElement = document.createElement('option');
                                optionElement.value = option.value;
                                optionElement.textContent = option.text;
                                selectPreferencia.appendChild(optionElement);
                            });
                            preferenceDiv.appendChild(selectPreferencia);
    
    
                            // --- SELECT GENDER OPTION ---
                            let defaultOptionValue = 'Masculino Feminino'; // Default value if no Firebase preference or invalid preference
    
                            // **CHECK TEMPORARY PREFERENCES FIRST - GENDER**
                            const tempPreferenceKey = `preferencia-${designacaoId}-${instanceIndex}`; // Unique key for gender preference
                            if (temporaryPreferences[tempPreferenceKey]) {
                                defaultOptionValue = temporaryPreferences[tempPreferenceKey]; // Use temporary preference if available
                            } else if (firebasePreference === 'Masculino' || firebasePreference === 'Feminino' || firebasePreference === 'Masculino Feminino') {
                                defaultOptionValue = firebasePreference; // Fallback to Firebase preference if no temporary preference
                            }
                            selectPreferencia.value = defaultOptionValue; // Set default value
    
    
                            // **NUMBER OF PARTICIPANTS DROPDOWN**
                            const labelParticipantes = document.createElement('label');
                            labelParticipantes.setAttribute('for', `participantes-${designacaoId}-${instanceIndex}`);
                            labelParticipantes.textContent = `Número de Participantes:`;
                            preferenceDiv.appendChild(labelParticipantes);
    
                            const selectParticipantes = document.createElement('select');
                            selectParticipantes.id = `participantes-${designacaoId}-${instanceIndex}`;
                            selectParticipantes.name = `participantes-${designacaoId}-${instanceIndex}`;
                            const optionsParticipantes = [
                                { value: '1', text: '1' },
                                { value: '2', text: '2' },
                                { value: '3', text: '3' }
                            ];
                            optionsParticipantes.forEach(option => {
                                const optionElement = document.createElement('option');
                                optionElement.value = option.value;
                                optionElement.textContent = option.text;
                                selectParticipantes.appendChild(optionElement);
                            });
                            preferenceDiv.appendChild(selectParticipantes);
    
    
                            // --- SELECT NUMBER OF PARTICIPANTS OPTION ---
                            let defaultParticipantesValue = '1'; // Default to '1'
                            const tempParticipantesKey = `participantes-${designacaoId}-${instanceIndex}`;
                            if (temporaryPreferences[tempParticipantesKey]) {
                                defaultParticipantesValue = temporaryPreferences[tempParticipantesKey];
                            } else if (firebaseNumeroParticipantes) {
                                defaultParticipantesValue = String(firebaseNumeroParticipantes);
                            }
                             selectParticipantes.value = defaultParticipantesValue; // Set participants default value
    
    
                            preferencesPopupList.appendChild(preferenceDiv);
    
    
                            // **ADD EVENT LISTENER TO STORE TEMPORARY PREFERENCE - GENDER**
                            selectPreferencia.addEventListener('change', function(event) {
                                temporaryPreferences[`preferencia-${designacaoId}-${instanceIndex}`] = event.target.value; // Store preference on change
                            });
    
                            // **ADD EVENT LISTENER TO STORE TEMPORARY PREFERENCE - PARTICIPANTS NUMBER**
                            selectParticipantes.addEventListener('change', function(event) {
                                temporaryPreferences[`participantes-${designacaoId}-${instanceIndex}`] = event.target.value; // Store participants number on change
                                console.log(`[selectParticipantes.onChange] Key: participantes-${designacaoId}-${instanceIndex}, Value: ${event.target.value}`); // LOGGING
                                console.log("[selectParticipantes.onChange] temporaryPreferences object:", JSON.stringify(temporaryPreferences)); // LOGGING the whole object as JSON
                            });
    
                        }
                    }
                }
    
                preferencesPopup.style.display = 'flex';
            };
    
    
            // **ADICIONE ESTA LINHA PARA ASSOCIAR O CLIQUE DO BOTÃO À FUNÇÃO openPreferencesPopup**
            document.getElementById('filterButton').addEventListener('click', openPreferencesPopup);
    
    
            // Event listener for close Preferences Popup button
            document.getElementById('closePreferencesPopup').addEventListener('click', function() {
                document.getElementById('preferencesPopup').style.display = 'none';
            });
    
    
            // Event listener for "Apply Filters" button in preferences popup
            document.getElementById('applyPreferencesFilters').addEventListener('click', async function() {
    const preferencesPopup = document.getElementById('preferencesPopup');
    console.log("Temporary Preferences before applying filters:", temporaryPreferences);

    const orderedDesignationItems = document.querySelectorAll('#designacoesList .designacao-item');
    let updateCallCount = 0; // Initialize a counter

    for (const item of orderedDesignationItems) {
        const designacaoId = item.dataset.designacaoId;
        const orderButton = item.querySelector('.order-button');
        const quantity = parseInt(orderButton.dataset.quantity) || 0;

        if (quantity > 0) {
            for (let instanceIndex = 1; instanceIndex <= quantity; instanceIndex++) {
                const instancePreferences = {
                    preferenciaGenero: temporaryPreferences[`preferencia-${designacaoId}-${instanceIndex}`],
                    numeroParticipantes: temporaryPreferences[`participantes-${designacaoId}-${instanceIndex}`]
                };
                console.log(`Applying filters for Designation ID: ${designacaoId}, Instance: ${instanceIndex}`);
                console.log("Instance Preferences:", instancePreferences);

                const designacaoDoc = await db.collection('designacoes').doc(designacaoId).get();
                if (designacaoDoc.exists) {
                    const designacaoData = designacaoDoc.data();
                    const designacaoInfo = { ...designacaoData, id: designacaoId, ordem: parseInt(orderButton.dataset.order) || 0, quantidade: quantity }; // Include quantity here


                    const diasSemanaDisplay = document.getElementById('weekDisplay').innerHTML;
                    const diasSemanaMatch = diasSemanaDisplay.match(/\((.*?)\)/);
                    const diasSemana = diasSemanaMatch ? diasSemanaMatch[1] : null;
                    const horariosData = await getHorariosFromFirebase(await getAnoPainelFirebase());
                    const diaSemanaReuniaoString = horariosData['dia-semana'];

                    console.log(`[applyPreferencesFilters] Calling updateActiveDesignationDisplay - Call Count: ${++updateCallCount}, Instance: ${instanceIndex}, Designation: ${designacaoInfo.nome}`); // **LOG CALL COUNT**
                    await updateActiveDesignationDisplay(designacaoInfo, designacaoInfo.ordem, quantity, instancePreferences, diasSemana, diaSemanaReuniaoString, temporaryPreferences);
                }
            }
        }
    }

    preferencesPopup.style.display = 'none';
});
    
    
            // Initial load of designacoes
            loadDesignacoes();
        });
    </script>
</body>
</html>
