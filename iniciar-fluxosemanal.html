<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Fluxo - Vida e Ministério</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* ========================================================== */
        /* === ESTILOS GERAIS E NOVOS ESTILOS PARA BOTÕES ========= */
        /* ========================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; display: flex; min-height: 100vh; background-color: #f5f6fa; }
        .sidebar { width: 250px; background-color: #2c3e50; color: white; padding: 20px 0; height: 100vh; position: fixed; }
        .logo { text-align: center; padding: 20px 0; border-bottom: 1px solid #34495e; }
        .nav-list { list-style: none; padding: 20px 0; }
        .nav-item { padding: 10px 20px; }
        .nav-item a { color: white; text-decoration: none; display: flex; align-items: center; }
        .nav-item i { margin-right: 10px; width: 20px; }
        .nav-item:hover { background-color: #34495e; }
        .content { margin-left: 250px; padding: 30px; flex-grow: 1; }
        .card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        h1 { color: #2c3e50; margin-bottom: 30px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #2c3e50; font-weight: bold; }
        .form-group select, .form-group input, .form-select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .checkbox-item input[type="checkbox"] { width: 16px; height: 16px; }
        .btn-submit { background-color: #2ecc71; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; transition: background-color 0.3s ease; }
        .btn-submit:hover { background-color: #27ae60; }
        .week-info { margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef; }
        .week-info p { margin: 0; color: #2c3e50; font-size: 16px; text-align: center; line-height: 1.5em; }
        
        .designacoes-section { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; }
        .designacoes-section.active { display: block; }
        
        .designacao-item { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 6px; padding: 8px 16px; background-color: #f8f9fa; border-radius: 8px; min-height: 32px; position: relative; }
        .designacao-item label { display: flex; align-items: center; width: 100%; font-size: 16px; color: #2c3e50; }
        .designacao-item label > span { flex-grow: 1; margin-left: 8px; }

        .order-button { background-color: #ddd; border: none; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; margin-right: 8px; color: #555; transition: background-color 0.3s ease; }
        .order-button.ordered { background-color: #2ecc71; color: white; }
        .order-button.ordered-level-2 { background-color: #3498db; }
        .order-button.ordered-level-3 { background-color: #f39c12; }
        .order-button.ordered-level-4 { background-color: #9b59b6; }
        .order-button.ordered-level-5 { background-color: #e74c3c; }

        .quantity-submenu { display: none; gap: 5px; margin-top: 5px; position: absolute; bottom: -35px; left: 40px; background: white; padding: 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .quantity-submenu.active { display: flex; }
        .quantity-button { background-color: #f0f0f0; border: none; border-radius: 4px; padding: 5px 8px; cursor: pointer; font-size: 14px; }
        .quantity-button.selected { background-color: #2ecc71; color: white; }
        
        .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
        .popup-content { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); width: 80%; max-width: 500px; position: relative; }
        .popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .popup-title { color: #2c3e50; font-size: 22px; }
        .popup-close-button { background: none; border: none; font-size: 20px; cursor: pointer; color: #777; }
        .popup-actions { text-align: right; margin-top: 20px; }
        #popupSummaryList li { list-style: none; padding: 5px 0; color: #333; }
        
        .filter-icon { position: absolute; bottom: 10px; left: 10px; cursor: pointer; color: #e67e22; font-size: 16px; }
        .lock-icon { position: absolute; bottom: 10px; left: 40px; cursor: pointer; color: #7f8c8d; font-size: 16px; }
        .lock-icon.locked { color: #e67e22; }
        .lupa-icon { position: absolute; bottom: 10px; left: 70px; cursor: pointer; color: #3498db; font-size: 16px; }
        .lab-icon { position: absolute; bottom: 10px; left: 100px; cursor: pointer; color: #9b59b6; font-size: 16px; }
        .filter-popup { display: none; position: absolute; bottom: 40px; left: 0; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; min-width: 200px; }
        .filter-popup.active { display: block; }

        .order-button.ordered-level-5 { background-color: #e74c3c; }
        .order-button.ordered-level-6 { background-color: #c0392b; }
        .order-button.ordered-level-7 { background-color: #a93226; }

        /* ========================================================== */
        /* === ESTILOS PARA OS POPUPS DE ANÁLISE (COPIADOS) ========= */
        /* ========================================================== */
        .estatisticas-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        .estatisticas-table th, .estatisticas-table td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; }
        .estatisticas-table thead th { background-color: #34495e; color: white; }
        .search-suggestions { display: none; position: absolute; border: 1px solid #ddd; border-top: none; background-color: white; width: 100%; max-height: 200px; overflow-y: auto; z-index: 2000; }
        .suggestion-item { padding: 10px; cursor: pointer; } .suggestion-item:hover { background-color: #f1f1f1; }
        .analysis-popup .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .analysis-popup .tab-button { padding: 10px 15px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; border-bottom: 3px solid transparent; }
        .analysis-popup .tab-button.active { border-bottom: 3px solid #3498db; font-weight: bold; }
        .analysis-popup .tab-content { display: none; }
        .analysis-popup .tab-content.active { display: block; }
        .lab-popup .lab-container { display: flex; gap: 30px; }
        .lab-popup .lab-current-selection { flex: 1; }
        .lab-popup .lab-suggestions { flex: 1; border-left: 1px solid #eee; padding-left: 30px; }
        .lab-popup .suggestion-item { padding: 8px; border-radius: 4px; cursor: pointer; margin-bottom: 5px; }
        .lab-popup .suggestion-item:hover { background-color: #f1f1f1; }
        .lab-popup .suggestion-justification { font-size: 0.8em; color: #777; margin-left: 10px; }
.turbo-button-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 10px;
    margin-bottom: 10px;
    padding-right: 10px;
}
.turbo-button {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    transition: color 0.3s ease, transform 0.3s ease;
    margin-left: 15px;
}
.turbo-button:hover {
    transform: scale(1.2);
}

.section-divider {
    border: none;
    border-top: 1px solid #ddd;
    margin-top: 20px;
    margin-bottom: 10px;
}

    </style>
</head>

<body>
    <div id="sidebar-placeholder"></div>

    <main class="content">
        <div class="card">
            <h1>Iniciar Fluxo Semanal</h1>
            <div class="week-info">
                <p id="weekDisplay">Carregando informações da semana...</p>
            </div>
            <form id="fluxoSemanalForm">
                <input type="hidden" id="semanaNumero" name="semanaNumero">
                <div class="form-group">
                    <label for="mes">Mês:</label>
                    <select id="mes" name="mes" required>
                        <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option><option value="4">Abril</option>
                        <option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option>
                        <option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tipo">Tipo de Reunião:</label>
                    <select id="tipo" name="tipo" required>
                        <option value="normal">Normal</option><option value="memorial">Memorial</option><option value="assembleia">Assembleia</option>
                        <option value="congresso">Congresso</option><option value="visita-servo">Visita do Servo</option><option value="evento-especial">Evento Especial</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Com Grupo?</label>
                    <div class="checkbox-group" id="nacionalidades"></div>
                </div>
                <div class="form-group">
                    <label for="sala">Sala:</label>
                    <select id="sala" name="sala" required>
                        <option value="salao-principal" selected>Salão Principal</option>
                        <option value="segunda-sala">Segunda Sala</option>
                        <option value="terceira-sala">Terceira Sala</option>
                    </select>
                </div>
                
                <button type="button" class="btn-submit" id="btnSeguinte">Seguinte</button>

                <div id="designacoesSection" class="designacoes-section">
                    <h4>Designações</h4>
                    <div id="designacoesList"></div>

                    <div id="turboButtonContainer" class="turbo-button-container">
                        <button id="turboButton" class="turbo-button" type="button" title="Preencher Participantes Automaticamente" style="color: #2ecc71;">
                            <i class="fas fa-rocket"></i>
                        </button>
                        <button id="estatisticasButton" class="turbo-button" type="button" title="Estatísticas" style="color: #3498db;">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        <button id="pesquisarButton" class="turbo-button" type="button" title="Pesquisar (Futuro)" style="color: #f39c12;">
                            <i class="fas fa-search"></i>
                        </button>
                        <button id="perfilButton" class="turbo-button" type="button" title="Perfil do Participante" style="color: #9b59b6;">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                    <hr class="section-divider">

                    <div id="activeDesignationsContainer"></div>
                </div>

                <button type="submit" class="btn-submit" style="margin-top: 20px; display: none;">Iniciar Fluxo</button>
            </form>
        </div>

        <div id="confirmationPopup" class="popup-overlay">
            <div class="popup-content">
                <div class="popup-header">
                    <h2 class="popup-title">Criar Fluxo Semanal</h2>
                    <button class="popup-close-button" id="closePopup">×</button>
                </div>
                <div class="popup-body">
                    <ul id="popupSummaryList"></ul>
                </div>
                <div class="popup-actions">
                    <button class="btn-submit" id="createFluxoSemanal">Confirmar e Criar</button>
                </div>
            </div>
        </div>

        <!-- =================================================================== -->
        <!-- ============= INÍCIO: POPUPS ADICIONADOS ========================== -->
        <!-- =================================================================== -->
        
        <!-- POPUP DE PERFIL DO PARTICIPANTE -->
        <div id="perfilPopup" class="popup-overlay">
            <div class="popup-content" style="max-width: 90%; width: 1200px;">
                <div class="popup-header"><h2 class="popup-title">Perfil do Participante</h2><button class="popup-close-button" id="closePerfilPopup">×</button></div>
                <div class="popup-body">
                    <div class="form-group" style="position: relative;">
                        <label for="pesquisaPessoa">Pesquisar Participante:</label>
                        <input type="text" id="pesquisaPessoa" class="form-control" placeholder="Comece a digitar um nome..." autocomplete="off">
                        <div id="pesquisaSugestoes" class="search-suggestions"></div>
                    </div>
                    <div id="perfilTableContainer" style="overflow-x: auto; max-height: 55vh; display: none;">
                        <table class="estatisticas-table">
                            <thead><tr><th>Data</th><th>Designação</th><th>Companheiro(s)</th><th>Meu Papel</th></tr></thead>
                            <tbody id="perfilTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- POPUP DE ANÁLISE DE PAR/TRIO -->
        <div id="pairAnalysisPopup" class="popup-overlay">
            <div class="popup-content analysis-popup" style="max-width: 90%; width: 1200px;">
                <div class="popup-header"><h2 class="popup-title" id="pairAnalysisTitle">Análise de Designação</h2><button class="popup-close-button" id="closePairAnalysisPopup">×</button></div>
                <div class="popup-body">
                    <div id="pairAnalysisTabsContainer" class="tabs"></div>
                    <div id="pairAnalysisContentContainer"></div>
                </div>
            </div>
        </div>

        <!-- POPUP LABORATÓRIO DE COMBINAÇÕES -->
        <div id="labPopup" class="popup-overlay">
            <div class="popup-content lab-popup" style="max-width: 90%; width: 1000px;">
                <div class="popup-header"><h2 class="popup-title">Laboratório de Combinações</h2><button class="popup-close-button" id="closeLabPopup">×</button></div>
                <div class="popup-body">
                    <div class="lab-container">
                        <div class="lab-current-selection" id="labSelectionContainer"></div>
                        <div class="lab-suggestions" id="labSuggestionsContainer"></div>
                    </div>
                    <div class="popup-actions" style="margin-top: 20px;"><button class="btn-submit" id="applyLabChanges">Aplicar Modificação</button></div>
                </div>
            </div>
        </div>
        <!-- =================================================================== -->
        <!-- ============= FIM: POPUPS ADICIONADOS ============================= -->
        <!-- =================================================================== -->

    </main>

  
<script>
    document.addEventListener('DOMContentLoaded', function() {
         // Botão de Perfil (Funcional)
        document.getElementById('perfilButton').addEventListener('click', () => {
            document.getElementById('perfilPopup').style.display = 'flex';
        });

        // Botão de Foguetão (Placeholder)
        document.getElementById('turboButton').addEventListener('click', () => {
            alert('A função de preenchimento automático (Foguetão) será implementada futuramente para esta secção.');
        });
        
        // Botão de Estatísticas (Placeholder)
        document.getElementById('estatisticasButton').addEventListener('click', () => {
            alert('A função de Estatísticas será implementada futuramente para esta secção.');
        });
        
        // Botão de Pesquisa (Placeholder)
        document.getElementById('pesquisarButton').addEventListener('click', () => {
            alert('A função de Pesquisa será implementada futuramente.');
        });

        // ===================================================================
        // ================== CONFIGURAÇÃO E VARIÁVEIS GLOBAIS =================
        // ===================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyD1fkxq6USO5RX22TlsPQFEaVSZoTj_t2A",
            authDomain: "escalas-6e0f9.firebaseapp.com",
            projectId: "escalas-6e0f9",
            storageBucket: "escalas-6e0f9.firebasestorage.app",
            messagingSenderId: "19118998563",
            appId: "1:19118998563:web:5412be658ae34bd45add96"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        document.getElementById('mes').value = new Date().getMonth() + 1;

        let allDesignations = new Map();
        let allPeopleDataMap = new Map();
        let allPeople = [];
        let temporaryPreferences = {};
    
        // ===================================================================
        // =========== FUNÇÕES AUXILIARES DE DATA E FIREBASE ===============
        // ===================================================================
        const getAnoPainelFirebase = async () => {
            const doc = await db.collection('painel').doc('ano').get();
            return doc.exists ? doc.data().ano : new Date().getFullYear();
        };

        const countHistoricoSemanas = async (ano, mes) => {
            const q = await db.collection('historico')
                .where("ano", "==", ano)
                .where("mes", "==", parseInt(mes))
                .where("quando", "==", "Semana")
                .where("parte", "==", "resto da semana")
                .get();
            return q.size;
        };

        const getTotalSemanasNoMes = (ano, mes) => {
            let count = 0, day = new Date(ano, mes - 1, 1);
            while (day.getMonth() === mes - 1) {
                if (day.getDay() === 1) count++;
                day.setDate(day.getDate() + 1);
            }
            return count;
        };

        const getDiasSemana = (ano, mes, semana) => {
            let firstDay = new Date(ano, mes - 1, 1);
            let dayOfWeek = firstDay.getDay();
            let offset = (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
            let firstMonday = new Date(firstDay);
            firstMonday.setDate(firstDay.getDate() - offset);
            let start = new Date(firstMonday);
            start.setDate(firstMonday.getDate() + (semana - 1) * 7);
            let end = new Date(start);
            end.setDate(start.getDate() + 6);
            const months = ["Jan", "Fev", "Mar", "Abr", "Maio", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            return `${start.getDate()} ${months[start.getMonth()]} - ${end.getDate()} ${months[end.getMonth()]}`;
        };

        const getHorariosFromFirebase = async (ano) => {
            const querySnapshot = await db.collection('horarios').where('ano', '==', ano).limit(1).get();
            if (!querySnapshot.empty) return querySnapshot.docs[0].data();
            return { 'dia-semana': 'segunda-feira', 'hora-semana': '19:30' };
        };
        
       const loadPeopleOptionsIntoSelects = async (designacao, container, genderPreference = 'ambos') => {
            try {
                let query = db.collection('pessoas')
                    .where('fazDesignacoesReuniao', '==', true)
                    .where('designacoesReuniao', 'array-contains', designacao.nome);

                if (genderPreference === 'masculino') query = query.where('genero', '==', 'Masculino');
                if (genderPreference === 'feminino') query = query.where('genero', '==', 'Feminino');
                
                const snapshot = await query.get();
                const peopleOptions = snapshot.docs.map(doc => `<option value="${doc.id}">${doc.data().nomePessoa}</option>`).join('');

                container.querySelectorAll('.form-select').forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Selecione...</option>' + peopleOptions;
                    select.value = currentValue;
                });
            } catch (error) {
                console.error('Erro ao carregar pessoas:', error);
            }
        };

        const initializeSystemData = async () => {
            try {
                const [pessoasSnapshot] = await Promise.all([
                    db.collection('pessoas').orderBy('nomePessoa').get(),
                ]);
                allPeople = [];
                allPeopleDataMap.clear();
                pessoasSnapshot.forEach(doc => {
                    const pessoaData = doc.data();
                    allPeople.push({ id: doc.id, nome: pessoaData.nomePessoa });
                    allPeopleDataMap.set(doc.id, { nome: pessoaData.nomePessoa, genero: pessoaData.genero });
                });
                console.log("Dados do sistema (Pessoas) inicializados.");
            } catch (error) {
                console.error("Erro ao inicializar dados do sistema:", error);
            }
        };


        // ===================================================================
        // ==================== LÓGICA PRINCIPAL DA PÁGINA ===================
        // ===================================================================
        const updateWeekDisplay = async () => {
            const weekDisplay = document.getElementById('weekDisplay');
            const btn = document.getElementById('btnSeguinte');
            const mes = document.getElementById('mes').value;
            const ano = await getAnoPainelFirebase();
            const semana = await countHistoricoSemanas(ano, mes) + 1;
            const totalSemanas = getTotalSemanasNoMes(ano, mes);

            if (semana > totalSemanas && totalSemanas > 0) {
                weekDisplay.innerHTML = "Mês completo. Por favor, selecione outro mês.";
                btn.disabled = true;
            } else {
                document.getElementById('semanaNumero').value = semana;
                weekDisplay.innerHTML = `${semana}ª semana de ${totalSemanas} <br>(${getDiasSemana(ano, mes, semana)})`;
                btn.disabled = false;
            }
        };

        const loadNacionalidades = async () => {
            const snapshot = await db.collection('nacionalidades').get();
            const container = document.getElementById('nacionalidades');
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                container.innerHTML += `<label class="checkbox-item"><input type="checkbox" name="nacionalidades" value="${data.nome}" ${data.nome === 'Portugal' ? 'checked' : ''}> ${data.nome}</label>`;
            });
        };

        const loadDesignacoes = async () => {
            const snapshot = await db.collection('designacoes')
                .where('tipo', '==', 'reuniao')
                .where('quando', '==', 'Semana')
                .where('parte', '==', 'resto da semana')
                .orderBy("ordem")
                .get();
            
            const list = document.getElementById('designacoesList');
            list.innerHTML = '';
            
            if (snapshot.empty) {
                list.innerHTML = '<p>Nenhuma designação encontrada.</p>';
                return;
            }

            const designacoesParaAtivar = [];
            snapshot.forEach(doc => {
                const designacao = { id: doc.id, ...doc.data() };
                allDesignations.set(doc.id, designacao);
                designacoesParaAtivar.push(designacao);

                const div = document.createElement('div');
                div.className = 'designacao-item';
                div.dataset.designacaoId = designacao.id;
                div.dataset.firestoreOrder = designacao.ordem;
                
                div.innerHTML = `<label><button type="button" class="order-button" data-order="0" data-quantity="1"></button><span>${designacao.nome}</span></label>`;
                list.appendChild(div);
            });

            for (const [index, designacao] of designacoesParaAtivar.entries()) {
                const order = index + 1;
                const quantity = 1;
                
                const button = list.querySelector(`.designacao-item[data-designacao-id="${designacao.id}"] .order-button`);
                button.dataset.order = order;
                button.dataset.quantity = quantity;
                button.textContent = quantity;
                updateOrderButtonClasses(button, order);
                await updateActiveDesignationDisplay(designacao, order, quantity);
            }
            reIndexOrderNumbers();
        };

        const removeActiveDesignationDisplay = (designacaoId) => {
            const displayToRemove = document.getElementById(`active-designation-${designacaoId}`);
            if (displayToRemove) displayToRemove.remove();
        };

        const updateActiveDesignationDisplay = async (designacao, order, quantity) => {
            console.log(`[DEBUG] Iniciando updateActiveDesignationDisplay para: ${designacao.nome}, Ordem: ${order}, Quantidade: ${quantity}`);

            const containerToUse = document.getElementById('activeDesignationsContainer');
            
            const savedSelections = {};
            let placeholder = null; // Variavel para guardar a posição do card
            const existingCard = document.getElementById(`active-designation-${designacao.id}`);
            
            if (existingCard) {
                console.log(`[DEBUG] Card existente encontrado para ${designacao.nome}. Salvando seleções e posição...`);
                // Salva seleções
                existingCard.querySelectorAll('.active-designation-container').forEach((instance, instanceIndex) => {
                    savedSelections[instanceIndex] = [];
                    instance.querySelectorAll('.form-select').forEach((select, selectIndex) => {
                        if (select.value) {
                            savedSelections[instanceIndex][selectIndex] = select.value;
                            console.log(` -> Salvo: Instância ${instanceIndex}, Campo ${selectIndex}, Valor: ${select.value}`);
                        }
                    });
                });
                
                // Cria e insere o placeholder para manter a ordem
                placeholder = document.createElement('div');
                placeholder.id = `placeholder-${designacao.id}`;
                existingCard.parentNode.insertBefore(placeholder, existingCard);
            }

            removeActiveDesignationDisplay(designacao.id); // Remove o card antigo
            
            if (quantity <= 0) {
                 console.log(`[DEBUG] Quantidade é ${quantity}. Removendo card e encerrando a função.`);
                 // Se havia um placeholder, remove-o também
                 if(placeholder) placeholder.remove();
                 return;
            }

            const mainDisplayContainer = document.createElement('div');
            mainDisplayContainer.id = `active-designation-${designacao.id}`;
            
            for (let i = 1; i <= quantity; i++) {
                const instanceContainer = document.createElement('div');
                instanceContainer.className = 'active-designation-container';
                instanceContainer.style.marginTop = '20px';
                instanceContainer.style.padding = '15px 15px 45px 15px';
                instanceContainer.style.borderRadius = '8px';
                instanceContainer.style.position = 'relative';
                instanceContainer.dataset.designacaoId = designacao.id;
                
                const colors = ['rgba(46, 204, 113, 0.1)', 'rgba(52, 152, 219, 0.1)', 'rgba(243, 156, 18, 0.1)', 'rgba(155, 89, 182, 0.1)', 'rgba(231, 76, 60, 0.1)', 'rgba(192, 57, 43, 0.1)', 'rgba(142, 68, 173, 0.1)'];
                instanceContainer.style.backgroundColor = colors[(order - 1) % colors.length] || '#f8f9fa';
                
                const title = document.createElement('h5');
                title.textContent = `${designacao.nome}` + (quantity > 1 ? ` (${i})` : '');
                instanceContainer.appendChild(title);
                
                const numParticipantes = temporaryPreferences[`participantes-${designacao.id}-${i}`] || designacao.numeroParticipantes || 1;
                console.log(`[DEBUG] Instância ${i-1} de ${designacao.nome}: Número de participantes determinado é: ${numParticipantes}`);

const roles = numParticipantes == 1 ? ["Participante"] : (numParticipantes == 2 ? ["Dirigente", "Ajudante 1"] : ["Dirigente", "Ajudante 1", "Ajudante 2"]);                console.log(`[DEBUG] Roles para ${numParticipantes} participantes:`, roles);
                
                roles.forEach((role, index) => {
                    instanceContainer.innerHTML += `<label style="display: block; font-size: 14px; color: #555; margin-top: 10px;">${role}</label><select id="participant-${designacao.id}-${i}-${index}" class="form-select"><option value="">Selecione...</option></select>`;
                });
                
                // --- Ícones (código completo) ---
                const filterIcon = document.createElement('i');
                filterIcon.className = 'fas fa-filter filter-icon';
                filterIcon.title = 'Filtrar';
                const filterPopup = document.createElement('div');
                filterPopup.className = 'filter-popup';
                filterPopup.innerHTML = `<h4>Filtros</h4><div><label>Nº de Participantes</label><select class="num-participantes-select"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div><div style="margin-top: 15px;"><label>Preferência de Género</label><select class="genero-preferencia-select"><option value="ambos">Masculino/Feminino</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option></select></div>`;
                instanceContainer.appendChild(filterPopup);
                instanceContainer.appendChild(filterIcon);
                const numParticipantesSelect = filterPopup.querySelector('.num-participantes-select');
                const generoPreferenciaSelect = filterPopup.querySelector('.genero-preferencia-select');
                numParticipantesSelect.value = temporaryPreferences[`participantes-${designacao.id}-${i}`] || designacao.numeroParticipantes || 1;
                generoPreferenciaSelect.value = designacao.feitoPor ? designacao.feitoPor.toLowerCase() : 'ambos';
                filterIcon.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.filter-popup.active').forEach(p => { if (p !== filterPopup) p.classList.remove('active'); }); filterPopup.classList.toggle('active'); });
                numParticipantesSelect.addEventListener('change', (e) => { console.log(`[EVENT] Nº de Participantes alterado para: ${e.target.value} para ${designacao.nome}`); temporaryPreferences[`participantes-${designacao.id}-${i}`] = e.target.value; updateActiveDesignationDisplay(designacao, order, quantity); filterPopup.classList.remove('active'); });
                generoPreferenciaSelect.addEventListener('change', (e) => { loadPeopleOptionsIntoSelects(designacao, instanceContainer, e.target.value); filterPopup.classList.remove('active'); });
                const lockIcon = document.createElement('i');
                lockIcon.className = 'fas fa-lock-open lock-icon';
                lockIcon.title = 'Bloquear/Desbloquear';
                lockIcon.addEventListener('click', (e) => { const isLocked = instanceContainer.dataset.locked === 'true'; instanceContainer.dataset.locked = !isLocked; e.target.classList.toggle('fa-lock-open', isLocked); e.target.classList.toggle('fa-lock', !isLocked); e.target.classList.toggle('locked', !isLocked); });
                instanceContainer.appendChild(lockIcon);
                const lupaIcon = document.createElement('i');
                lupaIcon.className = 'fas fa-search-plus lupa-icon';
                lupaIcon.title = 'Analisar Histórico';
                lupaIcon.addEventListener('click', () => { const selected = Array.from(instanceContainer.querySelectorAll('.form-select')).map(s => ({ id: s.value, name: s.options[s.selectedIndex].text })).filter(p => p.id); if (selected.length === 1) { loadParticipantProfile(selected[0].id); document.getElementById('perfilPopup').style.display = 'flex'; } else if (selected.length > 1) { openPairAnalysisPopup(selected); } else { alert("Selecione pelo menos um participante."); } });
                instanceContainer.appendChild(lupaIcon);
                const labIcon = document.createElement('i');
                labIcon.className = 'fas fa-flask lab-icon';
                labIcon.title = 'Laboratório de Combinações';
                labIcon.addEventListener('click', () => { alert("Laboratório de Combinações (Funcionalidade Futura)"); });
                instanceContainer.appendChild(labIcon);

                mainDisplayContainer.appendChild(instanceContainer);
            }
            
            // Inserção do card na posição correta
            if (placeholder) {
                console.log(`[DEBUG] Substituindo placeholder para manter a ordem de ${designacao.nome}.`);
                placeholder.parentNode.replaceChild(mainDisplayContainer, placeholder);
            } else {
                console.log(`[DEBUG] Adicionando novo card para ${designacao.nome} no final.`);
                containerToUse.appendChild(mainDisplayContainer);
            }

            await loadPeopleOptionsIntoSelects(designacao, mainDisplayContainer);

            // Bloco para restaurar as seleções salvas
            console.log(`[DEBUG] Restaurando seleções para ${designacao.nome}...`);
            mainDisplayContainer.querySelectorAll('.active-designation-container').forEach((instance, instanceIndex) => {
                if (savedSelections[instanceIndex]) {
                    instance.querySelectorAll('.form-select').forEach((select, selectIndex) => {
                        const savedValue = savedSelections[instanceIndex][selectIndex];
                        if (savedValue) {
                            select.value = savedValue;
                            console.log(` -> Restaurado: Instância ${instanceIndex}, Campo ${selectIndex}, Valor: ${savedValue}`);
                        }
                    });
                }
            });
            console.log(`[DEBUG] Fim de updateActiveDesignationDisplay para: ${designacao.nome}.`);
        };
        
        const updateOrderButtonClasses = (button, order) => {
            button.className = 'order-button';
            if (order > 0) {
                button.classList.add('ordered');
                if (order >= 2) button.classList.add('ordered-level-2');
                if (order >= 3) button.classList.add('ordered-level-3');
                if (order >= 4) button.classList.add('ordered-level-4');
                if (order >= 5) button.classList.add('ordered-level-5');
                if (order >= 6) button.classList.add('ordered-level-6');
                if (order >= 7) button.classList.add('ordered-level-7');
            }
        };

        const getNextOrderNumber = () => {
            return document.querySelectorAll('#designacoesList .order-button.ordered').length + 1;
        };
        
        const reIndexOrderNumbers = () => {
            const activeItems = [];
            document.querySelectorAll('#designacoesList .designacao-item').forEach(item => {
                const button = item.querySelector('.order-button');
                const displayOrder = parseInt(button.dataset.order) || 0;
                
                if (displayOrder > 0) {
                    activeItems.push({
                        itemElement: item,
                        firestoreOrder: parseInt(item.dataset.firestoreOrder) || 999 
                    });
                }
            });

            activeItems.sort((a, b) => a.firestoreOrder - b.firestoreOrder);
            
            const container = document.getElementById('activeDesignationsContainer');
            const fragment = document.createDocumentFragment();
            activeItems.forEach(sortedItem => {
                const designacaoId = sortedItem.itemElement.dataset.designacaoId;
                const card = container.querySelector(`#active-designation-${designacaoId}`);
                if (card) {
                    fragment.appendChild(card);
                }
            });

            container.innerHTML = '';
            container.appendChild(fragment);

            activeItems.forEach((sortedItem, index) => {
                const newDisplayOrder = index + 1;
                const button = sortedItem.itemElement.querySelector('.order-button');
                
                button.dataset.order = newDisplayOrder; 
                
                updateOrderButtonClasses(button, newDisplayOrder);

                const designacaoId = sortedItem.itemElement.dataset.designacaoId;
                const card = container.querySelector(`#active-designation-${designacaoId}`);
                if (card) {
                    const colors = ['rgba(46, 204, 113, 0.1)', 'rgba(52, 152, 219, 0.1)', 'rgba(243, 156, 18, 0.1)', 'rgba(155, 89, 182, 0.1)', 'rgba(231, 76, 60, 0.1)', 'rgba(192, 57, 43, 0.1)', 'rgba(142, 68, 173, 0.1)'];
                    card.querySelectorAll('.active-designation-container').forEach(instance => {
                        instance.style.backgroundColor = colors[newDisplayOrder - 1] || '#f8f9fa';
                    });
                }
            });
        };

        const createQuantitySubmenu = (designacaoId, orderButton) => {
            const submenu = document.createElement('div');
            submenu.className = 'quantity-submenu';
            for (let i = 1; i <= 5; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'quantity-button';
                btn.textContent = i;
                btn.dataset.quantityValue = i;
                if (i === (parseInt(orderButton.dataset.quantity) || 1)) btn.classList.add('selected');
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const newQuantity = parseInt(e.target.dataset.quantityValue);
                    let order = parseInt(orderButton.dataset.order) || 0;
                    if (order === 0) {
                        order = getNextOrderNumber();
                        orderButton.dataset.order = order;
                    }
                    orderButton.dataset.quantity = newQuantity;
                    orderButton.textContent = newQuantity;
                    submenu.querySelectorAll('.quantity-button').forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                    updateOrderButtonClasses(orderButton, order);
                    await updateActiveDesignationDisplay(allDesignations.get(designacaoId), order, newQuantity);
                    submenu.classList.remove('active');
                    reIndexOrderNumbers();
                });
                submenu.appendChild(btn);
            }
            return submenu;
        };
        
        // ===================================================================
        // =========== LÓGICA PARA OS POPUPS DE ANÁLISE =======================
        // ===================================================================
        const formatDateForDisplay = (dateString) => {
            if (!dateString) return 'N/A';
            const [ano, mes, dia] = dateString.split('-');
            return `${dia}/${mes}/${ano}`;
        };

        const buildHistoryTable = (records, titleText, isPairAnalysis = false) => {
            const container = document.createElement('div');
            container.innerHTML = `<h3>${titleText}</h3>`;
            if (!records || records.length === 0) {
                container.innerHTML += '<p>Nenhum histórico encontrado.</p>';
                return container;
            }
            const table = document.createElement('table');
            table.className = 'estatisticas-table';
            table.innerHTML = `<thead><tr><th>Data</th><th>Designação</th><th>${isPairAnalysis ? 'Papéis' : 'Companheiros'}</th></tr></thead>`;
            const tbody = document.createElement('tbody');
            records.forEach(rec => {
                const tr = document.createElement('tr');
                let rolesHtml = 'N/A';
                if (rec.papeis) {
                    rolesHtml = Object.entries(rec.papeis)
                        .map(([role, personId]) => `<li><strong>${role}:</strong> ${(allPeopleDataMap.get(personId) || {}).nome || 'N/A'}</li>`)
                        .join('');
                    rolesHtml = `<ul style="padding-left: 15px; margin: 0;">${rolesHtml}</ul>`;
                }
                tr.innerHTML = `<td>${formatDateForDisplay(rec.dia)}</td><td>${rec.designacaoNome}</td><td>${isPairAnalysis ? rolesHtml : (rec.companheiros || 'Nenhum')}</td>`;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            container.appendChild(table);
            return container;
        };

        const fetchIndividualHistory = async (personId) => {
            const snapshot = await db.collection('historico').orderBy("dia", "desc").get();
            let records = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                data.designacoes?.forEach(d => {
                    const allIds = Object.values(d.participantes || {});
                    if (allIds.includes(personId)) {
                        records.push({
                            dia: data.dia,
                            designacaoNome: allDesignations.get(d.designacaoId)?.nome || 'Desconhecida',
                            companheiros: allIds.filter(id => id !== personId).map(id => (allPeopleDataMap.get(id) || {}).nome || '?').join(', ')
                        });
                    }
                });
            });
            return records;
        };

        const loadParticipantProfile = async (personId) => {
            const container = document.getElementById('perfilTableContainer');
            container.style.display = 'block';
            container.innerHTML = 'A carregar...';
            const history = await fetchIndividualHistory(personId);
            container.innerHTML = '';
            container.appendChild(buildHistoryTable(history, `Histórico de ${(allPeopleDataMap.get(personId) || {}).nome}`));
        };
        
        const fetchPairHistory = async (participantIds) => {
            const snapshot = await db.collection('historico').orderBy("dia", "desc").get();
            let records = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                data.designacoes?.forEach(d => {
                    const allIds = Object.values(d.participantes || {});
                    if (participantIds.every(id => allIds.includes(id))) {
                        records.push({
                            dia: data.dia,
                            designacaoNome: allDesignations.get(d.designacaoId)?.nome || 'Desconhecida',
                            papeis: d.participantes
                        });
                    }
                });
            });
            return records;
        };

        const openPairAnalysisPopup = async (participants) => {
            const popup = document.getElementById('pairAnalysisPopup');
            const title = document.getElementById('pairAnalysisTitle');
            const tabsContainer = document.getElementById('pairAnalysisTabsContainer');
            const contentContainer = document.getElementById('pairAnalysisContentContainer');
            
            title.textContent = `Análise de: ${participants.map(p => p.name).join(' & ')}`;
            popup.style.display = 'flex';
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';

            const pairHistory = await fetchPairHistory(participants.map(p => p.id));
            
            tabsContainer.innerHTML = `<button class="tab-button active" data-target="#content-history">Histórico do Par</button>`;
            contentContainer.innerHTML = `<div id="content-history" class="tab-content active"></div>`;
            document.getElementById('content-history').appendChild(buildHistoryTable(pairHistory, "Colaborações Anteriores", true));
        };

        document.getElementById('closePerfilPopup').addEventListener('click', () => document.getElementById('perfilPopup').style.display = 'none');
        document.getElementById('closePairAnalysisPopup').addEventListener('click', () => document.getElementById('pairAnalysisPopup').style.display = 'none');
        document.getElementById('closeLabPopup').addEventListener('click', () => document.getElementById('labPopup').style.display = 'none');

        // ===================================================================
        // ====================== EVENT LISTENERS ============================
        // ===================================================================
        
        document.getElementById('btnSeguinte').addEventListener('click', async function() {
            document.getElementById('designacoesSection').classList.add('active');
            document.querySelector('#fluxoSemanalForm button[type="submit"]').style.display = 'block';
            const spacer = document.createElement('div');
            spacer.id = 'temp-scroll-spacer';
            spacer.style.height = '100vh';
            document.querySelector('.card').insertAdjacentElement('afterend', spacer);
            document.getElementById('designacoesList').scrollIntoView({ behavior: 'smooth', block: 'center' });
            await loadDesignacoes();
            document.getElementById('temp-scroll-spacer')?.remove();
        });

        document.getElementById('designacoesList').addEventListener('click', async function(event) {
            const orderButton = event.target.closest('.order-button');
            if (!orderButton) return;

            const designacaoItem = orderButton.closest('.designacao-item');
            const designacaoId = designacaoItem.dataset.designacaoId;
            let currentOrder = parseInt(orderButton.dataset.order) || 0;
            let quantitySubmenu = designacaoItem.querySelector('.quantity-submenu');

            if (!quantitySubmenu) {
                quantitySubmenu = createQuantitySubmenu(designacaoId, orderButton);
                designacaoItem.appendChild(quantitySubmenu);
            }

            if (currentOrder > 0) {
                orderButton.dataset.order = 0;
                orderButton.textContent = '';
                orderButton.className = 'order-button';
                removeActiveDesignationDisplay(designacaoId);
                quantitySubmenu.classList.remove('active');
                reIndexOrderNumbers();
            } else {
                quantitySubmenu.classList.toggle('active');
            }
        });

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.designacao-item')) {
                document.querySelectorAll('.quantity-submenu.active').forEach(submenu => {
                    submenu.classList.remove('active');
                });
            }
        });

        // ===================================================================
        // ====================== INICIALIZAÇÃO DA PÁGINA ====================
        // ===================================================================
        updateWeekDisplay();
        loadNacionalidades();
        initializeSystemData();
        
        fetch('slidebar.html').then(response => response.text()).then(html => document.getElementById("sidebar-placeholder").innerHTML = html);
    });
</script>

<script src="main.js"></script>

</body>
</html>
