<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Fluxo - Vida e Ministério</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* ========================================================== */
        /* === ESTILOS GERAIS E NOVOS ESTILOS PARA BOTÕES ========= */
        /* ========================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; display: flex; min-height: 100vh; background-color: #f5f6fa; }
        .sidebar { width: 250px; background-color: #2c3e50; color: white; padding: 20px 0; height: 100vh; position: fixed; }
        .logo { text-align: center; padding: 20px 0; border-bottom: 1px solid #34495e; }
        .nav-list { list-style: none; padding: 20px 0; }
        .nav-item { padding: 10px 20px; }
        .nav-item a { color: white; text-decoration: none; display: flex; align-items: center; }
        .nav-item i { margin-right: 10px; width: 20px; }
        .nav-item:hover { background-color: #34495e; }
        .content { margin-left: 250px; padding: 30px; flex-grow: 1; }
        .card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        h1 { color: #2c3e50; margin-bottom: 30px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #2c3e50; font-weight: bold; }
        .form-group select, .form-group input, .form-select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .checkbox-item input[type="checkbox"] { width: 16px; height: 16px; }
        .btn-submit { background-color: #2ecc71; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; transition: background-color 0.3s ease; }
        .btn-submit:hover { background-color: #27ae60; }
        .week-info { margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef; }
        .week-info p { margin: 0; color: #2c3e50; font-size: 16px; text-align: center; line-height: 1.5em; }
        
        .designacoes-section { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; }
        .designacoes-section.active { display: block; }
        
        .designacao-item { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 6px; padding: 8px 16px; background-color: #f8f9fa; border-radius: 8px; min-height: 32px; position: relative; }
        .designacao-item label { display: flex; align-items: center; width: 100%; font-size: 16px; color: #2c3e50; }
        .designacao-item label > span { flex-grow: 1; margin-left: 8px; }

        .order-button { background-color: #ddd; border: none; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; margin-right: 8px; color: #555; transition: background-color 0.3s ease; }
        .order-button.ordered { background-color: #2ecc71; color: white; }
        .order-button.ordered-level-2 { background-color: #3498db; }
        .order-button.ordered-level-3 { background-color: #f39c12; }
        .order-button.ordered-level-4 { background-color: #9b59b6; }
        .order-button.ordered-level-5 { background-color: #e74c3c; }

        .quantity-submenu { display: none; gap: 5px; margin-top: 5px; position: absolute; bottom: -35px; left: 40px; background: white; padding: 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .quantity-submenu.active { display: flex; }
        .quantity-button { background-color: #f0f0f0; border: none; border-radius: 4px; padding: 5px 8px; cursor: pointer; font-size: 14px; }
        .quantity-button.selected { background-color: #2ecc71; color: white; }
        
        .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
        .popup-content { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); width: 80%; max-width: 500px; position: relative; }
        .popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .popup-title { color: #2c3e50; font-size: 22px; }
        .popup-close-button { background: none; border: none; font-size: 20px; cursor: pointer; color: #777; }
        .popup-actions { text-align: right; margin-top: 20px; }
        #popupSummaryList li { list-style: none; padding: 5px 0; color: #333; }
        
        .filter-icon { position: absolute; bottom: 10px; left: 10px; cursor: pointer; color: #e67e22; font-size: 16px; }
        .lock-icon { position: absolute; bottom: 10px; left: 40px; cursor: pointer; color: #7f8c8d; font-size: 16px; }
        .lock-icon.locked { color: #e67e22; }
        .lupa-icon { position: absolute; bottom: 10px; left: 70px; cursor: pointer; color: #3498db; font-size: 16px; }
        .lab-icon { position: absolute; bottom: 10px; left: 100px; cursor: pointer; color: #9b59b6; font-size: 16px; }
        .filter-popup { display: none; position: absolute; bottom: 40px; left: 0; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; min-width: 200px; }
        .filter-popup.active { display: block; }

        .order-button.ordered-level-5 { background-color: #e74c3c; }
        .order-button.ordered-level-6 { background-color: #c0392b; }
        .order-button.ordered-level-7 { background-color: #a93226; }

        /* ========================================================== */
        /* === ESTILOS PARA OS POPUPS DE ANÁLISE (COPIADOS) ========= */
        /* ========================================================== */
        .estatisticas-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        .estatisticas-table th, .estatisticas-table td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; }
.estatisticas-table thead th { cursor: pointer; user-select: none; /* Impede a seleção de texto no cabeçalho ao clicar */ }
        .search-suggestions { display: none; position: absolute; border: 1px solid #ddd; border-top: none; background-color: white; width: 100%; max-height: 200px; overflow-y: auto; z-index: 2000; }
        .suggestion-item { padding: 10px; cursor: pointer; } .suggestion-item:hover { background-color: #f1f1f1; }
        .analysis-popup .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .analysis-popup .tab-button { padding: 10px 15px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; border-bottom: 3px solid transparent; }
        .analysis-popup .tab-button.active { border-bottom: 3px solid #3498db; font-weight: bold; }
        .analysis-popup .tab-content { display: none; }
        .analysis-popup .tab-content.active { display: block; }
        .lab-popup .lab-container { display: flex; gap: 30px; }
        .lab-popup .lab-current-selection { flex: 1; }
        .lab-popup .lab-suggestions { flex: 1; border-left: 1px solid #eee; padding-left: 30px; }
        .lab-popup .suggestion-item { padding: 8px; border-radius: 4px; cursor: pointer; margin-bottom: 5px; }
        .lab-popup .suggestion-item:hover { background-color: #f1f1f1; }
        .lab-popup .suggestion-justification { font-size: 0.8em; color: #777; margin-left: 10px; }
.turbo-button-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 10px;
    margin-bottom: 10px;
    padding-right: 10px;
}
.turbo-button {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    transition: color 0.3s ease, transform 0.3s ease;
    margin-left: 15px;
}
.turbo-button:hover {
    transform: scale(1.2);
}

.section-divider {
    border: none;
    border-top: 1px solid #ddd;
    margin-top: 20px;
    margin-bottom: 10px;
}

/* ========================================================== */
/* === ESTILOS PARA O POPUP DE ESTATÍSTICAS E TABELA ======== */
/* ========================================================== */
.popup-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
body.popup-open {
    overflow: hidden;
}
.estatisticas-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 14px;
}
.estatisticas-table th, .estatisticas-table td {
    border: 1px solid #ddd;
    padding: 10px 12px;
    text-align: left;
}
.estatisticas-table thead th {
    background-color: #34495e;
    color: white;
    position: sticky;
    top: -1px; /* Para fixar o cabeçalho ao rolar dentro do popup-body */
}
.tabs {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 20px;
}
.tab-button {
    padding: 12px 20px;
    cursor: pointer;
    border: none;
    background-color: transparent;
    font-size: 16px;
    color: #555;
    border-bottom: 2px solid transparent;
}
.tab-button.active {
    border-bottom: 2px solid #3498db;
    font-weight: bold;
    color: #3498db;
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}

/* ========================================================== */
/* ========= ESTILOS PARA ORDENAÇÃO DA TABELA =============== */
/* ========================================================== */
.estatisticas-table thead th {
    cursor: pointer;
    position: relative;
    user-select: none; /* Impede a seleção de texto no cabeçalho */
}

/* Estilo para a seta de ordenação (invisível por defeito) */
.estatisticas-table thead th::after {
    content: '';
    display: inline-block;
    width: 1em;
    height: 1em;
    margin-left: 8px;
    opacity: 0.3;
    font-size: 0.8em;
    line-height: 1;
    text-align: center;
}

/* Mostra a seta para cima quando ordenado ascendentemente */
.estatisticas-table thead th.sorted-asc::after {
    content: '▲';
    opacity: 1;
}

/* Mostra a seta para baixo quando ordenado descendentemente */
.estatisticas-table thead th.sorted-desc::after {
    content: '▼';
    opacity: 1;
}

/* Estilo para o Título do Pop-up */
.filter-popup h4 {
    margin: 0 0 15px 0;
    color: #2c3e50;
    font-size: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

/* Estilo para cada grupo (label + dropdown) dentro do pop-up */
.filter-popup > div {
    margin-bottom: 15px;
}
.filter-popup > div:last-child {
    margin-bottom: 0;
}

/* Estilo para as Etiquetas (Labels) dos filtros */
.filter-popup label {
    display: block;
    margin-bottom: 5px;
    color: #555;
    font-size: 14px;
    font-weight: bold;
}

/* Estilo para os Dropdowns (Selects) dentro do pop-up */
.filter-popup select {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    color: #333;
    background-color: #fff;
}


    </style>
</head>

<body>
    <div id="sidebar-placeholder"></div>

    <main class="content">
        <div class="card">
            <h1>Iniciar Fluxo Semanal</h1>
            <div class="week-info">
                <p id="weekDisplay">Carregando informações da semana...</p>
            </div>
            <form id="fluxoSemanalForm">
                <input type="hidden" id="semanaNumero" name="semanaNumero">
                <div class="form-group">
                    <label for="mes">Mês:</label>
                    <select id="mes" name="mes" required>
                        <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option><option value="4">Abril</option>
                        <option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option>
                        <option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tipo">Tipo de Reunião:</label>
                    <select id="tipo" name="tipo" required>
                        <option value="normal">Normal</option><option value="memorial">Memorial</option><option value="assembleia">Assembleia</option>
                        <option value="congresso">Congresso</option><option value="visita-servo">Visita do Servo</option><option value="evento-especial">Evento Especial</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Com Grupo?</label>
                    <div class="checkbox-group" id="nacionalidades"></div>
                </div>
                <div class="form-group">
                    <label for="sala">Sala:</label>
                    <select id="sala" name="sala" required>
                        <option value="salao-principal" selected>Salão Principal</option>
                        <option value="segunda-sala">Segunda Sala</option>
                        <option value="terceira-sala">Terceira Sala</option>
                    </select>
                </div>
                
                <button type="button" class="btn-submit" id="btnSeguinte">Seguinte</button>

                <div id="designacoesSection" class="designacoes-section">
                    <h4>Designações</h4>
                    <div id="designacoesList"></div>

                    <div id="turboButtonContainer" class="turbo-button-container">
                        <button id="turboButton" class="turbo-button" type="button" title="Preencher Participantes Automaticamente" style="color: #2ecc71;">
                            <i class="fas fa-rocket"></i>
                        </button>
                        <button id="estatisticasButton" class="turbo-button" type="button" title="Estatísticas" style="color: #3498db;">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        <button id="pesquisarButton" class="turbo-button" type="button" title="Pesquisar (Futuro)" style="color: #f39c12;">
                            <i class="fas fa-search"></i>
                        </button>
                        <button id="perfilButton" class="turbo-button" type="button" title="Perfil do Participante" style="color: #9b59b6;">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                    <hr class="section-divider">

                    <div id="activeDesignationsContainer"></div>
                </div>

                <button type="submit" class="btn-submit" style="margin-top: 20px; display: none;">Iniciar Fluxo</button>
            </form>
        </div>

        <div id="confirmationPopup" class="popup-overlay">
            <div class="popup-content">
                <div class="popup-header">
                    <h2 class="popup-title">Criar Fluxo Semanal</h2>
                    <button class="popup-close-button" id="closePopup">×</button>
                </div>
                <div class="popup-body">
                    <ul id="popupSummaryList"></ul>
                </div>
                <div class="popup-actions">
                    <button class="btn-submit" id="createFluxoSemanal">Confirmar e Criar</button>
                </div>
            </div>
        </div>

     <!-- =================================================================== -->
<!-- ============= INÍCIO: POPUP DE ESTATÍSTICAS ======================= -->
<!-- =================================================================== -->
<div id="estatisticasPopup" class="popup-overlay">
    <div class="popup-content" style="max-width: 90%; width: 1200px;">
        <div class="popup-header">
            <h2 class="popup-title">Estatísticas de Participação</h2>
            <button class="popup-close-button" id="closeEstatisticasPopup">×</button>
        </div>
        <div class="popup-body" style="overflow-y: auto; max-height: 80vh;">
            <!-- Abas de Navegação -->
            <div class="tabs">
                <button class="tab-button active" data-tab="geral">Geral</button>
                <!-- Outras abas podem ser adicionadas aqui no futuro -->
            </div>

            <!-- Conteúdo da Aba Geral -->
            <div id="tab-content-geral" class="tab-content active">
                <div id="estatisticasFiltros" class="estatisticas-filtros-container" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                    <div class="form-group">
                        <label for="filtroAno">Ano:</label>
                        <select id="filtroAno" name="filtroAno"></select>
                    </div>
                    <div class="form-group">
                        <label for="filtroMes">Mês:</label>
                        <select id="filtroMes" name="filtroMes">
                            <option value="">Todos os Meses</option>
                            <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option><option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroGenero">Género:</label>
                        <select id="filtroGenero" name="filtroGenero">
                            <option value="">Todos os Géneros</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroIdioma">Idioma:</label>
                        <select id="filtroIdioma" name="filtroIdioma">
                            <option value="">Todos os Idiomas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroParte">Parte:</label>
                        <select id="filtroParte" name="filtroParte">
                            <option value="">Todas as Partes</option>
                            <option value="escola">Escola</option>
                            <!-- ALTERAÇÃO IMPORTANTE: "resto da semana" agora está selecionado por defeito -->
                            <option value="resto da semana" selected>Resto da Semana</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroDesignacaoGeral">Designação:</label>
                        <select id="filtroDesignacaoGeral" name="filtroDesignacaoGeral">
                            <!-- Opções geradas dinamicamente -->
                        </select>
                    </div>
                </div>

                <div id="estatisticasLoading" style="text-align: center; padding: 40px; font-size: 18px;">
                    <i class="fas fa-spinner fa-spin"></i> A carregar estatísticas...
                </div>
                <div id="estatisticasTableContainer">
                    <!-- A tabela de estatísticas será gerada aqui -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- =================================================================== -->
<!-- ============= FIM: POPUP DE ESTATÍSTICAS ========================== -->
<!-- =================================================================== -->







        <!-- =================================================================== -->
        <!-- ============= INÍCIO: POPUPS ADICIONADOS ========================== -->
        <!-- =================================================================== -->
        




        <!-- POPUP DE PERFIL DO PARTICIPANTE -->
        <div id="perfilPopup" class="popup-overlay">
            <div class="popup-content" style="max-width: 90%; width: 1200px;">
                <div class="popup-header"><h2 class="popup-title">Perfil do Participante</h2><button class="popup-close-button" id="closePerfilPopup">×</button></div>
                <div class="popup-body">
                    <div class="form-group" style="position: relative;">
                        <label for="pesquisaPessoa">Pesquisar Participante:</label>
                        <input type="text" id="pesquisaPessoa" class="form-control" placeholder="Comece a digitar um nome..." autocomplete="off">
                        <div id="pesquisaSugestoes" class="search-suggestions"></div>
                    </div>
                    <div id="perfilTableContainer" style="overflow-x: auto; max-height: 55vh; display: none;">
                        <table class="estatisticas-table">
                            <thead><tr><th>Data</th><th>Designação</th><th>Companheiro(s)</th><th>Meu Papel</th></tr></thead>
                            <tbody id="perfilTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- POPUP DE ANÁLISE DE PAR/TRIO -->
        <div id="pairAnalysisPopup" class="popup-overlay">
            <div class="popup-content analysis-popup" style="max-width: 90%; width: 1200px;">
                <div class="popup-header"><h2 class="popup-title" id="pairAnalysisTitle">Análise de Designação</h2><button class="popup-close-button" id="closePairAnalysisPopup">×</button></div>
                <div class="popup-body">
                    <div id="pairAnalysisTabsContainer" class="tabs"></div>
                    <div id="pairAnalysisContentContainer"></div>
                </div>
            </div>
        </div>

        <!-- POPUP LABORATÓRIO DE COMBINAÇÕES -->
        <div id="labPopup" class="popup-overlay">
            <div class="popup-content lab-popup" style="max-width: 90%; width: 1000px;">
                <div class="popup-header"><h2 class="popup-title">Laboratório de Combinações</h2><button class="popup-close-button" id="closeLabPopup">×</button></div>
                <div class="popup-body">
                    <div class="lab-container">
                        <div class="lab-current-selection" id="labSelectionContainer"></div>
                        <div class="lab-suggestions" id="labSuggestionsContainer"></div>
                    </div>
                    <div class="popup-actions" style="margin-top: 20px;"><button class="btn-submit" id="applyLabChanges">Aplicar Modificação</button></div>
                </div>
            </div>
        </div>
        <!-- =================================================================== -->
        <!-- ============= FIM: POPUPS ADICIONADOS ============================= -->
        <!-- =================================================================== -->

             <!-- =================================================================== -->
<!-- =============== INÍCIO: POPUP DE CONFIRMAÇÃO DE EVENTO ESPECIAL ============= -->
<!-- =================================================================== -->
<div id="specialEventConfirmationPopup" class="popup-overlay">
    <div class="popup-content" style="max-width: 500px;">
        <div class="popup-header">
            <h2 class="popup-title">Aviso de Evento Especial</h2>
        </div>
        <div class="popup-body" style="padding: 20px 0;">
            <p id="specialEventPopupMessage" style="text-align: center; font-size: 16px; line-height: 1.6;">
                A data do evento coincide com esta semana. Deseja gravar um evento especial sem designações e concluir?
            </p>
        </div>
        <div class="popup-actions" style="display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn-submit" id="confirmSpecialEventSave" style="background-color: #2ecc71;">Sim, Gravar</button>
            <button class="btn-submit" id="cancelSpecialEventSave" style="background-color: #c0392b;">Cancelar</button>
        </div>
    </div>
</div>
<!-- =================================================================== -->
<!-- ================ FIM: POPUP DE CONFIRMAÇÃO DE EVENTO ESPECIAL =============== -->
<!-- =================================================================== -->

    </main>

  
<script>
    document.addEventListener('DOMContentLoaded', function() {
         // Botão de Perfil (Funcional)
        document.getElementById('perfilButton').addEventListener('click', () => {
            document.getElementById('perfilPopup').style.display = 'flex';
        });

        document.body.addEventListener('change', (event) => {
    if (event.target.classList.contains('form-select')) {
        handleGenderSync(event.target);
    }
});

        // Botão de Foguetão (Placeholder)
       document.getElementById('turboButton').addEventListener('click', async (event) => {
            const button = event.currentTarget;
            button.disabled = true;
            button.querySelector('i').classList.add('fa-spin'); // Adiciona um feedback visual

            try {
                await preencherAutomaticamente();
                alert("Preenchimento automático concluído!");
            } catch (error) {
                console.error("Ocorreu um erro crítico no preenchimento automático:", error);
                alert("Ocorreu um erro durante o preenchimento automático. Verifique a consola para mais detalhes.");
            } finally {
                button.disabled = false;
                button.querySelector('i').classList.remove('fa-spin'); // Remove o feedback
            }
        });
        
  
        // Botão de Pesquisa (Placeholder)
        document.getElementById('pesquisarButton').addEventListener('click', () => {
            alert('A função de Pesquisa será implementada futuramente.');
        });

        // ===================================================================
        // ================== CONFIGURAÇÃO E VARIÁVEIS GLOBAIS =================
        // ===================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyD1fkxq6USO5RX22TlsPQFEaVSZoTj_t2A",
            authDomain: "escalas-6e0f9.firebaseapp.com",
            projectId: "escalas-6e0f9",
            storageBucket: "escalas-6e0f9.firebasestorage.app",
            messagingSenderId: "19118998563",
            appId: "1:19118998563:web:5412be658ae34bd45add96"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        document.getElementById('mes').value = new Date().getMonth() + 1;

        let allDesignations = new Map();
        let allPeopleDataMap = new Map();
        let allPeople = [];
        let allDiscursosCache = [];
        let temporaryPreferences = {};
    
        // ===================================================================
        // =========== CÓDIGO PARA O FLUXO DE CONFIRMAÇÃO ============
        // ===================================================================

        const fluxoSemanalForm = document.getElementById('fluxoSemanalForm');
        const confirmationPopup = document.getElementById('confirmationPopup');
        const closePopupButton = document.getElementById('closePopup');
        const createFluxoButton = document.getElementById('createFluxoSemanal');

        const initializeDiscursos = async () => {
    if (allDiscursosCache.length > 0) return; // Não carregar se o cache já existir
    try {
        const snapshot = await db.collection('discursos').orderBy('numero').get();
        snapshot.forEach(doc => {
            // Guarda o número como string para facilitar a pesquisa "começa com"
            const data = doc.data();
            allDiscursosCache.push({ id: doc.id, ...data, numero: String(data.numero) });
        });
        console.log("Cache de discursos inicializado com sucesso.");
    } catch(error) {
        console.error("Erro ao inicializar cache de discursos:", error);
    }
};

        // ETAPA 1: Intercetar o clique no botão "Iniciar Fluxo"
        fluxoSemanalForm.addEventListener('submit', async function(e) {
            e.preventDefault(); // Impede o envio real do formulário
            
            await generatePopupSummary(); // Gera o conteúdo do resumo
            
            confirmationPopup.style.display = 'flex'; // Mostra o popup
        });

        // ETAPA 2: Lógica para o botão final "Confirmar e Criar" dentro do popup
    createFluxoButton.addEventListener('click', async function() {
    this.disabled = true;
    this.textContent = "A Guardar...";

    try {
        const ano = await getAnoPainelFirebase();
        const mes = parseInt(document.getElementById('mes').value);
        const semanaNumero = parseInt(document.getElementById('semanaNumero').value);
        const tipoEvento = document.getElementById('tipo').value;
        const idiomas = getSelectedNacionalidades();
        const sala = document.getElementById('sala').value;
        const diasSemana = getDiasSemana(ano, mes, semanaNumero);
        
        const historicoData = {
            ano: ano, mes: mes, semanaNumero: semanaNumero,
            semanaindex: `(${diasSemana} ${ano})`, designacoes: [],
            evento: tipoEvento, tipo: "reuniao", idioma: idiomas, sala: sala,
            quando: "Semana", parte: "resto da semana",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        document.querySelectorAll('#activeDesignationsContainer .active-designation-container').forEach(container => {
            const designacaoId = container.dataset.designacaoId;
            const participantes = {};
            const participantSelects = container.querySelectorAll('.form-select:not(.descricao-input):not(.discurso-search-input)');
            
            if (participantSelects.length === 1) {
                if (participantSelects[0].value) participantes['participante'] = participantSelects[0].value;
            } else {
                if (participantSelects[0] && participantSelects[0].value) participantes['dirigente'] = participantSelects[0].value;
                if (participantSelects[1] && participantSelects[1].value) participantes['ajudante1'] = participantSelects[1].value;
                if (participantSelects[2] && participantSelects[2].value) participantes['ajudante2'] = participantSelects[2].value;
            }

            const designacaoParaGuardar = { designacaoId: designacaoId, participantes: participantes };

            const designacaoInfo = allDesignations.get(designacaoId);
            if (designacaoInfo && designacaoInfo.anexadoDiscursos === true) {
                const searchInput = container.querySelector('.discurso-search-input');
                if (searchInput && searchInput.dataset.selectedDiscursoId) {
                    designacaoParaGuardar.discursoId = searchInput.dataset.selectedDiscursoId;
                }
            } else {
                const descricaoInput = container.querySelector('.descricao-input');
                if (descricaoInput && container.querySelector('.descricao-container').style.display !== 'none' && descricaoInput.value.trim() !== '') {
                    designacaoParaGuardar.descricao = descricaoInput.value.trim();
                }
            }
            
            if (Object.keys(participantes).length > 0 || designacaoParaGuardar.descricao || designacaoParaGuardar.discursoId) {
                historicoData.designacoes.push(designacaoParaGuardar);
            }
        });
        
        await db.collection("historico").add(historicoData);
        alert("Fluxo semanal criado com sucesso!");
        window.location.reload();

    } catch (error) {
        console.error("Erro ao criar fluxo semanal: ", error);
        alert("Ocorreu um erro ao guardar. Por favor, tente novamente.");
        this.disabled = false;
        this.textContent = "Confirmar e Criar";
    }
});

        // Função para gerar o resumo no popup
   async function generatePopupSummary() {
    const summaryList = document.getElementById('popupSummaryList');
    summaryList.innerHTML = ''; 

    const designacaoContainers = document.querySelectorAll('#activeDesignationsContainer .active-designation-container');
    if (designacaoContainers.length === 0) {
        summaryList.innerHTML = '<li>Nenhuma designação selecionada.</li>';
        return;
    }

    for (const container of designacaoContainers) {
        const designacaoId = container.dataset.designacaoId;
        const designacao = allDesignations.get(designacaoId);
        const designacaoNome = designacao ? designacao.nome : 'Designação Desconhecida';
        
        const participantSelects = container.querySelectorAll('.form-select:not(.descricao-input):not(.discurso-search-input)');
        const participantNames = Array.from(participantSelects).map(select => {
            return select.value ? (allPeopleDataMap.get(select.value) || {}).nome : null;
        }).filter(Boolean);

        let descricaoTexto = '';
        const searchInput = container.querySelector('.discurso-search-input');
        if (searchInput && searchInput.dataset.selectedDiscursoId) {
            const discurso = allDiscursosCache.find(d => d.id === searchInput.dataset.selectedDiscursoId);
            if(discurso) descricaoTexto = `<br><small style="color: #555;"><em>Discurso: ${discurso.numero} - ${discurso.nome}</em></small>`;
        } else {
            const descricaoInput = container.querySelector('.descricao-input');
            if (descricaoInput && container.querySelector('.descricao-container').style.display !== 'none' && descricaoInput.value.trim()) {
                descricaoTexto = `<br><small style="color: #555;"><em>Tema: ${descricaoInput.value.trim()}</em></small>`;
            }
        }
        
        if (participantNames.length > 0 || descricaoTexto) {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${designacaoNome}:</strong> ${participantNames.join(', ') || '<i>(Sem participantes)</i>'}${descricaoTexto}`;
            summaryList.appendChild(li);
        }
    }
}
        
        // Lógica para fechar o popup
        closePopupButton.addEventListener('click', () => {
            confirmationPopup.style.display = 'none';
        });
        
        // ===================================================================
// ================== LÓGICA DO POPUP DE ESTATÍSTICAS ==================
// ===================================================================

const estatisticasPopup = document.getElementById('estatisticasPopup');
const closeEstatisticasPopup = document.getElementById('closeEstatisticasPopup');
const estatisticasButton = document.getElementById('estatisticasButton');

let allYearsCache = [];
let allLanguagesCache = [];

// Função para abrir o popup e carregar os dados
function openEstatisticasPopup() {
    estatisticasPopup.style.display = 'flex';
    document.body.classList.add('popup-open');
    loadGeralTab(); // Carrega o conteúdo da aba "Geral"
}

// Função para fechar o popup
function closeEstatisticasPopupFunction() {
    estatisticasPopup.style.display = 'none';
    document.body.classList.remove('popup-open');
}

// Adiciona os eventos de abrir e fechar aos respetivos botões
estatisticasButton.addEventListener('click', openEstatisticasPopup);
closeEstatisticasPopup.addEventListener('click', closeEstatisticasPopupFunction);


// Função principal que controla o conteúdo da aba "Geral"
const loadGeralTab = async () => {
    // Popula os filtros de ano e idioma (apenas se ainda não estiverem populados)
    if (document.getElementById('filtroAno').options.length === 0) {
        await populateYearFilter(document.getElementById('filtroAno'));
    }
    if (document.getElementById('filtroIdioma').options.length <= 1) { // Menor ou igual a 1 para contar a opção "Todos"
        await populateLanguageFilter(document.getElementById('filtroIdioma'));
    }
    
    // Adiciona os event listeners aos filtros (garante que só são adicionados uma vez)
    if (!estatisticasPopup.dataset.listenersAdded) {
        document.getElementById('filtroParte').addEventListener('change', async () => {
            await populateDesignationFilter();
            generateStatisticsTable();
        });
        
        ['filtroAno', 'filtroMes', 'filtroGenero', 'filtroIdioma', 'filtroDesignacaoGeral'].forEach(id => {
            document.getElementById(id).addEventListener('change', generateStatisticsTable);
        });
        
        estatisticasPopup.dataset.listenersAdded = 'true';
    }
    
    // Inicia a geração da tabela
    await populateDesignationFilter();
    await generateStatisticsTable();
};

// Gera a tabela de estatísticas com base nos filtros
const generateStatisticsTable = async () => {
    const loadingDiv = document.getElementById('estatisticasLoading');
    const tableContainer = document.getElementById('estatisticasTableContainer');
    loadingDiv.style.display = 'block';
    tableContainer.innerHTML = '';

    // Lê os valores dos filtros
    const ano = document.getElementById('filtroAno').value ? parseInt(document.getElementById('filtroAno').value) : null;
    const mes = document.getElementById('filtroMes').value ? parseInt(document.getElementById('filtroMes').value) : null;
    const genero = document.getElementById('filtroGenero').value;
    const idioma = document.getElementById('filtroIdioma').value;
    const parte = document.getElementById('filtroParte').value;
    const designacao = document.getElementById('filtroDesignacaoGeral').value;

    try {
        // Constrói as queries para o Firestore
        let historicoQuery = db.collection('historico');
        if (ano) historicoQuery = historicoQuery.where('ano', '==', ano);
        if (mes) historicoQuery = historicoQuery.where('mes', '==', mes);

        let pessoasQuery = db.collection('pessoas').where('fazDesignacoesReuniao', '==', true);
        if (genero) pessoasQuery = pessoasQuery.where('genero', '==', genero);
        if (idioma) pessoasQuery = pessoasQuery.where('idioma', '==', idioma);

        let designacoesQuery = db.collection('designacoes').where('quando', '==', 'Semana');
        if (parte) designacoesQuery = designacoesQuery.where('parte', '==', parte);

        const [pessoasSnapshot, designacoesSnapshot, historicoSnapshot] = await Promise.all([
            pessoasQuery.orderBy('nomePessoa').get(),
            designacoesQuery.orderBy('ordem').get(),
            historicoQuery.get()
        ]);

        let designationsInOrder = [];
        designacoesSnapshot.forEach(doc => {
            designationsInOrder.push({ id: doc.id, name: doc.data().nome });
        });
        if (designacao) {
            designationsInOrder = designationsInOrder.filter(d => d.id === designacao);
        }

        const peopleMap = new Map();
        pessoasSnapshot.forEach(doc => {
            const counts = new Map();
            designationsInOrder.forEach(d => counts.set(d.id, 0));
            peopleMap.set(doc.id, { name: doc.data().nomePessoa, counts });
        });

        historicoSnapshot.forEach(doc => {
            doc.data().designacoes?.forEach(histDesig => {
                Object.values(histDesig.participantes || {}).forEach(pId => {
                    if (peopleMap.has(pId) && peopleMap.get(pId).counts.has(histDesig.designacaoId)) {
                        const personData = peopleMap.get(pId);
                        const currentCount = personData.counts.get(histDesig.designacaoId);
                        personData.counts.set(histDesig.designacaoId, currentCount + 1);
                    }
                });
            });
        });

        // Constrói o HTML da tabela
        let tableHTML = '<table class="estatisticas-table"><thead><tr><th>Participante</th>';
        designationsInOrder.forEach(d => { tableHTML += `<th>${d.name}</th>`; });
        tableHTML += '</tr></thead><tbody>';

        for (const [_, personData] of peopleMap.entries()) {
            tableHTML += `<tr><td>${personData.name}</td>`;
            designationsInOrder.forEach(d => {
                tableHTML += `<td style="text-align:center;">${personData.counts.get(d.id)}</td>`;
            });
            tableHTML += '</tr>';
        }
        tableHTML += '</tbody></table>';

        loadingDiv.style.display = 'none';
        tableContainer.innerHTML = tableHTML;
makeTableSortable(tableContainer.querySelector('.estatisticas-table'));

    } catch (error) {
        console.error("Erro ao gerar estatísticas:", error);
        loadingDiv.innerHTML = "Ocorreu um erro ao carregar os dados.";
    }
};

// Funções auxiliares para popular os dropdowns de filtro
const populateYearFilter = async (selectElement) => {
    const historicoSnapshot = await db.collection('historico').get();
    const years = new Set();
    historicoSnapshot.forEach(doc => years.add(doc.data().ano));
    allYearsCache = Array.from(years).sort((a, b) => b - a);
    const currentYear = new Date().getFullYear();
    selectElement.innerHTML = '';
    allYearsCache.forEach(year => {
        selectElement.innerHTML += `<option value="${year}" ${parseInt(year) === currentYear ? 'selected' : ''}>${year}</option>`;
    });
};

function makeTableSortable(table) {
    const header = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if (!header || !tbody) return; // Garante que a tabela tem os elementos necessários

    header.addEventListener('click', (e) => {
        const th = e.target.closest('th');
        if (!th) return; // Sai se o clique não foi num cabeçalho

        const columnIndex = Array.from(th.parentNode.children).indexOf(th);
        
        // Determina a nova direção da ordenação (ascendente/descendente)
        const currentDirection = th.dataset.sortDirection || 'desc';
        const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
        
        // Limpa a direção de todos os outros cabeçalhos para resetar a ordenação
        header.querySelectorAll('th').forEach(h => {
            delete h.dataset.sortDirection;
        });

        // Define a nova direção apenas no cabeçalho que foi clicado
        th.dataset.sortDirection = newDirection;

        // Pega todas as linhas da tabela e converte para um array para poder usar .sort()
        const rows = Array.from(tbody.querySelectorAll('tr'));

        // Ordena o array de linhas
        rows.sort((rowA, rowB) => {
            const cellA = rowA.children[columnIndex].textContent.trim();
            const cellB = rowB.children[columnIndex].textContent.trim();
            
            // Verifica se a coluna é a de nomes (índice 0) ou numérica
            const isNumericColumn = columnIndex > 0 && !isNaN(cellA) && !isNaN(cellB);

            let comparison = 0;
            if (isNumericColumn) {
                // Compara como números
                comparison = parseFloat(cellA) - parseFloat(cellB);
            } else {
                // Compara como texto (sensível à localidade 'pt' para acentos)
                comparison = cellA.localeCompare(cellB, 'pt', { sensitivity: 'base' });
            }

            // Inverte o resultado se a direção for descendente
            return newDirection === 'asc' ? comparison : -comparison;
        });

        // Limpa o corpo da tabela e adiciona as linhas já ordenadas
        tbody.innerHTML = '';
        tbody.append(...rows);
    });
}

const populateLanguageFilter = async (selectElement) => {
    // 1. VERIFICA SE A CACHE JÁ FOI PREENCHIDA ALGUMA VEZ.
    // Esta verificação evita consultas desnecessárias ao banco de dados.
    if (allLanguagesCache.length === 0) {
        try {
            const nacionalidadesSnapshot = await db.collection('nacionalidades').orderBy('nome').get();
            
            // Usamos um Set para garantir que não há duplicados, mesmo que a fonte de dados os tenha.
            const languages = new Set();
            nacionalidadesSnapshot.forEach(doc => {
                languages.add(doc.data().nome);
            });
            
            // A CORREÇÃO CRÍTICA ESTÁ AQUI:
            // Atribuímos um novo array à cache em vez de usar .push().
            // Isto impede que múltiplas chamadas adicionem os mesmos itens repetidamente.
            allLanguagesCache = Array.from(languages);

        } catch (error) {
            console.error("Erro ao carregar idiomas do Firebase:", error);
            return; // Sai da função em caso de erro.
        }
    }

    // 2. LIMPA O DROPDOWN E PREENCHE-O COM OS DADOS DA CACHE (AGORA SEMPRE LIMPA)
    selectElement.innerHTML = '<option value="">Todos os Idiomas</option>'; // Garante que a lista está sempre limpa antes de preencher.
    
    allLanguagesCache.forEach(lang => {
        selectElement.innerHTML += `<option value="${lang}">${lang}</option>`;
    });
};

const populateDesignationFilter = async () => {
    const filtroDesignacao = document.getElementById('filtroDesignacaoGeral');
    const parteSelecionada = document.getElementById('filtroParte').value;
    filtroDesignacao.innerHTML = '<option value="">Todas as Designações</option>';
    if (!parteSelecionada) return;

    const designacoesSnapshot = await db.collection('designacoes')
        .where('parte', '==', parteSelecionada)
        .where('quando', '==', 'Semana')
        .orderBy('ordem')
        .get();
        
    designacoesSnapshot.forEach(doc => {
        filtroDesignacao.innerHTML += `<option value="${doc.id}">${doc.data().nome}</option>`;
    });
};



// Substitui o event listener de placeholder do botão de estatísticas
document.getElementById('estatisticasButton').removeEventListener('click', () => {}); // Remove o antigo, se houver
document.getElementById('estatisticasButton').addEventListener('click', () => {
    estatisticasPopup.style.display = 'flex';
    document.body.classList.add('popup-open');
    loadGeralTab();
});




const getWeekMondaySunday = (ano, mes, semanaNumero) => {
    const primeiroDiaMes = new Date(ano, mes - 1, 1);
    let diaSemanaPrimeiroDia = primeiroDiaMes.getDay();
    if (diaSemanaPrimeiroDia === 0) diaSemanaPrimeiroDia = 7;

    let diasToAddForFirstMonday = (8 - diaSemanaPrimeiroDia) % 7;
    if (primeiroDiaMes.getDay() === 1) {
        diasToAddForFirstMonday = 0;
    }

    const primeiroSegundaMes = new Date(ano, mes - 1, 1 + diasToAddForFirstMonday);
    const monday = new Date(primeiroSegundaMes);
    monday.setDate(monday.getDate() + (semanaNumero - 1) * 7);
    const sunday = new Date(monday);
    sunday.setDate(sunday.getDate() + 6);

    monday.setHours(0, 0, 0, 0);
    sunday.setHours(23, 59, 59, 999);

    return { monday, sunday };
};

/**
 * Mostra um painel de confirmação customizado e retorna uma Promise.
 */
const showSpecialEventConfirmation = (eventType) => {
    const eventDisplayNames = {
        'memorial': 'O Memorial',
        'assembleia': 'A Assembleia',
        'congresso': 'O Congresso',
        'visita-servo': 'A Visita do Servo'
    };
    const eventName = eventDisplayNames[eventType] || 'Este evento especial';

    return new Promise((resolve) => {
        const popup = document.getElementById('specialEventConfirmationPopup');
        const messageEl = document.getElementById('specialEventPopupMessage');
        const confirmBtn = document.getElementById('confirmSpecialEventSave');
        const cancelBtn = document.getElementById('cancelSpecialEventSave');

        messageEl.textContent = `A data de ${eventName} coincide com esta semana. Deseja gravar um evento especial sem designações e concluir?`;
        popup.style.display = 'flex';

        const handleConfirm = () => {
            popup.style.display = 'none';
            confirmBtn.removeEventListener('click', handleConfirm);
            cancelBtn.removeEventListener('click', handleCancel);
            resolve(true);
        };

        const handleCancel = () => {
            popup.style.display = 'none';
            confirmBtn.removeEventListener('click', handleConfirm);
            cancelBtn.removeEventListener('click', handleCancel);
            resolve(false);
        };

        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);
    });
};

/**
 * Guarda um registo no histórico para um evento especial, sem designações.
 */
const saveSpecialEvent = async () => {
    try {
        const ano = await getAnoPainelFirebase();
        const mes = parseInt(document.getElementById('mes').value);
        const semanaNumero = parseInt(document.getElementById('semanaNumero').value);
        const tipoEvento = document.getElementById('tipo').value;
        const idiomas = getSelectedNacionalidades();
        const sala = document.getElementById('sala').value;
        const diasSemana = getDiasSemana(ano, mes, semanaNumero);

        const historicoData = {
            ano: ano,
            mes: mes,
            semanaNumero: semanaNumero,
            semanaindex: `(${diasSemana} ${ano})`,
            designacoes: [], // Lista de designações vazia
            evento: tipoEvento,
            tipo: "reuniao",
            idioma: idiomas,
            sala: sala,
            quando: "Semana",
            parte: "resto da semana", // Identificador desta página
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection("historico").add(historicoData);
        return true;
    } catch (error) {
        console.error("Erro ao gravar evento especial:", error);
        alert("Ocorreu um erro ao gravar o evento especial: " + error.message);
        return false;
    }
};

        // ===================================================================
        // =========== O RESTO DO SEU CÓDIGO ORIGINAL CONTINUA AQUI ============
        // ===================================================================

        const getAnoPainelFirebase = async () => {
            const doc = await db.collection('painel').doc('ano').get();
            return doc.exists ? doc.data().ano : new Date().getFullYear();
        };

        const countHistoricoSemanas = async (ano, mes) => {
            const q = await db.collection('historico')
                .where("ano", "==", ano)
                .where("mes", "==", parseInt(mes))
                .where("quando", "==", "Semana")
                .where("parte", "==", "resto da semana")
                .get();
            return q.size;
        };

        const getTotalSemanasNoMes = (ano, mes) => {
            let count = 0, day = new Date(ano, mes - 1, 1);
            while (day.getMonth() === mes - 1) {
                if (day.getDay() === 1) count++;
                day.setDate(day.getDate() + 1);
            }
            return count;
        };

      const getDiasSemana = (ano, mes, semanaNumero) => {
    const primeiroDiaMes = new Date(ano, mes - 1, 1);
    let diaSemanaPrimeiroDia = primeiroDiaMes.getDay();
    if (diaSemanaPrimeiroDia === 0) diaSemanaPrimeiroDia = 7;

    let diasToAddForFirstMonday = 0;
    if (diaSemanaPrimeiroDia !== 1) {
        diasToAddForFirstMonday = (8 - diaSemanaPrimeiroDia) % 7;
    }

    const primeiroSegundaMes = new Date(ano, mes - 1, 1 + diasToAddForFirstMonday);
    const inicioSemanaDate = new Date(ano, mes - 1, primeiroSegundaMes.getDate() + (semanaNumero - 1) * 7);
    const fimSemanaDate = new Date(ano, mes - 1, primeiroSegundaMes.getDate() + (semanaNumero - 1) * 7 + 6);

    const formatarMes = (date) => {
        const monthNames = ["Jan", "Fev", "Mar", "Abr", "Maio", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        return monthNames[date.getMonth()];
    };

    const inicio_dia = inicioSemanaDate.getDate();
    const fim_dia = fimSemanaDate.getDate();
    const inicio_mes = formatarMes(inicioSemanaDate);
    const fim_mes = formatarMes(fimSemanaDate);

    // LÓGICA CORRIGIDA: A string é sempre construída no formato completo.
    const diasSemanaString = `${inicio_dia} ${inicio_mes} - ${fim_dia} ${fim_mes}`;
    
    return diasSemanaString;
};

        const getHorariosFromFirebase = async (ano) => {
            const querySnapshot = await db.collection('horarios').where('ano', '==', ano).limit(1).get();
            if (!querySnapshot.empty) return querySnapshot.docs[0].data();
            return { 'dia-semana': 'segunda-feira', 'hora-semana': '19:30' };
        };
        
        const getSelectedNacionalidades = () => {
            const checkedBoxes = document.querySelectorAll('#nacionalidades input[type="checkbox"]:checked');
            return Array.from(checkedBoxes).map(cb => cb.value);
        };
        

const handleGenderSync = (changedSelect) => {
    // Encontra o container da instância atual (ex: "Demonstração (1)")
    const instanceContainer = changedSelect.closest('.active-designation-container');
    if (!instanceContainer) return;

    // Procura o novo filtro "Masculino com Feminino" dentro do cartão
    const genderMixSelect = instanceContainer.querySelector('.gender-mix-select');

    // Se a regra for "Sim", removemos qualquer filtro de género e paramos a função
    if (genderMixSelect && genderMixSelect.value === 'sim') {
        const allSelectsInInstance = instanceContainer.querySelectorAll('select.form-select');
        allSelectsInInstance.forEach(select => {
            Array.from(select.options).forEach(option => {
                option.style.display = ''; // Mostra todas as opções
            });
        });
        return; // Pára a execução para não aplicar o bloqueio de género
    }

    // O código abaixo só é executado se o filtro for "Não"
    const allSelectsInInstance = instanceContainer.querySelectorAll('select.form-select');
    const selectedPersonId = changedSelect.value;

    // Se um campo for limpo, remove todos os filtros de género
    if (!selectedPersonId) {
        allSelectsInInstance.forEach(select => {
            Array.from(select.options).forEach(option => {
                option.style.display = ''; 
            });
        });
        return;
    }

    const personData = allPeopleDataMap.get(selectedPersonId);
    if (!personData || !personData.genero) return;

    const requiredGender = personData.genero;

    // Itera sobre todos os dropdowns na mesma designação
    allSelectsInInstance.forEach(select => {
        // Valida seleções já feitas
        if (select !== changedSelect && select.value) {
            const otherPersonData = allPeopleDataMap.get(select.value);
            // Se o género for diferente, limpa a seleção
            if (!otherPersonData || otherPersonData.genero !== requiredGender) {
                select.value = ''; 
            }
        }
        
        // Filtra as opções nos outros dropdowns
        Array.from(select.options).forEach(option => {
            if (!option.value) { // Mantém sempre a opção "Selecione..."
                option.style.display = '';
                return;
            }
            const optionPersonData = allPeopleDataMap.get(option.value);
            if (optionPersonData && optionPersonData.genero === requiredGender) {
                option.style.display = ''; // Mostra se o género for o mesmo
            } else {
                option.style.display = 'none'; // Esconde se o género for diferente
            }
        });
    });
};


   const loadPeopleOptionsIntoSelects = async (designacao, container, genderPreference = 'ambos', idiomas = []) => {
    try {
        const ano = await getAnoPainelFirebase();
        const mes = parseInt(document.getElementById('mes').value);
        const semanaNumero = parseInt(document.getElementById('semanaNumero').value);
        const diasSemana = getDiasSemana(ano, mes, semanaNumero);
        const horarios = await getHorariosFromFirebase(ano);

        // Calcula a data exata da reunião para a verificação de ausência
        const meetingDate = getMeetingDayOfMonth(ano, diasSemana, horarios['dia-semana']);

        // 1. Faz a consulta inicial ao Firebase com os filtros gerais
        let query = db.collection('pessoas').where('fazDesignacoesReuniao', '==', true);
        if (idiomas.length > 0) {
            query = query.where('idioma', 'in', idiomas);
        }
        if (genderPreference === 'masculino') query = query.where('genero', '==', 'Masculino');
        if (genderPreference === 'feminino') query = query.where('genero', '==', 'Feminino');
        
        const snapshot = await query.get();

        // 2. Cria uma lista pré-filtrada com as pessoas que cumprem os requisitos básicos
        const eligiblePeopleList = [];
        snapshot.docs.forEach(doc => {
            const p = doc.data();
            const podeFazer = p.designacoesReuniao && p.designacoesReuniao.includes(designacao.nome);
            const isAbsent = meetingDate && p.ausencias && p.ausencias.includes(meetingDate);
            
            // Adiciona à lista apenas se puder fazer a designação e não estiver ausente
            if (podeFazer && !isAbsent) {
                eligiblePeopleList.push({ id: doc.id, data: p });
            }
        });
        
        // Ordena a lista alfabeticamente uma única vez
        eligiblePeopleList.sort((a, b) => a.data.nomePessoa.localeCompare(b.data.nomePessoa));

        // 3. Itera sobre cada dropdown (select) dentro do cartão da designação
        container.querySelectorAll('select.form-select').forEach((participantSelect, participantIndex) => { 
            const currentValue = participantSelect.value;
            participantSelect.innerHTML = '<option value="">Selecione...</option>'; // Limpa as opções anteriores

            // 4. Itera sobre a lista de pessoas elegíveis para criar as opções de cada dropdown
            eligiblePeopleList.forEach(person => {
                const pessoaData = person.data;

                
                let podeAssumirEstePapel = false;
                
                // Verifica se é a função de "Dirigente" (o primeiro dropdown numa designação com mais de uma pessoa)
                if (participantIndex === 0 && (designacao.numeroParticipantes || 1) > 1) {
                    
                    // REGRA PADRÃO: Pessoas com '+ à vontade' são sempre elegíveis como dirigentes
                    if (pessoaData.personalidade === '+ à vontade') {
                        podeAssumirEstePapel = true;
                    }

                    // NOVA EXCEÇÃO: Se a própria designação permitir, pessoas com '- à vontade' também são elegíveis
                    if (
                        Array.isArray(designacao.personalidade) &&
                        designacao.personalidade.includes('- à vontade') &&
                        pessoaData.personalidade === '- à vontade'
                    ) {
                        podeAssumirEstePapel = true;
                    }

                } else {
                    // Para todas as outras funções (Participante, Ajudante 1, Ajudante 2), não há restrição de personalidade
                    podeAssumirEstePapel = true;
                }
            

                if (podeAssumirEstePapel) {
                    const option = document.createElement('option');
                    option.value = person.id;
                    option.textContent = pessoaData.nomePessoa;
                    participantSelect.appendChild(option);
                }
            });

            // Restaura o valor que estava selecionado anteriormente, se ainda for uma opção válida
            if (currentValue) {
               participantSelect.value = currentValue;
            }
        });
    } catch (error) {
        console.error(`Erro ao carregar pessoas para a designação '${designacao.nome}':`, error);
    }
};

        const initializeSystemData = async () => {
            try {
                const [pessoasSnapshot] = await Promise.all([
                    db.collection('pessoas').orderBy('nomePessoa').get(),
                ]);
                allPeople = [];
                allPeopleDataMap.clear();
                pessoasSnapshot.forEach(doc => {
                    const pessoaData = doc.data();
                    allPeople.push({ id: doc.id, nome: pessoaData.nomePessoa });
                    allPeopleDataMap.set(doc.id, { nome: pessoaData.nomePessoa, genero: pessoaData.genero });
                });
                console.log("Dados do sistema (Pessoas) inicializados.");
                await initializeDiscursos(); 
            } catch (error) {
                console.error("Erro ao inicializar dados do sistema:", error);
            }
        };

        function getMeetingDayOfMonth(ano, diasSemanaString, diaSemanaReuniao) {
    if (!ano || !diasSemanaString || !diaSemanaReuniao) {
        return null;
    }
    const parts = diasSemanaString.split(" - ");
    if (parts.length < 2) return null;
    const startDay = parseInt(parts[0]);
    const endPart = parts[1].split(" ");
    const endDay = parseInt(endPart[0]);
    let startMonthStr = parts[0].split(" ")[1] || "";
    const endMonthStr = endPart.length > 1 ? endPart[1] : startMonthStr;
    const monthNames = ["Jan", "Fev", "Mar", "Abr", "Maio", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    let startMonthIndex = monthNames.indexOf(startMonthStr);
    const endMonthIndex = monthNames.indexOf(endMonthStr);
    if (startMonthIndex === -1) startMonthIndex = endMonthIndex;
    if (startMonthIndex === -1) return null;

    const dayOfWeekMeetingNumber = getDayOfWeekNumber(diaSemanaReuniao);
    if (dayOfWeekMeetingNumber === null) return null;

    const startOfWeekDate = new Date(ano, startMonthIndex, startDay);
    const endOfWeekDate = new Date(ano, endMonthIndex, endDay);
    let currentDay = new Date(startOfWeekDate);

    while (currentDay <= endOfWeekDate) {
        if (currentDay.getDay() === dayOfWeekMeetingNumber) {
            const month = String(currentDay.getMonth() + 1).padStart(2, '0');
            const day = String(currentDay.getDate()).padStart(2, '0');
            return `${ano}-${month}-${day}`;
        }
        currentDay.setDate(currentDay.getDate() + 1);
    }
    return null;
}

// Garanta que a função getDayOfWeekNumber também existe
function getDayOfWeekNumber(dayOfWeekString) {
    const days = { 'domingo': 0, 'segunda-feira': 1, 'terca-feira': 2, 'quarta-feira': 3, 'quinta-feira': 4, 'sexta-feira': 5, 'sabado': 6 };
    return days[dayOfWeekString.toLowerCase()];
}

        async function preencherAutomaticamente() {
            console.log("🚀 Iniciando o preenchimento automático...");
            const ano = await getAnoPainelFirebase();
            const mes = parseInt(document.getElementById('mes').value);
            const semana = parseInt(document.getElementById('semanaNumero').value);
            const dateRanges = getWeekDateRanges(ano, mes, semana);

            const vagas = [];
            document.querySelectorAll('.active-designation-container').forEach(card => {
                if (card.dataset.locked === 'true') return;
                card.querySelectorAll('select.form-select').forEach((select, index) => {
                    vagas.push({
                        elementId: select.id,
                        designacaoId: card.dataset.designacaoId,
                        instanceIndex: parseInt(select.id.split('-')[2]) - 1,
                        roleIndex: index,
                        filters: {
                            genero: card.querySelector('.genero-preferencia-select')?.value || 'ambos',
                            idiomas: getSelectedNacionalidades()
                        }
                    });
                });
            });

            if (vagas.length === 0) {
                console.log("Nenhuma vaga desbloqueada para preencher.");
                return;
            }

            const { peopleMap, designationsMap, historicoData } = await getDataFromFirebase();
            let candidatosPorVaga = await Promise.all(vagas.map(vaga =>
                gerarCandidatosParaVaga(vaga, peopleMap, historicoData, dateRanges)
            ));
            
            candidatosPorVaga.sort((a, b) => a.candidatos.length - b.candidatos.length);

            let atribuicoesFinais = {};
            let pessoasAtribuidas = new Set();

            candidatosPorVaga.forEach(item => {
                for (const candidato of item.candidatos) {
                    if (isCandidatoValido(candidato, item.vaga, atribuicoesFinais, pessoasAtribuidas, designationsMap, 'Não')) {
                        atribuicoesFinais[item.vaga.elementId] = candidato.id;
                        pessoasAtribuidas.add(candidato.id);
                        break;
                    }
                }
            });
            
            const vagasVazias = candidatosPorVaga.filter(item => !atribuicoesFinais[item.vaga.elementId]);
            if (vagasVazias.length > 0) {
                vagasVazias.forEach(item => {
                    for (const candidato of item.candidatos) {
                        if (isCandidatoValido(candidato, item.vaga, atribuicoesFinais, pessoasAtribuidas, designationsMap, 'Moderado')) {
                             atribuicoesFinais[item.vaga.elementId] = candidato.id;
                             pessoasAtribuidas.add(candidato.id);
                             break;
                        }
                    }
                });
            }

            const vagasAindaVazias = candidatosPorVaga.filter(item => !atribuicoesFinais[item.vaga.elementId]);
             if (vagasAindaVazias.length > 0) {
                vagasAindaVazias.forEach(item => {
                    const melhorCandidato = item.candidatos.find(c => !pessoasAtribuidas.has(c.id));
                     if (melhorCandidato) {
                        atribuicoesFinais[item.vaga.elementId] = melhorCandidato.id;
                        pessoasAtribuidas.add(melhorCandidato.id);
                     }
                });
            }

            for (const [elementId, pessoaId] of Object.entries(atribuicoesFinais)) {
                const selectElement = document.getElementById(elementId);
                if (selectElement) {
                    selectElement.value = pessoaId;
                }
            }
            console.log("✅ Preenchimento automático concluído.");
        }

        async function getDataFromFirebase() {
            const [pessoasSnapshot, designacoesSnapshot, historicoSnapshot] = await Promise.all([
                db.collection('pessoas').where('fazDesignacoesReuniao', '==', true).get(),
                db.collection('designacoes').get(),
                db.collection('historico').get()
            ]);

            const peopleMap = new Map();
            pessoasSnapshot.forEach(doc => peopleMap.set(doc.id, { id: doc.id, ...doc.data() }));
            const designationsMap = new Map();
            designacoesSnapshot.forEach(doc => designationsMap.set(doc.id, { id: doc.id, ...doc.data() }));
            const historicoData = [];
            historicoSnapshot.forEach(doc => historicoData.push({ id: doc.id, ...doc.data() }));

            return { peopleMap, designationsMap, historicoData };
        }

        async function gerarCandidatosParaVaga(vaga, peopleMap, historicoData, dateRanges) {
            let candidatos = Array.from(peopleMap.values());
            const designacao = allDesignations.get(vaga.designacaoId);
            candidatos = candidatos.filter(p => {
                const atendeGenero = vaga.filters.genero === 'ambos' || p.genero?.toLowerCase() === vaga.filters.genero;
                const atendeIdioma = vaga.filters.idiomas.includes(p.idioma);
                const podeFazerDesignacao = p.designacoesReuniao?.includes(designacao.nome);
                return atendeGenero && atendeIdioma && podeFazerDesignacao;
            });

            const historicoRelevante = historicoData.filter(h =>
                (h.dia >= dateRanges.previous.start && h.dia <= dateRanges.previous.end) ||
                (h.dia >= dateRanges.next.start && h.dia <= dateRanges.next.end)
            );
            const pessoasBloqueadasPorHistorico = new Set();
            historicoRelevante.forEach(h => {
                h.designacoes?.forEach(d => {
                    if (d.designacaoId === vaga.designacaoId) {
                        Object.values(d.participantes).forEach(pessoaId => pessoasBloqueadasPorHistorico.add(pessoaId));
                    }
                });
            });
            candidatos = candidatos.filter(p => !pessoasBloqueadasPorHistorico.has(p.id));

            const candidatosComFrequencia = candidatos.map(candidato => {
                let frequencia = 0;
                historicoData.forEach(h => {
                    h.designacoes?.forEach(d => {
                        if (d.designacaoId === vaga.designacaoId && Object.values(d.participantes).includes(candidato.id)) {
                            frequencia++;
                        }
                    });
                });
                return { ...candidato, frequencia };
            });
            candidatosComFrequencia.sort((a, b) => a.frequencia - b.frequencia);
            return { vaga, candidatos: candidatosComFrequencia };
        }
        
        function isCandidatoValido(candidato, vaga, atribuicoesAtuais, pessoasAtribuidas, designationsMap, nivelBloqueio) {
            const designacaoAtual = designationsMap.get(vaga.designacaoId);
            if (!designacaoAtual) return false;
            if (pessoasAtribuidas.has(candidato.id)) {
                const vagaOcupadaId = Object.keys(atribuicoesAtuais).find(key => atribuicoesAtuais[key] === candidato.id);
                const designacaoOcupada = designationsMap.get(vagaOcupadaId.split('-')[1]);
                const repeticaoPermite = designacaoAtual.repeticao?.includes(designacaoOcupada?.id) || designacaoOcupada?.repeticao?.includes(designacaoAtual.id);
                return repeticaoPermite;
            }
            for (const [vagaAtribuidaId, pessoaId] of Object.entries(atribuicoesAtuais)) {
                const designacaoAtribuidaId = document.getElementById(vagaAtribuidaId).closest('.active-designation-container').dataset.designacaoId;
                const designacaoAtribuida = designationsMap.get(designacaoAtribuidaId);
                if (!designacaoAtribuida) continue;
                const bloqueioAtual = designacaoAtual.bloqueio?.[designacaoAtribuida.id];
                if (bloqueioAtual === 'Não' || (nivelBloqueio === 'Moderado' && bloqueioAtual === 'Moderado')) {
                    return false;
                }
                const bloqueioOutro = designacaoAtribuida.bloqueio?.[designacaoAtual.id];
                if (bloqueioOutro === 'Não' || (nivelBloqueio === 'Moderado' && bloqueioOutro === 'Moderado')) {
                    return false;
                }
            }
            return true;
        }

        function getWeekDateRanges(ano, mes, semana) {
            let firstDayOfMonth = new Date(ano, mes - 1, 1);
            let dayOfWeek = firstDayOfMonth.getDay();
            let offset = (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
            let firstMondayOfMonth = new Date(firstDayOfMonth);
            firstMondayOfMonth.setDate(firstDayOfMonth.getDate() - offset);
            const startOfWeek = new Date(firstMondayOfMonth);
            startOfWeek.setDate(firstMondayOfMonth.getDate() + (semana - 1) * 7);
            const getRange = (startDate) => {
                const end = new Date(startDate);
                end.setDate(startDate.getDate() + 6);
                return {
                    start: startDate.toISOString().split('T')[0],
                    end: end.toISOString().split('T')[0]
                };
            };
            const current = getRange(startOfWeek);
            const previousStart = new Date(startOfWeek);
            previousStart.setDate(startOfWeek.getDate() - 7);
            const previous = getRange(previousStart);
            const nextStart = new Date(startOfWeek);
            nextStart.setDate(startOfWeek.getDate() + 7);
            const next = getRange(nextStart);
            return { current, previous, next };
        }

        const updateWeekDisplay = async () => {
            const weekDisplay = document.getElementById('weekDisplay');
            const btn = document.getElementById('btnSeguinte');
            const mes = document.getElementById('mes').value;
            const ano = await getAnoPainelFirebase();
            const semana = await countHistoricoSemanas(ano, mes) + 1;
            const totalSemanas = getTotalSemanasNoMes(ano, mes);

            if (semana > totalSemanas && totalSemanas > 0) {
                weekDisplay.innerHTML = "Mês completo. Por favor, selecione outro mês.";
                btn.disabled = true;
            } else {
                document.getElementById('semanaNumero').value = semana;
                weekDisplay.innerHTML = `${semana}ª semana de ${totalSemanas} <br>(${getDiasSemana(ano, mes, semana)})`;
                btn.disabled = false;
            }
        };

        const loadNacionalidades = async () => {
            const snapshot = await db.collection('nacionalidades').get();
            const container = document.getElementById('nacionalidades');
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                container.innerHTML += `<label class="checkbox-item"><input type="checkbox" name="nacionalidades" value="${data.nome}" ${data.nome === 'Portugal' ? 'checked' : ''}> ${data.nome}</label>`;
            });
        };

        const loadDesignacoes = async () => {
            const snapshot = await db.collection('designacoes')
                .where('tipo', '==', 'reuniao')
                .where('quando', '==', 'Semana')
                .where('parte', '==', 'resto da semana')
                .orderBy("ordem")
                .get();
            
            const list = document.getElementById('designacoesList');
            list.innerHTML = '';
            
            if (snapshot.empty) {
                list.innerHTML = '<p>Nenhuma designação encontrada.</p>';
                return;
            }

            const designacoesParaAtivar = [];
            snapshot.forEach(doc => {
                const designacao = { id: doc.id, ...doc.data() };
                allDesignations.set(doc.id, designacao);
                designacoesParaAtivar.push(designacao);

                const div = document.createElement('div');
                div.className = 'designacao-item';
                div.dataset.designacaoId = designacao.id;
                div.dataset.firestoreOrder = designacao.ordem;
                
                div.innerHTML = `<label><button type="button" class="order-button" data-order="0" data-quantity="1"></button><span>${designacao.nome}</span></label>`;
                list.appendChild(div);
            });

            for (const [index, designacao] of designacoesParaAtivar.entries()) {
                const order = index + 1;
                const quantity = 1;
                
                const button = list.querySelector(`.designacao-item[data-designacao-id="${designacao.id}"] .order-button`);
                button.dataset.order = order;
                button.dataset.quantity = quantity;
                button.textContent = quantity;
                updateOrderButtonClasses(button, order);
                await updateActiveDesignationDisplay(designacao, order, quantity);
            }
            reIndexOrderNumbers();
        };

        const removeActiveDesignationDisplay = (designacaoId) => {
            const displayToRemove = document.getElementById(`active-designation-${designacaoId}`);
            if (displayToRemove) displayToRemove.remove();
        };

 const updateActiveDesignationDisplay = async (designacao, order, quantity) => {
    // ======================= INÍCIO DO LOG DE DEPURAÇÃO =======================
    // Apenas para depuração, vamos verificar a designação "Necessidades Locais"
    if (designacao.nome === 'Necessidades Locais') {
        console.log("==============================================");
        console.log("[DEBUG] Processando o card:", designacao.nome);
        console.log("[DEBUG] Objeto 'designacao' completo:", designacao);
        console.log("[DEBUG] Valor de 'anexadoDiscursos':", designacao.anexadoDiscursos);
        console.log("[DEBUG] Tipo de 'anexadoDiscursos':", typeof designacao.anexadoDiscursos);
        console.log("[DEBUG] Verificação (designacao.anexadoDiscursos === true):", designacao.anexadoDiscursos === true);
    }
    // ======================= FIM DO LOG DE DEPURAÇÃO =======================

    const containerToUse = document.getElementById('activeDesignationsContainer');
    const savedSelections = {};
    let savedDescriptions = {};
    let placeholder = document.createElement('div');
    const existingCard = document.getElementById(`active-designation-${designacao.id}`);
    
    if (existingCard) {
        existingCard.querySelectorAll('.active-designation-container').forEach((instance, instanceIndex) => {
            savedSelections[instanceIndex] = Array.from(instance.querySelectorAll('.form-select:not(.descricao-input):not(.discurso-search-input)'))
                .map(select => select.value || null);

            const descInput = instance.querySelector('.descricao-input');
            const searchInput = instance.querySelector('.discurso-search-input');
            if (descInput) {
                savedDescriptions[instanceIndex] = { type: 'text', value: descInput.value };
            } else if (searchInput) {
                savedDescriptions[instanceIndex] = { 
                    type: 'discurso', 
                    value: searchInput.value, 
                    id: searchInput.dataset.selectedDiscursoId 
                };
            }
        });
        placeholder.id = `placeholder-${designacao.id}`;
        existingCard.parentNode.insertBefore(placeholder, existingCard);
    }

    removeActiveDesignationDisplay(designacao.id); 
    
    if (quantity <= 0) {
        if(placeholder && placeholder.parentNode) placeholder.remove();
        return;
    }

    const mainDisplayContainer = document.createElement('div');
    mainDisplayContainer.id = `active-designation-${designacao.id}`;
    
    for (let i = 1; i <= quantity; i++) {
        const instanceContainer = document.createElement('div');
        instanceContainer.className = 'active-designation-container';
        instanceContainer.style.marginTop = '20px';
        instanceContainer.style.padding = '15px 15px 45px 15px';
        instanceContainer.style.borderRadius = '8px';
        instanceContainer.style.position = 'relative';
        instanceContainer.dataset.designacaoId = designacao.id;
        
        const colors = ['rgba(46, 204, 113, 0.1)', 'rgba(52, 152, 219, 0.1)', 'rgba(243, 156, 18, 0.1)', 'rgba(155, 89, 182, 0.1)', 'rgba(231, 76, 60, 0.1)', 'rgba(192, 57, 43, 0.1)', 'rgba(142, 68, 173, 0.1)'];
        instanceContainer.style.backgroundColor = colors[(order - 1) % colors.length] || '#f8f9fa';
        
        const title = document.createElement('h5');
        title.textContent = `${designacao.nome}` + (quantity > 1 ? ` (${i})` : '');
        instanceContainer.appendChild(title);
        
        const numParticipantes = temporaryPreferences[`participantes-${designacao.id}-${i}`] || designacao.numeroParticipantes || 1;
        const roles = numParticipantes == 1 ? ["Participante"] : (numParticipantes == 2 ? ["Dirigente", "Ajudante 1"] : ["Dirigente", "Ajudante 1", "Ajudante 2"]);
        
        roles.forEach((role, index) => {
            instanceContainer.innerHTML += `<label style="display: block; font-size: 14px; color: #555; margin-top: 10px;">${role}</label><select id="participant-${designacao.id}-${i}-${index}" class="form-select"><option value="">Selecione...</option></select>`;
        });

        const descricaoContainer = document.createElement('div');
        descricaoContainer.className = 'descricao-container';
        descricaoContainer.style.display = 'none';

        // A condição crítica está aqui
        if (designacao.anexadoDiscursos === true || designacao.anexadoDiscursos === 'sim') {
            // Log para saber qual bloco foi executado
            if (designacao.nome === 'Necessidades Locais') console.log("[DEBUG] Bloco IF executado: Criando barra de pesquisa.");
            descricaoContainer.innerHTML = `
                <label style="display: block; font-size: 14px; color: #555; margin-top: 10px;">Discurso</label>
                <div class="discurso-search-wrapper" style="position: relative;">
                    <input type="text" class="form-select discurso-search-input" placeholder="Pesquisar por nº ou tema..." autocomplete="off" data-selected-discurso-id="">
                    <div class="search-suggestions discurso-suggestions"></div>
                </div>`;
        } else {
            // Log para saber qual bloco foi executado
             if (designacao.nome === 'Necessidades Locais') console.log("[DEBUG] Bloco ELSE executado: Criando campo de texto normal.");
            descricaoContainer.innerHTML = `
                <label style="display: block; font-size: 14px; color: #555; margin-top: 10px;">Descrição/Tema</label>
                <input type="text" class="form-select descricao-input" placeholder="Insira o tema ou descrição...">`;
        }
        instanceContainer.appendChild(descricaoContainer);
        
        // ... (resto do código da função continua igual)
        const filterIcon = document.createElement('i');
        filterIcon.className = 'fas fa-filter filter-icon';
        filterIcon.title = 'Filtrar';
        const filterPopup = document.createElement('div');
        filterPopup.className = 'filter-popup';

        filterPopup.innerHTML = `
            <h4>Filtros</h4>
            <div>
                <label>Nº de Participantes</label>
                <select class="num-participantes-select"> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> </select>
            </div>
            <div style="margin-top: 15px;">
                <label>Preferência de Género</label>
                <select class="genero-preferencia-select"> <option value="ambos">Masculino/Feminino</option> <option value="masculino">Masculino</option> <option value="feminino">Feminino</option> </select>
            </div>
            <div style="margin-top: 15px;">
                <label>Masculino com Feminino</label>
                <select class="gender-mix-select"> <option value="nao">Não</option> <option value="sim">Sim</option> </select>
            </div>
            <div style="margin-top: 15px;">
                <label>Descrição/Tema</label>
                <select class="descricao-tema-select"> <option value="sim">Sim</option> <option value="nao" selected>Não</option> </select>
            </div>
        `;
        instanceContainer.appendChild(filterPopup);
        instanceContainer.appendChild(filterIcon);
        
        const numParticipantesSelect = filterPopup.querySelector('.num-participantes-select');
        const generoPreferenciaSelect = filterPopup.querySelector('.genero-preferencia-select');
        const descricaoTemaSelect = filterPopup.querySelector('.descricao-tema-select');
        numParticipantesSelect.value = temporaryPreferences[`participantes-${designacao.id}-${i}`] || designacao.numeroParticipantes || 1;
        generoPreferenciaSelect.value = designacao.feitoPor ? designacao.feitoPor.toLowerCase() : 'ambos';
        descricaoTemaSelect.value = designacao.descricao === 'sim' || designacao.anexadoDiscursos === true ? 'sim' : 'nao';
        if (descricaoTemaSelect.value === 'sim') { descricaoContainer.style.display = 'block'; }
        filterIcon.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.filter-popup.active').forEach(p => { if (p !== filterPopup) p.classList.remove('active'); }); filterPopup.classList.toggle('active'); });
        numParticipantesSelect.addEventListener('change', (e) => { temporaryPreferences[`participantes-${designacao.id}-${i}`] = e.target.value; updateActiveDesignationDisplay(designacao, order, quantity); filterPopup.classList.remove('active'); });
        generoPreferenciaSelect.addEventListener('change', (e) => { const selectedIdiomas = getSelectedNacionalidades(); loadPeopleOptionsIntoSelects(designacao, instanceContainer, e.target.value, selectedIdiomas); filterPopup.classList.remove('active'); });
        descricaoTemaSelect.addEventListener('change', (e) => { descricaoContainer.style.display = e.target.value === 'sim' ? 'block' : 'none'; filterPopup.classList.remove('active'); });
        const lockIcon = document.createElement('i'); lockIcon.className = 'fas fa-lock-open lock-icon'; lockIcon.title = 'Bloquear/Desbloquear'; lockIcon.addEventListener('click', (e) => { const isLocked = instanceContainer.dataset.locked === 'true'; instanceContainer.dataset.locked = !isLocked; e.target.classList.toggle('fa-lock-open', isLocked); e.target.classList.toggle('fa-lock', !isLocked); e.target.classList.toggle('locked', !isLocked); }); instanceContainer.appendChild(lockIcon); const lupaIcon = document.createElement('i'); lupaIcon.className = 'fas fa-search-plus lupa-icon'; lupaIcon.title = 'Analisar Histórico'; lupaIcon.addEventListener('click', () => { const selected = Array.from(instanceContainer.querySelectorAll('.form-select')).map(s => ({ id: s.value, name: s.options[s.selectedIndex].text })).filter(p => p.id); if (selected.length === 1) { loadParticipantProfile(selected[0].id); document.getElementById('perfilPopup').style.display = 'flex'; } else if (selected.length > 1) { openPairAnalysisPopup(selected); } else { alert("Selecione pelo menos um participante."); } }); instanceContainer.appendChild(lupaIcon); const labIcon = document.createElement('i'); labIcon.className = 'fas fa-flask lab-icon'; labIcon.title = 'Laboratório de Combinações'; labIcon.addEventListener('click', () => { alert("Laboratório de Combinações (Funcionalidade Futura)"); }); instanceContainer.appendChild(labIcon);
        
        const searchInput = instanceContainer.querySelector('.discurso-search-input');
        if (searchInput) {
            const suggestionsContainer = instanceContainer.querySelector('.discurso-suggestions');
            const performSearch = () => {
                const query = searchInput.value.toLowerCase();
                suggestionsContainer.style.display = 'block';
                const resultados = allDiscursosCache.filter(d => d.numero.startsWith(query) || d.nome.toLowerCase().includes(query)).slice(0, 10);
                suggestionsContainer.innerHTML = '';
                if (resultados.length > 0) {
                    resultados.forEach(discurso => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.textContent = `${discurso.numero} - ${discurso.nome}`;
                        item.dataset.id = discurso.id;
                        item.dataset.fulltext = `${discurso.numero} - ${discurso.nome}`;
                        suggestionsContainer.appendChild(item);
                    });
                } else {
                    suggestionsContainer.innerHTML = '<div class="suggestion-item" style="pointer-events: none;">Nenhum discurso encontrado</div>';
                }
            };
            searchInput.addEventListener('focus', performSearch);
            searchInput.addEventListener('input', performSearch);
            searchInput.addEventListener('blur', () => setTimeout(() => { suggestionsContainer.style.display = 'none'; }, 200));
            suggestionsContainer.addEventListener('mousedown', (e) => {
                const target = e.target.closest('.suggestion-item');
                if (target && target.dataset.id) {
                    searchInput.value = target.dataset.fulltext;
                    searchInput.dataset.selectedDiscursoId = target.dataset.id;
                }
            });
        }
        mainDisplayContainer.appendChild(instanceContainer);
    }
    
    if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.replaceChild(mainDisplayContainer, placeholder);
    } else {
        containerToUse.appendChild(mainDisplayContainer);
    }

    const selectedIdiomas = getSelectedNacionalidades();
    await loadPeopleOptionsIntoSelects(designacao, mainDisplayContainer, designacao.feitoPor ? designacao.feitoPor.toLowerCase() : 'ambos', selectedIdiomas);

    mainDisplayContainer.querySelectorAll('.active-designation-container').forEach((instance, instanceIndex) => {
        if (savedSelections[instanceIndex]) {
            instance.querySelectorAll('.form-select:not(.descricao-input):not(.discurso-search-input)').forEach((select, selectIndex) => {
                if(savedSelections[instanceIndex][selectIndex]) select.value = savedSelections[instanceIndex][selectIndex];
            });
        }
        if (savedDescriptions[instanceIndex]) {
            if (savedDescriptions[instanceIndex].type === 'text') {
                const descInput = instance.querySelector('.descricao-input');
                if (descInput) descInput.value = savedDescriptions[instanceIndex].value;
            } else if (savedDescriptions[instanceIndex].type === 'discurso') {
                const searchInput = instance.querySelector('.discurso-search-input');
                if (searchInput) {
                    searchInput.value = savedDescriptions[instanceIndex].value;
                    searchInput.dataset.selectedDiscursoId = savedDescriptions[instanceIndex].id;
                }
            }
        }
    });
};
        
        const updateOrderButtonClasses = (button, order) => {
            button.className = 'order-button';
            if (order > 0) {
                button.classList.add('ordered');
                if (order >= 2) button.classList.add('ordered-level-2');
                if (order >= 3) button.classList.add('ordered-level-3');
                if (order >= 4) button.classList.add('ordered-level-4');
                if (order >= 5) button.classList.add('ordered-level-5');
                if (order >= 6) button.classList.add('ordered-level-6');
                if (order >= 7) button.classList.add('ordered-level-7');
            }
        };

        const getNextOrderNumber = () => {
            return document.querySelectorAll('#designacoesList .order-button.ordered').length + 1;
        };
        
        const reIndexOrderNumbers = () => {
            const activeItems = [];
            document.querySelectorAll('#designacoesList .designacao-item').forEach(item => {
                const button = item.querySelector('.order-button');
                const displayOrder = parseInt(button.dataset.order) || 0;
                
                if (displayOrder > 0) {
                    activeItems.push({
                        itemElement: item,
                        firestoreOrder: parseInt(item.dataset.firestoreOrder) || 999 
                    });
                }
            });

            activeItems.sort((a, b) => a.firestoreOrder - b.firestoreOrder);
            
            const container = document.getElementById('activeDesignationsContainer');
            const fragment = document.createDocumentFragment();
            activeItems.forEach(sortedItem => {
                const designacaoId = sortedItem.itemElement.dataset.designacaoId;
                const card = container.querySelector(`#active-designation-${designacaoId}`);
                if (card) {
                    fragment.appendChild(card);
                }
            });

            container.innerHTML = '';
            container.appendChild(fragment);

            activeItems.forEach((sortedItem, index) => {
                const newDisplayOrder = index + 1;
                const button = sortedItem.itemElement.querySelector('.order-button');
                
                button.dataset.order = newDisplayOrder; 
                
                updateOrderButtonClasses(button, newDisplayOrder);

                const designacaoId = sortedItem.itemElement.dataset.designacaoId;
                const card = container.querySelector(`#active-designation-${designacaoId}`);
                if (card) {
                    const colors = ['rgba(46, 204, 113, 0.1)', 'rgba(52, 152, 219, 0.1)', 'rgba(243, 156, 18, 0.1)', 'rgba(155, 89, 182, 0.1)', 'rgba(231, 76, 60, 0.1)', 'rgba(192, 57, 43, 0.1)', 'rgba(142, 68, 173, 0.1)'];
                    card.querySelectorAll('.active-designation-container').forEach(instance => {
                        instance.style.backgroundColor = colors[newDisplayOrder - 1] || '#f8f9fa';
                    });
                }
            });
        };

        const createQuantitySubmenu = (designacaoId, orderButton) => {
            const submenu = document.createElement('div');
            submenu.className = 'quantity-submenu';
            for (let i = 1; i <= 5; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'quantity-button';
                btn.textContent = i;
                btn.dataset.quantityValue = i;
                if (i === (parseInt(orderButton.dataset.quantity) || 1)) btn.classList.add('selected');
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const newQuantity = parseInt(e.target.dataset.quantityValue);
                    let order = parseInt(orderButton.dataset.order) || 0;
                    if (order === 0) {
                        order = getNextOrderNumber();
                        orderButton.dataset.order = order;
                    }
                    orderButton.dataset.quantity = newQuantity;
                    orderButton.textContent = newQuantity;
                    submenu.querySelectorAll('.quantity-button').forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                    updateOrderButtonClasses(orderButton, order);
                    await updateActiveDesignationDisplay(allDesignations.get(designacaoId), order, newQuantity);
                    submenu.classList.remove('active');
                    reIndexOrderNumbers();
                });
                submenu.appendChild(btn);
            }
            return submenu;
        };
        
        const formatDateForDisplay = (dateString) => {
            if (!dateString) return 'N/A';
            const [ano, mes, dia] = dateString.split('-');
            return `${dia}/${mes}/${ano}`;
        };

        const buildHistoryTable = (records, titleText, isPairAnalysis = false) => {
            const container = document.createElement('div');
            container.innerHTML = `<h3>${titleText}</h3>`;
            if (!records || records.length === 0) {
                container.innerHTML += '<p>Nenhum histórico encontrado.</p>';
                return container;
            }
            const table = document.createElement('table');
            table.className = 'estatisticas-table';
            table.innerHTML = `<thead><tr><th>Data</th><th>Designação</th><th>${isPairAnalysis ? 'Papéis' : 'Companheiros'}</th></tr></thead>`;
            const tbody = document.createElement('tbody');
            records.forEach(rec => {
                const tr = document.createElement('tr');
                let rolesHtml = 'N/A';
                if (rec.papeis) {
                    rolesHtml = Object.entries(rec.papeis)
                        .map(([role, personId]) => `<li><strong>${role}:</strong> ${(allPeopleDataMap.get(personId) || {}).nome || 'N/A'}</li>`)
                        .join('');
                    rolesHtml = `<ul style="padding-left: 15px; margin: 0;">${rolesHtml}</ul>`;
                }
                tr.innerHTML = `<td>${formatDateForDisplay(rec.dia)}</td><td>${rec.designacaoNome}</td><td>${isPairAnalysis ? rolesHtml : (rec.companheiros || 'Nenhum')}</td>`;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            container.appendChild(table);
            return container;
        };

        const fetchIndividualHistory = async (personId) => {
            const snapshot = await db.collection('historico').orderBy("dia", "desc").get();
            let records = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                data.designacoes?.forEach(d => {
                    const allIds = Object.values(d.participantes || {});
                    if (allIds.includes(personId)) {
                        records.push({
                            dia: data.dia,
                            designacaoNome: allDesignations.get(d.designacaoId)?.nome || 'Desconhecida',
                            companheiros: allIds.filter(id => id !== personId).map(id => (allPeopleDataMap.get(id) || {}).nome || '?').join(', ')
                        });
                    }
                });
            });
            return records;
        };

        const loadParticipantProfile = async (personId) => {
            const container = document.getElementById('perfilTableContainer');
            container.style.display = 'block';
            container.innerHTML = 'A carregar...';
            const history = await fetchIndividualHistory(personId);
            container.innerHTML = '';
            container.appendChild(buildHistoryTable(history, `Histórico de ${(allPeopleDataMap.get(personId) || {}).nome}`));
        };
        
        const fetchPairHistory = async (participantIds) => {
            const snapshot = await db.collection('historico').orderBy("dia", "desc").get();
            let records = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                data.designacoes?.forEach(d => {
                    const allIds = Object.values(d.participantes || {});
                    if (participantIds.every(id => allIds.includes(id))) {
                        records.push({
                            dia: data.dia,
                            designacaoNome: allDesignations.get(d.designacaoId)?.nome || 'Desconhecida',
                            papeis: d.participantes
                        });
                    }
                });
            });
            return records;
        };






        const openPairAnalysisPopup = async (participants) => {
            const popup = document.getElementById('pairAnalysisPopup');
            const title = document.getElementById('pairAnalysisTitle');
            const tabsContainer = document.getElementById('pairAnalysisTabsContainer');
            const contentContainer = document.getElementById('pairAnalysisContentContainer');
            
            title.textContent = `Análise de: ${participants.map(p => p.name).join(' & ')}`;
            popup.style.display = 'flex';
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';

            const pairHistory = await fetchPairHistory(participants.map(p => p.id));
            
            tabsContainer.innerHTML = `<button class="tab-button active" data-target="#content-history">Histórico do Par</button>`;
            contentContainer.innerHTML = `<div id="content-history" class="tab-content active"></div>`;
            document.getElementById('content-history').appendChild(buildHistoryTable(pairHistory, "Colaborações Anteriores", true));
        };

        document.getElementById('closePerfilPopup').addEventListener('click', () => document.getElementById('perfilPopup').style.display = 'none');
        document.getElementById('closePairAnalysisPopup').addEventListener('click', () => document.getElementById('pairAnalysisPopup').style.display = 'none');
        document.getElementById('closeLabPopup').addEventListener('click', () => document.getElementById('labPopup').style.display = 'none');
        
  document.getElementById('btnSeguinte').addEventListener('click', async function() {
    console.log("=====================================================");
    console.log("[DEBUG] Botão 'Seguinte' clicado. Iniciando verificação (v2)...");

    const tipoReuniao = document.getElementById('tipo').value;
    console.log(`[DEBUG] 1. Tipo de Reunião selecionado: "${tipoReuniao}"`);

    const specialEventTypes = ['memorial', 'assembleia', 'congresso', 'visita-servo'];

    if (specialEventTypes.includes(tipoReuniao)) {
        console.log(`[DEBUG] 2. O tipo "${tipoReuniao}" é um evento especial.`);

        const ano = await getAnoPainelFirebase();
        console.log(`[DEBUG] 3. Ano do painel: ${ano}`);

        const eventNameMap = {
            'memorial': 'Memorial',
            'assembleia': 'Assembleia',
            'congresso': 'Congresso',
            'visita-servo': 'Visita do Servo'
        };
        const eventNameForQuery = eventNameMap[tipoReuniao];
        console.log(`[DEBUG] 4. Nome para a consulta: "${eventNameForQuery}"`);

        if (eventNameForQuery) {
            const snapshot = await db.collection('eventos')
                .where('nome', '==', eventNameForQuery)
                .where('ano', '==', ano)
                .get();

            if (!snapshot.empty) {
                console.log(`[DEBUG] 5. SUCESSO! Foram encontrados ${snapshot.docs.length} evento(s) com este nome.`);
                
                const mes = parseInt(document.getElementById('mes').value);
                const semanaNumero = parseInt(document.getElementById('semanaNumero').value);
                const { monday: weekStart, sunday: weekEnd } = getWeekMondaySunday(ano, mes, semanaNumero);
                
                console.log(`[DEBUG] 6. Intervalo da semana a verificar: ${weekStart.toLocaleDateString()} a ${weekEnd.toLocaleDateString()}`);

                let overlapFound = false;

                // ===== INÍCIO DA LÓGICA CORRIGIDA =====
                // Agora percorremos TODOS os documentos encontrados
                for (const doc of snapshot.docs) {
                    const eventData = doc.data();
                    console.log(`[DEBUG] 7. A verificar o evento com data: ${eventData.data || (eventData.data_inicio + ' a ' + eventData.data_fim)}`);

                    // Verifica evento com data única
                    if (eventData.data) {
                        const eventDate = new Date(eventData.data + 'T12:00:00');
                        if (eventDate >= weekStart && eventDate <= weekEnd) {
                            overlapFound = true;
                            console.log(`[DEBUG] 8. VERDADEIRO! Sobreposição encontrada com este evento. A interromper a verificação.`);
                            break; // Interrompe o loop, pois já encontrámos uma correspondência
                        }
                    } 
                    // Verifica evento com data de início e fim
                    else if (eventData.data_inicio && eventData.data_fim) {
                        const eventStart = new Date(eventData.data_inicio + 'T00:00:00');
                        const eventEnd = new Date(eventData.data_fim + 'T23:59:59');
                        if (eventStart <= weekEnd && eventEnd >= weekStart) {
                            overlapFound = true;
                             console.log(`[DEBUG] 8. VERDADEIRO! Sobreposição encontrada com este evento. A interromper a verificação.`);
                            break; // Interrompe o loop
                        }
                    }
                }
                // ===== FIM DA LÓGICA CORRIGIDA =====


                if (overlapFound) {
                    console.log("[DEBUG] 9. A chamar o pop-up de confirmação.");
                    const confirmed = await showSpecialEventConfirmation(tipoReuniao);
                    if (confirmed) {
                        const success = await saveSpecialEvent();
                        if (success) {
                            alert(`Evento de ${eventNameForQuery} gravado com sucesso!`);
                            window.location.reload();
                        }
                    }
                    return; 
                } else {
                    console.log("[DEBUG] 8. FALSO. Nenhum dos eventos encontrados coincide com a semana selecionada.");
                }
            } else {
                console.warn(`[DEBUG] 5. AVISO! Nenhum evento correspondente encontrado para "${eventNameForQuery}" em ${ano}.`);
            }
        }
    } else {
         console.log(`[DEBUG] 2. O tipo "${tipoReuniao}" não é um evento especial.`);
    }

    console.log("[DEBUG] A continuar para o fluxo normal (mostrar designações).");
    document.getElementById('designacoesSection').classList.add('active');
    document.querySelector('#fluxoSemanalForm button[type="submit"]').style.display = 'block';
    
    const spacer = document.createElement('div');
    spacer.id = 'temp-scroll-spacer';
    spacer.style.height = '100vh';
    document.querySelector('.card').insertAdjacentElement('afterend', spacer);
    document.getElementById('designacoesList').scrollIntoView({ behavior: 'smooth', block: 'center' });
    await loadDesignacoes();
    document.getElementById('temp-scroll-spacer')?.remove();
});



        document.getElementById('designacoesList').addEventListener('click', async function(event) {
            const orderButton = event.target.closest('.order-button');
            if (!orderButton) return;

            const designacaoItem = orderButton.closest('.designacao-item');
            const designacaoId = designacaoItem.dataset.designacaoId;
            let currentOrder = parseInt(orderButton.dataset.order) || 0;
            let quantitySubmenu = designacaoItem.querySelector('.quantity-submenu');

            if (!quantitySubmenu) {
                quantitySubmenu = createQuantitySubmenu(designacaoId, orderButton);
                designacaoItem.appendChild(quantitySubmenu);
            }

            if (currentOrder > 0) {
                orderButton.dataset.order = 0;
                orderButton.textContent = '';
                orderButton.className = 'order-button';
                removeActiveDesignationDisplay(designacaoId);
                quantitySubmenu.classList.remove('active');
                reIndexOrderNumbers();
            } else {
                quantitySubmenu.classList.toggle('active');
            }
        });

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.designacao-item')) {
                document.querySelectorAll('.quantity-submenu.active').forEach(submenu => {
                    submenu.classList.remove('active');
                });
            }
        });

        document.getElementById('nacionalidades').addEventListener('change', () => {
            const selectedIdiomas = getSelectedNacionalidades();

            document.querySelectorAll('.active-designation-container').forEach(card => {
                const designacaoId = card.dataset.designacaoId;
                const designacao = allDesignations.get(designacaoId);

                if (designacao) {
                    const genderSelect = card.querySelector('.genero-preferencia-select');
                    const genderPreference = genderSelect ? genderSelect.value : 'ambos';
                    
                    loadPeopleOptionsIntoSelects(designacao, card, genderPreference, selectedIdiomas);
                }
            });
        });

        updateWeekDisplay();
        loadNacionalidades();
        initializeSystemData();
        
        fetch('slidebar.html').then(response => response.text()).then(html => document.getElementById("sidebar-placeholder").innerHTML = html);
    });
</script>

<script src="main.js"></script>

</body>
</html>
