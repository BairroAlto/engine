<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Escala - Reunião da Semana</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Estilos Gerais */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; display: flex; min-height: 100vh; background-color: #f5f6fa; color: #333; }

        /* Estilos da Sidebar */
        .sidebar { width: 250px; background-color: #2c3e50; color: white; padding-top: 20px; height: 100vh; position: fixed; left: 0; top: 0; display: flex; flex-direction: column; }
        .logo { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #34495e; }
        .logo h2 { margin: 0; }
        .nav-list { list-style: none; padding: 0; }
        .nav-item a { color: white; text-decoration: none; display: flex; align-items: center; padding: 15px 20px; transition: background-color 0.3s; }
        .nav-item a i { margin-right: 15px; width: 20px; text-align: center; }
        .nav-item a:hover { background-color: #34495e; }
        .nav-item.active a { background-color: #1abc9c; }

        /* Estilos do Conteúdo Principal */
        .content { margin-left: 250px; padding: 30px; flex-grow: 1; width: calc(100% - 250px); }
        h1 { color: #2c3e50; margin-bottom: 30px; font-size: 28px; }
        .card { background-color: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { color: #2c3e50; margin-bottom: 15px; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* Estilos para Filtros e Escala */
        #filters-container { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: bold; margin-bottom: 5px; font-size: 14px; color: #555; }
        .filter-group select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; background-color: #fff; }

        /* Estilos para os botões de ação */
        .action-buttons-container { margin-left: auto; display: flex; gap: 10px; }
        .action-button { padding: 8px 16px; font-size: 15px; font-weight: bold; border-radius: 4px; border: 1px solid transparent; cursor: pointer; transition: all 0.3s; }
        #edit-button { background-color: #3498db; color: white; border-color: #3498db; }
        #create-button { background-color: #2ecc71; color: white; border-color: #2ecc71; }
        .action-button:hover { opacity: 0.85; }
        #edit-button.active-edit { background-color: #e74c3c; border-color: #e74c3c; }

        #schedule-display { min-height: 100px; position: relative; }
        .loading-spinner { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; color: #3498db; }
        #schedule-display.loading .loading-spinner, .popup-body .loading-spinner { display: block; }
        #schedule-display.loading #schedule-content { opacity: 0.3; }
        
        .schedule-week { border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 20px; overflow: hidden; }
        .schedule-header { background-color: #34495e; color: white; padding: 12px 15px; font-size: 18px; }
        .schedule-body { padding: 15px; }
        .schedule-header-group { display: flex; align-items: center; background-color: #ecf0f1; padding: 8px 12px; border-radius: 4px; margin-top: 20px; margin-bottom: 10px; }
        .schedule-body > .schedule-header-group:first-child { margin-top: 0; }
        .header-icon { font-size: 18px; margin-right: 10px; }
        .schedule-header-group h4 { margin: 0; font-size: 16px; }
        .designation-list { list-style: none; padding-left: 15px; }
        .designation-item { margin-bottom: 10px; padding-left: 10px; border-left: 3px solid; border-left-color: #bdc3c7; }
        
        .designation-title-container { display: flex; justify-content: space-between; align-items: center; }
        .designation-title-container > strong { color: #2c3e50; }
        .edit-icon { color: #3498db; cursor: pointer; font-size: 16px; transition: color 0.2s; padding: 5px; }
        .edit-icon:hover { color: #2980b9; }

        .participant-list { list-style: none; padding-left: 20px; margin-top: 5px; }
        .participant-list li { color: #555; }
        .participant-list em { color: #7f8c8d; font-style: normal; font-size: 0.9em; }
        .special-event-message { text-align: center; padding: 40px 20px; font-size: 1.1em; font-weight: bold; color: #34495e; border: 2px dashed #bdc3c7; border-radius: 6px; margin: 10px; }
        .special-event-message i { display: block; font-size: 2em; margin-bottom: 15px; color: #1abc9c; }

        /* Estilos para Modals e Popups */
        .modal-overlay, .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active, .popup-overlay.active { display: flex; }
        .modal-content, .popup-content { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; position: relative; }
        .modal-header, .popup-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h3, .popup-title { color: #2c3e50; }
        .modal-close, .popup-close-button { font-size: 28px; font-weight: bold; color: #777; cursor: pointer; line-height: 1; background: none; border: none; }
        .modal-close:hover, .popup-close-button:hover { color: #333; }
        .popup-body .form-group { margin-bottom: 15px;}
        .popup-body .form-group label { font-weight: bold; margin-bottom: 5px; font-size: 14px; color: #555; }
        .popup-actions { margin-top: 20px; text-align: right; }
        #editPopupFilters .filter-group { min-width: 140px; } /* Ajuste de tamanho para os filtros do popup */


        /* Dropdowns */
        .form-select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }

        /* Validação de Erros */
        .form-select.invalid-selection { border: 2px solid #e74c3c; background-color: #fbeae5; }
        #validation-alert-container { display: none; position: fixed; bottom: 25px; right: 25px; z-index: 2000; }
        #validation-alert-icon { font-size: 36px; color: #e74c3c; cursor: pointer; background-color: white; border-radius: 50%; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        #validation-panel { display: none; position: absolute; bottom: 0; right: 0; width: 350px; background-color: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); overflow: hidden; }
        #validation-panel.active { display: block; }
        #validation-panel-header { display: flex; justify-content: space-between; padding: 10px 15px; background-color: #34495e; color: white; }
        #validation-panel-header h3 { margin: 0; font-size: 16px; }
        #validation-panel-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        #validation-list { list-style: none; padding: 15px; margin: 0; max-height: 250px; overflow-y: auto; }
        #validation-list li { padding: 8px 0; border-bottom: 1px solid #eee; }

        .btn-submit { background-color: #2ecc71; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        
        /* Tabelas e Estatísticas */
        .estatisticas-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        .estatisticas-table th, .estatisticas-table td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; }
        .estatisticas-table thead th { background-color: #34495e; color: white; }
        .estatisticas-table tbody tr:nth-child(even) { background-color: #f2f2f2; }
        body.popup-open { overflow: hidden; }
        #estatisticasPopup .popup-content, #perfilPopup .popup-content, #pairAnalysisPopup .popup-content, #editDesignationPopup .popup-content { display: flex; flex-direction: column; max-height: 90vh; }
        #estatisticasPopup .popup-body, #perfilPopup .popup-body, #pairAnalysisPopup .popup-body, #editDesignationPopup .popup-body { flex-grow: 1; overflow-y: auto; padding: 15px; }

        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar .logo h2, .sidebar .nav-item a span { display: none; }
            .content { margin-left: 70px; width: calc(100% - 70px); }
            #filters-container { flex-direction: column; align-items: stretch; }
            .action-buttons-container { margin-left: 0; margin-top: 15px; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><h2>Sistema de Escala</h2></div>
        <nav>
            <ul class="nav-list">
                <li class="nav-item"><a href="index.html"><i class="fas fa-tachometer-alt"></i><span>Painel</span></a></li>
                <li class="nav-item active"><a href="semana.html"><i class="fas fa-users"></i><span>Reunião Semana</span></a></li>
                <li class="nav-item"><a href="fimdesemana.html"><i class="fas fa-calendar-week"></i><span>Fim de Semana</span></a></li>
                <li class="nav-item"><a href="pregacao.html"><i class="fas fa-bullhorn"></i><span>Pregação</span></a></li>
                <li class="nav-item"><a href="estatisticas.html"><i class="fas fa-chart-bar"></i><span>Estatísticas</span></a></li>
                <li class="nav-item"><a href="nomes.html"><i class="fas fa-address-book"></i><span>Nomes</span></a></li>
                <li class="nav-item"><a href="iniciar.html"><i class="fas fa-play"></i><span>Iniciar</span></a></li>
                <li class="nav-item"><a href="criar.html"><i class="fas fa-plus"></i><span>Criar</span></a></li>
            </ul>
        </nav>
    </div>

    <main class="content">
        <h1>Reunião da Semana</h1>
        <div class="card">
            <h2>Escala da Reunião</h2>
            <div id="filters-container">
                <div class="filter-group"><label for="filter-ano">Ano</label><select id="filter-ano"></select></div>
                <div class="filter-group"><label for="filter-mes">Mês</label><select id="filter-mes"></select></div>
                <div class="filter-group"><label for="filter-semana">Semana</label><select id="filter-semana"></select></div>
                <div class="filter-group"><label for="filter-parte">Parte</label><select id="filter-parte"><option value="todas">Todas as Partes</option><option value="escola">Escola</option><option value="resto da semana">Vida e Ministério</option></select></div>
                <div class="filter-group"><label for="filter-sala">Sala</label><select id="filter-sala"><option value="todas">Todas as Salas</option><option value="salao-principal">Salão Principal</option><option value="segunda-sala">Segunda Sala</option><option value="terceira-sala">Terceira Sala</option></select></div>
                <div class="action-buttons-container">
                    <button id="edit-button" class="action-button">Editar</button>
                    <button id="create-button" class="action-button">Criar</button>
                </div>
            </div>
            <div id="schedule-display">
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                <div id="schedule-content"><p>Selecione os filtros para ver a escala.</p></div>
            </div>
        </div>
    </main>

    <!-- Modal de Ação Simples -->
    <div id="action-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Título do Modal</h3>
                <span id="modal-close-button" class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p id="modal-message">Mensagem do modal.</p>
            </div>
        </div>
    </div>

    <!-- ===== INÍCIO: HTML DE TODOS OS POPUPS AVANÇADOS ===== -->
    
    <!-- Popup de Edição de Designação -->
    <div id="editDesignationPopup" class="popup-overlay">
        <div class="popup-content" style="max-width: 90%; width: 800px;">
            <div class="popup-header">
                <h2 class="popup-title" id="editPopupTitle">Editar Designação</h2>
                <button class="popup-close-button" id="closeEditPopup">×</button>
            </div>
            <div class="popup-body">
                <div id="editPopupFilters" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                    <div class="filter-group" style="flex: 1;">
                        <label for="editNumParticipantes">Nº de Participantes</label>
                        <select id="editNumParticipantes" class="form-select" style="padding: 8px; font-size: 14px;"></select>
                    </div>
                    <div class="filter-group" style="flex: 1;">
                        <label for="editIdioma">Idioma</label>
                        <select id="editIdioma" class="form-select" style="padding: 8px; font-size: 14px;"></select>
                    </div>
                    <div class="filter-group" style="flex: 1;">
                        <label for="editGeneroPreferencia">Género</label>
                        <select id="editGeneroPreferencia" class="form-select" style="padding: 8px; font-size: 14px;"></select>
                    </div>
                    <div class="filter-group" style="flex: 1;">
                        <label for="editGeneroMix">Permitir Par Misto</label>
                        <select id="editGeneroMix" class="form-select" style="padding: 8px; font-size: 14px;"></select>
                    </div>
                </div>
                <div id="editPopupParticipants"></div>
            </div>
            <div class="popup-actions">
                <button class="btn-submit" id="saveDesignationChanges">Guardar Alterações</button>
            </div>
        </div>
    </div>

    <!-- Painel de Alerta de Validação -->
    <div id="validation-alert-container">
        <i id="validation-alert-icon" class="fas fa-exclamation-triangle" title="Alertas de Validação"></i>
        <div id="validation-panel">
            <div id="validation-panel-header">
                <h3>Regras Violadas</h3>
                <button id="validation-panel-close">×</button>
            </div>
            <ul id="validation-list"></ul>
        </div>
    </div>
    <!-- ===== FIM: HTML DE TODOS OS POPUPS AVANÇADOS ===== -->


    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD1fkxq6USO5RX22TlsPQFEaVSZoTj_t2A",
            authDomain: "escalas-6e0f9.firebaseapp.com",
            projectId: "escalas-6e0f9",
            storageBucket: "escalas-6e0f9.firebasestorage.app",
            messagingSenderId: "19118998563",
            appId: "1:19118998563:web:5412be658ae34bd45add96"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', async function() {
            // ===================================================================
            // INÍCIO: VARIÁVEIS GLOBAIS E DE CACHE
            // ===================================================================
            
            // Elementos da DOM
            const yearFilter = document.getElementById('filter-ano');
            const monthFilter = document.getElementById('filter-mes');
            const weekFilter = document.getElementById('filter-semana');
            const partFilter = document.getElementById('filter-parte');
            const roomFilter = document.getElementById('filter-sala');
            const editButton = document.getElementById('edit-button');
            const createButton = document.getElementById('create-button');
            const scheduleDisplay = document.getElementById('schedule-display');
            const scheduleContent = document.getElementById('schedule-content');
            
            // Modais e Popups
            const modalOverlay = document.getElementById('action-modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseButton = document.getElementById('modal-close-button');

            // --- CORREÇÃO: DECLARAÇÃO DE VARIÁVEIS MOVIDA PARA O TOPO ---
            const allPeopleDataMap = new Map();
            let allScheduleData = [];
            let allLanguagesCache = [];
            const personMap = new Map();
            const designationMap = new Map();
            const headerMap = new Map();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            let isEditMode = false;
            
            // ===================================================================
            // INÍCIO: LÓGICA DA PÁGINA PRINCIPAL (semana.html)
            // ===================================================================
            
            roomFilter.value = 'salao-principal';

            function openModal(title, message) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalOverlay.classList.add('active');
            }

            function closeModal() {
                modalOverlay.classList.remove('active');
            }

            async function loadInitialData() {
                scheduleDisplay.classList.add('loading');
                try {
                    const [historicoSnap, pessoasSnap, designacoesSnap, cabecalhosSnap] = await Promise.all([
                        db.collection('historico').where('quando', 'in', ['Semana', 'Fim de Semana']).where('tipo', '==', 'reuniao').orderBy('timestamp', 'desc').get(),
                        db.collection('pessoas').get(),
                        db.collection('designacoes').get(),
                        db.collection('cabecalhos').get()
                    ]);
                    
                    pessoasSnap.forEach(doc => {
                        personMap.set(doc.id, doc.data().nomePessoa);
                        allPeopleDataMap.set(doc.id, doc.data()); // Cache all person data for rules
                    });

                    designacoesSnap.forEach(doc => designationMap.set(doc.id, doc.data()));
                    cabecalhosSnap.forEach(doc => headerMap.set(doc.id, doc.data()));
                    allScheduleData = historicoSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    populateYearFilter();
                    updateMonthFilter();
                    updateWeekFilter();
                } catch (error) {
                    console.error("Erro ao carregar dados iniciais:", error);
                    scheduleContent.innerHTML = `<p style="color: red;">Ocorreu um erro ao carregar os dados. Tente novamente mais tarde.</p>`;
                } finally { 
                    scheduleDisplay.classList.remove('loading'); 
                }
            }

            function populateYearFilter() {
                const years = [...new Set(allScheduleData.map(item => item.ano))].sort((a, b) => b - a);
                yearFilter.innerHTML = ''; 
                years.forEach(year => { 
                    const option = document.createElement('option'); 
                    option.value = year; 
                    option.textContent = year; 
                    yearFilter.appendChild(option); 
                });
                yearFilter.value = new Date().getFullYear();
            }

            function updateMonthFilter() {
                const selectedYear = parseInt(yearFilter.value);
                const monthsInYear = [...new Set(allScheduleData.filter(item => item.ano === selectedYear).map(item => item.mes))].sort((a, b) => a - b);
                monthFilter.innerHTML = '<option value="todos">Todos os Meses</option>';
                monthsInYear.forEach(monthNum => { 
                    const option = document.createElement('option'); 
                    option.value = monthNum; 
                    option.textContent = monthNames[monthNum - 1]; 
                    monthFilter.appendChild(option); 
                });
                const currentMonth = new Date().getMonth() + 1;
                if (monthsInYear.includes(currentMonth)) { 
                    monthFilter.value = currentMonth; 
                } else { 
                    monthFilter.value = 'todos';
                }
            }

            function updateWeekFilter() {
                const selectedYear = parseInt(yearFilter.value);
                const selectedMonth = monthFilter.value === 'todos' ? null : parseInt(monthFilter.value);
                let filteredWeeks = allScheduleData.filter(item => item.ano === selectedYear);
                if (selectedMonth) { 
                    filteredWeeks = filteredWeeks.filter(item => item.mes === selectedMonth); 
                }
                const weeksByMonth = filteredWeeks.reduce((acc, item) => { 
                    if (!acc[item.mes]) acc[item.mes] = new Set(); 
                    if (item.semanaindex) acc[item.mes].add(item.semanaindex); 
                    return acc; 
                }, {});
                
                weekFilter.innerHTML = '<option value="todas">Todas as Semanas</option>';

                Object.keys(weeksByMonth).sort((a, b) => a - b).forEach(monthNum => {
                    const optgroup = document.createElement('optgroup'); 
                    optgroup.label = monthNames[monthNum - 1];
                    
                    const weekIndexes = [...new Set(filteredWeeks.filter(w => w.mes == monthNum).map(w => w.semanaindex))];

                    weekIndexes.sort((a, b) => {
                        const diaA = parseInt((a.match(/\d+/) || ["0"])[0], 10);
                        const diaB = parseInt((b.match(/\d+/) || ["0"])[0], 10);
                        return diaA - diaB;
                    });

                    weekIndexes.forEach(weekIndex => { 
                        if (!weekIndex) return;
                        const option = document.createElement('option'); 
                        option.value = weekIndex; 
                        option.textContent = weekIndex; 
                        optgroup.appendChild(option); 
                    });
                    weekFilter.appendChild(optgroup);
                });

                const hoje = new Date();
                if (selectedYear === hoje.getFullYear() && (selectedMonth === (hoje.getMonth() + 1) || selectedMonth === null)) {
                    let melhorOpcao = null;
                    let menorDiferenca = Infinity;
                    const diaAtual = hoje.getDate();

                    for (const option of weekFilter.options) {
                        if (option.value === 'todas') continue; 
                        const diaInicio = parseInt((option.textContent.match(/\d+/) || ["99"])[0], 10);
                        if (!isNaN(diaInicio)) {
                            const diferenca = diaAtual - diaInicio;
                            if (diferenca >= 0 && diferenca < menorDiferenca) {
                                menorDiferenca = diferenca;
                                melhorOpcao = option.value;
                            }
                        }
                    }
                    if (melhorOpcao) { 
                        weekFilter.value = melhorOpcao; 
                    }
                }
                
                if (weekFilter.value === 'todas' && isEditMode) {
                    isEditMode = false;
                }
                renderSchedule();
            }
            
            function renderSchedule() {
                scheduleDisplay.classList.add('loading');
                scheduleContent.innerHTML = '';
                
                editButton.classList.toggle('active-edit', isEditMode);
                editButton.textContent = isEditMode ? 'Concluir' : 'Editar';

                const selectedYear = parseInt(yearFilter.value);
                const selectedMonth = monthFilter.value === 'todos' ? null : parseInt(monthFilter.value);
                const selectedWeek = weekFilter.value;
                const selectedPart = partFilter.value;
                const selectedRoom = roomFilter.value;

                let timeFilteredData = allScheduleData.filter(item => 
                    item.ano === selectedYear &&
                    (!selectedMonth || item.mes === selectedMonth) &&
                    (selectedWeek === 'todas' || item.semanaindex === selectedWeek) &&
                    (selectedRoom === 'todas' || item.sala === selectedRoom)
                );

                const normalizeKey = (key) => key ? key.replace(/\s+/g, '').replace(/-/g, '') : '';
                const groupedByWeek = timeFilteredData.reduce((acc, item) => {
                    const key = normalizeKey(item.semanaindex); 
                    if (!key) return acc;
                    if (!acc[key]) {
                        acc[key] = { originalIndex: item.semanaindex, items: [] };
                    }
                    acc[key].items.push(item);
                    return acc;
                }, {});

                if (Object.keys(groupedByWeek).length === 0) {
                    scheduleContent.innerHTML = '<p>Nenhuma escala encontrada para os filtros selecionados.</p>';
                    scheduleDisplay.classList.remove('loading');
                    return;
                }

                const sortedWeekKeys = Object.keys(groupedByWeek).sort((keyA, keyB) => {
                    const weekStringA = groupedByWeek[keyA].originalIndex;
                    const weekStringB = groupedByWeek[keyB].originalIndex;
                    const dayA = parseInt((weekStringA.match(/\d+/) || ['0'])[0], 10);
                    const dayB = parseInt((weekStringB.match(/\d+/) || ['0'])[0], 10);
                    return dayA - dayB;
                });

                for (const normalizedKey of sortedWeekKeys) {
                    const group = groupedByWeek[normalizedKey];
                    const weekIndex = group.originalIndex; 
                    const weekData = group.items;         
                    const weekElement = document.createElement('div');
                    weekElement.className = 'schedule-week';
                    let headerHTML = `<div class="schedule-header">${weekIndex}</div>`;
                    let bodyHTML = '<div class="schedule-body">';
                    
                    const specialEventData = weekData.find(item => item.evento);
                    if (specialEventData && ['memorial', 'assembleia', 'congresso'].includes(specialEventData.evento.toLowerCase())) {
                        const eventName = specialEventData.evento.charAt(0).toUpperCase() + specialEventData.evento.slice(1);
                        const eventIcon = { memorial: 'fa-wine-glass', assembleia: 'fa-users', congresso: 'fa-landmark' }[specialEventData.evento.toLowerCase()] || 'fa-star';
                        bodyHTML += `<div class="special-event-message"><i class="fas ${eventIcon}"></i>Semana de ${eventName}</div>`;
                    } else {
                        let lastHeaderId = null;
                        let lastHeaderColor = '#bdc3c7'; 
                        let cumulativeIndex = 0;

                        weekData.forEach(doc => {
                            const sortedDesignationsInDoc = (doc.designacoes || []).sort((a, b) => {
                                const desigA = designationMap.get(a.designacaoId);
                                const desigB = designationMap.get(b.designacaoId);
                                return (desigA?.ordem || 999) - (desigB?.ordem || 999);
                            });

                            if(sortedDesignationsInDoc.length === 0 && weekData.length === 1) {
                                bodyHTML += '<p style="text-align:center; color:#777; padding: 20px;">Nenhuma designação para esta semana.</p>';
                            }

                            sortedDesignationsInDoc.forEach(desig => {
                                const fullDesigData = designationMap.get(desig.designacaoId);
                                if (!fullDesigData) return;
                                if (selectedPart !== 'todas' && fullDesigData.parte !== selectedPart) return;
                                
                                const desigName = fullDesigData.nome;
                                const currentHeaderId = fullDesigData.anexo;
                                if (currentHeaderId && currentHeaderId !== lastHeaderId) {
                                    const headerData = headerMap.get(currentHeaderId);
                                    if (headerData) {
                                        const bgColor = headerData.cor || '#ecf0f1';
                                        const textColor = getContrastColor(bgColor);
                                        lastHeaderColor = bgColor; 
                                        const headerStyle = `style="background-color: ${bgColor}; color: ${textColor};"`;
                                        bodyHTML += `<div class="schedule-header-group" ${headerStyle}><span class="header-icon">${headerData.icon || ''}</span><h4>${headerData.nome}</h4></div>`;
                                    }
                                    lastHeaderId = currentHeaderId;
                                }

                                const itemStyle = `style="border-left-color: ${lastHeaderColor};"`;
                                bodyHTML += `<ul class="designation-list"><li class="designation-item" ${itemStyle}>`;
                                bodyHTML += `<div class="designation-title-container"><strong>${desigName}</strong>`;
                                
                                if (isEditMode) {
                                    bodyHTML += `<i class="fas fa-pencil-alt edit-icon" data-designation-index="${cumulativeIndex}"></i>`;
                                }

                                bodyHTML += `</div>`;
                                
                                if (desig.participantes && Object.keys(desig.participantes).length > 0) {
                                    bodyHTML += '<ul class="participant-list">';
                                    for (const [role, personId] of Object.entries(desig.participantes)) {
                                        const personName = personMap.get(personId) || 'N/A';
                                        const formattedRole = role.charAt(0).toUpperCase() + role.slice(1);
                                        bodyHTML += `<li><em>${formattedRole}:</em> ${personName}</li>`;
                                    }
                                    bodyHTML += '</ul>';
                                }
                                bodyHTML += '</li></ul>';
                                cumulativeIndex++;
                            });
                        });
                    }
                    
                    bodyHTML += '</div>';
                    weekElement.innerHTML = headerHTML + bodyHTML;
                    scheduleContent.appendChild(weekElement);
                }
                scheduleDisplay.classList.remove('loading');
            }
            
            function getContrastColor(hexColor) {
                if (!hexColor) return '#333';
                const r = parseInt(hexColor.substr(1, 2), 16);
                const g = parseInt(hexColor.substr(3, 2), 16);
                const b = parseInt(hexColor.substr(5, 2), 16);
                const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                return (yiq >= 128) ? '#000000' : '#FFFFFF';
            }

            // Event Listeners da página original
            editButton.addEventListener('click', () => {
                if (weekFilter.value === 'todas') {
                    openModal('Ação Bloqueada', 'Por favor, selecione uma semana específica para poder editar.');
                    return;
                }
                isEditMode = !isEditMode;
                renderSchedule();
            });

            createButton.addEventListener('click', () => {
                if (weekFilter.value === 'todas') {
                    openModal('Ação Bloqueada', 'Por favor, selecione uma semana para usar como modelo para a criação.');
                    return;
                }
                openModal('Criar Nova Escala', `Você está criando uma nova escala usando a semana "${weekFilter.value}" como modelo.`);
            });

            modalCloseButton?.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (event) => { if (event.target === modalOverlay) closeModal(); });
            yearFilter.addEventListener('change', () => { updateMonthFilter(); updateWeekFilter(); });
            monthFilter.addEventListener('change', () => { updateWeekFilter(); });
            weekFilter.addEventListener('change', () => { if (isEditMode) isEditMode = false; renderSchedule(); });
            partFilter.addEventListener('change', renderSchedule);
            roomFilter.addEventListener('change', renderSchedule); 
            
            // ===================================================================
            // INÍCIO: CÓDIGO AVANÇADO (LÓGICA DE EDIÇÃO E VALIDAÇÃO)
            // ===================================================================
            
            // --- Lógica de Sincronização de Género ---
            const handleGenderSync = (changedSelect) => {
                const instanceContainer = changedSelect.closest('.popup-body');
                if (!instanceContainer) return;

                const genderMixSelect = instanceContainer.querySelector('#editGeneroMix');
                
                if (genderMixSelect && genderMixSelect.value === 'sim') {
                    const allSelectsInInstance = instanceContainer.querySelectorAll('.form-select');
                    allSelectsInInstance.forEach(select => {
                        Array.from(select.options).forEach(option => option.style.display = '');
                    });
                    return;
                }

                const allSelectsInInstance = instanceContainer.querySelectorAll('#editPopupParticipants .form-select');
                const selectedPersonId = changedSelect.value;

                if (!selectedPersonId) {
                    allSelectsInInstance.forEach(select => {
                        Array.from(select.options).forEach(option => option.style.display = '');
                    });
                    allSelectsInInstance.forEach(select => { if (select.value) handleGenderSync(select); });
                    return;
                }

                const personData = allPeopleDataMap.get(selectedPersonId);
                if (!personData || !personData.genero) return;
                const requiredGender = personData.genero;

                allSelectsInInstance.forEach(select => {
                    if (select !== changedSelect && select.value) {
                        const otherPersonData = allPeopleDataMap.get(select.value);
                        if (!otherPersonData || otherPersonData.genero !== requiredGender) select.value = '';
                    }
                    Array.from(select.options).forEach(option => {
                        if (!option.value) {
                            option.style.display = '';
                            return;
                        }
                        const optionPersonData = allPeopleDataMap.get(option.value);
                        if (optionPersonData && optionPersonData.genero === requiredGender) {
                            option.style.display = '';
                        } else {
                            option.style.display = 'none';
                        }
                    });
                });
            };
            
            // --- Funções de Validação em Tempo Real ---
            const getRecentPairs = async () => {
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 12);
                const recentPairsMap = new Map();
                const snapshot = await db.collection('historico').where("timestamp", ">=", startDate).get();
                snapshot.forEach(doc => {
                    doc.data().designacoes?.forEach(desig => {
                        if (desig.participantes && Object.keys(desig.participantes).length >= 2) {
                            const ids = Object.values(desig.participantes).sort();
                            const pairKey = ids.join('_');
                            if (!recentPairsMap.has(pairKey) || new Date(doc.data().dia) > new Date(recentPairsMap.get(pairKey).lastDate)) {
                                recentPairsMap.set(pairKey, { lastDate: doc.data().dia });
                            }
                        }
                    });
                });
                return recentPairsMap;
            };

            const getParticipantsForWeek = async (ano, mes, semana) => {
                if(!ano || !mes || !semana) return new Set();
                const q = db.collection('historico')
                    .where("ano", "in", [ano, String(ano)]) 
                    .where("mes", "==", mes)
                    .where("semanaNumero", "==", semana)
                    .where("quando", "==", "Semana");
                const snapshot = await q.get();
                const participants = new Set();
                if (!snapshot.empty) {
                    snapshot.docs[0].data().designacoes?.forEach(desig => {
                        Object.values(desig.participantes || {}).forEach(id => participants.add(id));
                    });
                }
                return participants;
            }

            const getPreviousWeekContext = async (currentAno, currentMes, currentSemana) => {
                 if (currentSemana > 1) {
                    return { ano: currentAno, mes: currentMes, semana: currentSemana - 1 };
                } else {
                    let prevMes = currentMes - 1;
                    let prevAno = currentAno;
                    if (prevMes === 0) {
                        prevMes = 12;
                        prevAno = currentAno - 1;
                    }
                    const q = db.collection('historico').where('ano', '==', prevAno).where('mes', '==', prevMes).orderBy('semanaNumero', 'desc').limit(1);
                    const snapshot = await q.get();
                    if (!snapshot.empty) {
                        return { ano: prevAno, mes: prevMes, semana: snapshot.docs[0].data().semanaNumero };
                    }
                    return { ano: prevAno, mes: prevMes, semana: 4 }; // Fallback
                }
            }

            const getNextWeekContext = async (currentAno, currentMes, currentSemana) => {
                const q = db.collection('historico').where('ano', '==', currentAno).where('mes', '==', currentMes).orderBy('semanaNumero', 'desc').limit(1);
                const snapshot = await q.get();
                if (!snapshot.empty && currentSemana < snapshot.docs[0].data().semanaNumero) {
                    return { ano: currentAno, mes: currentMes, semana: currentSemana + 1 };
                } else {
                    let nextMes = currentMes + 1;
                    let nextAno = currentAno;
                    if (nextMes === 13) {
                        nextMes = 1;
                        nextAno = currentAno + 1;
                    }
                    return { ano: nextAno, mes: nextMes, semana: 1 };
                }
            }

            const getParticipantsLastWeek = async (ano, mes, semana) => {
                const prev = await getPreviousWeekContext(ano, mes, semana);
                return getParticipantsForWeek(prev.ano, prev.mes, prev.semana);
            };

            const getParticipantsNextWeek = async (ano, mes, semana) => {
                const next = await getNextWeekContext(ano, mes, semana);
                return getParticipantsForWeek(next.ano, next.mes, next.semana);
            };

            // --- Lógica do Popup de Edição ---
            const editDesignationPopup = document.getElementById('editDesignationPopup');
            const closeEditPopup = document.getElementById('closeEditPopup');
            const saveDesignationChangesBtn = document.getElementById('saveDesignationChanges');
            const editPopupParticipantsContainer = document.getElementById('editPopupParticipants');

            let currentEditData = {
                historicoId: null,
                originalDesignation: null,
                historicoDocRefId: null
            };
            
        async function openEditDesignationPopup(designationIndex) {
    const selectedWeekValue = weekFilter.value;
    const weekHistoricoDocs = allScheduleData.filter(item => item.semanaindex === selectedWeekValue);

    let targetHistoricoDoc = null;
    let targetDesignationObj = null;
    let cumulativeIndex = 0;

    for (const doc of weekHistoricoDocs) {
        const sortedDesignationsInDoc = (doc.designacoes || []).sort((a, b) => {
            const desigA = designationMap.get(a.designacaoId);
            const desigB = designationMap.get(b.designacaoId);
            return (desigA?.ordem || 999) - (desigB?.ordem || 999);
        });

        if (designationIndex >= cumulativeIndex && designationIndex < cumulativeIndex + sortedDesignationsInDoc.length) {
            targetHistoricoDoc = doc;
            targetDesignationObj = sortedDesignationsInDoc[designationIndex - cumulativeIndex];
            break;
        }
        cumulativeIndex += sortedDesignationsInDoc.length;
    }

    if (!targetHistoricoDoc || !targetDesignationObj) {
        console.error("Não foi possível encontrar os dados da designação clicada.");
        openModal("Erro", "Não foi possível carregar os dados para edição.");
        return;
    }

    const fullDesigData = designationMap.get(targetDesignationObj.designacaoId);

    currentEditData.originalDesignation = JSON.parse(JSON.stringify(targetDesignationObj));
    currentEditData.historicoDocRefId = targetHistoricoDoc.id;

    document.getElementById('editPopupTitle').textContent = `Editar: ${fullDesigData.nome}`;

    const numParticipantesSelect = document.getElementById('editNumParticipantes');
    const idiomaSelect = document.getElementById('editIdioma');
    const generoPreferenciaSelect = document.getElementById('editGeneroPreferencia');
    const generoMixSelect = document.getElementById('editGeneroMix');
    
    numParticipantesSelect.innerHTML = '<option value="1">1</option><option value="2">2</option><option value="3">3</option>';
    generoPreferenciaSelect.innerHTML = '<option value="masculino feminino">Qualquer Género</option><option value="masculino">Masculino</option><option value="feminino">Feminino</option>';
    generoMixSelect.innerHTML = '<option value="nao">Não</option><option value="sim">Sim</option>';
    
    if (allLanguagesCache.length === 0) {
        const nacSnap = await db.collection('nacionalidades').orderBy('nome').get();
        nacSnap.forEach(doc => allLanguagesCache.push(doc.data().nome));
    }
    idiomaSelect.innerHTML = '<option value="todos">Todos</option>';
    allLanguagesCache.forEach(lang => idiomaSelect.add(new Option(lang, lang)));

    // ===== CORREÇÃO APLICADA AQUI =====
    // A variável 'item' foi substituída pela correta 'targetDesignationObj'
    const currentParticipantsCount = Object.keys(targetDesignationObj.participantes || {}).length;
    // ===================================
    
    numParticipantesSelect.value = currentParticipantsCount > 0 ? currentParticipantsCount : (fullDesigData.numeroParticipantes || 1);
    
    generoPreferenciaSelect.value = "masculino feminino";
    generoMixSelect.value = "nao";
    idiomaSelect.value = "todos";

    await generateEditPopupUI(targetHistoricoDoc, fullDesigData);

    [numParticipantesSelect, generoPreferenciaSelect, idiomaSelect].forEach(el => {
        el.onchange = () => generateEditPopupUI(targetHistoricoDoc, fullDesigData);
    });
    generoMixSelect.onchange = () => {
        const firstSelect = editPopupParticipantsContainer.querySelector('.form-select');
        if (firstSelect) handleGenderSync(firstSelect);
    };

    editDesignationPopup.classList.add('active');
    document.body.classList.add('popup-open');
}


            
            async function generateEditPopupUI(historicoDoc, fullDesigData) {
                editPopupParticipantsContainer.innerHTML = '<div class="loading-spinner" style="display: block; position: relative; top: auto; left: auto; transform: none;"><i class="fas fa-spinner fa-spin"></i></div>';
            
                const numParticipantes = parseInt(document.getElementById('editNumParticipantes').value);
                const idiomaPreferencia = document.getElementById('editIdioma').value;
                const generoPreferencia = document.getElementById('editGeneroPreferencia').value;
                const originalParticipants = currentEditData.originalDesignation.participantes || {};
            
                const participantRoles = [];
                if (numParticipantes === 1) participantRoles.push({ key: 'participante', label: "Participante" });
                else if (numParticipantes === 2) participantRoles.push({ key: 'dirigente', label: "Dirigente" }, { key: 'morador', label: "Morador" });
                else if (numParticipantes >= 3) participantRoles.push({ key: 'dirigente', label: "Dirigente" }, { key: 'morador', label: "Morador" }, { key: 'ajudante', label: "Ajudante" });
            
                let dropdownsHTML = '';
                participantRoles.forEach((role, i) => {
                    dropdownsHTML += `<div class="form-group"><label>${role.label}</label><select class="form-select" data-role-key="${role.key}" data-role-index="${i}"></select></div>`;
                });
                editPopupParticipantsContainer.innerHTML = dropdownsHTML;
            
                const allSelects = editPopupParticipantsContainer.querySelectorAll('.form-select');
                for (const select of allSelects) {
                    await populateSingleEditDropdown(select, historicoDoc, fullDesigData, generoPreferencia, idiomaPreferencia);
                    const roleKey = select.dataset.roleKey;
                    if (originalParticipants[roleKey] && select.querySelector(`option[value="${originalParticipants[roleKey]}"]`)) {
                        select.value = originalParticipants[roleKey];
                    }
                    select.addEventListener('change', () => {
                        handleGenderSync(select);
                        validatePopupSelections(historicoDoc);
                    });
                }
            
                if (allSelects.length > 0) {
                    handleGenderSync(allSelects[0]);
                    validatePopupSelections(historicoDoc);
                }
            }
            
          async function populateSingleEditDropdown(selectElement, historicoDoc, fullDesigData, generoPreferencia, idiomaPreferencia) {
    selectElement.innerHTML = '<option value="">Selecione...</option>';
    const roleIndex = parseInt(selectElement.dataset.roleIndex);
    const meetingDate = historicoDoc.dia;
    
    const eligiblePeople = [];
    for (const [personId, person] of allPeopleDataMap.entries()) {
        // Filtro 1: A pessoa faz designações na reunião e tem esta designação específica?
        if (!person.fazDesignacoesReuniao || !person.designacoesReuniao?.includes(fullDesigData.nome)) continue;
        
        // Filtro 2: A pessoa tem o privilégio congregacional necessário?
        const hasPrivilege = fullDesigData.quemFaz.some(priv => person.privilegiosCongregacao?.includes(priv));
        if (!hasPrivilege) continue;
        
        // Filtro 3: A pessoa corresponde ao filtro de género selecionado?
        if ((generoPreferencia === 'masculino' && person.genero !== 'Masculino') || (generoPreferencia === 'feminino' && person.genero !== 'Feminino')) continue;
        
        // Filtro 4: A pessoa corresponde ao filtro de idioma?
        if (idiomaPreferencia !== 'todos' && person.idioma !== idiomaPreferencia) continue;
        
        // Filtro 5: A pessoa está ausente na data da reunião?
        if (person.ausencias?.includes(meetingDate)) continue;
        
        // Filtro 6: A pessoa tem a personalidade adequada para a designação?
        let personalityOK = true;
        if (roleIndex === 0 && person.personalidade === '- à vontade' && !fullDesigData.personalidade?.includes('- à vontade')) {
            personalityOK = false;
        }
        if (!personalityOK) continue;

        eligiblePeople.push({ id: personId, name: person.nomePessoa });
    }

    // Ordena as pessoas elegíveis por nome e adiciona ao dropdown
    eligiblePeople.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
        selectElement.add(new Option(p.name, p.id));
    });
}

            
          async function validatePopupSelections(historicoDoc, fullDesigData) {
    const popupSelects = editPopupParticipantsContainer.querySelectorAll('.form-select');
    const allViolations = new Set();
    const validationList = document.getElementById('validation-list');
    const alertContainer = document.getElementById('validation-alert-container');

    popupSelects.forEach(s => s.classList.remove('invalid-selection'));
    validationList.innerHTML = '';

    const context = { ano: historicoDoc.ano, mes: historicoDoc.mes, semana: historicoDoc.semanaNumero };
    const [lastWeek, nextWeek, recentPairs] = await Promise.all([
        getParticipantsLastWeek(context.ano, context.mes, context.semana),
        getParticipantsNextWeek(context.ano, context.mes, context.semana),
        getRecentPairs()
    ]);
    
    // NOVO: Mapear todas as outras designações e seus participantes na semana atual
    const currentWeekAssignments = new Map();
    // NOVO: Obter o ID da designação que está sendo editada
    const currentlyEditedDesignationId = currentEditData.originalDesignation.designacaoId;

    // NOVO: Filtrar os documentos do histórico para encontrar apenas os da semana atual
    const weekHistoricoDocs = allScheduleData.filter(item =>
        item.ano === historicoDoc.ano &&
        item.mes === historicoDoc.mes &&
        item.semanaNumero === historicoDoc.semanaNumero
    );

    // NOVO: Iterar sobre os documentos da semana para construir o mapa de participantes
    for (const doc of weekHistoricoDocs) {
        for (const desig of doc.designacoes) {
            // Ignora a própria designação que estamos editando para evitar autoconflito
            if (desig.designacaoId === currentlyEditedDesignationId) continue;
            
            for (const personId of Object.values(desig.participantes)) {
                // Mapeia o ID da pessoa para o ID da designação que ela já tem
                currentWeekAssignments.set(personId, desig.designacaoId);
            }
        }
    }


    const selections = new Map();
    const currentPair = [];

    for (const select of popupSelects) {
        if (select.value) {
            const personId = select.value;
            const personName = select.options[select.selectedIndex].text;
            currentPair.push({id: personId, el: select, name: personName});

            // Validação 1: Dupla seleção no mesmo popup
            if (selections.has(personId)) {
                allViolations.add(`${personName} está selecionado mais de uma vez.`);
                select.classList.add('invalid-selection');
                selections.get(personId).el.classList.add('invalid-selection');
            } else {
                selections.set(personId, { el: select });
            }
            
            // Validação 2: Semana anterior
            if (lastWeek.has(personId)) { allViolations.add(`${personName} participou na semana anterior.`); select.classList.add('invalid-selection'); }
            
            // Validação 3: Semana seguinte
            if (nextWeek.has(personId)) { allViolations.add(`${personName} já está na semana seguinte.`); select.classList.add('invalid-selection'); }

            // ==========================================================
            // NOVO: INÍCIO DA LÓGICA DE VALIDAÇÃO DE BLOQUEIO
            // ==========================================================
            if (currentWeekAssignments.has(personId)) {
                // A pessoa selecionada já tem outra tarefa esta semana.
                const existingAssignmentId = currentWeekAssignments.get(personId);
                const existingAssignmentData = designationMap.get(existingAssignmentId);
                
                // Verifica se a designação existente possui regras de bloqueio
                if (existingAssignmentData && existingAssignmentData.bloqueio) {
                    
                    // A regra é: A designação EXISTENTE bloqueia a designação NOVA (que estamos editando)?
                    const blockRule = existingAssignmentData.bloqueio[currentlyEditedDesignationId];
                    
                    if (blockRule === "Não") {
                        const errorMessage = `${personName} já está a fazer "${existingAssignmentData.nome}" esta semana.`;
                        allViolations.add(errorMessage);
                        select.classList.add('invalid-selection');
                    }
                }
            }
            // ==========================================================
            // NOVO: FIM DA LÓGICA DE VALIDAÇÃO DE BLOQUEIO
            // ==========================================================
        }
    }

    // Validação 4: Pares recentes
    if (currentPair.length >= 2) {
        const pairKey = currentPair.map(p => p.id).sort().join('_');
        if (recentPairs.has(pairKey)) {
             const lastDate = new Date(recentPairs.get(pairKey).lastDate);
             const meetingDate = new Date(historicoDoc.dia + "T12:00:00Z");
             const monthDiff = (meetingDate.getFullYear() - lastDate.getFullYear()) * 12 + meetingDate.getMonth() - lastDate.getMonth();
             if (monthDiff <= 1) {
                 allViolations.add(`${currentPair.map(p => p.name).join(' e ')} trabalharam juntos recentemente.`);
                 currentPair.forEach(p => p.el.classList.add('invalid-selection'));
             }
        }
    }
    
    if (allViolations.size > 0) {
        allViolations.forEach(msg => validationList.innerHTML += `<li>${msg}</li>`);
        alertContainer.style.display = 'block';
    } else {
        alertContainer.style.display = 'none';
        document.getElementById('validation-panel').classList.remove('active');
    }
}




            // Evento de clique no lápis de edição
            scheduleContent.addEventListener('click', function(event) {
                if (event.target && event.target.classList.contains('edit-icon')) {
                    const designacaoIndex = parseInt(event.target.dataset.designationIndex, 10);
                    openEditDesignationPopup(designacaoIndex);
                }
            });

            // Handlers para fechar e guardar do novo popup
            closeEditPopup.addEventListener('click', () => {
                editDesignationPopup.classList.remove('active');
                document.body.classList.remove('popup-open');
                document.getElementById('validation-alert-container').style.display = 'none';
                document.getElementById('validation-panel').classList.remove('active');
            });

            saveDesignationChangesBtn.addEventListener('click', async () => {
                const newParticipants = {};
                editPopupParticipantsContainer.querySelectorAll('.form-select').forEach(select => {
                    if (select.value) newParticipants[select.dataset.roleKey] = select.value;
                });
                
                const historicoDocToUpdate = allScheduleData.find(d => d.id === currentEditData.historicoDocRefId);
                if (historicoDocToUpdate) {
                    
                    const originalString = JSON.stringify(currentEditData.originalDesignation.participantes);
                    const desigToUpdate = historicoDocToUpdate.designacoes.find(d => 
                        d.designacaoId === currentEditData.originalDesignation.designacaoId &&
                        JSON.stringify(d.participantes) === originalString
                    );

                    if (desigToUpdate) {
                        desigToUpdate.participantes = newParticipants;
                    } else {
                        console.error("Não foi possível encontrar a designação original para atualizar nos dados locais.");
                        openModal("Erro", "Ocorreu um erro ao tentar aplicar as alterações localmente.");
                        return;
                    }

                    try {
                        await db.collection('historico').doc(currentEditData.historicoDocRefId).update({
                            designacoes: historicoDocToUpdate.designacoes
                        });
                        renderSchedule();
                    } catch (error) {
                        console.error("Erro ao atualizar o documento:", error);
                        openModal("Erro de Gravação", "Não foi possível guardar as alterações. Por favor, tente novamente.");
                    }
                }
                closeEditPopup.click();
            });

            // Painel de Validação
            const validationIcon = document.getElementById('validation-alert-icon');
            const validationPanel = document.getElementById('validation-panel');
            const validationPanelClose = document.getElementById('validation-panel-close');
            validationIcon.addEventListener('click', () => validationPanel.classList.toggle('active'));
            validationPanelClose.addEventListener('click', () => validationPanel.classList.remove('active'));

            // Carregamento Inicial
            loadInitialData();
        });
    </script>
</body>
</html>
