<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Designação - Sistema de Escala</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
/* =================================================================== */
/*  1. ESTILOS GERAIS E LAYOUT (Vindos de criar.html)                  */
/*  Estes são os estilos base para o corpo, sidebar e conteúdo.      */
/* =================================================================== */

* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
}

body { 
    font-family: Arial, sans-serif; 
    display: flex; 
    min-height: 100vh; 
    background-color: #f5f6fa; 
}

/* --- Sidebar --- */
.sidebar { 
    width: 250px; 
    background-color: #2c3e50; 
    color: white; 
    padding-top: 20px; 
    height: 100vh; 
    position: fixed; 
    left: 0; 
    top: 0; 
    display: flex; 
    flex-direction: column; 
}
.logo { 
    text-align: center; 
    padding-bottom: 20px; 
    border-bottom: 1px solid #34495e; 
}
.logo h2 { 
    margin: 0; 
}
.nav-list { 
    list-style: none; 
    padding: 0; 
}
.nav-item a { 
    color: white; 
    text-decoration: none; 
    display: flex; 
    align-items: center; 
    padding: 15px 20px; 
    transition: background-color 0.3s; 
}
.nav-item a i { 
    margin-right: 15px; 
    width: 20px; 
    text-align: center; 
}
.nav-item a:hover { 
    background-color: #34495e; 
}
.nav-item.active a { 
    background-color: #1abc9c; 
}

/* --- Conteúdo Principal --- */
.content { 
    margin-left: 250px; 
    padding: 30px; 
    flex-grow: 1; 
    width: 100%; /* Ajuste para melhor responsividade */
}
h1 { 
    color: #2c3e50; 
    margin-bottom: 20px; 
    margin-top: 20px; 
    font-size: 28px; 
    border-bottom: 2px solid #ecf0f1; 
    padding-bottom: 10px; 
}
.content > h1:first-of-type { 
    margin-top: 0; 
}

/* =================================================================== */
/*  2. COMPONENTES DA PÁGINA 'CRIAR & EDITAR' (Cards)                  */
/* =================================================================== */

.card-container { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
    gap: 20px; 
}

.item-card {
    background-color: #ffffff;
    border: 1px solid #eef2f5;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
    text-align: center;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    height: 100%;
}

.item-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.12);
}

.item-card i { font-size: 28px; color: #34495e; }
.item-card h3 { font-size: 18px; color: #2c3e50; margin: 0; }

.button-group { display: flex; gap: 10px; width: 100%; margin-top: auto; }
.card-action-btn { flex-grow: 1; padding: 10px; border-radius: 5px; color: white; text-decoration: none; font-size: 14px; font-weight: bold; text-align: center; transition: opacity 0.3s; }
.card-action-btn:hover { opacity: 0.9; }
.btn-criar { background-color: #3498db; }
.btn-editar { background-color: #f39c12; }

.card-link { text-decoration: none; }
.gerenciar-card { border-top: 4px solid #9b59b6; }
.gerenciar-card i { color: #9b59b6; }
.gerenciar-card .action-text { margin-top: auto; color: #34495e; font-weight: bold; }

/* =================================================================== */
/*  3. COMPONENTES DA PÁGINA 'CRIAR DESIGNAÇÃO' (Formulário)           */
/* =================================================================== */

.card { /* Este .card é o container do formulário */
    background: white; 
    padding: 20px; 
    border-radius: 8px; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    max-width: 600px; 
    margin: 0 auto; 
}
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 5px; color: #2c3e50; }
.form-group input[type="text"], .form-group input[type="number"], .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }

.switch-group { display: flex; align-items: center; justify-content: space-between; }
.switch { position: relative; display: inline-block; width: 60px; height: 34px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e74c3c; transition: .4s; }
.slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
input:checked + .slider { background-color: #2ecc71; }
input:checked + .slider:before { transform: translateX(26px); }
.slider.round { border-radius: 34px; }
.slider.round:before { border-radius: 50%; }

.btn-criar { /* Estilo base para botões 'Criar', pode ser sobrescrito */
    background-color: #2c3e50; 
    color: white; 
    padding: 10px 20px; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    width: 100%; 
    font-size: 16px; 
    transition: background-color 0.3s; 
}
.btn-voltar { display: inline-block; margin-bottom: 20px; background-color: #7f8c8d; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; }

.checkbox-group { display: flex; flex-direction: column; gap: 8px; }
.checkbox-item { display: flex; align-items: center; padding: 6px; border-radius: 4px; font-size: 14px; }
.checkbox-item input[type="checkbox"] { margin-right: 8px; }
.checkbox-item:has(input[value="Ancião"]) { background-color: #bbdefb; }
.checkbox-item:has(input[value="Servo Ministerial"]) { background-color: #c8e6c9; }
.checkbox-item:has(input[value="Pioneiro Regular"]) { background-color: #fff9c4; }
.checkbox-item:has(input[value="Pioneiro Auxiliar"]) { background-color: #ffecb3; }
.checkbox-item:has(input[value="Publicador"]) { background-color: #ffcdd2; }
.checkbox-item:has(input[value="Publicador não Batizado"]) { background-color: #f8bbd0; }

.help-text { font-style: italic; font-size: 0.7em; color: #7f8c8d; font-weight: normal; margin-left: 8px; }
.checkbox-group-horizontal { display: flex; gap: 10px; flex-wrap: wrap; }
.option-item-horizontal { display: flex; align-items: center; padding: 8px 16px; border-radius: 20px; background-color: #ecf0f1; border: 1px solid #bdc3c7; cursor: pointer; transition: background-color 0.3s; }
.option-item-horizontal:has(input:checked) { background-color: #3498db; color: white; border-color: #2980b9; }
.option-item-horizontal input[type="checkbox"], .option-item-horizontal input[type="radio"] { /* Oculta o botão de rádio/checkbox original */ display: none; }

.tab-nav { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
.tab-button { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; color: #7f8c8d; border-bottom: 2px solid transparent; transition: all 0.3s ease; }
.tab-button.active { color: #2c3e50; border-bottom: 2px solid #2c3e50; }
.tab-pane { display: none; }
.tab-pane.active { display: block; }

.form-navigation { display: flex; justify-content: space-between; margin-top: 20px; }
.btn-nav { background-color: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
.btn-nav.prev { background-color: #95a5a6; }

.popup-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease-in-out; }
.popup-content { background-color: #ffffff; padding: 30px 50px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; color: #2c3e50; font-size: 1.1em; }

/* --- SEÇÕES DE ANEXO --- */
.anexo-section {
    background-color: #f2f5f7;
    padding: 15px;
    margin-top: 10px;
    border-radius: 5px;
}
.anexo-section h4 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #2c3e50;
    font-size: 16px;
}
.anexo-section .anexo-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
#horarios-anexo-section { border-left: 4px solid #3498db; } /* Cor azul para horários */
#locais-anexo-section { border-left: 4px solid #f39c12; } /* Cor laranja para locais */

/* =================================================================== */
/*  4. RESPONSIVIDADE (Mobile)                                         */
/*  Esta regra aplica-se a TODAS as páginas.                         */
/* =================================================================== */

@media (max-width: 768px) { 
    .sidebar { 
        width: 70px; 
    } 
    .sidebar .logo h2, .sidebar .nav-item a span { 
        display: none; 
    } 
    .content { 
        margin-left: 70px; 
        padding: 15px; /* Reduz o padding em telas menores */
    } 
}

    </style>
</head>
<body>
    <div id="sidebar-placeholder"></div>
    <main class="content">
        <a href="index.html#criar" class="btn-voltar"><i class="fas fa-arrow-left"></i> Voltar</a>
        <h1>Criar Designação</h1>
        <div class="card">
            <form id="criar-designacao-form">
                <!-- Navegação das Abas -->
                <div class="tab-nav">
                    <button type="button" class="tab-button active" data-tab="1">1. Geral</button>
                    <button type="button" class="tab-button" data-tab="2">2. Detalhes</button>
                    <button type="button" class="tab-button" data-tab="3">3. Participantes</button>
                </div>

                <!-- Conteúdo das Abas -->
                <div class="tab-content">
                    <!-- Aba 1: Geral -->
                    <div id="tab-1" class="tab-pane active">
                        <div class="form-group"><label for="nome-designacao">Nome da Designação</label><input type="text" id="nome-designacao" required></div>
                        <div class="form-group"><label for="numero-participantes">Número de Participantes</label><select id="numero-participantes"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div>
                        <div class="form-group"><label for="feito-por">Feito por</label><select id="feito-por" required><option value="Masculino">Apenas Homens</option><option value="Feminino">Apenas Mulheres</option><option value="Masculino Feminino">Homens e Mulheres</option></select></div>
                        <div class="form-group"><label for="preferencia">Preferência</label><select id="preferencia" required><option value="Masculino">Homens</option><option value="Feminino">Mulheres</option><option value="Masculino Feminino">Homens e Mulheres</option></select></div>
                        
                        <div class="form-group">
                            <label>Personalidade (do Dirigente)</label>
                            <div class="checkbox-group-horizontal">
                                <label class="option-item-horizontal"><input type="radio" name="personalidade" value="- à vontade"> - à vontade</label>
                                <label class="option-item-horizontal"><input type="radio" name="personalidade" value="+ à vontade"> + à vontade</label>
                            </div>
                        </div>

                        <div class="form-group switch-group"><label for="status">Desligado/Ligado</label><label class="switch"><input type="checkbox" id="status" checked><span class="slider round"></span></label></div>
                        
                        <div class="form-navigation">
                            <button type="button" class="btn-nav next-btn" data-next-tab="2">Seguinte</button>
                        </div>
                    </div>

                    <!-- Aba 2: Detalhes -->
             <div id="tab-2" class="tab-pane">
    <div class="form-group">
        <label for="quando">Quando?</label>
        <select id="quando" required>
            <option value="Semana">Semana</option>
            <option value="Fim de Semana">Fim de Semana</option>
            <option value="Semana e Fim de Semana">Semana e Fim de Semana</option>
        </select>
    </div>
    <div class="form-group">
        <label for="tipo">Tipo</label>
        <select id="tipo" required>
            <option value="reuniao">Reunião</option>
            <option value="pregacao">Pregação</option>
        </select>
    </div>
    <div class="form-group">
        <label for="parte">Parte</label>
        <select id="parte" required>
            <option value="escola">Escola</option>
            <option value="resto da semana">Resto da Semana</option>
            <option value="fim de semana">Fim de Semana</option>
            <option value="tecnicas">Técnicas</option>
            <option value="pregacao">Pregação</option>
            <option value="dirigencia saida">Dirigência Saída</option>
        </select>
    </div>

    <!-- SEÇÃO DE HORÁRIOS ANEXADOS -->
    <div id="horarios-anexo-section" class="anexo-section" style="display: none;">
        <h4>Anexar Horário <span class="help-text">(Opcional)</span></h4>
        <div class="anexo-container" id="horarios-container"></div>
    </div>
    
    <!-- SEÇÃO DE LOCAIS ANEXADOS (NOVA) -->
    <div id="locais-anexo-section" class="anexo-section" style="display: none;">
        <h4>Anexar Local <span class="help-text">(Opcional)</span></h4>
        <div class="anexo-container" id="locais-container"></div>
    </div>

    <div class="form-group" style="margin-top: 20px;">
        <label for="anexo">Anexo <span class="help-text">(Anexar a um Cabeçalho para aparecer na Escala)</span></label>
        <select id="anexo"><option value="">Nenhum</option></select>
    </div>
    <div class="form-group">
        <label for="descricao">Descrição <span class="help-text">(Necessidades Locais, Orador, etc...)</span></label>
        <select id="descricao">
            <option value="nao">Não</option>
            <option value="sim">Sim</option>
        </select>
    </div>
    <div class="form-group" id="anexado-discursos-group" style="display: none;">
        <label for="anexado-discursos">Anexado a Discursos</label>
        <select id="anexado-discursos">
            <option value="nao" selected>Não</option>
            <option value="sim">Sim</option>
        </select>
    </div>
    <div class="form-group">
        <label for="emoji">Emoji (Opcional)</label>
        <input type="text" id="emoji" maxlength="2">
    </div>

    <div class="form-navigation">
        <button type="button" class="btn-nav prev prev-btn" data-prev-tab="1">Anterior</button>
        <button type="button" class="btn-nav next-btn" data-next-tab="3">Seguinte</button>
    </div>
</div>

                    <!-- Aba 3: Participantes -->
                    <div id="tab-3" class="tab-pane">
                        <div class="form-group"><label>Quem faz?</label><div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Ancião">Ancião</label><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Servo Ministerial">Servo Ministerial</label><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Pioneiro Regular">Pioneiro Regular</label><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Pioneiro Auxiliar">Pioneiro Auxiliar</label><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Publicador">Publicador</label><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Publicador não Batizado">Publicador não Batizado</label></div></div>
                        
                        <div class="form-navigation">
                            <button type="button" class="btn-nav prev prev-btn" data-prev-tab="2">Anterior</button>
                            <button type="submit" class="btn-criar" style="width: auto;">Criar Designação</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div id="custom-popup" class="popup-container">
    <div class="popup-content">
        <p>Designação criada! Redirecionando para a página de ordenação...</p>
    </div>
</div>
    </main>

    <script src="firebase-config.js"></script>
    <script src="main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            if (typeof db === 'undefined') { alert("Erro de configuração do banco de dados."); return; }

            // --- Seletores de Elementos ---
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            const descricaoSelect = document.getElementById('descricao');
            const anexadoDiscursosGroup = document.getElementById('anexado-discursos-group');
            const parteSelect = document.getElementById('parte');
            const horariosSection = document.getElementById('horarios-anexo-section');
            const locaisSection = document.getElementById('locais-anexo-section'); // Novo seletor
            const form = document.getElementById('criar-designacao-form');
            
            // Flags para carregar dados apenas uma vez
            let horariosCarregados = false;
            let locaisCarregados = false; // Novo flag

            // --- Lógica das Abas ---
            function showTab(tabNumber) {
                tabPanes.forEach(pane => pane.classList.remove('active'));
                tabButtons.forEach(button => button.classList.remove('active'));
                document.getElementById(`tab-${tabNumber}`).classList.add('active');
                document.querySelector(`.tab-button[data-tab="${tabNumber}"]`).classList.add('active');
            }
            tabButtons.forEach(button => button.addEventListener('click', () => showTab(button.getAttribute('data-tab'))));
            document.querySelectorAll('.next-btn').forEach(button => button.addEventListener('click', () => showTab(button.getAttribute('data-next-tab'))));
            document.querySelectorAll('.prev-btn').forEach(button => button.addEventListener('click', () => showTab(button.getAttribute('data-prev-tab'))));

            // Lógica para mostrar/esconder 'Anexado a Discursos'
            descricaoSelect.addEventListener('change', function() {
                anexadoDiscursosGroup.style.display = (this.value === 'sim') ? 'block' : 'none';
                if (this.value !== 'sim') { document.getElementById('anexado-discursos').value = 'nao'; }
            });

            // --- Funções de Carregamento de Dados ---
            async function carregarAnexos() {
                const anexoSelect = document.getElementById('anexo');
                anexoSelect.innerHTML = '<option value="">Selecione um anexo</option>';
                try {
                    const snapshot = await db.collection('cabecalhos').get();
                    snapshot.forEach(doc => {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = doc.data().nome;
                        anexoSelect.appendChild(option);
                    });
                } catch (error) { console.error("Erro ao carregar anexos: ", error); }
            }

            function capitalize(string) { return string.charAt(0).toUpperCase() + string.slice(1); }

            async function carregarHorariosPregacao() {
                if (horariosCarregados) return;
                const container = document.getElementById('horarios-container');
                container.innerHTML = 'Carregando horários...';
                try {
                    const snapshot = await db.collection('horarios').where('tipo', '==', 'pregacao').get();
                    if (snapshot.empty) { container.innerHTML = 'Nenhum horário de pregação encontrado.'; return; }
                    
                    let horariosHTML = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data['dias-semana-horarios']) {
                            for (const dia in data['dias-semana-horarios']) {
                                data['dias-semana-horarios'][dia].forEach(hora => {
                                    const valor = `${capitalize(dia)} ${hora}`;
                                    horariosHTML += `<label class="option-item-horizontal"><input type="radio" name="horario_anexado" value="${valor}">${valor}</label>`;
                                });
                            }
                        }
                        if (data['dias-fimdesemana-horarios']) {
                            for (const dia in data['dias-fimdesemana-horarios']) {
                                let diaF = dia === 'sabado' ? 'Sábado' : capitalize(dia);
                                data['dias-fimdesemana-horarios'][dia].forEach(hora => {
                                    const valor = `${diaF} ${hora}`;
                                    horariosHTML += `<label class="option-item-horizontal"><input type="radio" name="horario_anexado" value="${valor}">${valor}</label>`;
                                });
                            }
                        }
                    });
                    container.innerHTML = horariosHTML;
                    horariosCarregados = true;
                } catch (error) { console.error("Erro ao carregar horários: ", error); container.innerHTML = 'Erro ao carregar horários.'; }
            }
            
            // --- NOVA FUNÇÃO PARA CARREGAR LOCAIS ---
            async function carregarLocais() {
                if (locaisCarregados) return;
                const container = document.getElementById('locais-container');
                container.innerHTML = 'Carregando locais...';
                try {
                    const snapshot = await db.collection('locais').where('tag', '==', 'Dirigência Saída').get();
                    if (snapshot.empty) {
                        container.innerHTML = 'Nenhum local com a tag "Dirigência Saída" foi encontrado.';
                        return;
                    }
                    let locaisHTML = '';
                    snapshot.forEach(doc => {
                        const valor = doc.data().nome;
                        locaisHTML += `<label class="option-item-horizontal"><input type="radio" name="local_anexado" value="${valor}">${valor}</label>`;
                    });
                    container.innerHTML = locaisHTML;
                    locaisCarregados = true;
                } catch (error) { console.error("Erro ao carregar locais: ", error); container.innerHTML = 'Erro ao carregar locais.'; }
            }

            // --- Event Listener para o campo "Parte" ---
            parteSelect.addEventListener('change', function() {
                if (this.value === 'dirigencia saida') {
                    horariosSection.style.display = 'block';
                    locaisSection.style.display = 'block'; // Mostra também a seção de locais
                    carregarHorariosPregacao();
                    carregarLocais(); // Chama a nova função para carregar locais
                } else {
                    horariosSection.style.display = 'none';
                    locaisSection.style.display = 'none'; // Esconde ambas as seções
                }
            });

            // Carregamento inicial de dados
            await carregarAnexos();

            // --- Submissão do Formulário ---
           form.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (!document.querySelector('input[name="quem_faz"]:checked')) {
                    alert('O campo "Quem faz?" é obrigatório. Por favor, selecione pelo menos uma opção.');
                    showTab(3);
                    return;
                }
                
                const personalidadeSel = document.querySelector('input[name="personalidade"]:checked');
                const horarioAnexadoSel = document.querySelector('input[name="horario_anexado"]:checked');
                const localAnexadoSel = document.querySelector('input[name="local_anexado"]:checked'); // Pega o local selecionado

                const designacao = {
                    nome: document.getElementById('nome-designacao').value,
                    numeroParticipantes: parseInt(document.getElementById('numero-participantes').value),
                    feitoPor: document.getElementById('feito-por').value,
                    preferencia: document.getElementById('preferencia').value,
                    personalidade: personalidadeSel ? personalidadeSel.value : "",
                    quando: document.getElementById('quando').value,
                    tipo: document.getElementById('tipo').value,
                    parte: document.getElementById('parte').value,
                    horarioAnexado: horarioAnexadoSel ? horarioAnexadoSel.value : "",
                    localAnexado: localAnexadoSel ? localAnexadoSel.value : "", // Adiciona o local ao objeto
                    anexo: document.getElementById('anexo').value,
                    descricao: document.getElementById('descricao').value,
                    anexadoDiscursos: document.getElementById('anexado-discursos').value,
                    emoji: document.getElementById('emoji').value,
                    status: document.getElementById('status').checked,
                    quemFaz: Array.from(document.querySelectorAll('input[name="quem_faz"]:checked')).map(cb => cb.value),
                    dataCriacao: new Date()
                };

                function showPopupAndRedirect(url) {
                    const popup = document.getElementById('custom-popup');
                    popup.style.display = 'flex';
                    setTimeout(() => { popup.style.opacity = '1'; }, 10);
                    setTimeout(() => { window.location.href = url; }, 1000);
                }

                try {
                    const newDocRef = await db.collection('designacoes').add(designacao);
                    showPopupAndRedirect(`gerenciar-ordem.html?id=${newDocRef.id}`);
                } catch (error) {
                    console.error('Erro ao criar designação:', error);
                    alert('Erro ao salvar a designação.');
                }
            });
        });
    </script>
</body>
</html>
