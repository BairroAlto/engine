<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Escala - Painel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Estilos Gerais (sem alterações) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; display: flex; min-height: 100vh; background-color: #f5f6fa; }
        .sidebar { width: 250px; background-color: #2c3e50; color: white; padding-top: 20px; height: 100vh; position: fixed; display: flex; flex-direction: column; }
        .logo { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #34495e; }
        .logo h2 { margin: 0; }
        .nav-list { list-style: none; padding: 0; }
        .nav-item a { color: white; text-decoration: none; display: flex; align-items: center; padding: 15px 20px; transition: background-color 0.3s; }
        .nav-item a i { margin-right: 15px; width: 20px; text-align: center; }
        .nav-item a:hover { background-color: #34495e; }
        .nav-item.active a { background-color: #1abc9c; }
        .content { margin-left: 250px; padding: 30px; flex-grow: 1; }
        h1 { color: #2c3e50; margin-bottom: 30px; font-size: 28px; }
        .year-card, .schedule-card { background-color: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); position: relative; }
        .year-card h2, .schedule-card h2 { color: #2c3e50; margin-bottom: 15px; font-size: 20px; }
        .year-card .year-display { font-size: 32px; color: #34495e; font-weight: bold; margin: 10px 0; }
        .year-card .error-message { color: #e74c3c; font-size: 14px; margin-top: 10px; }
        .edit-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #3498db; cursor: pointer; font-size: 19px; }
        .edit-btn:hover { color: #2980b9; }
        .meeting-times { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .meeting-time { padding: 15px; background: rgba(255, 255, 255, 0.6); border-radius: 6px; position: relative; }
        .meeting-time h3 { color: #2c3e50; font-size: 16px; margin-bottom: 10px; }
        @media (max-width: 768px) { .sidebar { width: 70px; } .sidebar .logo h2, .sidebar .nav-item a span { display: none; } .content { margin-left: 70px; } }
    </style>
</head>
<body>
    <!-- O HTML do corpo da página permanece o mesmo -->
    <div class="sidebar">
        <div class="logo"><h2>Sistema de Escala</h2></div>
        <nav>
            <ul class="nav-list">
                <li class="nav-item active"><a href="index.html"><i class="fas fa-tachometer-alt"></i><span>Painel</span></a></li>
                <li class="nav-item"><a href="semana.html"><i class="fas fa-users"></i><span>Reunião Semana</span></a></li>
                <li class="nav-item"><a href="fimdesemana.html"><i class="fas fa-calendar-week"></i><span>Fim de Semana</span></a></li>
                <li class="nav-item"><a href="pregacao.html"><i class="fas fa-bullhorn"></i><span>Pregação</span></a></li>
                <li class="nav-item"><a href="estatisticas.html"><i class="fas fa-chart-bar"></i><span>Estatísticas</span></a></li>
                <li class="nav-item"><a href="nomes.html"><i class="fas fa-address-book"></i><span>Nomes</span></a></li>
                <li class="nav-item"><a href="iniciar.html"><i class="fas fa-play"></i><span>Iniciar</span></a></li>
                <li class="nav-item"><a href="criar.html"><i class="fas fa-plus"></i><span>Criar</span></a></li>
            </ul>
        </nav>
    </div>
    <main class="content">
        <div id="painel">
            <h1>Painel</h1>
            <div class="year-card">
                <div style="position: relative;">
                    <h2>Ano Atual</h2>
                    <button class="edit-btn" id="editYearBtn"><i class="fas fa-edit"></i></button>
                </div>
                <div id="currentYear" class="year-display">Carregando...</div>
                <div id="yearError" class="error-message"></div>
            </div>
            <div class="schedule-card" style="background-color: #fff9c4;">
                <div style="position: relative;">
                    <h2>Eventos Especiais</h2>
                    <button class="edit-btn" id="editSpecialEventsBtn"><i class="fas fa-edit"></i></button>
                </div>
                <div id="specialEventsContainer" class="meeting-times">
                    Carregando eventos...
                </div>
            </div>
            <div class="schedule-card" style="background-color: #dcedc8;">
                <div style="position: relative;">
                    <h2>Horários de Reunião</h2>
                    <button class="edit-btn" id="editScheduleBtn"><i class="fas fa-edit"></i></button>
                </div>
                <div class="meeting-times">
                    <div class="meeting-time">
                        <h3>Reunião da Semana</h3>
                        <div id="weekdaySchedule">Carregando...</div>
                    </div>
                    <div class="meeting-time">
                        <h3>Reunião do Fim de Semana</h3>
                        <div id="weekendSchedule">Carregando...</div>
                    </div>
                </div>
            </div>
            <div class="schedule-card" style="background-color: #e0f7fa;">
                <div style="position: relative;">
                    <h2>Horários de Pregação</h2>
                    <button class="edit-btn" id="editPreachingScheduleBtn"><i class="fas fa-edit"></i></button>
                </div>
                <div class="meeting-times">
                    <div class="meeting-time">
                        <h3>Pregação Semana</h3>
                        <div id="weekdayPreachingSchedule">Carregando...</div>
                    </div>
                    <div class="meeting-time">
                        <h3>Pregação Fim de Semana</h3>
                        <div id="weekendPreachingSchedule">Carregando...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD1fkxq6USO5RX22TlsPQFEaVSZoTj_t2A",
            authDomain: "escalas-6e0f9.firebaseapp.com",
            projectId: "escalas-6e0f9",
            storageBucket: "escalas-6e0f9.firebasestorage.app",
            messagingSenderId: "19118998563",
            appId: "1:19118998563:web:5412be658ae34bd45add96"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Funções Auxiliares ---

        /**
         * Formata uma string de data 'AAAA-MM-DD' para 'DiaDaSemana: DD-MM-AAAA'.
         * @param {string} dateString A data no formato 'AAAA-MM-DD'.
         * @returns {string} A data formatada ou uma string vazia se a entrada for inválida.
         */
        function formatEventDate(dateString) {
            if (!dateString) return '';
            try {
                // Adicionar 'T12:00:00' para evitar problemas de fuso horário que podem mudar o dia
                const date = new Date(dateString + 'T12:00:00');
                if (isNaN(date.getTime())) return dateString; // Retorna original se a data for inválida

                // 1. Obter dia da semana em português e capitalizar
                const weekday = date.toLocaleDateString('pt-BR', { weekday: 'long' });
                const capitalizedWeekday = weekday.charAt(0).toUpperCase() + weekday.slice(1);

                // 2. Reformatar a data para DD-MM-AAAA
                const [year, month, day] = dateString.split('-');
                const formattedDate = `${day}-${month}-${year}`;

                // 3. Combinar tudo
                return `${capitalizedWeekday}: ${formattedDate}`;
            } catch (error) {
                console.error("Erro ao formatar data:", dateString, error);
                return dateString; // Retorna a data original em caso de erro
            }
        }

        // --- Funções de Renderização e Busca ---

        async function loadSpecialEvents(year) {
            const container = document.getElementById('specialEventsContainer');
            try {
                const snapshot = await db.collection('eventos').where('ano', '==', parseInt(year)).orderBy('data').get();
                if (snapshot.empty) {
                    container.innerHTML = `<div class="meeting-time">Nenhum evento especial cadastrado para ${year}.</div>`;
                    return;
                }
                let eventsHtml = '';
                snapshot.forEach(doc => {
                    const event = doc.data();
                    eventsHtml += `
                        <div class="meeting-time">
                            <h3>${event.nome || 'Evento sem Título'}</h3>
                            <div>${formatEventDate(event.data)}</div>
                        </div>
                    `;
                });
                container.innerHTML = eventsHtml;
            } catch (error) {
                console.error('Erro ao carregar eventos especiais:', error);
                container.innerHTML = '<div class="meeting-time">Erro ao carregar eventos.</div>';
            }
        }

        async function loadSchedules(year) {
            const weekdayScheduleDiv = document.getElementById('weekdaySchedule');
            const weekendScheduleDiv = document.getElementById('weekendSchedule');
            const weekdayPreachingScheduleDiv = document.getElementById('weekdayPreachingSchedule');
            const weekendPreachingScheduleDiv = document.getElementById('weekendPreachingSchedule');

            try {
                const reuniaoQuery = await db.collection('horarios').where('ano', '==', parseInt(year)).where('tipo', '==', 'reuniao').limit(1).get();
                if (!reuniaoQuery.empty) {
                    const data = reuniaoQuery.docs[0].data();
                    weekdayScheduleDiv.textContent = `${data['dia-semana']} ${data['hora-semana']}`;
                    weekendScheduleDiv.textContent = `${data['dia-fimdesemana']} ${data['hora-fimdesemana']}`;
                } else {
                    weekdayScheduleDiv.textContent = 'Não configurado';
                    weekendScheduleDiv.textContent = 'Não configurado';
                }

                const pregacaoQuery = await db.collection('horarios').where('ano', '==', parseInt(year)).where('tipo', '==', 'pregacao').limit(1).get();
                if (!pregacaoQuery.empty) {
                    const data = pregacaoQuery.docs[0].data();
                    let semanaHtml = Object.entries(data['dias-semana-horarios'] || {}).map(([dia, horas]) => `${dia.charAt(0).toUpperCase() + dia.slice(1)}: ${horas.join(', ')}`).join('<br>');
                    let fimSemanaHtml = Object.entries(data['dias-fimdesemana-horarios'] || {}).map(([dia, horas]) => `${dia.charAt(0).toUpperCase() + dia.slice(1)}: ${horas.join(', ')}`).join('<br>');
                    weekdayPreachingScheduleDiv.innerHTML = semanaHtml || 'Não configurado';
                    weekendPreachingScheduleDiv.innerHTML = fimSemanaHtml || 'Não configurado';
                } else {
                    weekdayPreachingScheduleDiv.textContent = 'Não configurado';
                    weekendPreachingScheduleDiv.textContent = 'Não configurado';
                }
            } catch (error) {
                console.error('Erro ao carregar horários:', error);
            }
        }

        // --- LÓGICA PRINCIPAL CENTRALIZADA ---

        async function initializeDashboard() {
            const yearDisplay = document.getElementById('currentYear');
            let currentYear = null;

            try {
                const doc = await db.collection('painel').doc('ano').get();
                if (doc.exists && doc.data().ano) {
                    currentYear = doc.data().ano;
                    yearDisplay.textContent = currentYear;
                } else {
                    yearDisplay.textContent = 'Não definido';
                }
            } catch (error) {
                console.error('Erro ao carregar o ano:', error);
                yearDisplay.textContent = 'Erro';
            }

            if (currentYear) {
                await Promise.all([
                    loadSpecialEvents(currentYear),
                    loadSchedules(currentYear)
                ]);
            } else {
                const msg = 'Selecione um ano para ver os dados.';
                document.getElementById('specialEventsContainer').innerHTML = `<div class="meeting-time">${msg}</div>`;
                document.getElementById('weekdaySchedule').textContent = 'Ano não definido';
                document.getElementById('weekendSchedule').textContent = 'Ano não definido';
                document.getElementById('weekdayPreachingSchedule').textContent = 'Ano não definido';
                document.getElementById('weekendPreachingSchedule').textContent = 'Ano não definido';
            }
            
            document.getElementById('editYearBtn').addEventListener('click', () => { window.location.href = `editar-ano.html`; });
            document.getElementById('editSpecialEventsBtn').addEventListener('click', () => { window.location.href = 'editar-evento.html'; });
            document.getElementById('editScheduleBtn').addEventListener('click', () => { if (currentYear) window.location.href = `editar-horario-reuniao.html?year=${currentYear}`; });
            document.getElementById('editPreachingScheduleBtn').addEventListener('click', () => { if (currentYear) window.location.href = `editar-horario-pregacao.html?year=${currentYear}`; });
        }

        // --- Event Listener para iniciar tudo ---
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
