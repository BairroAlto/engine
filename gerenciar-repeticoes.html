<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Designações com Repetição</title>
    
    <!-- 1. Links para Font Awesome e para o nosso CSS Global -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <!-- 2. Estilos que são ESPECÍFICOS APENAS para esta página -->
    <style>
        .layout-container { display: flex; gap: 30px; }
        .panel { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-y: auto; max-height: 80vh; }
        .panel-list { flex: 1; }
        .panel-editor { flex: 2; }
        .designation-list { list-style: none; padding-left: 0; }
        .designation-list-item { padding: 10px 8px; border-bottom: 1px solid #ecf0f1; cursor: pointer; transition: background-color 0.2s; border-radius: 4px; }
        .designation-list-item:hover { background-color: #f0f2f5; }
        .designation-list-item.active { background-color: #9b59b6; color: white; font-weight: bold; }
        
        /* Estilos para os checkboxes */
        .repetition-item { display: flex; align-items: center; padding: 10px 5px; border-bottom: 1px solid #ecf0f1; }
        .repetition-item input[type="checkbox"] { width: 18px; height: 18px; margin-right: 15px; cursor: pointer; }
        .repetition-item label { flex-grow: 1; cursor: pointer; user-select: none; }
        
        #editor-placeholder { color: #7f8c8d; text-align: center; padding: 50px 20px; }
        .save-button-container { text-align: right; margin-top: 20px; }
        #save-repetitions-btn { background-color: #2c3e50; color: white; padding: 12px 25px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        #save-repetitions-btn:hover { background-color: #34495e; }
        #save-feedback { margin-top: 15px; font-weight: bold; }
        
        .category-header { margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid; padding-bottom: 5px; font-size: 1.1em; }
        .category-semana { color: #3498db; border-bottom-color: #a9cce3; }
        .category-fim-de-semana { color: #9b59b6; border-bottom-color: #d7bde2; }
        .category-pregacao { color: #e67e22; border-bottom-color: #f0b27a; }
        .category-tecnicas { color: #8d6e63; border-bottom-color: #c0ab8e; }
        .subcategory-header { font-size: 0.9em; font-weight: bold; margin-top: 15px; margin-bottom: 5px; padding-left: 5px; text-transform: capitalize; opacity: 0.9; }
    </style>
</head>
<body>
    <!-- 3. O container onde o menu será injetado -->
    <div id="sidebar-placeholder"></div>

    <!-- 4. O conteúdo principal da página -->
    <main class="content">
        <h1>Gerenciar Designações com Repetição</h1>
        <div class="layout-container">
            <div class="panel panel-list">
                <h2>Todas as Designações</h2>
                <div id="designation-list-container"><p>Carregando...</p></div>
            </div>
            <div class="panel panel-editor">
                 <div id="editor-content">
                    <div id="editor-placeholder">
                        <i class="fas fa-arrow-left" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>Selecione uma designação à esquerda para definir com quais outras ela deve repetir.</p>
                    </div>
                 </div>
            </div>
        </div>
    </main>

    <!-- 5. ORDEM DE SCRIPTS UNIFICADA -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const designationListContainer = document.getElementById('designation-list-container');
            const editorContent = document.getElementById('editor-content');
            let allDesignations = [];
            
            // Estrutura para organizar a lista
            const categoryStructure = { "Semana": ["escola", "resto da semana"], "Fim de Semana": ["fim de semana"], "Técnicas": ["tecnicas"], "Pregação": ["pregacao", "dirigencia saida"] };
            const orderedCategories = ["Semana", "Fim de Semana", "Técnicas", "Pregação"];
            const categoryToClass = { 'Semana': 'category-semana', 'Fim de Semana': 'category-fim-de-semana', 'Pregação': 'category-pregacao', 'Técnicas': 'category-tecnicas' };
            const formatSubcategoryName = (text) => text.charAt(0).toUpperCase() + text.slice(1).replace(/_/g, ' ');

            try {
                const designacoesSnapshot = await db.collection('designacoes').get();
                allDesignations = designacoesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDesignationList(allDesignations);
            } catch (error) {
                console.error("Erro ao carregar designações: ", error);
                designationListContainer.innerHTML = "<p>Erro ao carregar designações.</p>";
            }

            // Renderiza a lista de designações na coluna da esquerda (igual à página anterior)
            function renderDesignationList(designations) {
                let html = '';
                orderedCategories.forEach(categoryName => {
                    const partes = categoryStructure[categoryName];
                    const categoryHasItems = designations.some(d => partes.includes(d.parte));
                    if (categoryHasItems) {
                        const className = categoryToClass[categoryName] || '';
                        html += `<h3 class="category-header ${className}">${categoryName}</h3>`;
                        partes.forEach(parte => {
                            const designationsInParte = designations.filter(d => d.parte === parte).sort((a, b) => a.nome.localeCompare(b.nome));
                            if (designationsInParte.length > 0) {
                                html += `<h5 class="subcategory-header ${className}">${formatSubcategoryName(parte)}</h5>`;
                                html += '<ul class="designation-list">';
                                designationsInParte.forEach(d => {
                                    html += `<li class="designation-list-item" data-designation-id="${d.id}">${d.nome}</li>`;
                                });
                                html += '</ul>';
                            }
                        });
                    }
                });
                designationListContainer.innerHTML = html;
                designationListContainer.querySelectorAll('.designation-list-item').forEach(item => {
                    item.addEventListener('click', handleDesignationClick);
                });
            }
            
            // Chamado ao clicar numa designação. Ativa o item e chama o renderizador do editor
            function handleDesignationClick(e) {
                const clickedItem = e.currentTarget;
                const selectedId = clickedItem.dataset.designationId;
                document.querySelectorAll('.designation-list-item.active').forEach(item => item.classList.remove('active'));
                clickedItem.classList.add('active');
                const selectedDesignation = allDesignations.find(d => d.id === selectedId);
                renderRepetitionEditor(selectedDesignation);
            }

            // Renderiza o painel da direita com os checkboxes
            function renderRepetitionEditor(selectedDesignation) {
                const currentRepetitions = selectedDesignation.repeticao || [];
                let html = `<h2>Regras de Repetição para: ${selectedDesignation.nome}</h2><p>Marque as designações que devem ser atribuídas à(s) mesma(s) pessoa(s).</p>`;
                
                const otherDesignations = allDesignations.filter(d => d.id !== selectedDesignation.id);

                orderedCategories.forEach(categoryName => {
                    const partes = categoryStructure[categoryName];
                    const categoryHasItems = otherDesignations.some(d => partes.includes(d.parte));
                    if (categoryHasItems) {
                        const className = categoryToClass[categoryName] || '';
                        html += `<h3 class="category-header ${className}">${categoryName}</h3>`;
                        partes.forEach(parte => {
                            const designationsInParte = otherDesignations.filter(d => d.parte === parte).sort((a, b) => a.nome.localeCompare(b.nome));
                            if (designationsInParte.length > 0) {
                                html += `<h5 class="subcategory-header ${className}">${formatSubcategoryName(parte)}</h5>`;
                                designationsInParte.forEach(otherD => {
                                    const isChecked = currentRepetitions.includes(otherD.id) ? 'checked' : '';
                                    html += `<div class="repetition-item">
                                               <input type="checkbox" id="rep-${otherD.id}" data-target-designation-id="${otherD.id}" ${isChecked}>
                                               <label for="rep-${otherD.id}">${otherD.nome}</label>
                                             </div>`;
                                });
                            }
                        });
                    }
                });
                
                html += `<div class="save-button-container"><button id="save-repetitions-btn" data-source-designation-id="${selectedDesignation.id}">Salvar Alterações</button><p id="save-feedback"></p></div>`;
                editorContent.innerHTML = html;
                document.getElementById('save-repetitions-btn').addEventListener('click', handleSaveChanges);
            }

            // Lida com o salvamento das mudanças, garantindo a sincronização recíproca
            async function handleSaveChanges(e) {
                const btn = e.target;
                const sourceDesignationId = btn.dataset.sourceDesignationId;
                const feedbackEl = document.getElementById('save-feedback');
                
                if (!sourceDesignationId) return;

                btn.disabled = true;
                btn.textContent = 'Salvando...';
                feedbackEl.textContent = '';

                // 1. Obter a lista antiga e a nova lista de repetições
                const sourceDesignation = allDesignations.find(d => d.id === sourceDesignationId);
                const oldRepetitions = sourceDesignation.repeticao || [];
                const newRepetitions = [];
                editorContent.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    newRepetitions.push(checkbox.dataset.targetDesignationId);
                });

                // 2. Determinar quais IDs foram adicionados e removidos
                const addedIds = newRepetitions.filter(id => !oldRepetitions.includes(id));
                const removedIds = oldRepetitions.filter(id => !newRepetitions.includes(id));
                
                const batch = db.batch();

                // 3. Atualizar o documento de origem
                const sourceRef = db.collection('designacoes').doc(sourceDesignationId);
                batch.update(sourceRef, { repeticao: newRepetitions });

                // 4. Atualizar os documentos adicionados (adicionar referência de volta)
                addedIds.forEach(targetId => {
                    const targetRef = db.collection('designacoes').doc(targetId);
                    batch.update(targetRef, { repeticao: firebase.firestore.FieldValue.arrayUnion(sourceDesignationId) });
                });

                // 5. Atualizar os documentos removidos (remover referência de volta)
                removedIds.forEach(targetId => {
                    const targetRef = db.collection('designacoes').doc(targetId);
                    batch.update(targetRef, { repeticao: firebase.firestore.FieldValue.arrayRemove(sourceDesignationId) });
                });

                // 6. Executar o batch
                try {
                    await batch.commit();
                    
                    // Atualizar estado local para evitar recarregar a página
                    sourceDesignation.repeticao = newRepetitions;
                    addedIds.forEach(id => allDesignations.find(d => d.id === id)?.repeticao?.push(sourceDesignationId));
                    removedIds.forEach(id => {
                        let target = allDesignations.find(d => d.id === id);
                        if (target && target.repeticao) {
                            target.repeticao = target.repeticao.filter(repId => repId !== sourceDesignationId);
                        }
                    });

                    feedbackEl.textContent = "Regras de repetição salvas com sucesso!";
                    feedbackEl.style.color = "#2ecc71";
                } catch (error) {
                    console.error("Erro ao salvar regras de repetição: ", error);
                    feedbackEl.textContent = "Erro ao salvar. Tente novamente.";
                    feedbackEl.style.color = "#e74c3c";
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Alterações';
                    setTimeout(() => { feedbackEl.textContent = ''; }, 4000);
                }
            }
        });
    </script>
    
    <!-- Quarto: O script que carrega o menu -->
    <script src="main.js"></script>

</body>
</html>
