<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Pessoa - Sistema de Escala</title>

    <!-- Links Externos (Font Awesome e nosso CSS Global) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css"> <!-- O seu CSS global -->

    <!-- Fontes Modernas do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Scripts do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Estilos ESPECÍFICOS e MELHORADOS para o formulário -->
    <style>
        /* --- GERAL & RESET --- */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --text-color: #34495e;
            --bg-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --border-color: #dfe6e9;
            --font-family: 'Inter', sans-serif;
            --border-radius: 8px;
        }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); }
        .card { background: var(--card-bg-color); padding: 0; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); max-width: 900px; margin: 20px auto; border: 1px solid var(--border-color); overflow: hidden; }
        .tabs { display: flex; background-color: #f8f9fa; border-bottom: 1px solid var(--border-color); }
        .tab-button { padding: 15px 25px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; font-weight: 500; color: var(--text-color); transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab-button:hover { background-color: #e9ecef; }
        .tab-button.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        .tab-content { display: none; padding: 40px; }
        .tab-content.active { display: block; }
        .form-subsection { margin-bottom: 35px; padding-bottom: 25px; border-bottom: 1px solid var(--border-color); }
        .form-subsection:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .form-subsection h3 { font-size: 20px; font-weight: 600; color: var(--primary-dark); margin-bottom: 25px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 12px; }
        .form-group { margin-bottom: 12px; position: relative; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-color); font-weight: 500; font-size: 14px; }
        .form-group input[type="text"], .form-group input[type="email"], .form-group input[type="tel"], .form-group select, .form-group input[type="date"] { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 14px; background-color: #fff; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        .switch-group { display: flex; align-items: center; gap: 15px; }
        .switch-group span { font-weight: 500; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--danger-color); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-group .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: var(--border-radius); border: 1px solid var(--border-color); font-size: 14px; cursor: pointer; transition: background-color 0.3s, border-color 0.3s; }
        .checkbox-group .checkbox-item input { accent-color: var(--primary-color); }
        .checkbox-item:has(input[value="Ancião"]) { background-color: #eaf3fb; border-color: #a9cce3; }
        .checkbox-item:has(input[value="Servo Ministerial"]) { background-color: #e9f7ef; border-color: #a9dfbf; }
        .checkbox-item:has(input[value="Pioneiro Regular"]), .checkbox-item:has(input[value="Pioneiro Especial"]) { background-color: #fef9e7; border-color: #fceea4; }
        .checkbox-item:has(input[value="Pioneiro Auxiliar"]), .checkbox-item:has(input[value="Missionário"]) { background-color: #fff4e0; border-color: #ffd8b2; }
        .checkbox-item:has(input[value="Publicador"]) { background-color: #fdedec; border-color: #f5b7b1; }
        .checkbox-item:has(input[value="Publicador não Batizado"]) { background-color: #fce4ec; border-color: #f3bad6; }
        .checkbox-item:has(input[value="Servo de Circuito"]) { background-color: #e5e7e9; border-color: #d7dbdd; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .section-header h2 { font-size: 24px; color: var(--text-color); font-weight: 600; margin: 0; }
        .designacoes-section { background-color: var(--bg-color); border-radius: var(--border-radius); padding: 25px; margin-top: 20px; border: 1px solid var(--border-color); }
        .designacoes-subsection { margin-bottom: 25px; }
        .designacoes-subsection:last-child { margin-bottom: 0; }
        .designacoes-subsection h3 { font-size: 18px; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .horarios-pregacao { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 25px; }
        .horarios-section h3 { font-size: 18px; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .day-container { margin-bottom: 15px; }
        .day-container h4 { font-size: 16px; font-weight: 500; margin-bottom: 10px; }
        .horario-item { display: flex; align-items: center; gap: 10px; padding: 10px; background-color: white; border-radius: var(--border-radius); margin-bottom: 8px; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border-color); }
        .horario-item.selected { background-color: #eaf3fb; border-color: var(--primary-color); color: var(--primary-dark); font-weight: 500; }
        .ausencias-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; align-items: end; }
        .ausencia-group { background: #fdfdfd; padding: 15px; border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .ausencia-group button { padding: 12px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s; font-weight: 500; width: 100%; margin-top: 10px; }
        #selected-ausencias-list, #selected-familia-list { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        .ausencia-item, .familia-member-item { background-color: #e8eaf6; padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500; }
        .ausencia-item button, .familia-member-item button { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 18px; padding: 0; line-height: 1; font-weight: bold; }
        .submit-area { padding: 20px 40px 40px 40px; }
        .btn-criar { background-color: var(--primary-color); color: white; padding: 15px 30px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 16px; font-weight: 600; transition: background-color 0.3s, transform 0.2s; display: inline-block; width: 100%; }
        .btn-criar:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .section-disabled { opacity: 0.5; pointer-events: none; }
        .suggestions-box { position: absolute; width: 100%; max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-top: none; background-color: white; border-radius: 0 0 var(--border-radius) var(--border-radius); box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10; display: none; }
        .suggestions-box div { padding: 10px; cursor: pointer; }
        .suggestions-box div:hover { background-color: #f0f0f0; }
        .form-warning { color: var(--danger-color); font-size: 13px; margin-top: 5px; font-weight: 500; }
        @media (max-width: 768px) { .form-row, .horarios-pregacao, .ausencias-inputs { grid-template-columns: 1fr; } .tab-content { padding: 20px; } .tabs { flex-wrap: wrap; } .tab-button { flex-grow: 1; text-align: center; } }
    </style>
</head>
<body>
   <div id="sidebar-placeholder"></div>

    <main class="content">
        <a href="index.html" class="btn-voltar"><i class="fas fa-arrow-left"></i> Voltar</a>
        <h1 id="page-title">Criar Pessoa</h1>
        <div class="card">
            <form id="criar-pessoa-form">
                <div class="tabs">
                    <button type="button" class="tab-button active" data-tab="pessoal">Informações Pessoais</button>
                    <button type="button" class="tab-button" data-tab="reuniao">Designações de Reunião</button>
                    <button type="button" class="tab-button" data-tab="pregacao">Designações de Pregação</button>
                    <button type="button" class="tab-button" data-tab="ausencias">Marcar Ausências</button>
                </div>

                <!-- Aba de Informações Pessoais -->
                <div id="pessoal" class="tab-content active">
                    <div class="form-subsection">
                        <h3>Informações Básicas</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nome-pessoa">Nome Curto</label>
                                <input type="text" id="nome-pessoa" name="nome-pessoa" required>
                                <div id="nome-curto-aviso" class="form-warning" style="display: none;"></div>
                            </div>
                            <div class="form-group">
                                <label for="nome-completo-pessoa">Nome Completo</label>
                                <input type="text" id="nome-completo-pessoa" name="nome-completo-pessoa" required>
                            </div>
                        </div>
                        <div class="form-row"><div class="form-group"><label for="email">Email</label><input type="email" id="email" name="email"></div><div class="form-group"><label for="telemovel">Telemóvel</label><input type="tel" id="telemovel" name="telemovel"></div></div>
                        <div class="form-group"><label for="morada">Morada</label><input type="text" id="morada" name="morada"></div>
                        <div class="form-row"><div class="form-group"><label for="idioma">Idioma</label><select id="idioma" name="idioma" required><option value="">Selecione um idioma</option></select></div><div class="form-group"><label>Gênero</label><div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" name="genero" value="Masculino" id="genero-masculino"> Masculino</label><label class="checkbox-item"><input type="checkbox" name="genero" value="Feminino" id="genero-feminino"> Feminino</label></div></div></div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Personalidade</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-item"><input type="checkbox" name="personalidade" value="- à vontade" id="personalidade-menos-avontade"> - à vontade</label>
                                    <label class="checkbox-item"><input type="checkbox" name="personalidade" value="+ à vontade" id="personalidade-mais-avontade"> + à vontade</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Na Congregação?</label>
                                <div class="switch-group">
                                    <label class="switch">
                                        <input type="checkbox" id="na-congregacao" name="na-congregacao" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>                   
                    </div>
                    <div class="form-subsection">
                        <h3>Informações Espirituais</h3>
                        <div class="form-row"><div class="form-group"><label>Ativo</label><div class="switch-group"><label class="switch"><input type="checkbox" id="ativo" name="ativo" checked><span class="slider"></span></label><span id="ativo-label">Sim</span></div></div></div>
                        <div id="spiritual-info-content">
                            <div class="form-row"><div class="form-group"><label for="grupo">Grupo</label><select id="grupo" name="grupo" class="form-select"><option value="">Sem grupo</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option></select></div></div>
                            <div class="form-group"><label>Privilégios Congregação</label><div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" name="privilegios-congregacao" value="Ancião"> Ancião</label><label class="checkbox-item"><input type="checkbox" name="privilegios-congregacao" value="Servo Ministerial"> Servo Ministerial</label><label class="checkbox-item"><input type="checkbox" name="privilegios-congregacao" value="Publicador"> Publicador</label><label class="checkbox-item"><input type="checkbox" name="privilegios-congregacao" value="Publicador não Batizado"> Publicador não Batizado</label></div></div>
                            <div class="form-group"><label>Privilégios Pregação</label><div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" name="privilegios-pregacao" value="Pioneiro Regular"> Pioneiro Regular</label><label class="checkbox-item"><input type="checkbox" name="privilegios-pregacao" value="Pioneiro Auxiliar"> Pioneiro Auxiliar</label><label class="checkbox-item"><input type="checkbox" name="privilegios-pregacao" value="Pioneiro Especial"> Pioneiro Especial</label><label class="checkbox-item"><input type="checkbox" name="privilegios-pregacao" value="Missionário"> Missionário</label></div></div>
                            <div class="form-group"><label>Privilégios Especiais</label><div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" name="privilegios-especiais" value="Servo de Circuito"> Servo de Circuito</label></div></div>
                        </div>
                    </div>
                    <div class="form-subsection">
                        <h3>Informações Avançadas</h3>
                        <div class="form-row"><div class="form-group"><label for="casado-com">Casado Com (Opcional)</label><input type="text" id="casado-com" name="casado-com"><div id="pessoas-suggestions" class="suggestions-box"></div></div><div class="form-group"><label for="familia-search">Família (Opcional)</label><input type="text" id="familia-search" name="familia-search" placeholder="Pesquisar para adicionar membro..."><div id="familia-suggestions" class="suggestions-box"></div></div></div>
                        <div id="selected-familia-list"></div>
                        <div class="form-row"><div class="form-group"><label for="data-nascimento">Nascimento (Opcional)</label><input type="date" id="data-nascimento" name="data-nascimento"></div><div class="form-group"><label for="data-batismo">Batismo (Opcional)</label><input type="date" id="data-batismo" name="data-batismo"></div></div>
                    </div>
                </div>

                <!-- Aba de Designações de Reunião -->
                <div id="reuniao" class="tab-content">
                    <div class="section-header"><h2>Designações de Reunião</h2><div class="switch-group"><span>Participa?</span><label class="switch"><input type="checkbox" id="faz-designacoes-reuniao" name="faz-designacoes-reuniao"><span class="slider"></span></label></div></div>
                    <div id="designacoes-reuniao" class="designacoes-section">
                        <div class="designacoes-subsection"><h3>Escola</h3><div class="checkbox-group" id="lista-designacoes-escola"></div></div>
                        <div class="designacoes-subsection"><h3>Resto da Semana</h3><div class="checkbox-group" id="lista-designacoes-resto-semana"></div></div>
                        <div class="designacoes-subsection"><h3>Fim de Semana</h3><div class="checkbox-group" id="lista-designacoes-fim-semana"></div></div>
                    </div>
                </div>

                <!-- Aba de Designações de Pregação -->
                <div id="pregacao" class="tab-content">
                    <div class="section-header"><h2>Designações de Pregação</h2><div class="switch-group"><span>Participa?</span><label class="switch"><input type="checkbox" id="faz-designacoes-pregacao" name="faz-designacoes-pregacao"><span class="slider"></span></label></div></div>
                    <div id="designacoes-pregacao" class="designacoes-section">
                        <div class="switch-group" style="margin-bottom: 20px;"><span>Acompanha Carrinhos</span><label class="switch"><input type="checkbox" id="acompanha-carrinhos" name="acompanha-carrinhos"><span class="slider"></span></label></div>
                        <div class="checkbox-group" id="lista-designacoes-pregacao"></div>
                        <div class="horarios-pregacao">
                            <div id="horarios-semana" class="horarios-section"><h3>Horários Semana</h3></div>
                            <div id="horarios-fim-de-semana" class="horarios-section"><h3>Horários Fim de Semana</h3></div>
                        </div>
                    </div>
                </div>

                <!-- Aba de Ausências -->
                <div id="ausencias" class="tab-content">
                    <div class="section-header"><h2>Marcar Ausências</h2></div>
                    <div class="ausencias-inputs">
                        <div class="ausencia-group"><label for="ausencia-single-date">Adicionar Data Única</label><div class="date-inputs"><input type="date" id="ausencia-single-date"></div><button type="button" id="add-single-ausencia-btn">Adicionar</button></div>
                        <div class="ausencia-group"><label>Adicionar por Intervalo</label><div class="date-inputs"><input type="date" id="ausencia-start-date" title="Data de início"><input type="date" id="ausencia-end-date" title="Data de fim"></div><button type="button" id="add-ausencia-btn">Adicionar</button></div>
                    </div>
                    <div id="selected-ausencias-list"></div>
                </div>
                
                <div class="submit-area">
                    <button type="submit" class="btn-criar" id="submit-button">Criar Pessoa</button>
                </div>
            </form>
        </div>
    </main>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD1fkxq6USO5RX22TlsPQFEaVSZoTj_t2A",
            authDomain: "escalas-6e0f9.firebaseapp.com",
            projectId: "escalas-6e0f9",
            storageBucket: "escalas-6e0f9.firebasestorage.app",
            messagingSenderId: "19118998563",
            appId: "1:19118998563:web:5412be658ae34bd45add96"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', function() {
            // Lógica para as abas
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = document.getElementById(tab.dataset.tab);
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(content => content.classList.remove('active'));
                    target.classList.add('active');
                });
            });

            // Variáveis do formulário
            const criarPessoaForm = document.getElementById('criar-pessoa-form');
            const pageTitle = document.getElementById('page-title');
            const submitButton = document.getElementById('submit-button');
            const nomePessoaInput = document.getElementById('nome-pessoa');
            const nomeCompletoPessoaInput = document.getElementById('nome-completo-pessoa');
            const telemovelInput = document.getElementById('telemovel');
            const moradaInput = document.getElementById('morada');
            const ativoSwitch = document.getElementById('ativo');
            const ativoLabel = document.getElementById('ativo-label');
            const spiritualInfoContent = document.getElementById('spiritual-info-content');
            const dataNascimentoInput = document.getElementById('data-nascimento');
            const dataBatismoInput = document.getElementById('data-batismo');
            const generoMasculinoCheckbox = document.getElementById('genero-masculino');
            const generoFemininoCheckbox = document.getElementById('genero-feminino');
            const idiomaSelect = document.getElementById('idioma');
            const grupoSelect = document.getElementById('grupo');
            const emailInput = document.getElementById('email');
            const personalidadeMenosAvontadeCheckbox = document.getElementById('personalidade-menos-avontade');
            const personalidadeMaisAvontadeCheckbox = document.getElementById('personalidade-mais-avontade');
            const naCongregacaoSwitch = document.getElementById('na-congregacao');
            const casadoComInput = document.getElementById('casado-com');
            const pessoasSuggestionsDiv = document.getElementById('pessoas-suggestions');
            const familiaSearchInput = document.getElementById('familia-search');
            const familiaSuggestionsDiv = document.getElementById('familia-suggestions');
            const selectedFamiliaListDiv = document.getElementById('selected-familia-list');
            const fazDesignacoesReuniaoSwitch = document.getElementById('faz-designacoes-reuniao');
            const designacoesReuniaoSection = document.getElementById('designacoes-reuniao');
            const listaDesignacoesEscolaDiv = document.getElementById('lista-designacoes-escola');
            const listaDesignacoesRestoSemanaDiv = document.getElementById('lista-designacoes-resto-semana');
            const listaDesignacoesFimSemanaDiv = document.getElementById('lista-designacoes-fim-semana');
            const fazDesignacoesPregacaoSwitch = document.getElementById('faz-designacoes-pregacao');
            const designacoesPregacaoSection = document.getElementById('designacoes-pregacao');
            const listaDesignacoesPregacaoDiv = document.getElementById('lista-designacoes-pregacao');
            const acompanhaCarrinhosSwitch = document.getElementById('acompanha-carrinhos');
            const horariosSemanaDiv = document.getElementById('horarios-semana');
            const horariosFimDeSemanaDiv = document.getElementById('horarios-fim-de-semana');
            const ausenciaSingleDateInput = document.getElementById('ausencia-single-date');
            const addSingleAusenciaBtn = document.getElementById('add-single-ausencia-btn');
            const ausenciaStartDateInput = document.getElementById('ausencia-start-date');
            const ausenciaEndDateInput = document.getElementById('ausencia-end-date');
            const addAusenciaBtn = document.getElementById('add-ausencia-btn');
            const selectedAusenciasListDiv = document.getElementById('selected-ausencias-list');

            let selectedAusencias = [], selectedFamilyMembers = [], allPessoas = [], editingPersonId = null;
            let selectedSpouseId = null, originalSpouseId = null; 
            
            const nomeCurtoAviso = document.getElementById('nome-curto-aviso');

            function validateNomeUnico() {
                const nomeCurtoValue = nomePessoaInput.value.trim();
                if (!nomeCurtoValue) { nomeCurtoAviso.style.display = 'none'; return; }
                const matchedPerson = allPessoas.find(p => p.nomePessoa.toLowerCase() === nomeCurtoValue.toLowerCase() && p.id !== editingPersonId);
                if (matchedPerson) {
                    nomeCurtoAviso.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Aviso: Já existe alguém com este nome curto.`;
                    nomeCurtoAviso.style.display = 'block';
                } else {
                    nomeCurtoAviso.style.display = 'none';
                }
            }

            function toggleSectionInputs(sectionElement, isDisabled) { sectionElement.querySelectorAll('input, select, textarea, button').forEach(input => { input.disabled = isDisabled; }); sectionElement.classList.toggle('section-disabled', isDisabled); }
            function uncheckOtherCheckboxes(checkboxes, currentCheckbox) { checkboxes.forEach(cb => { if (cb !== currentCheckbox) cb.checked = false; }); }
            function getSingleCheckedValue(name) { const checked = document.querySelector(`input[name="${name}"]:checked`); return checked ? [checked.value] : []; }
            function getMultiCheckedValues(selector) { return Array.from(document.querySelectorAll(`${selector}:checked`)).map(cb => cb.value); }

            function updateAusenciasDisplay() {
                selectedAusenciasListDiv.innerHTML = '';
                selectedAusencias.sort();
                selectedAusencias.forEach(date => {
                    const item = document.createElement('div');
                    item.className = 'ausencia-item';
                    item.textContent = new Date(date + 'T00:00:00').toLocaleDateString('pt-PT');
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = () => {
                        selectedAusencias = selectedAusencias.filter(d => d !== date);
                        updateAusenciasDisplay();
                    };
                    item.appendChild(removeBtn);
                    selectedAusenciasListDiv.appendChild(item);
                });
            }

            function updateFamilyMembersDisplay() {
                selectedFamiliaListDiv.innerHTML = '';
                selectedFamilyMembers.forEach(memberName => {
                    const item = document.createElement('div');
                    item.className = 'familia-member-item';
                    item.textContent = memberName;
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = () => {
                        selectedFamilyMembers = selectedFamilyMembers.filter(m => m !== memberName);
                        updateFamilyMembersDisplay();
                    };
                    item.appendChild(removeBtn);
                    selectedFamiliaListDiv.appendChild(item);
                });
            }

            function createDesignacaoCheckbox(nome, listName) { const label = document.createElement('label'); label.className = 'checkbox-item'; label.innerHTML = `<input type="checkbox" name="${listName}" value="${nome}"> ${nome}`; return label; }
            function createTimeSlotCheckbox(time, day, type) { const label = document.createElement('label'); label.className = 'horario-item'; label.innerHTML = `<input type="checkbox" value="${time}" data-day="${day}" class="horario-checkbox" name="horario-${type}-${day}"> ${time}`; label.querySelector('input').onchange = (e) => label.classList.toggle('selected', e.target.checked); return label; }
            
            function getSelectedHorarios() {
                const horarios = { semana: { segunda: [], terca: [], quarta: [], quinta: [], sexta: [] }, fimDeSemana: { sabado: [], domingo: [] } };
                document.querySelectorAll('.horario-checkbox:checked').forEach(checkbox => {
                    const day = checkbox.dataset.day;
                    const time = checkbox.value;
                    if (horarios.semana.hasOwnProperty(day)) horarios.semana[day].push(time);
                    else if (horarios.fimDeSemana.hasOwnProperty(day)) horarios.fimDeSemana[day].push(time);
                });
                for (const day in horarios.semana) { horarios.semana[day].sort(); }
                for (const day in horarios.fimDeSemana) { horarios.fimDeSemana[day].sort(); }
                return horarios;
            }
            
            function showSuggestions(suggestions, container, onSelect) {
                container.innerHTML = '';
                if (suggestions.length === 0) { container.style.display = 'none'; return; }
                suggestions.forEach(person => {
                    const div = document.createElement('div');
                    div.textContent = person.nomePessoa;
                    div.addEventListener('click', () => { onSelect(person); });
                    container.appendChild(div);
                });
                container.style.display = 'block';
            }
            function hideSuggestions(container) { container.style.display = 'none'; }

            const loadDataPromises = [
                db.collection("nacionalidades").get().then(snapshot => snapshot.forEach(doc => idiomaSelect.add(new Option(doc.data().nome, doc.data().nome)))),
                db.collection("pessoas").orderBy("nomePessoa").get().then(snapshot => { allPessoas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); }),
                db.collection("designacoes").where("tipo", "==", "reuniao").orderBy("ordem").orderBy("nome").get().then(snapshot => snapshot.forEach(doc => { const data = doc.data(); const checkbox = createDesignacaoCheckbox(data.nome, 'designacoes-reuniao-list'); if (data.parte === 'escola') listaDesignacoesEscolaDiv.appendChild(checkbox); else if (data.parte === 'resto da semana') listaDesignacoesRestoSemanaDiv.appendChild(checkbox); else if (data.parte === 'fim de semana') listaDesignacoesFimSemanaDiv.appendChild(checkbox); })),
                db.collection("designacoes").where("tipo", "==", "pregacao").orderBy("nome").get().then(snapshot => snapshot.forEach(doc => listaDesignacoesPregacaoDiv.appendChild(createDesignacaoCheckbox(doc.data().nome, 'designacoes-pregacao-list')))),
                db.collection("horarios").orderBy("ano", "desc").limit(1).get().then(snapshot => { if (snapshot.empty) return; const data = snapshot.docs[0].data(); const weekOrder = ["segunda", "terca", "quarta", "quinta", "sexta"]; const weekendOrder = ["sabado", "domingo"]; const createDaySection = (day, times, container, type) => { if (!times || times.length === 0) return; const dayContainer = document.createElement('div'); dayContainer.className = 'day-container'; dayContainer.innerHTML = `<h4>${day.charAt(0).toUpperCase() + day.slice(1)}</h4>`; times.sort().forEach(time => dayContainer.appendChild(createTimeSlotCheckbox(time, day, type))); container.appendChild(dayContainer); }; if (data['dias-semana-horarios']) weekOrder.forEach(day => createDaySection(day, data['dias-semana-horarios'][day], horariosSemanaDiv, 'semana')); if (data['dias-fimdesemana-horarios']) weekendOrder.forEach(day => createDaySection(day, data['dias-fimdesemana-horarios'][day], horariosFimDeSemanaDiv, 'fim-de-semana')); })
            ];
            
            function populateFormForEdit(data) {
                nomePessoaInput.value = data.nomePessoa || '';
                nomeCompletoPessoaInput.value = data.nomeCompletoPessoa || '';
                emailInput.value = data.email || '';
                telemovelInput.value = data.telemovel || '';
                moradaInput.value = data.morada || '';
                idiomaSelect.value = data.idioma || '';
                if (data.genero === 'Masculino') generoMasculinoCheckbox.checked = true;
                if (data.genero === 'Feminino') generoFemininoCheckbox.checked = true;
                if (data.personalidade === '- à vontade') personalidadeMenosAvontadeCheckbox.checked = true;
                if (data.personalidade === '+ à vontade') personalidadeMaisAvontadeCheckbox.checked = true;
                naCongregacaoSwitch.checked = typeof data.naCongregacao !== 'undefined' ? data.naCongregacao : true;

                ativoSwitch.checked = typeof data.ativo !== 'undefined' ? data.ativo : true;
                if (ativoSwitch.checked) {
                    grupoSelect.value = data.grupo || '';
                    (data.privilegiosCongregacao || []).forEach(p => { const cb = document.querySelector(`input[name="privilegios-congregacao"][value="${p}"]`); if (cb) cb.checked = true; });
                    (data.privilegiosPregacao || []).forEach(p => { const cb = document.querySelector(`input[name="privilegios-pregacao"][value="${p}"]`); if (cb) cb.checked = true; });
                    (data.privilegiosEspeciais || []).forEach(p => { const cb = document.querySelector(`input[name="privilegios-especiais"][value="${p}"]`); if (cb) cb.checked = true; });
                }
                
                originalSpouseId = data.casadoCom || null;
                selectedSpouseId = originalSpouseId;
                if (selectedSpouseId) {
                    const spouse = allPessoas.find(p => p.id === selectedSpouseId);
                    casadoComInput.value = spouse ? spouse.nomePessoa : '';
                }
                selectedFamilyMembers = data.familia || [];
                updateFamilyMembersDisplay();
                dataNascimentoInput.value = data.dataNascimento || '';
                dataBatismoInput.value = data.dataBatismo || '';

                fazDesignacoesReuniaoSwitch.checked = data.fazDesignacoesReuniao || false;
                if (fazDesignacoesReuniaoSwitch.checked) {
                    (data.designacoesReuniao || []).forEach(d => {
                        const checkbox = document.querySelector(`input[name="designacoes-reuniao-list"][value="${d}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                fazDesignacoesPregacaoSwitch.checked = data.fazDesignacoesPregacao || false;
                if (fazDesignacoesPregacaoSwitch.checked) {
                    acompanhaCarrinhosSwitch.checked = data.acompanhaCarrinhos || false;
                    (data.designacoesPregacao || []).forEach(d => {
                        const checkbox = document.querySelector(`input[name="designacoes-pregacao-list"][value="${d}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                    const horarios = data.horariosPregacao || {};
                    document.querySelectorAll('.horario-checkbox').forEach(cb => {
                        const day = cb.dataset.day;
                        const time = cb.value;
                        const isSemana = horarios.semana && horarios.semana[day] && horarios.semana[day].includes(time);
                        const isFds = horarios.fimDeSemana && horarios.fimDeSemana[day] && horarios.fimDeSemana[day].includes(time);
                        if (isSemana || isFds) {
                            cb.checked = true;
                            cb.parentElement.classList.add('selected');
                        }
                    });
                }
                
                selectedAusencias = data.ausencias || [];
                updateAusenciasDisplay();

                toggleSpiritualSection();
                toggleDesignacoesReuniaoSection();
                toggleDesignacoesPregacaoSection();
            }

            Promise.all(loadDataPromises).then(() => {
                const urlParams = new URLSearchParams(window.location.search);
                editingPersonId = urlParams.get('id');
                if (editingPersonId) {
                    pageTitle.textContent = 'Editar Pessoa';
                    submitButton.textContent = 'Salvar Alterações';
                    db.collection('pessoas').doc(editingPersonId).get().then(doc => {
                        if (doc.exists) {
                            populateFormForEdit(doc.data());
                        } else {
                            alert('Pessoa não encontrada!');
                        }
                    });
                } else {
                    toggleSpiritualSection();
                    toggleDesignacoesReuniaoSection();
                    toggleDesignacoesPregacaoSection();
                }
            }).catch(error => console.error("Erro ao carregar dados iniciais:", error));
            
            function toggleSpiritualSection() { const isAtivo = ativoSwitch.checked; ativoLabel.textContent = isAtivo ? "Sim" : "Não"; toggleSectionInputs(spiritualInfoContent, !isAtivo); }
            ativoSwitch.addEventListener('change', toggleSpiritualSection);
            
            function toggleDesignacoesReuniaoSection() { toggleSectionInputs(designacoesReuniaoSection, !fazDesignacoesReuniaoSwitch.checked); }
            fazDesignacoesReuniaoSwitch.addEventListener('change', toggleDesignacoesReuniaoSection);
            
            function toggleDesignacoesPregacaoSection() { toggleSectionInputs(designacoesPregacaoSection, !fazDesignacoesPregacaoSwitch.checked); }
            fazDesignacoesPregacaoSwitch.addEventListener('change', toggleDesignacoesPregacaoSection);

            personalidadeMenosAvontadeCheckbox.onchange = () => { if (personalidadeMenosAvontadeCheckbox.checked) personalidadeMaisAvontadeCheckbox.checked = false; };
            personalidadeMaisAvontadeCheckbox.onchange = () => { if (personalidadeMaisAvontadeCheckbox.checked) personalidadeMenosAvontadeCheckbox.checked = false; };

            const checkboxesCongregacao = document.querySelectorAll('input[name="privilegios-congregacao"]');
            checkboxesCongregacao.forEach(cb => { cb.addEventListener('change', (e) => { uncheckOtherCheckboxes(checkboxesCongregacao, e.target); }); });
            
            const checkboxesPregacao = document.querySelectorAll('input[name="privilegios-pregacao"]');
            checkboxesPregacao.forEach(cb => { cb.addEventListener('change', (e) => uncheckOtherCheckboxes(checkboxesPregacao, e.target)); });

            function handleSpouseSuggestions() {
                const inputText = casadoComInput.value.toLowerCase().trim();
                if (!inputText) { hideSuggestions(pessoasSuggestionsDiv); return; }
                let targetGender = null;
                if (generoMasculinoCheckbox.checked) targetGender = 'Feminino';
                else if (generoFemininoCheckbox.checked) targetGender = 'Masculino';
                
                let suggestions = allPessoas.filter(p => p.nomePessoa.toLowerCase().includes(inputText) && p.id !== editingPersonId);
                if (targetGender) { suggestions = suggestions.filter(p => p.genero === targetGender); }

                if (suggestions.length > 0) {
                    showSuggestions(suggestions, pessoasSuggestionsDiv, (selectedPerson) => {
                        casadoComInput.value = selectedPerson.nomePessoa;
                        selectedSpouseId = selectedPerson.id;
                        hideSuggestions(pessoasSuggestionsDiv);
                    });
                } else {
                    hideSuggestions(pessoasSuggestionsDiv);
                }
            }
            
            nomePessoaInput.addEventListener('input', validateNomeUnico);
            casadoComInput.addEventListener('input', () => { selectedSpouseId = null; handleSpouseSuggestions(); });
            generoMasculinoCheckbox.onchange = () => { if (generoMasculinoCheckbox.checked) generoFemininoCheckbox.checked = false; handleSpouseSuggestions(); };
            generoFemininoCheckbox.onchange = () => { if (generoFemininoCheckbox.checked) generoMasculinoCheckbox.checked = false; handleSpouseSuggestions(); };

            familiaSearchInput.addEventListener('input', () => {
                const inputText = familiaSearchInput.value.toLowerCase().trim();
                if (!inputText) { hideSuggestions(familiaSuggestionsDiv); return; }
                const suggestions = allPessoas.filter(p => p.nomePessoa.toLowerCase().includes(inputText) && p.id !== editingPersonId && !selectedFamilyMembers.includes(p.nomePessoa));
                if (suggestions.length > 0) {
                    showSuggestions(suggestions, familiaSuggestionsDiv, (selectedPerson) => {
                        selectedFamilyMembers.push(selectedPerson.nomePessoa);
                        updateFamilyMembersDisplay();
                        familiaSearchInput.value = '';
                        hideSuggestions(familiaSuggestionsDiv);
                    });
                } else {
                    hideSuggestions(familiaSuggestionsDiv);
                }
            });

            document.addEventListener('click', (e) => {
                if (!pessoasSuggestionsDiv.contains(e.target) && e.target !== casadoComInput) hideSuggestions(pessoasSuggestionsDiv);
                if (!familiaSuggestionsDiv.contains(e.target) && e.target !== familiaSearchInput) hideSuggestions(familiaSuggestionsDiv);
            });

            addSingleAusenciaBtn.addEventListener('click', () => {
                const date = ausenciaSingleDateInput.value;
                if (date && !selectedAusencias.includes(date)) {
                    selectedAusencias.push(date);
                    updateAusenciasDisplay();
                }
                ausenciaSingleDateInput.value = '';
            });

            addAusenciaBtn.addEventListener('click', () => {
                const startDate = new Date(ausenciaStartDateInput.value + 'T00:00:00');
                const endDate = new Date(ausenciaEndDateInput.value + 'T00:00:00');
                if (ausenciaStartDateInput.value && ausenciaEndDateInput.value && startDate <= endDate) {
                    for (let d = startDate; d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateString = d.toISOString().split('T')[0];
                        if (!selectedAusencias.includes(dateString)) selectedAusencias.push(dateString);
                    }
                    updateAusenciasDisplay();
                }
                ausenciaStartDateInput.value = '';
                ausenciaEndDateInput.value = '';
            });

            criarPessoaForm.onsubmit = (e) => {
                e.preventDefault();
                const nome = nomePessoaInput.value.trim();
                if (!nome || (!generoMasculinoCheckbox.checked && !generoFemininoCheckbox.checked) || !idiomaSelect.value) { alert('Nome Curto, Gênero e Idioma são obrigatórios.'); return; }
                if (casadoComInput.value.trim() === '') { selectedSpouseId = null; }

                const pessoaData = {
                    nomePessoa: nome,
                    nomeCompletoPessoa: nomeCompletoPessoaInput.value.trim(),
                    email: emailInput.value.trim(),
                    telemovel: telemovelInput.value.trim(),
                    morada: moradaInput.value.trim(),
                    idioma: idiomaSelect.value,
                    genero: generoMasculinoCheckbox.checked ? 'Masculino' : 'Feminino',
                    personalidade: personalidadeMenosAvontadeCheckbox.checked ? '- à vontade' : (personalidadeMaisAvontadeCheckbox.checked ? '+ à vontade' : ''),
                    naCongregacao: naCongregacaoSwitch.checked,
                    ativo: ativoSwitch.checked,
                    grupo: ativoSwitch.checked ? grupoSelect.value : '',
                    privilegiosCongregacao: ativoSwitch.checked ? getSingleCheckedValue('privilegios-congregacao') : [],
                    privilegiosPregacao: ativoSwitch.checked ? getSingleCheckedValue('privilegios-pregacao') : [],
                    privilegiosEspeciais: ativoSwitch.checked ? getSingleCheckedValue('privilegios-especiais') : [],
                    casadoCom: selectedSpouseId,
                    familia: selectedFamilyMembers.sort(),
                    dataNascimento: dataNascimentoInput.value || null,
                    dataBatismo: dataBatismoInput.value || null,
                    fazDesignacoesReuniao: fazDesignacoesReuniaoSwitch.checked,
                    designacoesReuniao: fazDesignacoesReuniaoSwitch.checked ? getMultiCheckedValues('input[name="designacoes-reuniao-list"]') : [],
                    fazDesignacoesPregacao: fazDesignacoesPregacaoSwitch.checked,
                    acompanhaCarrinhos: fazDesignacoesPregacaoSwitch.checked ? acompanhaCarrinhosSwitch.checked : false,
                    designacoesPregacao: fazDesignacoesPregacaoSwitch.checked ? getMultiCheckedValues('input[name="designacoes-pregacao-list"]') : [],
                    horariosPregacao: fazDesignacoesPregacaoSwitch.checked ? getSelectedHorarios() : { semana: {}, fimDeSemana: {} },
                    ausencias: selectedAusencias.sort()
                };
                
                const promise = editingPersonId ? db.collection("pessoas").doc(editingPersonId).update(pessoaData) : db.collection("pessoas").add(pessoaData);
                promise.then((result) => {
                    const currentPersonId = editingPersonId || result.id;
                    const newSpouseId = selectedSpouseId;
                    const spouseUpdatePromises = [];
                    if (originalSpouseId && originalSpouseId !== newSpouseId) {
                        spouseUpdatePromises.push(db.collection("pessoas").doc(originalSpouseId).update({ casadoCom: null }));
                    }
                    if (newSpouseId && newSpouseId !== originalSpouseId) {
                        spouseUpdatePromises.push(db.collection("pessoas").doc(newSpouseId).update({ casadoCom: currentPersonId }));
                    }
                    if (spouseUpdatePromises.length === 0) {
                        alert(`Pessoa ${editingPersonId ? 'atualizada' : 'criada'} com sucesso!`);
                        window.location.href = 'nomes.html';
                        return;
                    }
                    Promise.all(spouseUpdatePromises)
                        .then(() => {
                            alert(`Pessoa ${editingPersonId ? 'atualizada' : 'criada'} com sucesso! Vínculos de casamento atualizados.`);
                            window.location.href = 'nomes.html';
                        })
                        .catch(error => {
                            alert(`Pessoa salva, mas ocorreu um erro ao atualizar os cônjuges: ${error.message}`);
                            window.location.href = 'nomes.html';
                        });
                }).catch(error => alert("Erro ao salvar: " + error.message));
            };
        });
    </script>

    <!-- Script que carrega o menu -->
    <script src="main.js"></script>

</body>
</html>
