<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Designação - Sistema de Escala</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        main.content { background-color: #f4f7f9; color: #2c3e50; padding: 20px; min-height: 100vh; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: 40px auto 0 auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: #2c3e50; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .switch-group { display: flex; align-items: center; justify-content: space-between; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e74c3c; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .btn-salvar { background-color: #2980b9; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; transition: background-color 0.3s; }
        .btn-salvar:hover { background-color: #3498db; }
        .checkbox-group { display: flex; flex-direction: column; gap: 8px; }
        .checkbox-item { display: flex; align-items: center; padding: 6px; border-radius: 4px; font-size: 14px; }
        .checkbox-item input[type="checkbox"] { margin-right: 8px; }
        .btn-voltar { display: inline-block; margin-bottom: 20px; background-color: #7f8c8d; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; transition: background-color 0.3s; }
        .checkbox-item:has(input[value="Ancião"]) { background-color: #bbdefb; }
        .checkbox-item:has(input[value="Servo Ministerial"]) { background-color: #c8e6c9; }
        .checkbox-item:has(input[value="Pioneiro Regular"]) { background-color: #fff9c4; }
        .checkbox-item:has(input[value="Pioneiro Auxiliar"]) { background-color: #ffecb3; }
        .checkbox-item:has(input[value="Publicador"]) { background-color: #ffcdd2; }
        .checkbox-item:has(input[value="Publicador não Batizado"]) { background-color: #f8bbd0; }
        .list-container { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .list-container { grid-template-columns: 1fr 1fr; } }
        .panel-card { background-color: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .panel-card h2 { color: #2c3e50; margin-top: 0; margin-bottom: 15px; font-size: 20px; }
        .designation-list { margin-top: 15px; }
        .designation-item { display: flex; align-items: center; padding: 10px; background-color: #fff; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 8px; justify-content: space-between; }
        .designation-name { margin-left: 10px; text-align: left; flex-grow: 1; }
        .designation-status i.fa-check { color: #2ecc71; }
        .designation-status i.fa-times { color: #e74c3c; }
        .edit-btn.inline { background: none; border: none; color: #3498db; cursor: pointer; font-size: 19px; }
        .edit-btn.inline:hover { color: #2980b9; }

        .help-text { font-style: italic; font-size: 0.7em; color: #7f8c8d; font-weight: normal; margin-left: 8px; }
        .checkbox-group-horizontal { display: flex; gap: 10px; flex-wrap: wrap; }
        .option-item-horizontal { display: flex; align-items: center; padding: 8px 16px; border-radius: 20px; background-color: #ecf0f1; border: 1px solid #bdc3c7; cursor: pointer; transition: background-color 0.3s; }
        .option-item-horizontal:has(input:checked) { background-color: #3498db; color: white; border-color: #2980b9; }
        .option-item-horizontal input[type="radio"] { display: none; }

        /* --- NOVO ESTILO PARA A SEÇÃO DE HORÁRIOS --- */
        #horarios-anexo-section {
            background-color: #f2f5f7;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
        }
        #horarios-anexo-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
        }
        #horarios-anexo-section .horarios-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #horarios-anexo-section .horarios-group h5 {
            width: 100%;
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 8px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

    </style>
</head>
<body>
    
   <div id="sidebar-placeholder"></div>

    <main class="content">
        <a href="index.html" class="btn-voltar"><i class="fas fa-arrow-left"></i> Voltar</a>
        <h1>Editar Designação</h1>
        
        <div class="list-container">
            <div class="panel-card">
                <h2>Designações de Reunião</h2>
                <div id="lista-reuniao" class="designation-list">Carregando...</div>
            </div>
            <div class="panel-card">
                <h2>Designações de Pregação</h2>
                <div id="lista-pregacao" class="designation-list">Carregando...</div>
            </div>
        </div>
        
        <div class="card" id="edit-form-card" style="display: none;">
            <form id="editar-designacao-form">
                <div class="form-group"><label for="nome-designacao">Nome da Designação</label><input type="text" id="nome-designacao" required></div>
                <div class="form-group"><label for="numero-participantes">Número de Participantes</label><select id="numero-participantes" required><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div>
                <div class="form-group"><label for="feito-por">Feito por</label><select id="feito-por" required><option value="Masculino">Apenas Homens</option><option value="Feminino">Apenas Mulheres</option><option value="Masculino Feminino">Homens e Mulheres</option></select></div>
                <div class="form-group"><label for="preferencia">Preferência</label><select id="preferencia" required><option value="Masculino">Homens</option><option value="Feminino">Mulheres</option><option value="Masculino Feminino">Homens e Mulheres</option></select></div>
                <div class="form-group">
                    <label>Personalidade (do Dirigente)</label>
                    <div class="checkbox-group-horizontal">
                        <label class="option-item-horizontal"><input type="radio" name="personalidade" value="- à vontade"> - à vontade</label>
                        <label class="option-item-horizontal"><input type="radio" name="personalidade" value="+ à vontade"> + à vontade</label>
                    </div>
                </div>
                <div class="form-group"><label for="quando">Quando?</label><select id="quando" required><option value="Semana">Semana</option><option value="Fim de Semana">Fim de Semana</option><option value="Semana e Fim de Semana">Semana e Fim de Semana</option></select></div>
                <div class="form-group"><label for="tipo">Tipo</label><select id="tipo" required><option value="reuniao">Reunião</option><option value="pregacao">Pregação</option></select></div>
                <div class="form-group"><label for="parte">Parte</label><select id="parte" required><option value="escola">Escola</option><option value="resto da semana">Resto da Semana</option><option value="fim de semana">Fim de Semana</option><option value="tecnicas">Técnicas</option><option value="pregacao">Pregação</option><option value="dirigencia saida">Dirigência Saída</option></select></div>
                
                <!-- INÍCIO DA NOVA SEÇÃO DE HORÁRIOS ANEXADOS -->
                <div id="horarios-anexo-section" style="display: none;">
                    <h4>Escolha aqui um horário para anexar ao Dirigente <span class="help-text">(Opcional)</span></h4>
                    <div class="horarios-container" id="horarios-container">
                        <!-- Os horários serão inseridos aqui pelo JavaScript -->
                    </div>
                </div>
                <!-- FIM DA NOVA SEÇÃO -->

                <div class="form-group"><label for="anexo">Anexo <span class="help-text">(Anexar a um Cabeçalho para aparecer na Escala)</span></label><select id="anexo"><option value="">Carregando Anexos...</option></select></div>
                
                <div class="form-group">
                    <label for="descricao">Descrição <span class="help-text">(Necessidades Locais, Orador, etc...)</span></label>
                    <select id="descricao">
                        <option value="nao">Não</option>
                        <option value="sim">Sim</option>
                    </select>
                </div>
                
                <div class="form-group" id="anexado-discursos-group" style="display: none;">
                    <label for="anexado-discursos">Anexado a Discursos</label>
                    <select id="anexado-discursos">
                        <option value="nao" selected>Não</option>
                        <option value="sim">Sim</option>
                    </select>
                </div>
                
                <div class="form-group"><label for="emoji">Emoji (Opcional)</label><input type="text" id="emoji" maxlength="2"></div>
                <div class="form-group"><label>Quem faz?</label><div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Ancião">Ancião</label><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Servo Ministerial">Servo Ministerial</label><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Pioneiro Regular">Pioneiro Regular</label><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Pioneiro Auxiliar">Pioneiro Auxiliar</label><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Publicador">Publicador</label><label class="checkbox-item"><input type="checkbox" name="quem_faz" value="Publicador não Batizado">Publicador não Batizado</label></div></div>
                <div class="form-group switch-group"><label for="status">Desligado/Ligado</label><label class="switch"><input type="checkbox" id="status"><span class="slider round"></span></label></div>
                <button type="submit" class="btn-salvar">Salvar Alterações</button>
            </form>
        </div>
    </main>

    <script src="firebase-config.js"></script>
    <script src="main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            if (typeof db === 'undefined') { alert("Erro de configuração do banco de dados."); return; }

            const mainContent = document.querySelector('.content');
            const editFormCard = document.getElementById('edit-form-card');
            const editForm = document.getElementById('editar-designacao-form');
            const listaReuniaoDiv = document.getElementById('lista-reuniao');
            const listaPregacaoDiv = document.getElementById('lista-pregacao');

            // --- Seletores para a nova funcionalidade ---
            const parteSelect = document.getElementById('parte');
            const horariosSection = document.getElementById('horarios-anexo-section');
            let horariosCarregados = false; // Flag para carregar os horários apenas uma vez

            let idAtualEmEdicao = null;

            const descricaoSelect = document.getElementById('descricao');
            const anexadoDiscursosGroup = document.getElementById('anexado-discursos-group');

            descricaoSelect.addEventListener('change', function() {
                anexadoDiscursosGroup.style.display = (this.value === 'sim') ? 'block' : 'none';
                if (this.value !== 'sim') {
                    document.getElementById('anexado-discursos').value = 'nao';
                }
            });

            async function carregarAnexos() {
                const anexoSelect = document.getElementById('anexo');
                anexoSelect.innerHTML = '<option value="">Selecione um anexo</option>';
                try {
                    const snapshot = await db.collection('cabecalhos').get();
                    snapshot.forEach(doc => {
                        const anexo = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = anexo.nome;
                        anexoSelect.appendChild(option);
                    });
                } catch (error) { console.error("Erro ao carregar anexos: ", error); }
            }
            
            // --- FUNÇÕES PARA A NOVA SEÇÃO DE HORÁRIOS ---
            function capitalize(string) { return string.charAt(0).toUpperCase() + string.slice(1); }

            async function carregarHorariosPregacao(horarioSalvo = null) {
                if (horariosCarregados) { // Se já carregou, apenas atualiza a seleção
                     document.querySelectorAll('input[name="horario_anexado"]').forEach(radio => {
                        radio.checked = (radio.value === horarioSalvo);
                    });
                    return;
                }
                const container = document.getElementById('horarios-container');
                container.innerHTML = '';
                try {
                    const snapshot = await db.collection('horarios').where('tipo', '==', 'pregacao').get();
                    if (snapshot.empty) { container.textContent = 'Nenhum horário de pregação encontrado.'; return; }
                    let semanaHTML = '<div class="horarios-group" style="width: 100%;"><h5>-- Durante a Semana</h5>';
                    let fimDeSemanaHTML = '<div class="horarios-group" style="width: 100%;"><h5>-- Durante Fim de Semana</h5>';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data['dias-semana-horarios']) {
                            for (const dia in data['dias-semana-horarios']) {
                                data['dias-semana-horarios'][dia].forEach(hora => {
                                    const valor = `${capitalize(dia)} ${hora}`;
                                    const checked = valor === horarioSalvo ? 'checked' : '';
                                    semanaHTML += `<label class="option-item-horizontal"><input type="radio" name="horario_anexado" value="${valor}" ${checked}>${valor}</label>`;
                                });
                            }
                        }
                        if (data['dias-fimdesemana-horarios']) {
                            for (const dia in data['dias-fimdesemana-horarios']) {
                                let diaFormatado = dia === 'sabado' ? 'Sábado' : capitalize(dia);
                                data['dias-fimdesemana-horarios'][dia].forEach(hora => {
                                    const valor = `${diaFormatado} ${hora}`;
                                    const checked = valor === horarioSalvo ? 'checked' : '';
                                    fimDeSemanaHTML += `<label class="option-item-horizontal"><input type="radio" name="horario_anexado" value="${valor}" ${checked}>${valor}</label>`;
                                });
                            }
                        }
                    });
                    semanaHTML += '</div>';
                    fimDeSemanaHTML += '</div>';
                    container.innerHTML = semanaHTML + fimDeSemanaHTML;
                    horariosCarregados = true;
                } catch (error) { console.error("Erro ao carregar horários: ", error); container.textContent = 'Erro ao carregar horários.'; }
            }

            parteSelect.addEventListener('change', function() {
                if (this.value === 'dirigencia saida') {
                    horariosSection.style.display = 'block';
                    carregarHorariosPregacao(); // Carrega os horários sem pré-seleção
                } else {
                    horariosSection.style.display = 'none';
                }
            });

            // --- FIM DAS FUNÇÕES DA NOVA SEÇÃO ---

            async function renderizarListas() {
                listaReuniaoDiv.innerHTML = 'Carregando...';
                listaPregacaoDiv.innerHTML = 'Carregando...';
                try {
                    const snapshot = await db.collection('designacoes').orderBy('nome').get();
                    listaReuniaoDiv.innerHTML = '';
                    listaPregacaoDiv.innerHTML = '';
                    if (snapshot.empty) {
                        listaReuniaoDiv.innerHTML = 'Nenhuma designação encontrada.';
                        listaPregacaoDiv.innerHTML = 'Nenhuma designação encontrada.';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const itemHtml = `<div class="designation-item" data-id="${doc.id}"><span class="designation-status"><i class="fas ${data.status ? 'fa-check' : 'fa-times'}"></i></span><span class="designation-name">${data.nome}</span><button class="edit-btn inline"><i class="fas fa-edit"></i></button></div>`;
                        if (data.tipo === 'reuniao') { listaReuniaoDiv.innerHTML += itemHtml; } 
                        else if (data.tipo === 'pregacao') { listaPregacaoDiv.innerHTML += itemHtml; }
                    });
                } catch (error) {
                    console.error("Erro ao carregar designações: ", error);
                    listaReuniaoDiv.innerHTML = 'Erro ao carregar.';
                    listaPregacaoDiv.innerHTML = 'Erro ao carregar.';
                }
            }

            async function carregarDadosFormulario(id) {
                try {
                    const doc = await db.collection('designacoes').doc(id).get();
                    if (doc.exists) {
                        const data = doc.data();
                        // Preenchimento dos campos existentes
                        document.getElementById('nome-designacao').value = data.nome || '';
                        document.getElementById('numero-participantes').value = data.numeroParticipantes || '1';
                        document.getElementById('feito-por').value = data.feitoPor || 'Masculino';
                        document.getElementById('preferencia').value = data.preferencia || 'Masculino';
                        document.getElementById('quando').value = data.quando || 'Semana';
                        document.getElementById('tipo').value = data.tipo || 'reuniao';
                        document.getElementById('parte').value = data.parte || 'escola';
                        document.getElementById('anexo').value = data.anexo || '';
                        document.getElementById('descricao').value = data.descricao || 'nao';
                        document.getElementById('status').checked = data.status;
                        document.getElementById('emoji').value = data.emoji || '';
                        document.getElementById('anexado-discursos').value = data.anexadoDiscursos || 'nao';
                        anexadoDiscursosGroup.style.display = (data.descricao === 'sim') ? 'block' : 'none';

                        document.querySelectorAll('input[name="quem_faz"]').forEach(cb => cb.checked = false);
                        if (data.quemFaz && Array.isArray(data.quemFaz)) { data.quemFaz.forEach(p => { const cb = document.querySelector(`input[name="quem_faz"][value="${p}"]`); if (cb) cb.checked = true; }); }
                        document.querySelectorAll('input[name="personalidade"]').forEach(radio => radio.checked = false);
                        if (data.personalidade) { const rb = document.querySelector(`input[name="personalidade"][value="${data.personalidade}"]`); if (rb) rb.checked = true; }
                        
                        // --- LÓGICA PARA EXIBIR E PREENCHER A SEÇÃO DE HORÁRIOS ---
                        if (data.parte === 'dirigencia saida') {
                            horariosSection.style.display = 'block';
                            await carregarHorariosPregacao(data.horarioAnexado || null);
                        } else {
                            horariosSection.style.display = 'none';
                        }
                        // --- FIM DA LÓGICA ---

                        idAtualEmEdicao = id;
                        editFormCard.style.display = 'block';
                        editFormCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } catch (error) { console.error("Erro ao buscar dados da designação:", error); }
            }
            
            await carregarAnexos();
            await renderizarListas();

            mainContent.addEventListener('click', function(e) {
                const editButton = e.target.closest('.edit-btn.inline');
                if (editButton) { carregarDadosFormulario(e.target.closest('.designation-item').dataset.id); }
            });

            editForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (!idAtualEmEdicao) return;
                if (!document.querySelector('input[name="quem_faz"]:checked')) { alert('O campo "Quem faz?" é obrigatório.'); return; }

                const personalidadeSelecionada = document.querySelector('input[name="personalidade"]:checked');
                const horarioAnexadoSelecionado = document.querySelector('input[name="horario_anexado"]:checked');

                const designacaoAtualizada = {
                    nome: document.getElementById('nome-designacao').value,
                    numeroParticipantes: parseInt(document.getElementById('numero-participantes').value),
                    feitoPor: document.getElementById('feito-por').value,
                    preferencia: document.getElementById('preferencia').value,
                    personalidade: personalidadeSelecionada ? personalidadeSelecionada.value : "",
                    quando: document.getElementById('quando').value,
                    tipo: document.getElementById('tipo').value,
                    parte: document.getElementById('parte').value,
                    // --- SALVANDO O HORÁRIO ANEXADO ---
                    horarioAnexado: horarioAnexadoSelecionado ? horarioAnexadoSelecionado.value : "",
                    anexo: document.getElementById('anexo').value,
                    descricao: document.getElementById('descricao').value,
                    anexadoDiscursos: document.getElementById('anexado-discursos').value,
                    emoji: document.getElementById('emoji').value,
                    status: document.getElementById('status').checked,
                    quemFaz: Array.from(document.querySelectorAll('input[name="quem_faz"]:checked')).map(cb => cb.value),
                    dataModificacao: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await db.collection('designacoes').doc(idAtualEmEdicao).update(designacaoAtualizada);
                    alert('Designação atualizada com sucesso!');
                    editFormCard.style.display = 'none';
                    idAtualEmEdicao = null;
                    await renderizarListas();
                } catch (error) { console.error("Erro ao atualizar:", error); alert("Erro ao salvar."); }
            });
        });
    </script>
</body>
</html>
