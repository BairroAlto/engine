<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Escala - Estatísticas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos Gerais */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; display: flex; min-height: 100vh; background-color: #f5f6fa; }

        /* Estilos da Sidebar */
        .sidebar { width: 250px; background-color: #2c3e50; color: white; padding-top: 20px; height: 100vh; position: fixed; left: 0; top: 0; display: flex; flex-direction: column; overflow-y: auto; }
        .logo { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #34495e; }
        .logo h2 { margin: 0; }
        .nav-list { list-style: none; padding: 0; }
        .nav-item a { color: white; text-decoration: none; display: flex; align-items: center; padding: 15px 20px; transition: background-color 0.3s; }
        .nav-item a i { margin-right: 15px; width: 20px; text-align: center; }
        .nav-item a:hover { background-color: #34495e; }
        .nav-item.active a { background-color: #1abc9c; }

        /* Estilos do Conteúdo Principal */
        .content { margin-left: 250px; padding: 30px; flex-grow: 1; width: calc(100% - 250px); }
        h1 { color: #2c3e50; margin-bottom: 30px; font-size: 28px; }
        .card { background-color: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { color: #2c3e50; margin-bottom: 15px; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;}

        /* Estilos das Abas */
        .tab-container { overflow: auto; white-space: nowrap; border-bottom: 1px solid #ccc; margin-bottom: 20px; }
        .tab-link { background-color: inherit; display: inline-block; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 16px; border-bottom: 3px solid transparent; }
        .tab-link:hover { background-color: #f1f1f1; }
        .tab-link.active { font-weight: bold; color: #2c3e50; border-bottom: 3px solid #1abc9c; }
        .tab-content { display: none; animation: fadeEffect 0.5s; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }
        
        /* Estilos da Secção de Filtros Retrátil */
        .collapsible-container { background-color: #ecf0f1; border-radius: 8px; margin-bottom: 20px; }
        .filter-toggle-button { background-color: transparent; border: none; padding: 15px 20px; width: 100%; text-align: left; cursor: pointer; font-size: 16px; font-weight: bold; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        .filter-toggle-button .toggle-icon { margin-left: auto; transition: transform 0.3s ease; }
        .collapsible-container.open .filter-toggle-button .toggle-icon { transform: rotate(180deg); }
        .filter-panel-wrapper { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .filter-panel-wrapper.overflow-visible { overflow: visible; }
        .collapsible-container.open .filter-panel-wrapper { max-height: 1000px; transition: max-height 0.4s ease-in; }

        /* Estilos do Painel de Filtros */
        .filter-panel { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; padding: 20px; border-top: 1px solid #bdc3c7; }
        .filter-item { display: flex; flex-direction: column; gap: 5px; }
        .filter-item label { font-weight: bold; font-size: 14px; color: #34495e; }
        .sync-filter-item { display: flex; align-items: center; gap: 8px; padding-bottom: 8px; }
        .sync-filter-item label { cursor: pointer; }

        /* Estilos do Multi-Select Dropdown */
        .multi-select-container { position: relative; width: 200px; }
        .multi-select-button { width: 100%; text-align: left; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; background-color: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .multi-select-button::after { content: '▼'; font-size: 12px; }
        
        .multi-select-options { display: none; position: absolute; background-color: white; color: #2c3e50; border-radius: 4px; z-index: 10; width: 100%; max-height: 250px; overflow-y: auto; border: 1px solid #bdc3c7; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .multi-select-options.open { display: block; }
        .multi-select-header { padding: 8px; display: flex; justify-content: space-between; border-bottom: 1px solid #dfe6e9; background-color: #f8f9fa; }
        .multi-select-header a { color: #2980b9; text-decoration: none; cursor: pointer; font-size: 14px; font-weight: bold; }
        .multi-select-search-wrapper { padding: 8px; border-bottom: 1px solid #dfe6e9; background-color: #f8f9fa; }
        .multi-select-search { width: 100%; padding: 6px 10px; border: 1px solid #bdc3c7; border-radius: 4px; background-color: #f5f6fa; color: #2c3e50; box-sizing: border-box; }
        .multi-select-search:focus { outline: none; border-color: #1abc9c; }
        .multi-select-options label { display: block; padding: 8px 12px; cursor: pointer; }
        .multi-select-options label:hover { background-color: #f1f1f1; }
        .multi-select-options input { margin-right: 8px; }
        
        /* ESTILOS PARA A ABA GERAL */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-item { background-color: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #1abc9c; }
        .stat-item h3 { font-size: 16px; color: #34495e; margin-bottom: 8px; }
        .stat-item p { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .stat-item p span { font-size: 14px; font-weight: normal; color: #7f8c8d; }
        #idiomas-container .idioma-stat, #media-idiomas-container .idioma-stat, #perc-idiomas-container .idioma-stat { margin-top: 5px; font-size: 18px; font-weight: 500;}
        .chart-container { background-color: #2c3e50; color: white; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .chart-container h2 { color: white; border-bottom-color: #34495e; }
        .charts-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }

        /* ESTILOS PARA A ABA TOP */
        .sub-tab-container { border-bottom: 1px solid #dfe6e9; margin-bottom: 20px; }
        .sub-tab-link { background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 15px; color: #7f8c8d; border-bottom: 2px solid transparent; }
        .sub-tab-link.active { color: #2c3e50; font-weight: bold; border-bottom-color: #2980b9; }
        .sub-tab-content { display: none; }
        .top-list { list-style-type: none; padding: 0; }
        .top-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 8px; border-bottom: 1px solid #ecf0f1; transition: background-color 0.2s; }
        .top-list-item:hover { background-color: #f8f9fa; }
        .top-list-item .name { font-weight: 500; }
        .top-list-item .count { font-weight: bold; font-size: 16px; color: #1abc9c; background-color: #e8f8f5; padding: 4px 10px; border-radius: 12px; }
        .list-view-controls { margin-bottom: 15px; display: flex; gap: 10px; }
        .control-button { background-color: #ecf0f1; border: 1px solid #bdc3c7; color: #2c3e50; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s, color 0.3s; }
        .control-button.active { background-color: #3498db; color: white; border-color: #3498db; }
        .detailed-list-item { font-size: 14px; padding: 8px; flex-direction: column; align-items: flex-start; }
        .detailed-list-item .date { font-weight: bold; color: #34495e; }
        .detailed-list-item .assignment { color: #2980b9; }
        .detailed-list-item .participants { color: #7f8c8d; }

        /* ESTILOS PARA A ABA COMPARAÇÃO */
        .comparison-search-container { position: relative; max-width: 500px; }
        #comparison-search-input, #individual-search-input { width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 16px; }
        .search-results { display: none; position: absolute; width: 100%; background-color: white; border: 1px solid #dfe6e9; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 100; }
        .search-result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f1f1; }
        .search-result-item:hover { background-color: #ecf0f1; }
        .search-result-item:last-child { border-bottom: none; }
        #comparison-cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 20px; }
        .person-comparison-card { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; border-left: 5px solid #3498db; }
        .person-comparison-card h3 { color: #2c3e50; margin-bottom: 15px; }
        .person-comparison-card .stat { font-size: 16px; margin-bottom: 10px; }
        .person-comparison-card .stat strong { color: #2980b9; }
        .person-comparison-card .top-assignments-list { list-style-type: none; padding-left: 0; margin-top: 10px; }
        .person-comparison-card .top-assignments-list li { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ecf0f1; font-size: 14px; }
        .person-comparison-card .top-assignments-list li .count { font-weight: bold; background-color: #eaf2f8; padding: 2px 8px; border-radius: 10px; }
        .remove-person-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #c0392b; font-size: 18px; cursor: pointer; transition: color 0.2s; }
        .remove-person-btn:hover { color: #e74c3c; }
        #comparison-chart-container .chart-container { background-color: white; padding: 15px; border-radius: 8px; }

        /* ESTILOS PARA A ABA INDIVIDUAL */
        #individual-summary-header { display: flex; justify-content: space-between; align-items: center; font-size: 16px; padding: 10px; flex-wrap: wrap; gap: 10px; }
        #individual-total-count { font-weight: bold; color: #2c3e50; }
        #individual-peer-average strong { font-size: 18px; }
        .color-green { color: #27ae60; }
        .color-red { color: #c0392b; }
        .color-blue { color: #2980b9; }
        .individual-content-wrapper { display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 20px; margin-top: 20px; }
        #individual-detailed-list .detailed-list-item { transition: background-color 0.3s; border-radius: 4px; }
        #individual-detailed-list .highlight { background-color: #eaf2f8; border-left: 3px solid #3498db; }
        .interactive-list .top-list-item { cursor: pointer; }
        .interactive-list .top-list-item:hover { background-color: #f2f2f2; }
        .interactive-list .top-list-item.active { background-color: #d4e6f1; border-left: 3px solid #2980b9; font-weight: bold; }
        
        /* ESTILOS PARA GRÁFICOS E MODAL */
        .charts-grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; padding: 15px; }
        .chart-card { background-color: #34495e; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-header h2 { margin: 0; font-size: 18px; color: #ecf0f1; }
        .expand-chart-btn { background: none; border: none; color: #bdc3c7; font-size: 16px; cursor: pointer; transition: color 0.3s; }
        .expand-chart-btn:hover { color: white; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { position: relative; background-color: #2c3e50; padding: 30px; border-radius: 10px; width: 90%; max-width: 1200px; height: 80%; }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; color: white; font-size: 30px; cursor: pointer; }
        
        /* ESTILOS PARA SECÇÃO DE DISCURSOS */
        .discursos-cards-wrapper { display: grid; grid-template-columns: 1fr 2fr 2fr; gap: 20px; margin-top: 20px; }
        #discursos-average-card p { font-size: 20px; }
        .discurso-count { font-weight: bold; color: #1abc9c; background-color: #e8f8f5; padding: 2px 8px; border-radius: 10px; font-size: 14px; }

.chart-wrapper {
    position: relative;
    height: 300px; /* Altura fixa para os gráficos. Pode ajustar este valor. */
    width: 100%;
}

        /* Media Queries */
        @media (max-width: 1200px) { .discursos-cards-wrapper { grid-template-columns: 1fr; } }
        @media (max-width: 992px) { .individual-content-wrapper { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { width: 70px; } .sidebar .logo h2, .sidebar .nav-item span { display: none; } .content { margin-left: 70px; width: calc(100% - 70px); } .stats-grid, .charts-wrapper { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo"><h2>Sistema de Escala</h2></div>
        <nav><ul class="nav-list">
            <li class="nav-item"><a href="index.html"><i class="fas fa-tachometer-alt"></i><span>Painel</span></a></li>
            <li class="nav-item"><a href="semana.html"><i class="fas fa-users"></i><span>Reunião Semana</span></a></li>
            <li class="nav-item"><a href="fimdesemana.html"><i class="fas fa-calendar-week"></i><span>Fim de Semana</span></a></li>
            <li class="nav-item"><a href="pregacao.html"><i class="fas fa-bullhorn"></i><span>Pregação</span></a></li>
            <li class="nav-item active"><a href="estatisticas.html"><i class="fas fa-chart-bar"></i><span>Estatísticas</span></a></li>
            <li class="nav-item"><a href="nomes.html"><i class="fas fa-address-book"></i><span>Nomes</span></a></li>
            <li class="nav-item"><a href="iniciar.html"><i class="fas fa-play"></i><span>Iniciar</span></a></li>
            <li class="nav-item"><a href="criar.html"><i class="fas fa-plus"></i><span>Criar</span></a></li>
        </ul></nav>
    </div>

    <!-- Conteúdo Principal -->
  <main class="content">
        <h1>Estatísticas</h1>
        <div class="tab-container">
            <button class="tab-link active" onclick="openTab(event, 'Geral')">Geral</button>
            <button class="tab-link" onclick="openTab(event, 'Top')">Top</button>
            <button class="tab-link" onclick="openTab(event, 'Comparacao')">Comparação</button>
            <button class="tab-link" onclick="openTab(event, 'Individual')">Individual</button>
            <button class="tab-link" onclick="openTab(event, 'Designacoes')">Designações</button>
            <button class="tab-link" onclick="openTab(event, 'Discursos')">Discursos</button>
            <button class="tab-link" onclick="openTab(event, 'Necessidades')">Necessidades Locais</button>
        </div>

        <!-- Aba Geral -->
        <div id="Geral" class="tab-content" style="display: block;">
            <div class="collapsible-container"><button class="filter-toggle-button"><i class="fas fa-filter"></i><span>Mostrar Filtros</span><i class="fas fa-chevron-down toggle-icon"></i></button><div class="filter-panel-wrapper"></div></div>
            <div class="card"><h2>Métricas Chave</h2><div class="stats-grid"><div class="stat-item"><h3 title="Total de designações que correspondem aos filtros selecionados.">Total de Designações</h3><p id="total-designacoes">0</p></div><div class="stat-item"><h3 title="Total de participações do género masculino.">Participações (Masculino)</h3><p id="total-masculino">0</p></div><div class="stat-item"><h3 title="Total de participações do género feminino.">Participações (Feminino)</h3><p id="total-feminino">0</p></div><div class="stat-item"><h3>Participações (Idiomas)</h3><div id="idiomas-container"></div></div></div></div>
            <div class="card"><h2>Médias Mensais</h2><div class="stats-grid"><div class="stat-item"><h3>Média Total/Mês</h3><p id="media-total-mes">0.0</p></div><div class="stat-item"><h3>Média Masc./Mês</h3><p id="media-masc-mes">0.0</p></div><div class="stat-item"><h3>Média Fem./Mês</h3><p id="media-fem-mes">0.0</p></div><div class="stat-item"><h3>Média Idiomas/Mês</h3><div id="media-idiomas-container"></div></div></div></div>
            <div class="card"><h2>Análise Percentual</h2><div class="stats-grid"><div class="stat-item"><h3 title="Percentagem de designações (baseado nos filtros) em relação ao total geral do período."> % Designações (Filtro vs Total)</h3><p id="perc-designacoes">0%</p></div><div class="stat-item"><h3 title="Percentagem de participações masculinas dentro do total filtrado.">% Participações (Masculino)</h3><p id="perc-masculino">0%</p></div><div class="stat-item"><h3 title="Percentagem de participações femininas dentro do total filtrado.">% Participações (Feminino)</h3><p id="perc-feminino">0%</p></div><div class="stat-item"><h3>% Participações (Idiomas)</h3><div id="perc-idiomas-container"></div></div></div></div>
            <div class="chart-container"><h2>Gráficos de Tendência</h2><canvas id="tendencia-total-chart"></canvas><div class="charts-wrapper"><canvas id="tendencia-genero-chart"></canvas><canvas id="tendencia-idioma-chart"></canvas></div></div>
        </div>
        
        <!-- Aba Top -->
        <div id="Top" class="tab-content">
            <div class="collapsible-container"><button class="filter-toggle-button"><i class="fas fa-filter"></i><span>Mostrar Filtros</span><i class="fas fa-chevron-down toggle-icon"></i></button><div class="filter-panel-wrapper"></div></div>
            <div class="sub-tab-container"><button class="sub-tab-link active" onclick="openSubTab(event, 'TopPessoas')">Top Pessoas</button><button class="sub-tab-link" onclick="openSubTab(event, 'TopDesignacoes')">Top Designações</button></div>
            <div id="TopPessoas" class="sub-tab-content" style="display: block;"><div class="card"><h2>Top Participantes</h2><ul id="top-pessoas-list" class="top-list"><li class="top-list-item"><span class="name">A carregar...</span><span class="count">--</span></li></ul></div></div>
            <div id="TopDesignacoes" class="sub-tab-content"><div class="card"><h2>Análise de Designações</h2><div class="list-view-controls"><button id="btn-agrupar" class="control-button active">Agrupar Designações</button><button id="btn-detalhado" class="control-button">Listar Detalhado</button></div><div id="view-agrupado" style="display: block;"><ul id="top-designacoes-agrupado-list" class="top-list"><li class="top-list-item"><span class="name">A carregar...</span><span class="count">--</span></li></ul></div><div id="view-detalhado" style="display: none;"><ul id="top-designacoes-detalhado-list" class="top-list"><li class="detailed-list-item">A carregar...</li></ul></div></div></div>
        </div>

        <!-- Aba Comparação -->
        <div id="Comparacao" class="tab-content">
            <div class="collapsible-container"><button class="filter-toggle-button"><i class="fas fa-filter"></i><span>Mostrar Filtros</span><i class="fas fa-chevron-down toggle-icon"></i></button><div class="filter-panel-wrapper"></div></div>
            <div class="card"><h2>Adicionar Pessoa para Comparar</h2><div class="comparison-search-container"><input type="text" id="comparison-search-input" placeholder="Pesquise por nome..."><div id="comparison-search-results" class="search-results"></div></div></div>
            <div id="comparison-cards-container"></div>
            <div id="comparison-chart-container" class="card" style="display: none;"><h2>Comparativo de Participações Totais</h2><div class="chart-container"><canvas id="comparison-chart"></canvas></div></div>
        </div>

        <!-- Aba Individual -->
        <div id="Individual" class="tab-content">
            <div class="collapsible-container"><button class="filter-toggle-button"><i class="fas fa-filter"></i><span>Mostrar Filtros</span><i class="fas fa-chevron-down toggle-icon"></i></button><div class="filter-panel-wrapper"></div></div>
            <div class="card"><h2>Selecionar Pessoa para Análise</h2><div class="comparison-search-container"><input type="text" id="individual-search-input" placeholder="Pesquise por nome..."><div id="individual-search-results" class="search-results"></div></div></div>
            
            <div id="individual-analysis-container" style="display: none;">
                <div class="card"><div id="individual-summary-header"><span id="individual-total-count"></span><span id="individual-peer-average"></span></div></div>
                
                <div class="individual-content-wrapper">
                    <div class="card"><h2>Resumo por Designação</h2><ul id="individual-aggregated-list" class="top-list interactive-list"></ul></div>
                    <div class="card"><h2>Parceiros Mais Frequentes</h2><ul id="individual-frequent-partners-list" class="top-list interactive-list"></ul></div>
                    <div class="card"><h2>Histórico de Designações</h2><ul id="individual-detailed-list" class="top-list"></ul></div>
                </div>

                <div id="individual-discursos-container" style="display: none;">
                    <div class="discursos-cards-wrapper">
                        <div class="card"><h2>Média de Discursos</h2><div id="discursos-average-card" class="stat-item" style="border-left-color: #f39c12;"></div></div>
                        <div class="card"><h2>Resumo por Discurso</h2><ul id="discursos-aggregated-list" class="top-list"></ul></div>
                        <div class="card"><h2>Histórico de Discursos</h2><ul id="discursos-detailed-list" class="top-list"></ul></div>
                    </div>
                    <div class="card" style="margin-top: 20px; background-color: #2c3e50; color: white;">
                        <div class="charts-grid-container">
                            <div class="chart-card"><div class="chart-header"><h2>Discursos por Mês</h2><button class="expand-chart-btn" data-chart-id="discursos-by-month" title="Expandir Gráfico"><i class="fas fa-expand-arrows-alt"></i></button></div><div class="chart-wrapper"><canvas id="individual-chart-discursos-by-month"></canvas></div></div>
                            <div class="chart-card"><div class="chart-header"><h2>Discursos por Ano</h2><button class="expand-chart-btn" data-chart-id="discursos-by-year" title="Expandir Gráfico"><i class="fas fa-expand-arrows-alt"></i></button></div><div class="chart-wrapper"><canvas id="individual-chart-discursos-by-year"></canvas></div></div>
                        </div>
                    </div>
                </div>
                
                <div id="individual-charts-container" class="card" style="margin-top: 20px; background-color: #2c3e50; color: white;">
                    <div class="charts-grid-container">
                        <div class="chart-card"><div class="chart-header"><h2>Designações por Elemento</h2><button class="expand-chart-btn" data-chart-id="by-designation" title="Expandir Gráfico"><i class="fas fa-expand-arrows-alt"></i></button></div><div class="chart-wrapper"><canvas id="individual-chart-by-designation"></canvas></div></div>
                        <div class="chart-card"><div class="chart-header"><h2>Designações por Semana</h2><button class="expand-chart-btn" data-chart-id="by-week" title="Expandir Gráfico"><i class="fas fa-expand-arrows-alt"></i></button></div><div class="chart-wrapper"><canvas id="individual-chart-by-week"></canvas></div></div>
                        <div class="chart-card"><div class="chart-header"><h2>Designações por Mês</h2><button class="expand-chart-btn" data-chart-id="by-month" title="Expandir Gráfico"><i class="fas fa-expand-arrows-alt"></i></button></div><div class="chart-wrapper"><canvas id="individual-chart-by-month"></canvas></div></div>
                        <div class="chart-card"><div class="chart-header"><h2>Designações por Ano</h2><button class="expand-chart-btn" data-chart-id="by-year" title="Expandir Gráfico"><i class="fas fa-expand-arrows-alt"></i></button></div><div class="chart-wrapper"><canvas id="individual-chart-by-year"></canvas></div></div>
                    </div>
                </div>
            </div>
            
            <div id="individual-placeholder" class="card"><p style="text-align: center; color: #7f8c8d; padding: 20px;">Para começar, pesquise e selecione uma pessoa na barra acima.</p></div>
        </div>

        <!-- Outras abas -->
        <div id="Designacoes" class="tab-content"><div class="collapsible-container"><button class="filter-toggle-button"><i class="fas fa-filter"></i><span>Mostrar Filtros</span><i class="fas fa-chevron-down toggle-icon"></i></button><div class="filter-panel-wrapper"></div></div><div class="card"><h2>Estatísticas de Designações</h2></div></div>
        <div id="Discursos" class="tab-content"><div class="collapsible-container"><button class="filter-toggle-button"><i class="fas fa-filter"></i><span>Mostrar Filtros</span><i class="fas fa-chevron-down toggle-icon"></i></button><div class="filter-panel-wrapper"></div></div><div class="card"><h2>Estatísticas de Discursos</h2></div></div>
        <div id="Necessidades" class="tab-content"><div class="collapsible-container"><button class="filter-toggle-button"><i class="fas fa-filter"></i><span>Mostrar Filtros</span><i class="fas fa-chevron-down toggle-icon"></i></button><div class="filter-panel-wrapper"></div></div><div class="card"><h2>Necessidades Locais</h2></div></div>
    
        <div id="chart-modal-overlay" class="modal-overlay">
            <div class="modal-content">
                <button id="chart-modal-close" class="modal-close-btn">&times;</button>
                <div class="chart-wrapper" style="height: 100%;">
                    <canvas id="modal-chart-canvas"></canvas>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Template do Painel de Filtros -->
    <template id="filter-panel-template">
        <div class="filter-panel">
            <div class="filter-item"><label>Ano</label><div class="multi-select-container" data-filter-name="ano" data-select-mode="multi"><div class="multi-select-button"><span class="multi-select-label">Todos os Anos</span></div><div class="multi-select-options"><div class="multi-select-header"><a class="select-all">Selecionar Todos</a><a class="clear-selection">Limpar Seleção</a></div><div class="multi-select-search-wrapper"><input type="text" class="multi-select-search" placeholder="Procurar..."></div><div class="multi-select-list"></div></div></div></div>
            <div class="filter-item"><label>Mês</label><div class="multi-select-container" data-filter-name="mes" data-select-mode="multi"><div class="multi-select-button"><span class="multi-select-label">Todos os Meses</span></div><div class="multi-select-options"><div class="multi-select-header"><a class="select-all">Selecionar Todos</a><a class="clear-selection">Limpar Seleção</a></div><div class="multi-select-search-wrapper"><input type="text" class="multi-select-search" placeholder="Procurar..."></div><div class="multi-select-list"></div></div></div></div>
            <div class="filter-item"><label>Tipo</label><div class="multi-select-container" data-filter-name="tipo" data-select-mode="multi"><div class="multi-select-button"><span class="multi-select-label">Todos</span></div><div class="multi-select-options"><div class="multi-select-header"><a class="select-all">Selecionar Todos</a><a class="clear-selection">Limpar Seleção</a></div><div class="multi-select-search-wrapper"><input type="text" class="multi-select-search" placeholder="Procurar..."></div><div class="multi-select-list"></div></div></div></div>
            <div class="filter-item"><label>Quando</label><div class="multi-select-container" data-filter-name="quando" data-select-mode="multi"><div class="multi-select-button"><span class="multi-select-label">Semana</span></div><div class="multi-select-options"><div class="multi-select-header"><a class="select-all">Selecionar Todos</a><a class="clear-selection">Limpar Seleção</a></div><div class="multi-select-search-wrapper"><input type="text" class="multi-select-search" placeholder="Procurar..."></div><div class="multi-select-list"></div></div></div></div>
            <div class="filter-item"><label>Parte</label><div class="multi-select-container" data-filter-name="parte" data-select-mode="multi"><div class="multi-select-button"><span class="multi-select-label">Todas as Partes</span></div><div class="multi-select-options"><div class="multi-select-header"><a class="select-all">Selecionar Todos</a><a class="clear-selection">Limpar Seleção</a></div><div class="multi-select-search-wrapper"><input type="text" class="multi-select-search" placeholder="Procurar..."></div><div class="multi-select-list"></div></div></div></div>
            <div class="filter-item"><label>Semana</label><div class="multi-select-container" data-filter-name="semana" data-select-mode="multi"><div class="multi-select-button"><span class="multi-select-label">Todas as Semanas</span></div><div class="multi-select-options"><div class="multi-select-header"><a class="select-all">Selecionar Todos</a><a class="clear-selection">Limpar Seleção</a></div><div class="multi-select-search-wrapper"><input type="text" class="multi-select-search" placeholder="Procurar..."></div><div class="multi-select-list"></div></div></div></div>
            <div class="filter-item"><label>Género</label><div class="multi-select-container" data-filter-name="genero" data-select-mode="multi"><div class="multi-select-button"><span class="multi-select-label">Todos os Géneros</span></div><div class="multi-select-options"><div class="multi-select-header"><a class="select-all">Selecionar Todos</a><a class="clear-selection">Limpar Seleção</a></div><div class="multi-select-search-wrapper"><input type="text" class="multi-select-search" placeholder="Procurar..."></div><div class="multi-select-list"></div></div></div></div>
            <div class="filter-item"><label>Idioma</label><div class="multi-select-container" data-filter-name="idioma" data-select-mode="multi"><div class="multi-select-button"><span class="multi-select-label">Todos os Idiomas</span></div><div class="multi-select-options"><div class="multi-select-header"><a class="select-all">Selecionar Todos</a><a class="clear-selection">Limpar Seleção</a></div><div class="multi-select-search-wrapper"><input type="text" class="multi-select-search" placeholder="Procurar..."></div><div class="multi-select-list"></div></div></div></div>
            <div class="filter-item"><label>Sala</label><div class="multi-select-container" data-filter-name="sala" data-select-mode="multi"><div class="multi-select-button"><span class="multi-select-label">Salão Principal</span></div><div class="multi-select-options"><div class="multi-select-header"><a class="select-all">Selecionar Todos</a><a class="clear-selection">Limpar Seleção</a></div><div class="multi-select-search-wrapper"><input type="text" class="multi-select-search" placeholder="Procurar..."></div><div class="multi-select-list"></div></div></div></div>
            <div class="filter-item"><label>Designações</label><div class="multi-select-container" data-filter-name="designacoes" data-select-mode="multi"><div class="multi-select-button"><span class="multi-select-label">Todos selecionados</span></div><div class="multi-select-options"><div class="multi-select-header"><a class="select-all">Selecionar Todos</a><a class="clear-selection">Limpar Seleção</a></div><div class="multi-select-search-wrapper"><input type="text" class="multi-select-search" placeholder="Procurar..."></div><div class="multi-select-list"></div></div></div></div>
            <div class="sync-filter-item"><input type="checkbox" class="sync-filters-checkbox" id="sync-filters-checkbox"><label for="sync-filters-checkbox">Sincronizar Filtros</label></div>
        </div>
    </template>

 <script>
    // Configuração do Firebase
    const firebaseConfig = { 
        apiKey: "AIzaSyD1fkxq6USO5RX22TlsPQFEaVSZoTj_t2A", 
        authDomain: "escalas-6e0f9.firebaseapp.com", 
        projectId: "escalas-6e0f9", 
        storageBucket: "escalas-6e0f9.firebasestorage.app", 
        messagingSenderId: "19118998563", 
        appId: "1:19118998563:web:5412be658ae34bd45add96" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- VARIÁVEIS GLOBAIS E MAPAS DE CACHE ---
    let historicoSemanas = [];
    let designacoesMap = new Map();
    let pessoasMap = new Map();
    let nacionalidadesMap = new Map();
    let discursosMap = new Map();
    let oradorDesignacaoId = null;
    
    // --- VARIÁVEIS GLOBAIS PARA AS NOVAS ABAS ---
    let selectedPeopleForComparison = [];
    let comparisonChart = null;
    let selectedPersonForIndividual = null;
    let individualChartByDesignation = null,
        individualChartByWeek = null,
        individualChartByMonth = null,
        individualChartByYear = null,
        individualChartDiscursosByMonth = null,
        individualChartDiscursosByYear = null,
        modalChart = null;

    // --- FUNÇÕES AUXILIARES DE UI ---
    function openTab(evt, tabName) { 
        document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none"); 
        document.querySelectorAll(".tab-link").forEach(tl => tl.classList.remove("active")); 
        document.getElementById(tabName).style.display = "block"; 
        evt.currentTarget.classList.add("active"); 
    }
    function openSubTab(evt, subTabName) { 
        const parentContent = evt.currentTarget.closest('.tab-content'); 
        parentContent.querySelectorAll('.sub-tab-content').forEach(stc => stc.style.display = "none"); 
        parentContent.querySelectorAll('.sub-tab-link').forEach(stl => stl.classList.remove("active")); 
        parentContent.querySelector(`#${subTabName}`).style.display = "block"; 
        evt.currentTarget.classList.add("active"); 
    }

    // --- FUNÇÕES DO DROPDOWN PERSONALIZADO ---
    function updateMultiSelectLabel(container) {
        if (!container) return;
        const label = container.querySelector('.multi-select-label');
        const checkboxes = container.querySelectorAll('.multi-select-list input[type="checkbox"]');
        const total = checkboxes.length;
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        if (total === 0) { label.textContent = "Nenhuma opção"; }
        else if (selectedCount === total) { label.textContent = "Todos selecionados"; }
        else if (selectedCount === 0) { label.textContent = "Nenhum selecionado"; }
        else { label.textContent = `${selectedCount} selecionados`; }
    }
    function getCustomDropdownValues(filterPanel, filterName) {
        const container = filterPanel.querySelector(`.multi-select-container[data-filter-name="${filterName}"]`);
        if (!container) return [];
        const checked = container.querySelectorAll('input[type="checkbox"]:checked');
        return Array.from(checked).map(cb => cb.value);
    }
    function populateSemanaFilter(panel) {
        if (!panel) return;
        const semanaContainer = panel.querySelector('.multi-select-container[data-filter-name="semana"]');
        const semanaList = semanaContainer.querySelector('.multi-select-list');
        const selectedMonths = getCustomDropdownValues(panel, 'mes').map(m => parseInt(m));
        const semanasFiltradas = selectedMonths.length === 12 ? historicoSemanas : historicoSemanas.filter(item => selectedMonths.includes(item.startDate.getMonth() + 1));
        if (semanasFiltradas.length === 0) {
            semanaList.innerHTML = '<label style="color: #7f8c8d; padding-left: 12px;">Nenhuma semana para o(s) mes(es) selecionado(s).</label>';
            updateMultiSelectLabel(semanaContainer); return;
        }
        let html = ''; let currentMonth = -1;
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        semanasFiltradas.forEach(semana => {
            const semanaMes = semana.startDate.getMonth();
            if (semanaMes !== currentMonth) {
                currentMonth = semanaMes;
                html += `<strong style="display: block; padding: 8px 12px; font-size: 14px; background-color: #f0f0f0;">${monthNames[currentMonth]} ${semana.startDate.getFullYear()}</strong>`;
            }
            html += `<label><input type="checkbox" value="${semana.id}" checked> ${semana.semanaindex}</label>`;
        });
        semanaList.innerHTML = html;
        updateMultiSelectLabel(semanaContainer);
    }

    // --- LÓGICA DE FILTRAGEM ---
    function buildHistoricoQuery() { return db.collection('historico'); }
   function getFilteredAssignments(documents, filterPanel) {
    const meses = getCustomDropdownValues(filterPanel, 'mes');
    const generos = getCustomDropdownValues(filterPanel, 'genero');
    const idiomaIds = getCustomDropdownValues(filterPanel, 'idioma');
    const selectedDesignacoes = getCustomDropdownValues(filterPanel, 'designacoes');
    const totalMeses = 12, totalGeneros = 2, totalIdiomas = nacionalidadesMap.size, totalDesignacoes = designacoesMap.size;
    const idiomaNomesFiltro = idiomaIds.map(id => nacionalidadesMap.get(id));
    let docsToProcess = documents;
    if (meses.length < totalMeses) {
        const mesesInt = meses.map(m => parseInt(m));
        docsToProcess = docsToProcess.filter(doc => {
            const docDate = historicoSemanas.find(s => s.id === doc.id)?.startDate;
            return docDate && mesesInt.includes(docDate.getMonth() + 1);
        });
    }
    const validAssignments = [];
    docsToProcess.forEach(doc => {
        if (!doc.designacoes) return;
        Object.values(doc.designacoes).forEach(desig => {
            if (selectedDesignacoes.length < totalDesignacoes && !selectedDesignacoes.includes(desig.designacaoId)) return;
            
            // --- INÍCIO DA CORREÇÃO ---
            let participantIds = [];
            if (desig.participantes) {
                // CASO 1: A estrutura é { participante: "..." } ou { participante: ["..."] } (Ex: Orador)
                if (desig.participantes.participante) {
                    participantIds = [desig.participantes.participante].flat().filter(Boolean);
                } 
                // CASO 2: A estrutura é { dirigente: "...", morador: "..." } (Ex: Demonstrações)
                else {
                    const orderedParticipants = [desig.participantes.dirigente, desig.participantes.morador, desig.participantes.ajudante];
                    participantIds = orderedParticipants.flat().filter(Boolean);
                }
            } 
            // CASO 3: A estrutura tem "participante" no nível principal (outros casos)
            else if (desig.participante) {
                participantIds = [desig.participante].flat().filter(Boolean);
            }
            // --- FIM DA CORREÇÃO ---

            if (participantIds.length === 0) return;

            const filteredParticipantIds = participantIds.filter(id => {
                const pessoa = pessoasMap.get(id); if (!pessoa) return false;
                const genderMatch = generos.length === totalGeneros || (pessoa.genero && generos.includes(pessoa.genero.toLowerCase()));
                const languageMatch = idiomaIds.length === totalIdiomas || (pessoa.idioma && idiomaNomesFiltro.includes(pessoa.idioma));
                return genderMatch && languageMatch;
            });

            if (filteredParticipantIds.length > 0) {
                validAssignments.push({
                    designacaoId: desig.designacaoId,
                    date: doc.dia,
                    participantIds: filteredParticipantIds,
                    weekId: doc.id,
                    descricao: desig.descricao || null
                });
            }
        });
    });
    return validAssignments;
}

    // --- FUNÇÕES DE ATUALIZAÇÃO DOS PAINÉIS ---
    async function updateGeralDashboard() {
        console.log("A atualizar 'Geral' com filtros...");
        const filterPanel = document.getElementById('Geral').querySelector('.filter-panel');
        if (!filterPanel) return;

        const snapshot = await buildHistoricoQuery().get();
        let documents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const anosSelecionados = getCustomDropdownValues(filterPanel, 'ano').map(y => parseInt(y));
        const semanasSelecionadas = getCustomDropdownValues(filterPanel, 'semana');
        const totalAnosDisponiveis = filterPanel.querySelector('[data-filter-name="ano"]').querySelectorAll('input[type="checkbox"]').length;
        const totalSemanasDisponiveis = filterPanel.querySelector('[data-filter-name="semana"]').querySelectorAll('input[type="checkbox"]').length;

        if (anosSelecionados.length < totalAnosDisponiveis) {
            documents = documents.filter(doc => anosSelecionados.includes(doc.ano));
        }
        if (semanasSelecionadas.length < totalSemanasDisponiveis) {
            documents = documents.filter(doc => semanasSelecionadas.includes(doc.id));
        }

        const validAssignments = getFilteredAssignments(documents, filterPanel);
        const flatParticipations = [];
        validAssignments.forEach(assignment => {
            assignment.participantIds.forEach(personId => {
                flatParticipations.push({
                    personId: personId,
                    designacaoId: assignment.designacaoId,
                    date: assignment.date
                });
            });
        });

        const totalDesignacoes = flatParticipations.length;
        let totalMasculino = 0, totalFeminino = 0;
        const idiomasCount = new Map();
        flatParticipations.forEach(p => {
            const pessoa = pessoasMap.get(p.personId);
            if (!pessoa) return;
            if (pessoa.genero === 'masculino') totalMasculino++;
            if (pessoa.genero === 'feminino') totalFeminino++;
            const idioma = pessoa.idioma || 'Não especificado';
            idiomasCount.set(idioma, (idiomasCount.get(idioma) || 0) + 1);
        });

        const filteredHistoricoSemanas = historicoSemanas.filter(s => documents.some(d => d.id === s.id));
        let numMonths = 0;
        if (filteredHistoricoSemanas.length > 0) {
            const firstDate = filteredHistoricoSemanas[0].startDate;
            const lastDate = filteredHistoricoSemanas[filteredHistoricoSemanas.length - 1].startDate;
            numMonths = (lastDate.getFullYear() - firstDate.getFullYear()) * 12 + (lastDate.getMonth() - firstDate.getMonth()) + 1;
            numMonths = Math.max(1, numMonths);
        }
        
        const mediaTotalMes = numMonths > 0 ? (totalDesignacoes / numMonths).toFixed(1) : '0.0';
        const mediaMascMes = numMonths > 0 ? (totalMasculino / numMonths).toFixed(1) : '0.0';
        const mediaFemMes = numMonths > 0 ? (totalFeminino / numMonths).toFixed(1) : '0.0';
        let mediaIdiomasHTML = '';
        for (const [idioma, count] of idiomasCount.entries()) { mediaIdiomasHTML += `<div class="idioma-stat">${idioma}: <strong>${numMonths > 0 ? (count / numMonths).toFixed(1) : '0.0'}</strong></div>`; }
        const percMasculino = totalDesignacoes > 0 ? ((totalMasculino / totalDesignacoes) * 100).toFixed(0) : '0';
        const percFeminino = totalDesignacoes > 0 ? ((totalFeminino / totalDesignacoes) * 100).toFixed(0) : '0';
        let percIdiomasHTML = '';
        for (const [idioma, count] of idiomasCount.entries()) { percIdiomasHTML += `<div class="idioma-stat">${idioma}: <strong>${totalDesignacoes > 0 ? ((count / totalDesignacoes) * 100).toFixed(0) : '0'}%</strong></div>`; }

        document.getElementById('total-designacoes').textContent = totalDesignacoes;
        document.getElementById('total-masculino').textContent = totalMasculino;
        document.getElementById('total-feminino').textContent = totalFeminino;
        let idiomasHTML = '';
        for (const [idioma, count] of idiomasCount.entries()) { idiomasHTML += `<div class="idioma-stat">${idioma}: <strong>${count}</strong></div>`; }
        document.getElementById('idiomas-container').innerHTML = idiomasHTML || 'N/A';
        document.getElementById('media-total-mes').textContent = mediaTotalMes;
        document.getElementById('media-masc-mes').textContent = mediaMascMes;
        document.getElementById('media-fem-mes').textContent = mediaFemMes;
        document.getElementById('media-idiomas-container').innerHTML = mediaIdiomasHTML || 'N/A';
        document.getElementById('perc-designacoes').textContent = 'N/A';
        document.getElementById('perc-masculino').textContent = `${percMasculino}%`;
        document.getElementById('perc-feminino').textContent = `${percFeminino}%`;
        document.getElementById('perc-idiomas-container').innerHTML = percIdiomasHTML || 'N/A';
    }
    
    async function updateTopDashboard() {
        console.log("A atualizar 'Top' com filtros...");
        const filterPanel = document.getElementById('Top').querySelector('.filter-panel');
        if (!filterPanel) return;

        const snapshot = await buildHistoricoQuery().get();
        let documents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const anosSelecionados = getCustomDropdownValues(filterPanel, 'ano').map(y => parseInt(y));
        const semanasSelecionadas = getCustomDropdownValues(filterPanel, 'semana');
        const totalAnosDisponiveis = filterPanel.querySelector('[data-filter-name="ano"]').querySelectorAll('input[type="checkbox"]').length;
        const totalSemanasDisponiveis = filterPanel.querySelector('[data-filter-name="semana"]').querySelectorAll('input[type="checkbox"]').length;

        if (anosSelecionados.length < totalAnosDisponiveis) { documents = documents.filter(doc => anosSelecionados.includes(doc.ano)); }
        if (semanasSelecionadas.length < totalSemanasDisponiveis) { documents = documents.filter(doc => semanasSelecionadas.includes(doc.id)); }
        
        const validAssignments = getFilteredAssignments(documents, filterPanel);
        const participantCounts = new Map(), assignmentCounts = new Map(), detailedListHTML = [];

        validAssignments.forEach(assignment => {
            const desigNome = designacoesMap.get(assignment.designacaoId) || 'Desconhecida';
            assignmentCounts.set(desigNome, (assignmentCounts.get(desigNome) || 0) + 1);
            assignment.participantIds.forEach(id => { participantCounts.set(id, (participantCounts.get(id) || 0) + 1); });
            const participantNames = assignment.participantIds.map(id => pessoasMap.get(id)?.nomePessoa || `ID(${id})`).join(' - ');
            const dateParts = assignment.date ? assignment.date.split('-') : [];
            const fDate = dateParts.length === 3 ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : (assignment.date || '');
            detailedListHTML.push(`<li class="top-list-item detailed-list-item"><div><span class="date">${fDate}</span> - <span class="assignment">${desigNome}:</span> <span class="participants">${participantNames}</span></div></li>`);
        });

        const sortedParticipants = [...participantCounts.entries()].sort((a, b) => b[1] - a[1]);
        document.getElementById('top-pessoas-list').innerHTML = sortedParticipants.length > 0 ? sortedParticipants.map(([id, count]) => `<li class="top-list-item"><span class="name">${pessoasMap.get(id)?.nomePessoa || 'ID Desconhecido'}</span><span class="count">${count}</span></li>`).join('') : "<li>Nenhum resultado.</li>";
        const sortedAssignments = [...assignmentCounts.entries()].sort((a, b) => b[1] - a[1]);
        document.getElementById('top-designacoes-agrupado-list').innerHTML = sortedAssignments.length > 0 ? sortedAssignments.map(([name, count]) => `<li class="top-list-item"><span class="name">${name}</span><span class="count">${count}</span></li>`).join('') : "<li>Nenhum resultado.</li>";
        document.getElementById('top-designacoes-detalhado-list').innerHTML = detailedListHTML.length > 0 ? detailedListHTML.join('') : "<li>Nenhum resultado.</li>";
    }

    async function updateComparacaoDashboard() {
        console.log("A atualizar 'Comparação' com filtros...");
        const filterPanel = document.getElementById('Comparacao').querySelector('.filter-panel');
        const cardsContainer = document.getElementById('comparison-cards-container');
        const chartContainer = document.getElementById('comparison-chart-container');
        
        cardsContainer.innerHTML = '';
        chartContainer.style.display = 'none';

        if (selectedPeopleForComparison.length === 0) {
            cardsContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #7f8c8d;">Para começar, pesquise e adicione uma pessoa.</p>';
            return;
        }

        const snapshot = await buildHistoricoQuery().get();
        let documents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const anosSelecionados = getCustomDropdownValues(filterPanel, 'ano').map(y => parseInt(y));
        const semanasSelecionadas = getCustomDropdownValues(filterPanel, 'semana');
        const totalAnosDisponiveis = filterPanel.querySelector('[data-filter-name="ano"]').querySelectorAll('input[type="checkbox"]').length;
        const totalSemanasDisponiveis = filterPanel.querySelector('[data-filter-name="semana"]').querySelectorAll('input[type="checkbox"]').length;

        if (anosSelecionados.length < totalAnosDisponiveis) { documents = documents.filter(doc => anosSelecionados.includes(doc.ano)); }
        if (semanasSelecionadas.length < totalSemanasDisponiveis) { documents = documents.filter(doc => semanasSelecionadas.includes(doc.id)); }
        
        const allValidAssignments = getFilteredAssignments(documents, filterPanel);
        const totalFilteredAssignments = allValidAssignments.reduce((acc, curr) => acc + curr.participantIds.length, 0);
        const chartLabels = [], chartData = [];

        selectedPeopleForComparison.forEach(personId => {
            const personData = pessoasMap.get(personId); if (!personData) return;
            const personParticipations = [];
            allValidAssignments.forEach(assignment => { if (assignment.participantIds.includes(personId)) { personParticipations.push({ designacaoId: assignment.designacaoId, date: assignment.date }); } });
            const personTotal = personParticipations.length;
            const percentage = totalFilteredAssignments > 0 ? ((personTotal / totalFilteredAssignments) * 100).toFixed(1) : 0;
            const assignmentCounts = new Map();
            personParticipations.forEach(p => { const desigNome = designacoesMap.get(p.designacaoId) || 'Desconhecida'; assignmentCounts.set(desigNome, (assignmentCounts.get(desigNome) || 0) + 1); });
            const sortedAssignments = [...assignmentCounts.entries()].sort((a, b) => b[1] - a[1]).slice(0, 6);
            let topAssignmentsHTML = sortedAssignments.map(([name, count]) => `<li><span>${name}</span><span class="count">${count}</span></li>`).join('');
            if (sortedAssignments.length === 0) { topAssignmentsHTML = '<li>Nenhuma designação encontrada com os filtros atuais.</li>'; }
            chartLabels.push(personData.nomePessoa); chartData.push(personTotal);
            const cardHTML = `<div class="person-comparison-card"><button class="remove-person-btn" data-person-id="${personId}" title="Remover Pessoa">&times;</button><h3>${personData.nomePessoa}</h3><div class="stat">Participações Totais: <strong>${personTotal}</strong></div><div class="stat">Média (vs Total Filtrado): <strong>${percentage}%</strong></div><h4>Top 6 Designações:</h4><ul class="top-assignments-list">${topAssignmentsHTML}</ul></div>`;
            cardsContainer.innerHTML += cardHTML;
        });

        if (selectedPeopleForComparison.length > 1) {
            chartContainer.style.display = 'block'; const ctx = document.getElementById('comparison-chart').getContext('2d');
            if (comparisonChart) { comparisonChart.destroy(); }
            comparisonChart = new Chart(ctx, { type: 'bar', data: { labels: chartLabels, datasets: [{ label: 'Total de Participações', data: chartData, backgroundColor: 'rgba(52, 152, 219, 0.7)', borderColor: 'rgba(41, 128, 185, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, ticks: { color: '#2c3e50' } }, x: { ticks: { color: '#2c3e50' } } }, plugins: { legend: { labels: { color: '#2c3e50' } } } } });
        }
    }

    async function updateIndividualDashboard() {
    console.log("A atualizar 'Individual' com filtros, gráficos e discursos...");
    const filterPanel = document.getElementById('Individual').querySelector('.filter-panel');
    const analysisContainer = document.getElementById('individual-analysis-container');
    const placeholder = document.getElementById('individual-placeholder');
    const chartsContainer = document.getElementById('individual-charts-container');
    const discursosContainer = document.getElementById('individual-discursos-container');

    if (!selectedPersonForIndividual) {
        analysisContainer.style.display = 'none';
        placeholder.style.display = 'block';
        return;
    }
    
    analysisContainer.style.display = 'block';
    placeholder.style.display = 'none';
    discursosContainer.style.display = 'none'; // Esconde por defeito

    // Obtenção e filtragem de dados (sem alterações)
    const snapshot = await buildHistoricoQuery().get();
    let documents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    const anosSelecionados = getCustomDropdownValues(filterPanel, 'ano').map(y => parseInt(y));
    const semanasSelecionadas = getCustomDropdownValues(filterPanel, 'semana');
    const totalAnosDisponiveis = filterPanel.querySelector('[data-filter-name="ano"]').querySelectorAll('input[type="checkbox"]').length;
    const totalSemanasDisponiveis = filterPanel.querySelector('[data-filter-name="semana"]').querySelectorAll('input[type="checkbox"]').length;
    if (anosSelecionados.length < totalAnosDisponiveis) { documents = documents.filter(doc => anosSelecionados.includes(doc.ano)); }
    if (semanasSelecionadas.length < totalSemanasDisponiveis) { documents = documents.filter(doc => semanasSelecionadas.includes(doc.id)); }
    const allValidAssignments = getFilteredAssignments(documents, filterPanel);
    const personAssignments = allValidAssignments.filter(a => a.participantIds.includes(selectedPersonForIndividual));

    // Preenchimento dos cards de resumo, parceiros e histórico (sem alterações)
    const personData = pessoasMap.get(selectedPersonForIndividual);
    document.getElementById('individual-total-count').textContent = `${personData.nomePessoa} teve ${personAssignments.length} designações no período.`;
    document.getElementById('individual-peer-average').innerHTML = '';
    const aggregatedList = document.getElementById('individual-aggregated-list');
    const assignmentCounts = new Map();
    personAssignments.forEach(p => { const desigId = p.designacaoId; assignmentCounts.set(desigId, (assignmentCounts.get(desigId) || 0) + 1); });
    const sortedAssignments = [...assignmentCounts.entries()].sort((a, b) => b[1] - a[1]);
    aggregatedList.innerHTML = sortedAssignments.map(([id, count]) => `<li class="top-list-item" data-designation-id="${id}"><span class="name">${designacoesMap.get(id) || 'Desconhecida'}</span><span class="count">${count}</span></li>`).join('') || '<li>Nenhum resultado.</li>';
    const partnersList = document.getElementById('individual-frequent-partners-list');
    const partnerCounts = new Map();
    personAssignments.forEach(assignment => { assignment.participantIds.forEach(participantId => { if (participantId !== selectedPersonForIndividual) { partnerCounts.set(participantId, (partnerCounts.get(participantId) || 0) + 1); } }); });
    const sortedPartners = [...partnerCounts.entries()].sort((a, b) => b[1] - a[1]);
    partnersList.innerHTML = sortedPartners.map(([id, count]) => `<li class="top-list-item" data-partner-id="${id}"><span class="name">${pessoasMap.get(id)?.nomePessoa || 'Desconhecido'}</span><span class="count">${count}</span></li>`).join('') || '<li>Nenhum parceiro encontrado.</li>';
    const detailedList = document.getElementById('individual-detailed-list');
    detailedList.innerHTML = personAssignments.map(assignment => {
        const desigNome = designacoesMap.get(assignment.designacaoId) || 'Desconhecida';
        const dateParts = assignment.date ? assignment.date.split('-') : [];
        const fDate = dateParts.length === 3 ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : (assignment.date || 'Sem data');
        const otherParticipantIds = assignment.participantIds.filter(id => id !== selectedPersonForIndividual);
        const coParticipantsText = otherParticipantIds.map(id => pessoasMap.get(id)?.nomePessoa || `ID(${id})`).join(' - ');
        return `<li class="top-list-item detailed-list-item highlight" data-designation-id="${assignment.designacaoId}" data-co-participant-ids="${otherParticipantIds.join(',')}"><div><span class="date">${fDate}</span> - <span class="assignment">${desigNome}</span>${coParticipantsText ? `: <span class="participants">${coParticipantsText}</span>` : ''}</div></li>`;
    }).join('') || '<li>Nenhum resultado.</li>';

    // Lógica para os gráficos gerais
    if (personAssignments.length > 0) {
        chartsContainer.style.display = 'block';
        const byDesignation = new Map(), byWeek = new Map(), byMonth = new Map(), byYear = new Map();
        personAssignments.forEach(a => {
            const desigName = designacoesMap.get(a.designacaoId) || 'Desconhecida'; byDesignation.set(desigName, (byDesignation.get(desigName) || 0) + 1);
            const semana = historicoSemanas.find(s => s.id === a.weekId); if (semana) { byWeek.set(semana.semanaindex, (byWeek.get(semana.semanaindex) || 0) + 1); }
            if (a.date) {
                const date = new Date(a.date); const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const yearMonth = `${year}/${month}`; byMonth.set(yearMonth, (byMonth.get(yearMonth) || 0) + 1); byYear.set(year, (byYear.get(year) || 0) + 1);
            }
        });
        const sortedWeeks = [...byWeek.entries()].sort((a, b) => historicoSemanas.find(s=>s.semanaindex === a[0]).startDate - historicoSemanas.find(s=>s.semanaindex === b[0]).startDate);
        const sortedMonths = [...byMonth.entries()].sort(); const sortedYears = [...byYear.entries()].sort();
        
        // --- CORREÇÃO AQUI ---
        // Os nomes dos tipos agora usam hífen para corresponder ao HTML
        renderIndividualChart('by-designation', [...byDesignation.keys()], [...byDesignation.values()], 'bar', '#3498db');
        renderIndividualChart('by-week', sortedWeeks.map(w => w[0]), sortedWeeks.map(w => w[1]), 'bar', '#9b59b6');
        renderIndividualChart('by-month', sortedMonths.map(m => m[0]), sortedMonths.map(m => m[1]), 'line', '#1abc9c');
        renderIndividualChart('by-year', sortedYears.map(y => y[0]), sortedYears.map(y => y[1]), 'bar', '#e67e22');

    } else { chartsContainer.style.display = 'none'; }

    // Lógica para a secção de discursos
    if (!oradorDesignacaoId) return;
    const personDiscursos = personAssignments.filter(a => a.designacaoId === oradorDesignacaoId && a.descricao).map(a => { const discursoInfo = discursosMap.get(a.descricao); if (!discursoInfo) return null; return { date: a.date, discursoId: a.descricao, numero: discursoInfo.numero, nome: discursoInfo.nome }; }).filter(Boolean);
    if (personDiscursos.length > 0) {
        discursosContainer.style.display = 'block';
        const allDiscursos = allValidAssignments.filter(a => a.designacaoId === oradorDesignacaoId);
        const speakerCounts = new Map(); allDiscursos.forEach(d => { d.participantIds.forEach(id => speakerCounts.set(id, (speakerCounts.get(id) || 0) + 1)); });
        let average = 0; if (speakerCounts.size > 0) { let total = 0; speakerCounts.forEach(count => total += count); average = total / speakerCounts.size; }
        const avgCard = document.getElementById('discursos-average-card');
        let comparisonHTML = `A pessoa está <strong class="color-green">na média</strong>.`;
        if (personDiscursos.length > average * 1.1) comparisonHTML = `A pessoa está <strong class="color-blue">acima da média</strong>.`;
        if (personDiscursos.length < average * 0.9) comparisonHTML = `A pessoa está <strong class="color-red">abaixo da média</strong>.`;
        avgCard.innerHTML = `<h3>${personDiscursos.length} Discursos</h3><p>${comparisonHTML}<br><span>(Média: ${average.toFixed(1)})</span></p>`;
        
        const discursosDetailedList = document.getElementById('discursos-detailed-list');
        discursosDetailedList.innerHTML = personDiscursos.sort((a,b) => new Date(b.date) - new Date(a.date)).map(d => { const dateParts = d.date.split('-'); const fDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`; return `<li class="top-list-item"><span>${fDate} - (${d.numero}) ${d.nome}</span></li>`; }).join('');
        
        const discursosAggregatedList = document.getElementById('discursos-aggregated-list');
        const discursoCounts = new Map(); personDiscursos.forEach(d => { const key = `${d.numero} - ${d.nome}`; discursoCounts.set(key, (discursoCounts.get(key) || 0) + 1); });
        discursosAggregatedList.innerHTML = [...discursoCounts.entries()].sort((a, b) => b[1] - a[1]).map(([nome, count]) => `<li class="top-list-item"><span class="name">${nome}</span><span class="discurso-count">${count}</span></li>`).join('');
        
        const discursosByMonth = new Map(), discursosByYear = new Map();
        personDiscursos.forEach(d => { const date = new Date(d.date); const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const yearMonth = `${month}/${year}`; discursosByMonth.set(yearMonth, (discursosByMonth.get(yearMonth) || 0) + 1); discursosByYear.set(year, (discursosByYear.get(year) || 0) + 1); });
        const sortedDiscursoMonths = [...discursosByMonth.entries()].sort((a,b) => new Date(a[0].split('/')[1], a[0].split('/')[0]-1) - new Date(b[0].split('/')[1], b[0].split('/')[0]-1));
        const sortedDiscursoYears = [...discursosByYear.entries()].sort();

        // --- CORREÇÃO AQUI ---
        // Os nomes dos tipos agora usam hífen para corresponder ao HTML
        renderIndividualChart('discursos-by-month', sortedDiscursoMonths.map(m => m[0]), sortedDiscursoMonths.map(m => m[1]), 'bar', '#8e8e8e', 'Nº de Discursos');
        renderIndividualChart('discursos-by-year', sortedDiscursoYears.map(y => y[0]), sortedDiscursoYears.map(y => y[1]), 'bar', '#006400', 'Nº de Discursos');
    }
}

   function renderIndividualChart(type, labels, data, chartType, color, datasetLabel = 'Nº Designações') {
    const chartId = `individual-chart-${type}`;
    const ctx = document.getElementById(chartId).getContext('2d');
    let chartInstance;

    // --- INÍCIO DA CORREÇÃO (PRIMEIRO SWITCH) ---
    // Os 'case' foram atualizados para usar hífen
    switch(type) {
        case 'by-designation': chartInstance = individualChartByDesignation; break;
        case 'by-week': chartInstance = individualChartByWeek; break;
        case 'by-month': chartInstance = individualChartByMonth; break;
        case 'by-year': chartInstance = individualChartByYear; break;
        case 'discursos-by-month': chartInstance = individualChartDiscursosByMonth; break;
        case 'discursos-by-year': chartInstance = individualChartDiscursosByYear; break;
    }
    // --- FIM DA CORREÇÃO ---

    if (chartInstance) { 
        chartInstance.destroy(); 
    }

    const newChart = new Chart(ctx, {
        type: chartType,
        data: { 
            labels: labels, 
            datasets: [{ 
                label: datasetLabel, 
                data: data, 
                backgroundColor: color, 
                borderColor: color, 
                tension: 0.1 
            }] 
        },
        options: {
            responsive: true, 
            maintainAspectRatio: false,
            scales: { 
                y: { 
                    beginAtZero: true, 
                    ticks: { color: '#bdc3c7', stepSize: 1 }, 
                    grid: { color: 'rgba(255, 255, 255, 0.1)' } 
                }, 
                x: { 
                    ticks: { color: '#bdc3c7' }, 
                    grid: { color: 'rgba(255, 255, 255, 0.1)' } 
                } 
            },
            plugins: { 
                legend: { 
                    labels: { color: '#ecf0f1' } 
                } 
            }
        }
    });

    // --- INÍCIO DA CORREÇÃO (SEGUNDO SWITCH) ---
    // Os 'case' também foram atualizados aqui para guardar o novo gráfico
    switch(type) {
        case 'by-designation': individualChartByDesignation = newChart; break;
        case 'by-week': individualChartByWeek = newChart; break;
        case 'by-month': individualChartByMonth = newChart; break;
        case 'by-year': individualChartByYear = newChart; break;
        case 'discursos-by-month': individualChartDiscursosByMonth = newChart; break;
        case 'discursos-by-year': individualChartDiscursosByYear = newChart; break;
    }
    // --- FIM DA CORREÇÃO ---
}

    // --- LÓGICA PRINCIPAL DA PÁGINA ---
    document.addEventListener('DOMContentLoaded', async function() {
        const filterTemplate = document.getElementById('filter-panel-template').content;
        document.querySelectorAll('.filter-panel-wrapper').forEach((wrapper, index) => {
            const clone = document.importNode(filterTemplate, true);
            clone.querySelector('.sync-filters-checkbox').id = `sync-checkbox-${index}`;
            clone.querySelector('label[for="sync-filters-checkbox"]').setAttribute('for', `sync-checkbox-${index}`);
            wrapper.appendChild(clone);
        });

        const populateAllFilters = async () => {
            try {
                const [historicoSnapshot, nacionalidadesSnapshot, designacoesSnapshot] = await Promise.all([ db.collection('historico').get(), db.collection('nacionalidades').get(), db.collection('designacoes').get() ]);
                const years = new Set(); const dateRegex = /(\d{1,2})\s(\w{3})/; const monthMap = { 'Jan': 0, 'Fev': 1, 'Mar': 2, 'Abr': 3, 'Mai': 4, 'Jun': 5, 'Jul': 6, 'Ago': 7, 'Set': 8, 'Out': 9, 'Nov': 10, 'Dez': 11 };
                historicoSnapshot.forEach(doc => { const data = doc.data(); if (data.ano) years.add(data.ano); if (data.semanaindex) { const match = data.semanaindex.match(dateRegex); if(match){ historicoSemanas.push({ ...data, id: doc.id, startDate: new Date(data.ano, monthMap[match[2]], parseInt(match[1])) }); } } });
                historicoSemanas = [...new Map(historicoSemanas.map(item => [item['semanaindex'], item])).values()];
                historicoSemanas.sort((a, b) => a.startDate - b.startDate);
                const sortedYears = Array.from(years).sort((a, b) => b - a);
                const staticOptions = {
                    mes: [{v:'1',t:'Janeiro'},{v:'2',t:'Fevereiro'},{v:'3',t:'Março'},{v:'4',t:'Abril'},{v:'5',t:'Maio'},{v:'6',t:'Junho'},{v:'7',t:'Julho'},{v:'8',t:'Agosto'},{v:'9',t:'Setembro'},{v:'10',t:'Outubro'},{v:'11',t:'Novembro'},{v:'12',t:'Dezembro'}],
                    tipo: [{v:'reuniao',t:'Reunião'},{v:'pregacao',t:'Pregação'}],
                    quando: [{v:'semana',t:'Semana'},{v:'fim-de-semana',t:'Fim de Semana'},{v:'ambos',t:'Semana e Fim de Semana'}],
                    parte: [{v:'escola',t:'Escola'},{v:'vida-e-ministerio',t:'Vida e Ministério'},{v:'fim-de-semana',t:'Fim de semana'},{v:'tecnicas',t:'Técnicas'},{v:'pregacao',t:'Pregação'},{v:'dirigencia-saida',t:'Dirigência Saída'}],
                    genero: [{v:'masculino',t:'Masculino'},{v:'feminino',t:'Feminino'}],
                    sala: [{v:'salao-principal',t:'Salão Principal'},{v:'segunda-sala',t:'Segunda Sala'},{v:'terceira-sala',t:'Terceira Sala'}],
                    ano: sortedYears.map(y => ({v:y, t:y})),
                    idioma: Array.from(nacionalidadesSnapshot.docs.map(doc => ({v:doc.id, t:doc.data().nome}))),
                    designacoes: Array.from(designacoesSnapshot.docs.map(doc => ({v:doc.id, t:doc.data().nome})))
                };
                document.querySelectorAll('.filter-panel').forEach(panel => {
                    for (const [filterName, options] of Object.entries(staticOptions)) {
                        const container = panel.querySelector(`.multi-select-container[data-filter-name="${filterName}"]`);
                        if (container) { const list = container.querySelector('.multi-select-list'); list.innerHTML = options.map(opt => `<label><input type="checkbox" value="${opt.v}" checked> ${opt.t}</label>`).join(''); updateMultiSelectLabel(container); }
                    }
                    populateSemanaFilter(panel);
                });
            } catch (error) { console.error("Erro ao popular os filtros:", error); }
        };
        
        async function preloadData() {
            try {
                const [designacoesSnapshot, pessoasSnapshot, nacionalidadesSnapshot, discursosSnapshot] = await Promise.all([ db.collection('designacoes').get(), db.collection('pessoas').get(), db.collection('nacionalidades').get(), db.collection('discursos').get() ]);
                designacoesSnapshot.forEach(doc => { const data = doc.data(); designacoesMap.set(doc.id, data.nome); if (data.nome === 'Orador') { oradorDesignacaoId = doc.id; } });
                pessoasSnapshot.forEach(doc => pessoasMap.set(doc.id, doc.data()));
                nacionalidadesSnapshot.forEach(doc => nacionalidadesMap.set(doc.id, doc.data().nome));
                discursosSnapshot.forEach(doc => discursosMap.set(doc.id, doc.data()));
                console.log("Dados de designações, pessoas, nacionalidades e discursos pré-carregados.");
                if (oradorDesignacaoId) { console.log(`ID da designação 'Orador' encontrado: ${oradorDesignacaoId}`); } else { console.warn("'Orador' não encontrado na coleção de designações."); }
            } catch (error) { console.error("Erro ao pré-carregar dados:", error); }
        }

        await populateAllFilters();
        await preloadData();

        // --- EVENT LISTENERS ---
        document.querySelectorAll('.filter-toggle-button').forEach(button => { button.addEventListener('click', () => { const container = button.closest('.collapsible-container'); if (!container) return; const wrapper = container.querySelector('.filter-panel-wrapper'); container.classList.toggle('open'); if (container.classList.contains('open')) { button.querySelector('span').textContent = 'Ocultar Filtros'; setTimeout(() => { wrapper.classList.add('overflow-visible'); }, 400); } else { button.querySelector('span').textContent = 'Mostrar Filtros'; wrapper.classList.remove('overflow-visible'); } }); });
        document.querySelectorAll('.multi-select-container').forEach(container => {
            const button = container.querySelector('.multi-select-button'), options = container.querySelector('.multi-select-options'), list = container.querySelector('.multi-select-list'), searchInput = container.querySelector('.multi-select-search');
            if (button) button.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.multi-select-options.open').forEach(open => { if (open !== options) open.classList.remove('open'); }); options.classList.toggle('open'); });
            if (list) list.addEventListener('change', (e) => { if (e.target.type === 'checkbox') { const panel = container.closest('.filter-panel'); updateMultiSelectLabel(container); if (container.dataset.filterName === 'mes') { populateSemanaFilter(panel); } panel.dispatchEvent(new Event('change', { bubbles: true })); } });
            if (searchInput) searchInput.addEventListener('input', function() { const searchTerm = this.value.toLowerCase(); list.querySelectorAll('label, strong').forEach(el => { if (el.tagName === 'STRONG') return; el.style.display = el.textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none'; }); });
            const selectAll = container.querySelector('.select-all'), clearSelection = container.querySelector('.clear-selection');
            const actionHandler = () => { const panel = container.closest('.filter-panel'); updateMultiSelectLabel(container); if (container.dataset.filterName === 'mes') { populateSemanaFilter(panel); } panel.dispatchEvent(new Event('change', { bubbles: true })); };
            if (selectAll) selectAll.addEventListener('click', () => { list.querySelectorAll('input').forEach(cb => cb.checked = true); actionHandler(); });
            if (clearSelection) clearSelection.addEventListener('click', () => { list.querySelectorAll('input').forEach(cb => cb.checked = false); actionHandler(); });
        });
        document.querySelectorAll('.filter-panel').forEach(panel => { panel.addEventListener('change', () => { const tabId = panel.closest('.tab-content').id; if (tabId === 'Geral') updateGeralDashboard(); else if (tabId === 'Top') updateTopDashboard(); else if (tabId === 'Comparacao') updateComparacaoDashboard(); else if (tabId === 'Individual') updateIndividualDashboard(); }); });
        
        const indSearchInput = document.getElementById('individual-search-input'), indSearchResults = document.getElementById('individual-search-results');
        if (indSearchInput) { indSearchInput.addEventListener('input', () => { const q = indSearchInput.value.toLowerCase(); if (q.length < 2) { indSearchResults.style.display = 'none'; return; } const f = [...pessoasMap.entries()].filter(([i, d]) => d.nomePessoa.toLowerCase().includes(q)).sort((a, b) => a[1].nomePessoa.localeCompare(b[1].nomePessoa)); indSearchResults.innerHTML = f.slice(0, 10).map(([i, d]) => `<div class="search-result-item" data-person-id="${i}">${d.nomePessoa}</div>`).join(''); indSearchResults.style.display = 'block'; }); }
        if(indSearchResults){ indSearchResults.addEventListener('click',(e)=>{if(e.target.classList.contains('search-result-item')){selectedPersonForIndividual=e.target.dataset.personId;updateIndividualDashboard();indSearchInput.value='';indSearchResults.style.display='none';}});}

        const indAggregatedList = document.getElementById('individual-aggregated-list');
        if(indAggregatedList){ indAggregatedList.addEventListener('click', (e) => { const c = e.target.closest('.top-list-item'); if (!c) return; const dId = c.dataset.designationId; const dItems = document.querySelectorAll('#individual-detailed-list .top-list-item'); const aItems = document.querySelectorAll('#individual-aggregated-list .top-list-item'); const pItems = document.querySelectorAll('#individual-frequent-partners-list .top-list-item'); pItems.forEach(i => i.classList.remove('active')); if (c.classList.contains('active')) { c.classList.remove('active'); dItems.forEach(i => i.classList.add('highlight')); } else { aItems.forEach(i => i.classList.remove('active')); c.classList.add('active'); dItems.forEach(i => { if (i.dataset.designationId === dId) i.classList.add('highlight'); else i.classList.remove('highlight'); }); } }); }
        
        const indFrequentPartnersList = document.getElementById('individual-frequent-partners-list');
        if (indFrequentPartnersList) { indFrequentPartnersList.addEventListener('click', (e) => { const c = e.target.closest('.top-list-item'); if (!c) return; const pId = c.dataset.partnerId; const dItems = document.querySelectorAll('#individual-detailed-list .top-list-item'); const pItems = document.querySelectorAll('#individual-frequent-partners-list .top-list-item'); const aItems = document.querySelectorAll('#individual-aggregated-list .top-list-item'); aItems.forEach(i => i.classList.remove('active')); if (c.classList.contains('active')) { c.classList.remove('active'); dItems.forEach(i => i.classList.add('highlight')); } else { pItems.forEach(i => i.classList.remove('active')); c.classList.add('active'); dItems.forEach(i => { const coIds = i.dataset.coParticipantIds.split(','); if (coIds.includes(pId)) i.classList.add('highlight'); else i.classList.remove('highlight'); }); } }); }

        const modalOverlay = document.getElementById('chart-modal-overlay');
const modalCloseBtn = document.getElementById('chart-modal-close');

document.querySelectorAll('.expand-chart-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const chartId = btn.dataset.chartId;
        let sourceChart;

        // --- INÍCIO DA CORREÇÃO ---
        // Os 'case' agora usam hífen para corresponder exatamente
        // aos atributos 'data-chart-id' no HTML.
        switch(chartId) {
            case 'by-designation': sourceChart = individualChartByDesignation; break;
            case 'by-week': sourceChart = individualChartByWeek; break;
            case 'by-month': sourceChart = individualChartByMonth; break;
            case 'by-year': sourceChart = individualChartByYear; break;
            case 'discursos-by-month': sourceChart = individualChartDiscursosByMonth; break;
            case 'discursos-by-year': sourceChart = individualChartDiscursosByYear; break;
        }
        // --- FIM DA CORREÇÃO ---

        if (sourceChart) {
            modalOverlay.style.display = 'flex';
            const modalCtx = document.getElementById('modal-chart-canvas').getContext('2d');
            if (modalChart) modalChart.destroy(); // Destruir gráfico anterior do modal
            
            // Clona a configuração do gráfico de origem para o modal
            modalChart = new Chart(modalCtx, {
                type: sourceChart.config.type,
                data: sourceChart.config.data,
                options: { ...sourceChart.config.options, maintainAspectRatio: false } // Garante que o gráfico preenche o espaço
            });
        }
    });
});

function closeModal() {
    modalOverlay.style.display = 'none';
    if (modalChart) {
        modalChart.destroy();
        modalChart = null;
    }
}

modalCloseBtn.addEventListener('click', closeModal);
modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) { // Fecha apenas se clicar no fundo
        closeModal();
    }
});

        function closeModal() { modalOverlay.style.display = 'none'; if (modalChart) { modalChart.destroy(); modalChart = null; } }
        modalCloseBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) { closeModal(); } });
        
        window.addEventListener('click', (e) => { 
            const openDropdown = document.querySelector('.multi-select-options.open');
            if (openDropdown && !openDropdown.parentElement.contains(e.target)) { openDropdown.classList.remove('open'); }
            if(!document.querySelector('.comparison-search-container')?.contains(e.target)){ if(indSearchResults) indSearchResults.style.display='none'; }
        });

        await updateGeralDashboard();
        await updateTopDashboard();
        await updateComparacaoDashboard();
        await updateIndividualDashboard();
        console.log("Página pronta e filtros configurados.");
    });
</script>
</body>
</html>
